<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>MyEMR V6.2</title>

  <style>
    :root {
      --sidebar-bg: #202123;
      --sidebar-hover: #2A2B32;
      --main-bg: #f7f7f8;
      --panel-bg: #ffffff;

      --text-primary: #111827;
      --text-muted: #6b7280;
      --text-invert: #ececf1;

      --accent-color: #10a37f;
      --border-color: #e5e7eb;
      --danger-color: #ef4444;

      --chip-bg: #f3f4f6;
      --chip-border: #e5e7eb;
      --chip-text: #374151;
      --chip-active-bg: rgba(16,163,127,0.12);
      --chip-active-border: rgba(16,163,127,0.45);
      --chip-active-text: #0d8a6a;

      --shadow-sm: 0 1px 2px rgba(0,0,0,0.06);
      --shadow-md: 0 8px 24px rgba(0,0,0,0.10);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      height: 100vh;
      height: 100dvh;
      min-height: 100vh;
      display: flex;
      color: var(--text-primary);
      background-color: var(--main-bg);
      overflow: hidden;
    }


    /* ===== App Shell Layout (Desktop) ===== */
    #appShell{
      display: flex;
      flex: 1 1 auto;
      width: 100%;
      height: 100%;
      min-height: 0;
      min-width: 0;
      overflow: hidden;
    }

    /* ===== Scrollbar 美化 ===== */
    * { scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.18) transparent; }
    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb {
      background: rgba(0,0,0,0.18);
      border-radius: 999px;
      border: 2px solid transparent;
      background-clip: padding-box;
    }
    ::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.28); background-clip: padding-box; }
    .sidebar * { scrollbar-color: rgba(255,255,255,0.22) transparent; }
    .sidebar ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.18); }
    .sidebar ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.26); }

    /* ===== Icons（线性）===== */
    .ico {
      width: 16px; height: 16px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .ico svg {
      width: 16px; height: 16px;
      stroke: currentColor;
      fill: none;
      stroke-width: 1.8;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    /* Icon Picker: ensure inline SVGs render correctly (not only inside .ico) */
    .icon-badge svg,
    .new-icon-preview svg {
      width: 18px; height: 18px;
      stroke: currentColor;
      fill: none;
      stroke-width: 1.8;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    /* --- 侧边栏 --- */
    .sidebar {
      width: 280px;
      background-color: var(--sidebar-bg);
      color: var(--text-invert);
      display: flex;
      flex-direction: column;
      padding: 10px;
      flex-shrink: 0;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    .sidebar-header { margin-bottom: 16px; }

    .action-btn {
      border: 1px solid rgba(255,255,255,0.18);
      padding: 10px 12px;
      border-radius: 10px;
      cursor: pointer;
      transition: 0.18s;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      color: var(--text-invert);
      margin-bottom: 8px;
      background: rgba(255,255,255,0.02);
      width: 100%;
      user-select: none;
    }
    .action-btn:hover { background-color: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.22); }
    .btn-green {
      background-color: rgba(16,163,127,0.96);
      border: 1px solid rgba(16,163,127,0.8);
      color: white;
    }
    .btn-green:hover { background-color: #0d8a6a; border-color: rgba(16,163,127,1); }

    .sidebar-section-title{
      font-size: 13px;
      font-weight: 800;
      color: rgba(236,236,241,0.90);
      margin: 12px 0 10px;
      padding: 10px 10px;
      border-radius: 12px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.10);
      display: flex;
      align-items: center;
      gap: 8px;
      letter-spacing: .06em;
    }
    .sidebar-section-title::before{
      content: "";
      width: 4px;
      height: 16px;
      border-radius: 999px;
      background: rgba(16,163,127,0.95);
      box-shadow: 0 0 0 3px rgba(16,163,127,0.14);
      flex-shrink: 0;
    }

    .category-tree { flex: 1; overflow-y: auto; margin-top: 4px; }

    .cat-header {
      padding: 8px 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: 10px;
      user-select: none;
      cursor: pointer;
      gap: 10px;
    }
    .cat-left { display:flex; align-items:center; gap: 8px; min-width: 0; }
    .cat-name { font-size: 13px; font-weight: 700; color: inherit; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .sidebar .cat-name { color: rgba(236,236,241,0.98); }

    .cat-header:hover, .cat-header.active { background-color: var(--sidebar-hover); }

    .cat-right { display:flex; align-items:center; gap: 6px; flex-shrink: 0; }
    .cat-arrow {
      font-size: 0;
      color: rgba(236,236,241,0.5);
      padding: 4px 6px;
      border-radius: 8px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .cat-arrow:hover { background: rgba(255,255,255,0.08); color: rgba(236,236,241,0.85); }

    .sub-cat-list { display: none; padding-left: 22px; margin: 4px 0 6px; }
    .sub-cat-list.expanded { display: block; }
    .sub-cat-item {
      padding: 7px 10px;
      font-size: 12.5px;
      font-weight: 600;
      color: rgba(236,236,241,0.88);
      border-radius: 10px;
      cursor: pointer;
      user-select: none;
      display:flex;
      align-items:center;
      gap: 8px;
    }
    .sub-cat-item:hover, .sub-cat-item.active { background-color: rgba(255,255,255,0.10); color: rgba(236,236,241,0.95); }

    .sidebar-footer {
      margin-top: auto;
      border-top: 1px solid rgba(255,255,255,0.14);
      padding-top: 10px;
    }

    /* --- 主区域 --- */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100%;
      min-width: 0;
      min-height: 0;
    }
    .top-bar {
      padding: 14px 18px;
      background-color: var(--panel-bg);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .current-filter {
      font-weight: 800;
      color: #374151;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 40%;
    }
    .search-box {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      font-size: 14px;
      outline: none;
      background: #fbfbfc;
    }
    .search-box:focus { border-color: rgba(16,163,127,0.65); box-shadow: 0 0 0 3px rgba(16,163,127,0.10); background: #fff; }

    .content-area {
      flex: 1;
      overflow-y: auto;
      padding: 18px;
      background-color: var(--main-bg);
      -webkit-overflow-scrolling: touch;
      min-height: 0;
    }
    .content-container { max-width: 980px; margin: 0 auto; }

    /* --- 卡片 --- */
    .template-card {
      background: var(--panel-bg);
      border: 1px solid var(--border-color);
      border-radius: 14px;
      padding: 14px;
      margin-bottom: 14px;
      box-shadow: var(--shadow-sm);
      transition: 0.18s;
    }
    .template-card:hover { box-shadow: var(--shadow-md); transform: translateY(-1px); }

    .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; gap: 10px; }
    .card-title { font-weight: 800; font-size: 15px; color: #111827; line-height: 1.3; }
    .card-actions { display:flex; gap:8px; align-items:center; flex-shrink:0; }

    .card-meta { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 6px; }
    .tag { font-size: 11px; padding: 3px 8px; border-radius: 999px; color: #374151; background: #f3f4f6; border: 1px solid #eef0f3; }
    .tag-main { background: rgba(2,132,199,0.10); color: #0369a1; border-color: rgba(2,132,199,0.18); }
    .tag-sub { background: rgba(22,163,74,0.10); color: #15803d; border-color: rgba(22,163,74,0.18); }

    .card-body {
      font-size: 14px;
      line-height: 1.65;
      color: #374151;
      background-color: #fbfbfc;
      padding: 12px;
      border-radius: 12px;
      border: 1px dashed #e5e7eb;
      cursor: pointer;
      overflow-wrap: anywhere;
    }
    .card-body:hover { border-color: rgba(16,163,127,0.55); }

    .btn-copy, .btn-move {
      padding: 7px 10px;
      font-size: 12px;
      border: 1px solid #e5e7eb;
      background: #fff;
      border-radius: 10px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: #374151;
      transition: .15s;
      user-select:none;
    }
    .btn-copy:hover, .btn-move:hover { border-color: rgba(16,163,127,0.45); background: rgba(16,163,127,0.04); }
    .btn-copy.copied { background: rgba(16,163,127,0.12); color: #0d8a6a; border-color: rgba(16,163,127,0.45); }

    /* --- 模态框（遮罩点击不关闭） --- */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.55);
      justify-content: center;
      align-items: center;
      z-index: 2000;
      padding: 18px;
    }
    .modal-content {
      background: var(--panel-bg);
      border: 1px solid rgba(255,255,255,0.05);
      padding: 18px;
      border-radius: 16px;
      width: 720px;
      max-width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-md);
    }

    /* Mobile/iOS: prevent background scrolling when a modal is open */
    
    html.modal-open {
      position: fixed;
      left: 0; right: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
body.modal-open {
      position: fixed;
      left: 0; right: 0;
      width: 100%;
      overflow: hidden;
    }
    .modal-content {
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }
    .modal-title {
      font-size: 16px;
      font-weight: 900;
      margin-bottom: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }
    .modal-close {
      cursor:pointer;
      color: #6b7280;
      padding: 6px 8px;
      border-radius: 10px;
      display:inline-flex;
      align-items:center;
      gap:0;
      user-select:none;
      border: 1px solid #e5e7eb;
      background: #fff;
          white-space: nowrap;
      flex-wrap: nowrap;
    }
    .modal-close:hover { background: #f3f4f6; color:#111827; }
    .modal-close span{ white-space: nowrap; }

    .form-row { display: flex; gap: 10px; margin-bottom: 12px; }
    .form-col { flex: 1; min-width: 0; }
    .form-label { display: block; margin-bottom: 6px; font-weight: 800; font-size: 12px; color: #374151; }
    .form-input, .form-select {
      width: 100%;
      padding: 9px 10px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      font-size: 13px;
      outline: none;
      background: #fff;
    }

    /* 下拉框箭头美化（含移动模板界面） */
    .form-select {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      padding-right: 36px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none'%3E%3Cpath d='M7 10l5 5 5-5' stroke='%236b7280' stroke-width='2.2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 16px 16px;
      cursor: pointer;
    }
    .form-select:hover {
      border-color: rgba(107,114,128,0.45);
    }
    .form-select:disabled {
      cursor: not-allowed;
      background-color: #f9fafb;
      color: #9ca3af;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none'%3E%3Cpath d='M7 10l5 5 5-5' stroke='%23cbd5e1' stroke-width='2.2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
    }

    .form-input:focus, .form-select:focus {
      border-color: rgba(16,163,127,0.65);
      box-shadow: 0 0 0 3px rgba(16,163,127,0.10);
    }
    .hint { font-size: 12px; color: var(--text-muted); margin-top: 8px; line-height: 1.55; }

    /* ====== 模板编辑：底部按钮始终可见（sticky）====== */
    .modal-footer {
      position: sticky;
      bottom: -18px;
      background: linear-gradient(to top, rgba(255,255,255,0.98), rgba(255,255,255,0.86));
      padding: 12px 0 0;
      margin-top: 14px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      border-top: 1px solid rgba(229,231,235,0.65);
      backdrop-filter: blur(6px);
    }

    /* ====== 模板编辑弹窗：正文可滚动 + 底部按钮固定（兼容 iOS）====== */
    .modal-content-editor{
      display: flex;
      flex-direction: column;
      overflow: hidden; /* 让滚动只发生在 .modal-body，避免 sticky 在 iOS 下抖动 */
    }
    .modal-content-editor .modal-body{
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      padding-right: 6px;
      padding-bottom: 6px;
    }
    .modal-content-editor .modal-footer{
      position: relative;
      bottom: auto;
      margin: 0 -18px -18px;
      padding: 12px 18px calc(12px + env(safe-area-inset-bottom));
      background: linear-gradient(to top, rgba(255,255,255,0.98), rgba(255,255,255,0.92));
      border-top: 1px solid rgba(229,231,235,0.85);
      border-radius: 0 0 16px 16px;
      box-shadow: 0 -10px 24px rgba(0,0,0,0.08);
      backdrop-filter: blur(8px);
    }

    .btn {
      padding: 9px 14px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .btn-primary { background: rgba(16,163,127,0.96); color: white; }
    .btn-primary:hover { background: #0d8a6a; }
    .btn-secondary { background: #f3f4f6; color: #374151; }
    .btn-secondary:hover { background: #e9edf2; }
    .btn-danger { background: rgba(239,68,68,0.96); color: white; }
    .btn-danger:hover { background: #dc2626; }
    .btn-sm { padding: 6px 10px; font-size: 12px; border-radius: 10px; }

    .btn:disabled { opacity: 0.55; cursor: not-allowed; filter: grayscale(0.10); }

    /* 富文本编辑器 */
    .rte-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      padding: 8px;
      border: 1px solid #e5e7eb;
      border-radius: 12px 12px 0 0;
      background: #fbfbfc;
    }
    .rte-btn {
      padding: 7px 10px;
      border: 1px solid #e5e7eb;
      background: #fff;
      border-radius: 10px;
      cursor: pointer;
      font-size: 12px;
      line-height: 1;
      color: #374151;
      user-select:none;
      transition: .15s;
    }
    .rte-btn:hover { border-color: rgba(16,163,127,0.45); background: rgba(16,163,127,0.04); }
    .rte-divider { width: 1px; background: #e5e7eb; margin: 0 2px; }

    .rte-editor {
      border: 1px solid #e5e7eb;
      border-top: none;
      border-radius: 0 0 12px 12px;
      min-height: 180px;
      padding: 12px;
      outline: none;
      background: #fff;
      color: #111827;
      line-height: 1.7;
      overflow-y: auto;
    }
    .rte-editor:focus { box-shadow: 0 0 0 3px rgba(16,163,127,0.10); }

    /* 标签选择器 */
    .tag-picker {
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 10px;
      background: #fff;
    }
    .tag-selected-row { display:flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
    .tag-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--chip-border);
      background: var(--chip-bg);
      color: var(--chip-text);
      cursor: pointer;
      user-select: none;
      font-size: 12px;
      transition: .15s;
      max-width: 100%;
    }
    .tag-chip:hover { border-color: #cbd5e1; }
    .tag-chip.active {
      background: var(--chip-active-bg);
      border-color: var(--chip-active-border);
      color: var(--chip-active-text);
      font-weight: 800;
    }
    .tag-chip .x { font-weight: 900; opacity: .55; }
    .tag-chip.active .x { opacity: .75; }

    .tag-add-row { display:flex; gap:8px; margin-top:8px; align-items: center; }
    /* 标签新增行：避免按钮被挤到逐字换行 */
    .tag-add-row .form-input{ flex: 1 1 auto; width: auto; min-width: 0; }
    #btnAddTag{ flex: 0 0 auto; white-space: nowrap; }
    #btnAddTag span{ white-space: nowrap; }


    .tag-pool-wrap { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #e5e7eb; }
    .tag-pool { display:flex; flex-wrap: wrap; gap: 6px; overflow: visible; padding-bottom: 2px; }
    .tag-pool.collapsed { max-height: 80px; overflow: hidden; }
    .tag-pool-toggle {
      margin-top: 8px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      font-size: 12px;
      color: #4b5563;
      user-select: none;
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #fff;
      width: fit-content;
    }
    .tag-pool-toggle:hover { border-color: rgba(16,163,127,0.45); background: rgba(16,163,127,0.04); color: #111827; }

    /* 分类管理 */
    .manage-layout { display: flex; gap: 15px; height: 420px; }
    .manage-col { flex: 1; border: 1px solid #e5e7eb; border-radius: 14px; display: flex; flex-direction: column; overflow:hidden; background:#fff; }
    .manage-header { padding: 10px; background: #fbfbfc; border-bottom: 1px solid #e5e7eb; font-weight: 900; font-size: 13px; color:#374151; }
    .manage-list { flex: 1; overflow-y: auto; padding: 6px; }

    .manage-item {
      padding: 8px 10px;
      border-radius: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      border: 1px solid transparent;
      cursor: pointer;
      user-select:none;
      gap: 10px;
      color:#111827;
    }
    .manage-item:hover { background: #f3f4f6; }
    .manage-item.active { background: rgba(2,132,199,0.10); border-color: rgba(2,132,199,0.16); color: #0369a1; }

    .manage-item-left { display:flex; align-items:center; gap:8px; min-width:0; }
    .manage-item-left span.name { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; flex:1; min-width:0; }


    .inline-rename-input {
      font-size: 13px;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid rgba(16,163,127,0.45);
      background: #fff;
      color: var(--text-primary);
      outline: none;
      min-width: 80px;
      width: 100%;
    }
    .inline-rename-input:focus {
      box-shadow: 0 0 0 3px rgba(16,163,127,0.14);
      border-color: rgba(16,163,127,0.65);
    }
    .manage-item-left .inline-rename-input { flex: 1; }

    .item-controls { display: flex; gap: 6px; }
    .icon-btn {
      cursor: pointer;
      padding: 6px 8px;
      color: #6b7280;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #fff;
      user-select:none;
      display:inline-flex;
      align-items:center;
      gap:0;
      font-size: 12px;
    }
    /* More (overflow) button for mobile compact layout */
    .icon-btn.more { display: none; }
    .more-menu { display: none; }

    .icon-btn.icon-only { padding: 6px; gap: 0; }

    /* Mobile: prevent category name being squeezed/covered by control buttons in Manage Categories */
    
@media (max-width: 560px) {
      /* Keep one-line row; make buttons compact; fold less-used actions into "更多" */
      .manage-item { flex-direction: row; align-items: center; flex-wrap: nowrap; position: relative; }
      .manage-item-left { flex: 1 1 auto; min-width: 0; }
      .manage-item-left .name { flex: 1 1 auto; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .item-controls { width: auto; justify-content: flex-end; flex-wrap: nowrap; gap: 4px; }
      .item-controls .icon-btn { padding: 6px; width: 34px; height: 34px; }
      .item-controls .icon-btn .ico svg { width: 18px; height: 18px; }

      /* show "更多" only on mobile */
      .item-controls .icon-btn.more { display: inline-flex; }

      /* hide the less-used inline buttons on mobile (available in the more menu) */
      .item-controls .icon-btn:not(.more) { display: none; }

      .more-menu { display: none; position: absolute; right: 10px; top: calc(100% - 6px);
        background: #fff; border: 1px solid rgba(0,0,0,0.10); border-radius: 12px;
        padding: 6px; box-shadow: 0 12px 32px rgba(0,0,0,0.14); width: 160px; z-index: 30000;
      }
      .manage-item.show-more-menu .more-menu { display: block; }

      .more-menu-item {
        width: 100%;
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 10px;
        border-radius: 10px;
        border: none;
        background: transparent;
        color: #111827;
        font-size: 14px;
        cursor: pointer;
      }
      .more-menu-item:hover { background: #f3f4f6; }
      .more-menu-item .ico svg { width: 18px; height: 18px; }
      .more-menu-item.danger { color: #b91c1c; }
      .more-menu-item.danger:hover { background: rgba(185,28,28,0.08); }
    }
      .item-controls .icon-btn { padding: 6px; }
      /* give the name line a little breathing room */
      .manage-item-left .name { padding-right: 2px; }
    }

    .icon-btn:hover { background: #f3f4f6; color: #111827; }
    .icon-btn.delete:hover { background: rgba(239,68,68,0.10); border-color: rgba(239,68,68,0.22); color: #b91c1c; }
    .icon-btn.rename:hover { background: rgba(2,132,199,0.10); border-color: rgba(2,132,199,0.22); color: #0369a1; }
    .icon-btn.iconpick:hover { background: rgba(16,163,127,0.08); border-color: rgba(16,163,127,0.22); color: #0d8a6a; }

    .manage-input-row {
      padding: 10px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      gap: 8px;
      background:#fff;
      align-items: center;
      flex-wrap: wrap;
    }
    .new-icon-preview {
      width: 34px;
      height: 34px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #fff;
      display:flex;
      align-items:center;
      justify-content:center;
      color: #374151;
    }

    /* Icon Picker */
    .icon-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-top: 12px;
    }
    .icon-item {
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      padding: 10px;
      background: #fff;
      cursor: pointer;
      user-select:none;
      display:flex;
      gap: 10px;
      align-items:center;
      transition: .15s;
      min-height: 56px;
    }
    .icon-item:hover { border-color: rgba(16,163,127,0.45); background: rgba(16,163,127,0.04); }
    .icon-item.disabled { opacity: 0.45; cursor: not-allowed; background: #fbfbfc; }
    .icon-item.disabled:hover { border-color: #e5e7eb; background: #fbfbfc; }

    .icon-badge {
      width: 34px;
      height: 34px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      display:flex;
      align-items:center;
      justify-content:center;
      color: #374151;
      background: #fff;
      flex-shrink: 0;
    }
    .icon-text { display:flex; flex-direction: column; gap: 2px; min-width:0; }
    .icon-text .label { font-weight: 900; font-size: 12px; color: #111827; }
    .icon-text .desc { font-size: 12px; color: #6b7280; white-space: nowrap; overflow:hidden; text-overflow: ellipsis; }

    /* Icon Picker: inline filtering + close button always visible */
    .modal-content-iconpicker{
      display: flex;
      flex-direction: column;
      overflow: hidden; /* header stays visible; body scrolls */
    }
    .modal-content-iconpicker .icon-picker-body{
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      padding-right: 6px;
      padding-bottom: 6px;
    }
    /* Title bar stays visually separated from scrolling grid */
    #iconPickerModal .modal-title{
      margin-bottom: 0;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(229,231,235,0.65);
      background: linear-gradient(to bottom, rgba(255,255,255,0.98), rgba(255,255,255,0.92));
      backdrop-filter: blur(8px);
    }
    #iconPickerModal .icon-picker-body{ padding-top: 12px; }


    /* 三选项确认 */
    .confirm3-modal {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.62);
      justify-content: center;
      align-items: center;
      z-index: 2000;
      padding: 18px;
    }
    .confirm3-box {
      width: 460px;
      max-width: 100%;
      background: #fff;
      border-radius: 16px;
      box-shadow: var(--shadow-md);
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.04);
    }
    .confirm3-header {
      padding: 12px 14px;
      background: #fbfbfc;
      border-bottom: 1px solid #e5e7eb;
      font-weight: 900;
      font-size: 14px;
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 10px;
    }
    .confirm3-body {
      padding: 12px 14px;
      font-size: 13px;
      color: #374151;
      line-height: 1.65;
      white-space: pre-wrap;
    }
    .confirm3-footer {
      padding: 12px 14px;
      border-top: 1px solid #e5e7eb;
      display:flex;
      gap: 10px;
      justify-content: flex-end;
      flex-wrap: wrap;
      background: #fff;
    }
    .confirm3-x {
      cursor: pointer;
      color: #6b7280;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #fff;
      user-select:none;
      display:inline-flex;
      align-items:center;
      gap:0;
      font-weight: 800;
      font-size: 12px;
      line-height: 1;
    }
    .confirm3-x .ico { display:inline-flex; }
    .confirm3-x:hover { background: #f3f4f6; color:#111827; }

    @media (max-width: 820px) {
      .sidebar { width: 240px; }
      .modal-content { width: 96vw; }
      .current-filter { max-width: 38%; }
    }
    /* ===== Mobile (iPhone) 兼容：侧边栏抽屉 + 顶部按钮 ===== */
.sidebar-toggle { display:none; align-items:center; justify-content:center; padding: 8px; border-radius: 10px; }
.sidebar-toggle .ico svg{ width:20px; height:20px; }
.sidebar-backdrop { display:none; position: fixed; inset: 0; background: rgba(0,0,0,.35); z-index: 1100; }

@media (max-width: 680px) {

  /* App shell should not constrain page height on iPhone; keep page scroll stable */
  #appShell{
    display: block;
    height: auto;
    min-height: 100dvh;
    overflow: visible;
  }
  /* Mobile menu button polish */
  .sidebar-toggle{ background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.10); }
  .sidebar-toggle:active{ transform: scale(0.98); }

  /* iOS Safari 100vh 适配 */
  body { height: 100dvh; }
  @supports (-webkit-touch-callout: none) {
    html, body { height: -webkit-fill-available; }
    body { height: -webkit-fill-available; }
  }

  .sidebar { 
    display:flex;
    flex-direction: column;
    overflow: hidden; /* keep header/footer fixed on mobile */
    position: fixed;
    top: 0;
    bottom: 0;
    left: 0;
    height: 100dvh;
    width: min(82vw, 320px);
    transform: translateX(-105%);
    transition: transform .25s ease;
    z-index: 1200;
    box-shadow: 0 12px 30px rgba(0,0,0,.18);
    padding-top: calc(12px + env(safe-area-inset-top));
    padding-bottom: calc(12px + env(safe-area-inset-bottom));
    overscroll-behavior: contain;
  }
  .sidebar.open { transform: translateX(0); }
  .sidebar-backdrop.show { display:block; }

  /* Mobile sidebar: keep header and footer fixed; only the tree scrolls */
  .sidebar-header{ flex: 0 0 auto; }
  .sidebar-footer{ flex: 0 0 auto; }
  .category-tree{
    flex: 1 1 auto;
    min-height: 0;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 6px;
  }

  .main-content { width: 100%; }
  .sidebar-toggle { display: inline-flex; }

  .current-filter { max-width: 44%; }
  .top-bar { padding: 10px 12px; gap: 10px; }
  .content-area { padding: 12px; }


  /* ===== Mobile scrolling reliability (iOS Safari) =====
     在小屏端改为“页面滚动”为主，避免 iOS 在 flex + overflow 容器中出现无法滑动的问题（必须放大才可滚动）。
  */
  html, body { overflow-x: hidden; }
  body{
    display: block;
    height: auto;
    min-height: 100dvh;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior-y: auto;
  }
  .main-content{
    height: auto;
    min-height: 100dvh;
  }
  /* 让内容随页面滚动，而不是依赖内部滚动容器（iOS 更稳定） */
  .content-area{
    overflow: visible;
    -webkit-overflow-scrolling: auto;
    min-height: auto;
  }
    /* 顶栏固定（iOS 小屏更稳定，便于随时呼出侧边栏/搜索） */
  .top-bar{
    position: fixed;
    top: env(safe-area-inset-top);
    left: 0;
    right: 0;
    z-index: 1050;
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(229,231,235,0.65);
  }
  /* 为固定顶栏留出空间，避免内容被遮挡（高度由 JS 动态写入 --topbar-h） */
  .main-content{
    padding-top: calc(env(safe-area-inset-top) + var(--topbar-h, 64px));
  }
}

  

/* ===== Sidebar app badge ===== */
.app-badge{
  margin-top: 10px;
  padding: 8px 10px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.10);
  background: rgba(255,255,255,0.06);
  color: rgba(255,255,255,0.90);
  font-size: 12px;
  font-weight: 800;
  letter-spacing: .2px;
  text-align: center;
  user-select: none;
}



@media (max-width: 680px) {
  /* Mobile: center modals, keep header/close visible, and cooperate with iOS keyboard/visualViewport */
  .modal{
    padding: calc(12px + env(safe-area-inset-top)) 12px calc(12px + env(safe-area-inset-bottom));
    align-items: center;
    height: var(--vvh, 100dvh);
    top: var(--vvoffset, 0px);
  }
  .modal-content{
    width: 100%;
    max-height: calc(var(--vvh, 100dvh) - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 24px);
    padding: 14px;
    border-radius: 14px;
  }
  /* Sticky footer should not be covered by Safari bottom bar */
  .modal-footer{
    bottom: 0;
    padding: 12px 0 calc(10px + env(safe-area-inset-bottom));
    margin-bottom: 0;
  }

  /* Prevent iOS Safari auto-zoom on focus (keep inputs >= 16px) */
  input, textarea, select, button,
  .rte, [contenteditable="true"]{
    font-size: 16px !important;
  }
}



/* Close button: always keep text horizontal */
.btn-close, .btn-close span { white-space: nowrap; }


    /* ===== Password Protection (MyEMR) ===== */
    .auth-overlay{
      position: fixed;
      inset: 0;
      z-index: 200000;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(240,242,246,.92);
      padding: 18px;
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }
    .auth-card{
      width: min(420px, 100%);
      border-radius: 16px;
      background: rgba(255,255,255,.96);
      border: 1px solid rgba(0,0,0,.10);
      box-shadow: 0 14px 48px rgba(0,0,0,.14);
      padding: 16px 16px 14px;
    }
    .auth-head{
      display:flex; align-items:baseline; justify-content:space-between;
      padding-bottom: 10px; margin-bottom: 10px;
      border-bottom: 1px solid rgba(0,0,0,.08);
    }
    .auth-brand{ font-weight: 900; font-size: 18px; letter-spacing:.2px;}
    .auth-ver{ font-weight: 800; font-size: 12px; opacity:.55; }
    .auth-title{ font-size: 16px; font-weight: 900; margin: 2px 0 6px; }
    .auth-hint{ font-size: 13px; opacity:.75; line-height: 1.45; }
    .auth-input{
      width: 100%;
      border: 1px solid rgba(0,0,0,.10);
      border-radius: 12px;
      padding: 11px 12px;
      font-size: 15px;
      font-weight: 700;
      background: #fff;
      margin-top: 10px;
    }
    .auth-input:focus{ outline:none; border-color: rgba(16,185,129,.55); box-shadow: 0 0 0 4px rgba(16,185,129,.12); }
    .auth-btn{
      width: 100%;
      border: 1px solid rgba(0,0,0,.10);
      border-radius: 12px;
      padding: 11px 12px;
      font-size: 15px;
      font-weight: 800;
      background: rgba(255,255,255,.95);
      margin-top: 10px;
      cursor: pointer;
    }
    .auth-btn.primary{
      border-color: rgba(16,185,129,.35);
      background: rgba(16,185,129,.12);
      color: #0b7a55;
    }
    .auth-btn:active{ transform: translateY(1px); }
    .auth-error{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(239,68,68,.25);
      background: rgba(239,68,68,.08);
      color: #b91c1c;
      font-weight: 800;
      font-size: 13px;
      line-height: 1.35;
    }
    .auth-footnote{
      margin-top: 12px;
      font-size: 12px;
      opacity: .6;
      line-height: 1.35;
    }



/* =========================
   设置弹窗（移动端/桌面通用）
   ========================= */
.sidebar-footer .settings-card{
  justify-content: center;
  font-weight: 700;
}
.sidebar-footer .settings-card .ico{ margin-right: 10px; }

.settings-section{
  border: 1px solid var(--border-color);
  border-radius: 12px;
  padding: 12px;
  margin-bottom: 12px;
  background: rgba(0,0,0,0.02);
}
.settings-section-title{
  font-weight: 800;
  margin-bottom: 10px;
}
.settings-actions{
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}
.settings-row{
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  margin-top: 10px;
}
.settings-row .form-select{ flex: 0 0 170px; max-width: 170px; }
.settings-label{
  font-weight: 700;
  color: #374151;
  line-height: 1.2;
  white-space: nowrap;
}
.about-line{
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 0 2px;
  font-weight: 700;
}

/* ===== Settings modal readability on desktop (avoid sidebar button styling) ===== */
#settingsModal .settings-actions .action-btn{
  border: 1px solid var(--border-color);
  background: #ffffff;
  color: var(--text-primary);
  margin-bottom: 0;
}
#settingsModal .settings-actions .action-btn:hover{
  background: #f3f4f6;
  border-color: #d1d5db;
}
#settingsModal .settings-actions .action-btn .ico{
  color: #374151;
}

/* ===== Token manager modal button readability (avoid sidebar styling) ===== */
#tokenManagerModal .settings-actions .action-btn{
  border: 1px solid var(--border-color);
  background: #ffffff;
  color: var(--text-primary);
  margin-bottom: 0;
}
#tokenManagerModal .settings-actions .action-btn:hover{
  background: #f3f4f6;
  border-color: #d1d5db;
}
#tokenManagerModal .settings-actions .action-btn .ico{
  color: #374151;
}


.switch{
  position: relative;
  display: inline-block;
  width: 46px;
  height: 26px;
  flex: 0 0 auto;
}
.switch input{
  opacity: 0;
  width: 0;
  height: 0;
}
.slider{
  position: absolute;
  cursor: pointer;
  inset: 0;
  background: #cfd8dc;
  transition: .2s;
  border-radius: 999px;
}
.slider:before{
  position: absolute;
  content: "";
  height: 22px;
  width: 22px;
  left: 2px;
  top: 2px;
  background: #fff;
  transition: .2s;
  border-radius: 999px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.18);
}
.switch input:checked + .slider{
  background: var(--accent-color);
  box-shadow: 0 0 0 3px rgba(16,163,127,0.18) inset;
}
.switch input:checked + .slider:before{
  transform: translateX(20px);
}

@media (max-width: 740px){
  .settings-actions .action-btn{ flex: 1 1 calc(50% - 10px); }
}

/* ---- Dialog modal (alert/confirm) ---- */
.modal-content-dialog { max-width: 560px; }
.dialog-body { white-space: pre-wrap; font-size: 14px; color: var(--text-primary); }
.btn.btn-danger { background: #dc2626; border-color: #dc2626; color: #fff; }
.btn.btn-danger:hover { filter: brightness(0.95); }


    /* ===== MyEMR Token Elements (interactive placeholders) ===== */
    .emr-token{
      display:inline-flex;
      align-items:center;
      gap:0;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(17,24,39,.18);
      background:rgba(17,24,39,.04);
      color:#111827;
      font-size:13px;
      line-height:1.4;
      user-select:none;
      cursor:pointer;
      white-space:nowrap;
      vertical-align:baseline;
    }
    .emr-token:hover{ background:rgba(17,24,39,.07); }
    /* 未填写：显示字段名作为占位；已填写：仅显示值 */
    .emr-token[data-emr-value=""]{
      color:#6b7280;
      border-style:dashed;
      background:rgba(16,163,127,.08);
    }
    .emr-token[data-emr-value=""]:hover{ background:rgba(16,163,127,.12); }
    .token-list{ display:flex; flex-direction:column; gap:10px; }
    .token-item{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px; border:1px solid rgba(17,24,39,.12);
      border-radius:12px; background:#fff;
    }
    .token-item .meta{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .token-item .meta .name{ font-weight:700; color:#111827; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .token-item .meta .sub{ font-size:12px; color:rgba(17,24,39,.65); }
    .token-item .ops{ display:flex; gap:8px; flex:0 0 auto; }
    .token-opt-grid{ display:grid; grid-template-columns:repeat(2, minmax(0, 1fr)); gap:10px; }
    .token-opt{
      padding:10px 10px; border:1px solid rgba(17,24,39,.14);
      border-radius:12px; background:#fff; cursor:pointer; text-align:center; user-select:none;
    }
    .token-opt:hover{ background:rgba(17,24,39,.04); }
    .token-opt.is-selected{
      background: rgba(16,163,127,.12);
      border-color: rgba(16,163,127,.45);
      color: var(--accent-color);
      font-weight: 600;
    }
    .token-cur{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      background: rgba(16,163,127,.12);
      color: var(--accent-color);
      border:1px solid rgba(16,163,127,.25);
      font-weight:600;
      vertical-align:baseline;
    }
    .token-add-row{ display:flex; gap:8px; align-items:center; }
    .token-add-row .form-input{ flex:1; min-width:0; }

    @media (max-width: 680px){
      .token-opt-grid{ grid-template-columns:1fr; }
    }


    /* Settings modal: keep header (close button) always visible */
    #settingsModal .modal-content{
      display:flex;
      flex-direction:column;
      overflow:hidden; /* prevent outer scroll; body scrolls */
    }
    
    #settingsModal .modal-title{ flex: 0 0 auto; }
    #settingsModal .modal-body{
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding-right: 6px;
      padding-bottom: 6px;
      overscroll-behavior: contain;
    }
#settingsModal .modal-title{
      position:sticky;
      top:0;
      z-index:2;
      background: var(--panel-bg);
      padding-bottom: 12px;
      margin-bottom: 12px;
      border-bottom: 1px solid rgba(0,0,0,0.08);
    }

    /* Token Value Picker: fixed header/footer with scrollable body (consistent with Settings) */
    #tokenValueModal .modal-content{
      display:flex;
      flex-direction:column;
      overflow:hidden; /* prevent outer scroll; body scrolls */
    }
    #tokenValueModal .modal-title{
      position:sticky;
      top:0;
      z-index:2;
      background: var(--panel-bg);
      padding-bottom: 12px;
      margin-bottom: 12px;
      border-bottom: 1px solid rgba(0,0,0,0.08);
    }
    #tokenValueModal .modal-body{
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding-right: 6px;
      padding-bottom: 6px;
      overscroll-behavior: contain;
    }
    #tokenValueModal .modal-footer{
      flex: 0 0 auto;
      background: linear-gradient(to top, rgba(255,255,255,0.98), rgba(255,255,255,0.90));
      padding-top: 12px;
      margin-top: 12px;
      border-top: 1px solid rgba(0,0,0,0.08);
    }
    #settingsModal .modal-close{ white-space: nowrap; }


/* Mobile: prevent scroll chaining when drawer is open */
@media (max-width: 680px) {
  .sidebar .category-tree { overscroll-behavior: contain; -webkit-overflow-scrolling: touch; }
  #sidebarBackdrop.show { overscroll-behavior: none; }
}

</style>
</head>

<body>

  <!-- Password Protection -->
  <div class="auth-overlay" id="authOverlay" style="display:none" role="dialog" aria-modal="true" aria-label="MyEMR 登录">
    <div class="auth-card" onclick="event.stopPropagation()">
      <div class="auth-head">
        <div class="auth-brand">MyEMR</div>
        <div class="auth-ver">V6.2</div>
      </div>

      <div class="auth-section" id="authLoginSection" style="display:none">
        <div class="auth-title">登录</div>
        <div class="auth-hint">请输入密码以继续使用。</div>
        <input class="auth-input" id="authLoginPwd" type="password" placeholder="输入密码" autocomplete="current-password"
               autocorrect="off" autocapitalize="none" spellcheck="false" enterkeyhint="go" />
        <div class="auth-error" id="authLoginErr" style="display:none"></div>
        <button class="auth-btn primary" id="authLoginBtn">登录</button>
        <button class="auth-btn" id="authToSetupBtn" style="display:none">设置密码</button>
      </div>

      <div class="auth-section" id="authSetupSection" style="display:none">
        <div class="auth-title">设置密码</div>
        <div class="auth-hint">首次使用请设置一个登录密码（仅保存在本机浏览器）。</div>
        <input class="auth-input" id="authNewPwd" type="password" placeholder="新密码（至少 4 位）" autocomplete="new-password"
               autocorrect="off" autocapitalize="none" spellcheck="false" enterkeyhint="next" />
        <input class="auth-input" id="authNewPwd2" type="password" placeholder="再次输入新密码" autocomplete="new-password"
               autocorrect="off" autocapitalize="none" spellcheck="false" enterkeyhint="go" />
        <div class="auth-error" id="authSetupErr" style="display:none"></div>
        <button class="auth-btn primary" id="authSetupBtn">保存并进入</button>
        <button class="auth-btn" id="authToLoginBtn">返回登录</button>
      </div>

      <div class="auth-section" id="authChangeSection" style="display:none">
        <div class="auth-title">修改密码</div>
        <div class="auth-hint">请输入旧密码并设置新密码。</div>
        <input class="auth-input" id="authOldPwd" type="password" placeholder="旧密码" autocomplete="current-password"
               autocorrect="off" autocapitalize="none" spellcheck="false" enterkeyhint="next" />
        <input class="auth-input" id="authChgPwd" type="password" placeholder="新密码（至少 4 位）" autocomplete="new-password"
               autocorrect="off" autocapitalize="none" spellcheck="false" enterkeyhint="next" />
        <input class="auth-input" id="authChgPwd2" type="password" placeholder="再次输入新密码" autocomplete="new-password"
               autocorrect="off" autocapitalize="none" spellcheck="false" enterkeyhint="go" />
        <div class="auth-error" id="authChgErr" style="display:none"></div>
        <button class="auth-btn primary" id="authChgBtn">确认修改</button>
        <button class="auth-btn" id="authChgCancelBtn">取消</button>
      </div>

      <div class="auth-footnote">
        提示：忘记密码可在浏览器中清除本网站数据后重新设置。
      </div>
    </div>
  </div>

  <div id="appShell" style="display:none">


  <div class="sidebar">
    <div class="sidebar-header">
      <button class="action-btn btn-green" onclick="openTemplateModal()">
        <span class="ico" id="icoPlus"></span>
        <span>新建模板</span>
      </button>

      <button class="action-btn" onclick="openCategoryManager()">
        <span class="ico" id="icoManage"></span>
        <span>管理分类与排序</span>
      </button>
    </div>

    <div class="sidebar-section-title">目录导航</div>
    <div class="category-tree" id="sidebarTree"></div>

    
  <div class="sidebar-footer">
    <button class="action-btn settings-card" onclick="openSettings()">
      <span class="ico" id="icoSettings"></span>
      <span>设置</span>
    </button>
  </div>
</div>

<input type="file" id="fileInput" style="display:none" onchange="importData(this)" accept=".json" />

<div class="sidebar-backdrop" id="sidebarBackdrop" onclick="closeSidebar()"></div>

  <div class="main-content">
    <div class="top-bar">
      <button class="icon-btn sidebar-toggle" type="button" onclick="toggleSidebar()" title="打开目录" aria-label="打开目录">
        <span class="ico" id="icoMenu"></span>
      </button>
      <div class="current-filter" id="currentFilterLabel">全部模板</div>
      <input type="text" class="search-box" id="searchInput" placeholder="搜索内容、标题、关键词或分类..." oninput="renderTemplates()" />
    </div>

    <div class="content-area">
      <div class="content-container" id="templateList"></div>
    </div>
  </div>

  <!-- 模板编辑/新建 -->
  <div class="modal" id="templateModal" onclick="noopClose(event)">
    <div class="modal-content modal-content-editor" onclick="event.stopPropagation()">
      <div class="modal-title">
        <span id="modalTitleText">编辑模板</span>
        <span class="modal-close" onclick="requestCloseModal('templateModal')">
          <span class="ico" id="icoClose1"></span>
          <span>关闭</span>
        </span>
      </div>

      <div class="modal-body">

      <input type="hidden" id="editId" />

      <div class="form-row">
        <div class="form-col">
          <label class="form-label">一级分类</label>
          <select class="form-select" id="inputMainCat" onchange="updateSubCatOptions()"></select>
        </div>
        <div class="form-col">
          <label class="form-label">二级分类</label>
          <select class="form-select" id="inputSubCat"></select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-col">
          <label class="form-label">标题 / 关键词</label>
          <input type="text" class="form-input" id="inputTitle" placeholder="例如：高血压-病例特点汇总" />
        </div>
      </div>

      <!-- 标签：输入新增 + 下方点击选择（多选） -->
      <div class="form-row">
        <div class="form-col">
          <label class="form-label">其他标签（常用优先；点击可多选；也可新增）</label>

          <div class="tag-picker">
            <div class="tag-add-row">
              <input type="text" class="form-input" id="newTagInput" placeholder="输入新标签（回车或点添加）" />
              <button class="btn btn-primary btn-sm" id="btnAddTag" type="button" onclick="addNewTagFromInput()" disabled>
                <span class="ico" id="icoPlusTag"></span>
                <span>添加</span>
              </button>
            </div>

            <div class="hint">
              标签池默认仅显示两行；常用标签排在前面；可“展开/收起”。保存后仍以“逗号分隔”存储，兼容已有数据。
            </div>

            <div class="tag-selected-row" id="selectedTagsRow"></div>

            <div class="tag-pool-wrap">
              <div class="tag-pool collapsed" id="tagPool"></div>
              <div class="tag-pool-toggle" id="tagPoolToggle" onclick="toggleTagPool()">
                <span class="ico" id="icoChevron"></span>
                <span id="tagPoolToggleText">展开标签池</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 富文本编辑器 -->
      <div class="form-col">
        <label class="form-label">模板内容（富文本）</label>
        <div class="rte-toolbar">
          <button class="rte-btn" type="button" onclick="rteCmd('bold')"><b>B</b></button>
          <button class="rte-btn" type="button" onclick="rteCmd('italic')"><i>I</i></button>
          <button class="rte-btn" type="button" onclick="rteCmd('underline')"><u>U</u></button>
          <span class="rte-divider"></span>
          <button class="rte-btn" type="button" onclick="rteCmd('insertUnorderedList')">• 列表</button>
          <button class="rte-btn" type="button" onclick="rteCmd('insertOrderedList')">1. 列表</button>
          <span class="rte-divider"></span>
          <button class="rte-btn" type="button" onclick="rteColor('#ef4444')">红色</button>
          <button class="rte-btn" type="button" onclick="rteColor('#111827')">黑色</button>
          <span class="rte-divider"></span>
          <span class="rte-divider"></span>
          <button class="rte-btn" type="button" onclick="openTokenInsert()">插入字段</button>
          <button class="rte-btn" type="button" onclick="rteCmd('removeFormat')">清除格式</button>
          <button class="rte-btn" type="button" onclick="rteCmd('undo')">撤销</button>
          <button class="rte-btn" type="button" onclick="rteCmd('redo')">重做</button>
        </div>
        <div class="rte-editor" id="inputContentEditor" contenteditable="true"></div>
        <div class="hint">复制按钮默认复制“纯文本”版本，便于粘贴到病历系统。</div>
      </div>

      </div>

      <div class="modal-footer">
        <button class="btn btn-danger" id="btnDelete" onclick="deleteTemplate()" style="display:none; margin-right:auto">
          <span class="ico" id="icoTrash"></span> 删除
        </button>
        <button class="btn btn-secondary" onclick="requestCloseModal('templateModal')">
          <span class="ico" id="icoX"></span> 取消
        </button>
        <button class="btn btn-primary" onclick="saveTemplate()">
          <span class="ico" id="icoSave"></span> 保存
        </button>
      </div>
    </div>
  </div>

  <!-- 移动模板 -->
  <div class="modal" id="moveModal" onclick="noopClose(event)">
    <div class="modal-content" style="width:560px;" onclick="event.stopPropagation()">
      <div class="modal-title">
        <span>移动模板到其他分类</span>
        <span class="modal-close" onclick="requestCloseModal('moveModal')">
          <span class="ico" id="icoClose2"></span>
          <span>关闭</span>
        </span>
      </div>
      <input type="hidden" id="moveId" />

      <div class="form-row">
        <div class="form-col">
          <label class="form-label">目标一级分类</label>
          <select class="form-select" id="moveMainCat" onchange="updateMoveSubCatOptions()"></select>
        </div>
        <div class="form-col">
          <label class="form-label">目标二级分类</label>
          <select class="form-select" id="moveSubCat"></select>
        </div>
      </div>

      <div class="hint">仅移动分类归属，不改动标题、内容与标签。</div>

      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="requestCloseModal('moveModal')">
          <span class="ico" id="icoX2"></span> 取消
        </button>
        <button class="btn btn-primary" onclick="confirmMoveTemplate()">
          <span class="ico" id="icoMove"></span> 确认移动
        </button>
      </div>
    </div>
  </div>

  <!-- 分类管理 -->
  <div class="modal" id="categoryModal" onclick="noopClose(event)">
    <div class="modal-content" style="width: 860px;" onclick="event.stopPropagation()">
      <div class="modal-title">
        <span>管理分类与排序（支持重命名 / 选图标 / 二级分类图标）</span>
        <span class="modal-close" onclick="requestCloseModal('categoryModal')">
          <span class="ico" id="icoClose3"></span>
          <span>关闭</span>
        </span>
      </div>

      <div class="hint" style="margin-top:-4px; margin-bottom:10px;">
        说明：一级分类图标全局不重复；二级分类图标全局也不重复。点击“调色盘”按钮可重新选择图标。
      </div>

      <div class="manage-layout">
        <div class="manage-col">
          <div class="manage-header">一级分类（点击选中）</div>
          <div class="manage-list" id="manageMainList"></div>

          <div class="manage-input-row">
            <div class="new-icon-preview" id="newMainIconPreview"></div>
            <button class="icon-btn iconpick" type="button" onclick="openIconPickerForNewMain()">
              <span class="ico" id="icoPalette1"></span> 图标
            </button>
            <input type="text" id="newMainCatName" class="form-input" placeholder="新一级分类名" style="flex:1; min-width:180px;" />
            <button class="btn btn-primary btn-sm" onclick="addMainCategory()">
              <span class="ico" id="icoPlus3"></span> 添加
            </button>
          </div>
        </div>

        <div class="manage-col">
          <div class="manage-header">二级分类（<span id="selectedMainCatName" style="color:var(--accent-color)">未选择</span>）</div>
          <div class="manage-list" id="manageSubList">
            <div style="padding:10px; color:#9ca3af; text-align:center">请先在左侧选择一级分类</div>
          </div>

          <div class="manage-input-row">
            <div class="new-icon-preview" id="newSubIconPreview"></div>
            <button class="icon-btn iconpick" type="button" id="btnPickNewSubIcon" onclick="openIconPickerForNewSub()" disabled>
              <span class="ico" id="icoPalette2"></span> 图标
            </button>
            <input type="text" id="newSubCatName" class="form-input" placeholder="新二级分类名" style="flex:1; min-width:180px;" disabled />
            <button class="btn btn-primary btn-sm" id="btnAddSub" onclick="addSubCategory()" disabled>
              <span class="ico" id="icoPlus4"></span> 添加
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 图标选择器 -->
  <div class="modal" id="iconPickerModal" onclick="noopClose(event)">
    <div class="modal-content modal-content-iconpicker" style="width: 920px;" onclick="event.stopPropagation()">
      <div class="modal-title">
        <span id="iconPickerTitle">选择图标</span>
        <span class="modal-close" onclick="closeModalDirect('iconPickerModal')" title="关闭" aria-label="关闭">
          <span class="ico" id="icoClose4"></span>
          <span>关闭</span>
        </span>
      </div>

      <div class="icon-picker-body">
        <div class="hint" id="iconPickerHint">点击图标即可应用。</div>

        <div class="form-row" style="margin-top:10px;">
          <div class="form-col">
            <label class="form-label">搜索图标（按名称/描述）</label>
            <input type="text" class="form-input" id="iconSearchInput" placeholder="例如：手术、药物、影像、风险..." autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" inputmode="search" enterkeyhint="search" oninput="renderIconPickerGrid()" />
          </div>
        </div>

        <div class="icon-grid" id="iconGrid"></div>
      </div>
    </div>
  </div>

  
<!-- 设置 -->
<div class="modal" id="settingsModal" onclick="noopClose(event)">
  <div class="modal-content" style="width: 560px;" onclick="event.stopPropagation()">
    <div class="modal-title">
      <span>设置</span>
      <span class="modal-close" onclick="requestCloseModal('settingsModal')">
        <span class="ico" id="icoCloseSettings"></span>
        <span>关闭</span>
      </span>
    </div>

    <div class="modal-body">
      <div class="settings-section">
        <div class="settings-section-title">安全</div>
        <div class="settings-actions">
          <button class="action-btn" type="button" onclick="openChangePassword(); requestCloseModal('settingsModal');">
            <span class="ico" id="icoSetKey"></span>
            <span>修改密码</span>
          </button>
          <button class="action-btn" type="button" onclick="lockApp(); requestCloseModal('settingsModal');">
            <span class="ico" id="icoSetLock"></span>
            <span>锁定</span>
          </button>
        </div>

        <div class="settings-row">
          <div class="settings-label">无操作自动锁定</div>
          <select class="form-select" id="setAutoLockMinutes" onchange="updateSettingsFromUI()">
            <option value="0">关闭</option>
            <option value="1">1 分钟</option>
            <option value="2">2 分钟</option>
            <option value="5">5 分钟</option>
            <option value="10">10 分钟</option>
            <option value="15">15 分钟</option>
            <option value="30">30 分钟</option>
          </select>
        </div>

        <div class="settings-row">
          <div class="settings-label">离开当前网页即锁定</div>
          <label class="switch" title="切到桌面/切后台/切到其他标签页将立即锁定">
            <input type="checkbox" id="setLockOnLeave" onchange="updateSettingsFromUI()">
            <span class="slider"></span>
          </label>
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-section-title">数据</div>
        <div class="settings-actions">
          <button class="action-btn" type="button" onclick="exportData()">
            <span class="ico" id="icoSetExport"></span>
            <span>备份导出</span>
          </button>
          <button class="action-btn" type="button" onclick="triggerImportFromSettings()">
            <span class="ico" id="icoSetImport"></span>
            <span>恢复导入</span>
          </button>
          <button class="action-btn" type="button" onclick="importPresetFromSettings()">
            <span class="ico" id="icoSetPreset"></span>
            <span>导入预设</span>
          </button>
        </div>
        <div class="hint" style="margin-top:8px;">导入时可选择“增加”或“覆盖”。</div>
      </div>

      <div class="settings-section">
              <div class="settings-section">
        <div class="settings-section-title">字段元素</div>
        <div class="settings-actions">
          <button class="action-btn" type="button" onclick="openTokenManager();">
            <span class="ico" id="icoSetToken"></span>
            <span>管理字段元素</span>
          </button>
        </div>
        <div class="hint" style="margin-top:8px;">用于在模板内容中插入可点击填写的字段（如下拉选择“发病部位”等）。</div>
      </div>

<div class="settings-section-title">关于</div>
        <div class="about-line">
          <span class="ico" id="icoSetInfo"></span>
          <span id="aboutVersion">MyEMR V6.2</span>
        </div>
      </div>

    </div>
  </div>
</div>

  <!-- 通用弹窗提醒/确认 -->
  <div class="modal" id="dialogModal" onclick="noopClose(event)" style="display:none;">
    <div class="modal-content modal-content-dialog" onclick="event.stopPropagation()">
      <div class="modal-title">
        <span id="dialogTitle">提示</span>
        <span class="modal-close" onclick="closeDialogModal()">
          <span class="ico" id="icoCloseDialog"></span>
          <span>关闭</span>
        </span>
      </div>
      <div class="modal-body">
        <div id="dialogBody" class="dialog-body"></div>
      </div>
      <div class="modal-footer" id="dialogFooter">
        <button class="btn btn-secondary" id="dialogCancelBtn" onclick="dialogModalCancel()">取消</button>
        <button class="btn btn-primary" id="dialogOkBtn" onclick="dialogModalOk()">确定</button>
      </div>
    </div>
  </div>

  <!-- 三选项确认弹窗 -->
  <div class="confirm3-modal" id="confirm3Modal" onclick="closeConfirm3('cancel')">
    <div class="confirm3-box" onclick="event.stopPropagation()">
      <div class="confirm3-header">
        <span id="confirm3Title">未保存的修改</span>
        <span class="confirm3-x" onclick="closeConfirm3('cancel')" title="关闭" aria-label="关闭"><span class="ico" id="icoConfirmClose"></span><span>关闭</span></span>
      </div>
      <div class="confirm3-body" id="confirm3Body">你有未保存的修改。</div>
      <div class="confirm3-footer">
        <button class="btn btn-secondary" id="confirm3BtnContinue" type="button" onclick="closeConfirm3('continue')">继续编辑</button>
        <button class="btn btn-danger" id="confirm3BtnDiscard" type="button" onclick="closeConfirm3('discard')">不保存关闭</button>
        <button class="btn btn-primary" id="confirm3BtnSave" type="button" onclick="closeConfirm3('save')">保存并关闭</button>
      </div>
    </div>
  </div>

<script>
/* =========================
   1) 图标库（扩展版）
   ========================= */
const ICONS = (() => {
  const s = (paths) => `<svg viewBox="0 0 24 24" aria-hidden="true">${paths}</svg>`;
  const P = {
    plus: s(`<path d="M12 5v14"/><path d="M5 12h14"/>`),
    plusCircle: s(`<circle cx="12" cy="12" r="9"/><path d="M12 8v8"/><path d="M8 12h8"/>`),
    x: s(`<path d="M6 6l12 12"/><path d="M18 6l-12 12"/>`),
    check: s(`<path d="M20 6L9 17l-5-5"/>`),
    chevronDown: s(`<path d="M6 9l6 6 6-6"/>`),
    chevronUp: s(`<path d="M6 15l6-6 6 6"/>`),
    chevronRight: s(`<path d="M9 6l6 6-6 6"/>`),
    menu: s(`<path d="M4 7h16"/><path d="M4 12h16"/><path d="M4 17h16"/>`),
    more: s(`<path d="M6 12h.01"/><path d="M12 12h.01"/><path d="M18 12h.01"/>`),

    folder: s(`<path d="M3 7h6l2 2h10v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7z"/>`),
    folderOpen: s(`<path d="M3 7h6l2 2h10"/><path d="M4 20l2-9h16l-2 9H4z"/>`),

    clipboard: s(`<path d="M9 4h6"/><path d="M10 4a2 2 0 0 0-2 2v2h8V6a2 2 0 0 0-2-2"/><path d="M6 8h12v13H6z"/>`),
    file: s(`<path d="M14 3H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V8z"/><path d="M14 3v5h5"/>`),
    tag: s(`<path d="M20 10l-8 8-9-9V4h5l12 6z"/><path d="M7.5 7.5h.01"/>`),
    bookmark: s(`<path d="M7 3h10v18l-5-3-5 3z"/>`),

    settings: s(`<path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/><path d="M19.4 15a7.8 7.8 0 0 0 .1-2l2-1.2-2-3.4-2.3.6a7.4 7.4 0 0 0-1.7-1l-.3-2.4H10l-.3 2.4a7.4 7.4 0 0 0-1.7 1l-2.3-.6-2 3.4L5.7 13a7.8 7.8 0 0 0 .1 2l-2 1.2 2 3.4 2.3-.6a7.4 7.4 0 0 0 1.7 1l.3 2.4h4.8l.3-2.4a7.4 7.4 0 0 0 1.7-1l2.3.6 2-3.4-2-1.2z"/>`),
    sort: s(`<path d="M10 6H4"/><path d="M20 6h-6"/><path d="M14 18H4"/><path d="M20 18h-2"/><path d="M8 12H4"/><path d="M20 12H12"/>`),
    upload: s(`<path d="M12 3v12"/><path d="M7 8l5-5 5 5"/><path d="M5 21h14"/>`),
    download: s(`<path d="M12 3v12"/><path d="M7 10l5 5 5-5"/><path d="M5 21h14"/>`),
    receipt: s(`<path d="M6 2h12v20l-2-1-2 1-2-1-2 1-2-1-2 1V2z"/><path d="M9 7h6"/><path d="M9 11h6"/><path d="M9 15h4"/>`),
    restore: s(`<path d="M3 12a9 9 0 1 0 3-6.7"/><path d="M3 3v6h6"/>`),

    /* 医疗/病历常用：扩展 */
    stethoscope: s(`<path d="M6 3v4a4 4 0 0 0 8 0V3"/><path d="M10 11v3a4 4 0 0 0 8 0v-1"/><circle cx="18" cy="13" r="2"/>`),
    heart: s(`<path d="M12 21s-7-4.4-9-8.8C1.5 8 4 5.5 7 6c1.5.2 2.7 1.2 3 2 0.3-.8 1.5-1.8 3-2 3-.5 5.5 2 4 6.2C19 16.6 12 21 12 21z"/>`),
    lungs: s(`<path d="M12 3v8"/><path d="M12 11c-2 0-4-3-6-3-2 0-3 2-3 4v6"/><path d="M12 11c2 0 4-3 6-3 2 0 3 2 3 4v6"/><path d="M12 21v-6"/>`),
    brain: s(`<path d="M8 4a3 3 0 0 0-3 3v2a3 3 0 0 0 3 3"/><path d="M16 4a3 3 0 0 1 3 3v2a3 3 0 0 1-3 3"/><path d="M8 4h8"/><path d="M9 14v6"/><path d="M15 14v6"/>`),
    bone: s(`<path d="M6 8a2 2 0 1 1 2-2l8 8a2 2 0 1 1-2 2l-8-8z"/><path d="M16 6a2 2 0 1 1 2 2"/><path d="M8 16a2 2 0 1 1-2 2"/>`),
    tooth: s(`<path d="M8 3c-2 1-3 3-3 6 0 4 2 6 3 10 0 1 1 2 2 2 2 0 1-4 2-6 1 2 0 6 2 6 1 0 2-1 2-2 1-4 3-6 3-10 0-3-1-5-3-6-2-1-4-1-5 0z"/>`),
    syringe: s(`<path d="M5 15l10-10"/><path d="M7 17l10-10"/><path d="M14 4l6 6"/><path d="M3 21l4-4"/><path d="M11 6l6 6"/>`),
    pill: s(`<path d="M10 14l7-7a4 4 0 0 0-6-6l-7 7a4 4 0 0 0 6 6z"/><path d="M8 8l8 8"/>`),
    infusion: s(`<path d="M12 2v6"/><path d="M9 8h6"/><path d="M8 22h8"/><path d="M12 8v14"/><path d="M16 12h4"/><path d="M4 12h4"/>`),
    bandage: s(`<path d="M4 10l10-6 6 10-10 6z"/><path d="M7 12h.01"/><path d="M10 10h.01"/><path d="M13 8h.01"/><path d="M16 6h.01"/>`),

    scalpel: s(`<path d="M4 20l6-6"/><path d="M6 18l-2 2"/><path d="M10 14L20 4"/><path d="M14 10l4 4"/>`),
    anesthesia: s(`<path d="M4 7h16"/><path d="M6 7v10"/><path d="M18 7v10"/><path d="M8 17h8"/><path d="M10 12h4"/>`),
    periop: s(`<path d="M12 2v4"/><path d="M12 18v4"/><path d="M4 12H2"/><path d="M22 12h-2"/><path d="M5 5l2 2"/><path d="M19 19l-2-2"/><path d="M19 5l-2 2"/><path d="M5 19l2-2"/><circle cx="12" cy="12" r="4"/>`),

    lab: s(`<path d="M10 2v4l-4 8a6 6 0 0 0 5 8h2a6 6 0 0 0 5-8l-4-8V2"/><path d="M8 10h8"/>`),
    microscope: s(`<path d="M6 20h10"/><path d="M8 20a4 4 0 0 1 8 0"/><path d="M10 14l3-3"/><path d="M12 6l2 2"/><path d="M14 8l-3 3"/><path d="M7 9l3 3"/><path d="M6 9h4"/>`),
    dna: s(`<path d="M7 4c4 4 6 12 10 16"/><path d="M17 4c-4 4-6 12-10 16"/><path d="M9 7h6"/><path d="M9 17h6"/>`),

    imaging: s(`<rect x="4" y="6" width="16" height="12" rx="2"/><path d="M8 10h8"/><path d="M8 14h6"/>`),
    ct: s(`<circle cx="12" cy="12" r="8"/><path d="M12 4v8l6 6"/>`),
    mri: s(`<rect x="4" y="5" width="16" height="14" rx="2"/><path d="M8 9h8"/><path d="M8 13h8"/><path d="M8 17h5"/>`),
    ultrasound: s(`<path d="M4 7h8v10H4z"/><path d="M12 9h3a3 3 0 0 1 3 3v2a3 3 0 0 1-3 3h-3"/><path d="M6 10h4"/><path d="M6 13h4"/>`),

    shield: s(`<path d="M12 2l8 4v6c0 5-3.5 9-8 10-4.5-1-8-5-8-10V6l8-4z"/>`),
    alert: s(`<path d="M12 9v4"/><path d="M12 17h.01"/><path d="M10.3 3h3.4L21 19H3L10.3 3z"/>`),
    info: s(`<circle cx="12" cy="12" r="9"/><path d="M12 10v6"/><path d="M12 7h.01"/>`),

    consult: s(`<path d="M4 5h16v10H7l-3 3V5z"/><path d="M8 9h8"/><path d="M8 12h5"/>`),
    note: s(`<path d="M4 4h12l4 4v12a2 2 0 0 1-2 2H4z"/><path d="M16 4v4h4"/><path d="M7 12h10"/><path d="M7 16h8"/>`),
    consent: s(`<path d="M7 3h10v18H7z"/><path d="M9 7h6"/><path d="M9 11h6"/><path d="M9 15h4"/><path d="M14 15l1 1 2-2"/>`),
    notice: s(`<path d="M5 4h14v16H5z"/><path d="M8 8h8"/><path d="M8 12h8"/><path d="M8 16h5"/>`),

    discharge: s(`<path d="M14 3H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V8z"/><path d="M14 3v5h5"/><path d="M9 13h6"/><path d="M12 10v6"/>`),
    transfer: s(`<path d="M7 7h10"/><path d="M17 7l-2-2"/><path d="M17 7l-2 2"/><path d="M17 17H7"/><path d="M7 17l2-2"/><path d="M7 17l2 2"/>`),
    followup: s(`<path d="M6 7h12"/><path d="M6 11h8"/><path d="M6 15h10"/><path d="M17 11l2 2-2 2"/>`),

    calendar: s(`<rect x="3" y="5" width="18" height="16" rx="2"/><path d="M8 3v4"/><path d="M16 3v4"/><path d="M3 9h18"/>`),
    phone: s(`<path d="M7 2h10v20H7z"/><path d="M11 18h2"/>`),
    message: s(`<path d="M4 5h16v10H7l-3 3V5z"/>`),

    move: s(`<path d="M15 6l4 4-4 4"/><path d="M19 10H10a6 6 0 0 0 0 12h1"/>`),
    save: s(`<path d="M5 4h14l1 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4z"/><path d="M8 4v6h8V4"/><path d="M8 20v-6h8v6"/>`),
    trash: s(`<path d="M4 7h16"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M6 7l1-3h10l1 3"/><path d="M7 7v14h10V7"/>`),
    palette: s(`<path d="M12 3a9 9 0 0 0 0 18h2a2 2 0 0 0 0-4h-1a2 2 0 0 1 0-4h1a4 4 0 0 0 0-8h-2z"/><path d="M7.5 10.5h.01"/><path d="M9.5 7.5h.01"/><path d="M12.5 6.5h.01"/><path d="M15.5 7.5h.01"/>`),


    /* 常用 UI：新增 */
    user: s(`<circle cx="12" cy="8" r="4"/><path d="M4 21c1.6-4.6 6.2-7 8-7s6.4 2.4 8 7"/>`),
    users: s(`<circle cx="9" cy="8" r="3"/><circle cx="16" cy="9" r="3"/><path d="M3.5 21c1.2-3.8 4.8-6 7.5-6"/><path d="M13 15c2.8 0 6 2.2 7.5 6"/>`),
    search: s(`<circle cx="11" cy="11" r="7"/><path d="M21 21l-4.3-4.3"/>`),
    pen: s(`<path d="M12 20h9"/><path d="M16.5 3.5l4 4L7 21H3v-4L16.5 3.5z"/><path d="M15 5l4 4"/>`),
    copy: s(`<rect x="9" y="9" width="10" height="10" rx="2"/><rect x="5" y="5" width="10" height="10" rx="2"/>`),
    star: s(`<path d="M12 2l3 7 7 .6-5.3 4.6L18.6 22 12 18.2 5.4 22l1.9-7.2L2 9.6 9 9l3-7z"/>`),
    clock: s(`<circle cx="12" cy="12" r="9"/><path d="M12 7v6l4 2"/>`),
    eye: s(`<path d="M2 12s4-7 10-7 10 7 10 7-4 7-10 7S2 12 2 12z"/><circle cx="12" cy="12" r="3"/>`),
    lock: s(`<rect x="6" y="11" width="12" height="10" rx="2"/><path d="M8 11V8a4 4 0 0 1 8 0v3"/>`),
    unlock: s(`<rect x="6" y="11" width="12" height="10" rx="2"/><path d="M10 11V8a4 4 0 0 1 7-2"/>`),
    home: s(`<path d="M3 11l9-8 9 8"/><path d="M5 10v11h14V10"/><path d="M10 21v-6h4v6"/>`),
    hospital: s(`<path d="M5 22V6a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16"/><path d="M9 10h6"/><path d="M12 7v6"/><path d="M7 22v-6h10v6"/>`),
    ambulance: s(`<path d="M3 16V8h10v8"/><path d="M13 12h5l3 3v1"/><path d="M5 16a2 2 0 1 0 4 0"/><path d="M15 16a2 2 0 1 0 4 0"/><path d="M16 10h2"/><path d="M9 10h.01"/><path d="M7 11h4"/><path d="M9 9v4"/>`),
    bed: s(`<path d="M4 12V7a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v5"/><path d="M4 12h16v6"/><path d="M4 18v3"/><path d="M20 18v3"/><path d="M16 12V9h4a2 2 0 0 1 2 2v1"/>`),
    droplet: s(`<path d="M12 2s7 8 7 13a7 7 0 0 1-14 0c0-5 7-13 7-13z"/>`),
    thermometer: s(`<path d="M14 14.5a3.5 3.5 0 1 1-4 0V5a2 2 0 0 1 4 0v9.5z"/><path d="M12 6v8"/>`),
    location: s(`<path d="M12 22s7-6.2 7-12a7 7 0 0 0-14 0c0 5.8 7 12 7 12z"/><circle cx="12" cy="10" r="2.5"/>`),
    link: s(`<path d="M10 13a5 5 0 0 1 0-7l1-1a5 5 0 0 1 7 7l-1 1"/><path d="M14 11a5 5 0 0 1 0 7l-1 1a5 5 0 0 1-7-7l1-1"/>`),
    printer: s(`<path d="M7 8V3h10v5"/><rect x="6" y="14" width="12" height="8" rx="2"/><path d="M6 12H5a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v1a2 2 0 0 1-2 2h-1"/><path d="M8 18h8"/>`),
    image: s(`<rect x="4" y="5" width="16" height="14" rx="2"/><circle cx="9" cy="10" r="1.5"/><path d="M20 16l-6-6-6 7"/>`),
    share: s(`<path d="M4 12v7a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-7"/><path d="M16 6l-4-4-4 4"/><path d="M12 2v13"/>`),


    /* 更丰富的二级分类语义图标（用于全局去重与更精细匹配） */
    activity: s(`<path d="M22 12h-4l-3 9-6-18-3 9H2"/>`),
    gauge: s(`<circle cx="12" cy="12" r="9"/><path d="M12 12l4-2"/><path d="M6.5 15.5a7 7 0 0 1 11 0"/>`),
    clipboardCheck: s(`<path d="M9 4h6"/><path d="M10 4a2 2 0 0 0-2 2v2h8V6a2 2 0 0 0-2-2"/><path d="M6 8h12v13H6z"/><path d="M9 14l2 2 4-4"/>`),
    clipboardList: s(`<path d="M9 4h6"/><path d="M10 4a2 2 0 0 0-2 2v2h8V6a2 2 0 0 0-2-2"/><path d="M6 8h12v13H6z"/><path d="M9 12h6"/><path d="M9 16h6"/>`),
    list: s(`<path d="M8 6h13"/><path d="M8 12h13"/><path d="M8 18h13"/><path d="M3 6h.01"/><path d="M3 12h.01"/><path d="M3 18h.01"/>`),
    listCheck: s(`<path d="M8 6h13"/><path d="M8 12h13"/><path d="M8 18h13"/><path d="M3 6l1 1 2-2"/><path d="M3 12l1 1 2-2"/><path d="M3 18l1 1 2-2"/>`),
    filter: s(`<path d="M4 5h16"/><path d="M7 12l5 6 5-6"/><path d="M9 12V5"/><path d="M15 12V5"/>`),
    route: s(`<path d="M4 7h6a3 3 0 0 1 3 3v7"/><path d="M20 17h-6a3 3 0 0 1-3-3V7"/><path d="M4 7l2-2"/><path d="M4 7l2 2"/><path d="M20 17l-2-2"/><path d="M20 17l-2 2"/>`),
    ear: s(`<path d="M10 5a4 4 0 0 1 6 3c0 2-1 3-2 4"/><path d="M8 11c0-3 1-6 5-6"/><path d="M8 11v5a3 3 0 0 0 6 0"/><path d="M10 16a1.5 1.5 0 0 0 3 0"/>`),
    venus: s(`<circle cx="12" cy="8" r="4"/><path d="M12 12v6"/><path d="M10 16h4"/>`),
    utensils: s(`<path d="M7 3v8"/><path d="M5 3v8"/><path d="M9 3v8"/><path d="M7 11v10"/><path d="M15 3v18"/><path d="M18 3v6a3 3 0 0 1-3 3h0"/>`),
    nurse: s(`<path d="M12 3c3 0 5 2 5 5v2"/><path d="M7 10V8c0-3 2-5 5-5"/><path d="M6 21v-4a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v4"/><path d="M12 12v4"/><path d="M10 14h4"/>`),
    handover: s(`<path d="M7 7h10"/><path d="M17 7l-2-2"/><path d="M17 7l-2 2"/><path d="M17 17H7"/><path d="M7 17l2-2"/><path d="M7 17l2 2"/>`),
    rounds: s(`<circle cx="8" cy="8" r="3"/><circle cx="16" cy="8" r="3"/><path d="M3 21c1.2-4 4-6 5-6"/><path d="M21 21c-1.2-4-4-6-5-6"/><path d="M9 14c1 .2 2 .5 3 .5s2-.3 3-.5"/>`),
    report: s(`<path d="M6 2h9l3 3v17H6z"/><path d="M15 2v3h3"/><path d="M9 10h6"/><path d="M9 14h6"/><path d="M9 18h4"/>`),
    barChart: s(`<path d="M4 20V10"/><path d="M10 20V4"/><path d="M16 20v-8"/><path d="M22 20H2"/>`),
    pieChart: s(`<path d="M12 2v10h10"/><path d="M12 12a10 10 0 1 1 0-10"/><path d="M12 12l7 7"/>`),
    fileText: s(`<path d="M14 3H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V8z"/><path d="M14 3v5h5"/><path d="M8 13h8"/><path d="M8 17h6"/>`),
    fileCheck: s(`<path d="M14 3H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V8z"/><path d="M14 3v5h5"/><path d="M9 14l2 2 4-4"/>`),
    fileSearch: s(`<path d="M14 3H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V8z"/><path d="M14 3v5h5"/><circle cx="11" cy="14" r="3"/><path d="M15 18l2 2"/>`),
    checkSquare: s(`<rect x="4" y="4" width="16" height="16" rx="2"/><path d="M8 12l3 3 5-6"/>`),
    minusCircle: s(`<circle cx="12" cy="12" r="9"/><path d="M8 12h8"/>`),
    plusSquare: s(`<rect x="4" y="4" width="16" height="16" rx="2"/><path d="M12 8v8"/><path d="M8 12h8"/>`),
    zap: s(`<path d="M13 2L3 14h7l-1 8 10-12h-7l1-8z"/>`),
    flag: s(`<path d="M5 22V4"/><path d="M5 4h11l-2 4 2 4H5"/>`),
    layers: s(`<path d="M12 2l9 5-9 5-9-5 9-5z"/><path d="M3 12l9 5 9-5"/><path d="M3 17l9 5 9-5"/>`),
    target: s(`<circle cx="12" cy="12" r="9"/><circle cx="12" cy="12" r="5"/><path d="M12 7v10"/><path d="M7 12h10"/>`),
    stomach: s(`<path d="M8 3v5a4 4 0 0 0 4 4h2a3 3 0 0 1 0 6h-1a4 4 0 0 0-4 4"/><path d="M16 3c0 2-1 3-1 5a5 5 0 0 0 2 4"/>`),

    /* 扩展：更多通用/医疗/管理图标（用于后期分类扩展支撑） */
    mail: s(`<rect x="4" y="6" width="16" height="12" rx="2"/><path d="M4 7l8 6 8-6"/>`),
    bell: s(`<path d="M18 8a6 6 0 0 0-12 0c0 7-3 7-3 7h18s-3 0-3-7"/><path d="M13.7 21a2 2 0 0 1-3.4 0"/>`),
    bellOff: s(`<path d="M18 8a6 6 0 0 0-10.5-3.8"/><path d="M6 8c0 7-3 7-3 7h12"/><path d="M13.7 21a2 2 0 0 1-3.4 0"/><path d="M3 3l18 18"/>`),
    camera: s(`<path d="M4 7h4l2-2h4l2 2h4v12H4z"/><circle cx="12" cy="13" r="3"/>`),
    video: s(`<rect x="3" y="7" width="14" height="10" rx="2"/><path d="M17 10l4-2v8l-4-2"/>`),
    paperclip: s(`<path d="M21 12l-8.5 8.5a5 5 0 0 1-7.1-7.1L14 4.8a3.5 3.5 0 0 1 5 5L10.4 18.4a2 2 0 0 1-2.8-2.8L15 8.2"/>`),

    database: s(`<ellipse cx="12" cy="5" rx="7" ry="3"/><path d="M5 5v6c0 1.7 3.1 3 7 3s7-1.3 7-3V5"/><path d="M5 11v6c0 1.7 3.1 3 7 3s7-1.3 7-3v-6"/>`),
    cloud: s(`<path d="M18 18H6a4 4 0 0 1 0-8 5 5 0 0 1 9.7-1.5A4 4 0 0 1 18 18z"/>`),
    server: s(`<rect x="4" y="4" width="16" height="6" rx="2"/><rect x="4" y="14" width="16" height="6" rx="2"/><path d="M8 7h.01"/><path d="M8 17h.01"/>`),
    wifi: s(`<path d="M5 10a11 11 0 0 1 14 0"/><path d="M8 13a7 7 0 0 1 8 0"/><path d="M11 16a3 3 0 0 1 2 0"/><path d="M12 19h.01"/>`),
    refresh: s(`<path d="M21 12a9 9 0 0 0-15-6"/><path d="M3 12a9 9 0 0 0 15 6"/><path d="M6 6H3V3"/><path d="M18 18h3v3"/>`),
    undo: s(`<path d="M9 14H5l4-4"/><path d="M5 14c0-4 3-7 7-7h5"/>`),
    redo: s(`<path d="M15 10h4l-4 4"/><path d="M19 10c0 4-3 7-7 7H7"/>`),
    archive: s(`<path d="M4 4h16v4H4z"/><path d="M6 8v12h12V8"/><path d="M10 12h4"/>`),
    inbox: s(`<path d="M4 4h16v16H4z"/><path d="M4 14h5l2 2h2l2-2h5"/><path d="M12 7v6"/><path d="M9 10l3 3 3-3"/>`),
    send: s(`<path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/>`),

    book: s(`<path d="M4 19a2 2 0 0 0 2 2h14"/><path d="M6 3h14v18H6a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"/>`),
    bookOpen: s(`<path d="M2 5a2 2 0 0 1 2-2h7v18H4a2 2 0 0 0-2 2V5z"/><path d="M22 5a2 2 0 0 0-2-2h-7v18h7a2 2 0 0 1 2 2V5z"/>`),
    graduationCap: s(`<path d="M3 8l9-4 9 4-9 4-9-4z"/><path d="M21 10v6"/><path d="M6 12v5c0 2 3 4 6 4s6-2 6-4v-5"/>`),

    wrench: s(`<path d="M21 7a5 5 0 0 1-7 4L7 18a2 2 0 0 1-3-3l7-7a5 5 0 0 1 4-7l-2 2 3 3 2-2z"/>`),
    key: s(`<path d="M7 14a4 4 0 1 1 0-8 4 4 0 0 1 0 8z"/><path d="M11 10h10"/><path d="M18 10v3"/><path d="M15 10v2"/>`),
    idCard: s(`<rect x="4" y="6" width="16" height="12" rx="2"/><path d="M8 10h.01"/><path d="M8 14h6"/><path d="M14 10h4"/>`),
    stamp: s(`<path d="M7 21h10"/><path d="M8 21v-2a4 4 0 0 1 8 0v2"/><path d="M9 7a3 3 0 0 1 6 0c0 2-1 3-1 5H10c0-2-1-3-1-5z"/>`),
    signature: s(`<path d="M4 16c2-3 4-6 6-6 2 0 2 3 4 3s3-4 6-8"/><path d="M4 21h16"/>`),
    scan: s(`<path d="M7 3H5a2 2 0 0 0-2 2v2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><path d="M17 21h2a2 2 0 0 0 2-2v-2"/><path d="M6 12h12"/>`),
    qr: s(`<rect x="4" y="4" width="6" height="6" rx="1"/><rect x="14" y="4" width="6" height="6" rx="1"/><rect x="4" y="14" width="6" height="6" rx="1"/><path d="M14 14h2v2h-2z"/><path d="M18 14h2v6h-6v-2h4z"/>`),
    barcode: s(`<path d="M4 7v10"/><path d="M7 7v10"/><path d="M10 7v10"/><path d="M14 7v10"/><path d="M17 7v10"/><path d="M20 7v10"/>`),

    calculator: s(`<rect x="5" y="3" width="14" height="18" rx="2"/><path d="M8 7h8"/><path d="M8 11h.01"/><path d="M12 11h.01"/><path d="M16 11h.01"/><path d="M8 15h.01"/><path d="M12 15h.01"/><path d="M16 15h.01"/><path d="M8 19h8"/>`),
    creditCard: s(`<rect x="3" y="6" width="18" height="12" rx="2"/><path d="M3 10h18"/><path d="M7 15h4"/>`),
    wallet: s(`<path d="M4 7h14a2 2 0 0 1 2 2v2H6a2 2 0 0 0 0 4h14v2a2 2 0 0 1-2 2H4z"/><path d="M20 11v6"/><path d="M16 14h.01"/>`),

    package: s(`<path d="M21 8l-9-5-9 5 9 5 9-5z"/><path d="M3 8v10l9 5 9-5V8"/><path d="M12 13v10"/>`),
    truck: s(`<path d="M3 16V6h11v10"/><path d="M14 10h5l3 3v3h-8"/><path d="M5 16a2 2 0 1 0 4 0"/><path d="M15 16a2 2 0 1 0 4 0"/>`),

    cigarette: s(`<path d="M3 14h12"/><path d="M18 14h3"/><path d="M15 12v4"/><path d="M21 12v4"/><path d="M6 10c0-2 2-2 2-4s-2-2-2-4"/>`),
    baby: s(`<circle cx="12" cy="8" r="3"/><path d="M8 21a4 4 0 0 1 8 0"/><path d="M7 12c1.5 2 3.2 3 5 3s3.5-1 5-3"/>`),
    mars: s(`<circle cx="10" cy="14" r="5"/><path d="M14 10l7-7"/><path d="M16 3h5v5"/>`),
    wheelchair: s(`<circle cx="10" cy="19" r="3"/><path d="M10 10a2 2 0 1 0-4 0 2 2 0 0 0 4 0z"/><path d="M8 12h4l2 6h4"/><path d="M14 18l2 4"/>`),
    crutch: s(`<path d="M8 3l4 4"/><path d="M10 5l-5 5a3 3 0 0 0 0 4l6 6a3 3 0 0 0 4 0l1-1"/><path d="M16 20l3 3"/>`),

    mask: s(`<path d="M4 12c2-5 14-5 16 0"/><path d="M6 12v5c0 2 3 4 6 4s6-2 6-4v-5"/><path d="M4 12l-2-1"/><path d="M20 12l2-1"/><path d="M8 15h8"/>`),
    handWash: s(`<path d="M6 12h10a3 3 0 0 1 3 3v6H9a3 3 0 0 1-3-3v-6z"/><path d="M6 12V9a2 2 0 0 1 4 0v3"/><path d="M10 12V8a2 2 0 0 1 4 0v4"/><path d="M14 12V9a2 2 0 0 1 4 0v3"/><path d="M5 6h.01"/><path d="M8 5h.01"/><path d="M11 6h.01"/>`),
    virus: s(`<circle cx="12" cy="12" r="5"/><path d="M12 2v3"/><path d="M12 19v3"/><path d="M2 12h3"/><path d="M19 12h3"/><path d="M4.6 4.6l2.1 2.1"/><path d="M17.3 17.3l2.1 2.1"/><path d="M19.4 4.6l-2.1 2.1"/><path d="M6.7 17.3l-2.1 2.1"/>`),
    bug: s(`<path d="M9 9V7a3 3 0 0 1 6 0v2"/><path d="M8 12h8"/><path d="M7 15h10"/><path d="M12 9v12"/><path d="M4 13h3"/><path d="M17 13h3"/><path d="M7 4l2 2"/><path d="M17 4l-2 2"/>`),

    clipboardSignature: s(`<path d="M9 4h6"/><path d="M10 4a2 2 0 0 0-2 2v2h8V6a2 2 0 0 0-2-2"/><path d="M6 8h12v13H6z"/><path d="M8 16c2-2 3-4 4-4 1 0 1 2 2 2s2-2 4-5"/>`),
    clipboardPulse: s(`<path d="M9 4h6"/><path d="M10 4a2 2 0 0 0-2 2v2h8V6a2 2 0 0 0-2-2"/><path d="M6 8h12v13H6z"/><path d="M7.5 14h2l1.2 3 2-6 1.6 5 1-2H17"/>`),
    radiation: s(`<circle cx="12" cy="12" r="2"/><path d="M12 2a10 10 0 0 1 8.7 5"/><path d="M3.3 7A10 10 0 0 1 12 2"/><path d="M12 22a10 10 0 0 1-8.7-5"/><path d="M20.7 17A10 10 0 0 1 12 22"/>`),
    xray: s(`<rect x="4" y="5" width="16" height="14" rx="2"/><path d="M9 9c0 3 6 3 6 6"/><path d="M15 9c0 3-6 3-6 6"/><path d="M12 7v10"/>`),

  };

  // 图标元数据（用于搜索/分组/语义）
  const meta = (key, label, desc) => ({ key, label, desc, svg: P[key] });

  // 扩展列表：尽量覆盖“可能用到的模板”
  const list = [
    meta('menu', '菜单', '菜单/侧边栏'),
    meta('more', '更多', '更多操作/折叠菜单'),
    meta('folder', '目录', '分类/目录'),
    meta('folderOpen', '展开', '展开目录'),
    meta('clipboard', '病历', '病历要点/摘要'),
    meta('file', '文书', '记录/文档'),
    meta('note', '记录', '病程/笔记'),
    meta('stethoscope', '查体', '体格检查/听诊'),
    meta('heart', '心脏', '心内科/循环'),
    meta('lungs', '呼吸', '呼吸科/肺'),
    meta('brain', '神经', '神经系统'),
    meta('bone', '骨科', '骨科/骨'),
    meta('tooth', '口腔', '口腔/牙'),
    meta('lab', '化验', '实验室检查'),
    meta('microscope', '病理', '病理/显微'),
    meta('dna', '遗传', '基因/分子'),
    meta('imaging', '影像', '影像检查'),
    meta('ct', 'CT', 'CT/时间线'),
    meta('mri', 'MRI', '核磁/结构'),
    meta('ultrasound', '超声', '超声/床旁'),
    meta('syringe', '注射', '注射/疫苗'),
    meta('pill', '药物', '口服用药'),
    meta('infusion', '输液', '静脉治疗'),
    meta('bandage', '换药', '敷料/伤口'),
    meta('scalpel', '手术', '手术相关'),
    meta('anesthesia', '麻醉', '麻醉/镇静'),
    meta('periop', '围手术期', '术前术后管理'),
    meta('shield', '风险', '风险/防护'),
    meta('alert', '危重', '病危/警示'),
    meta('info', '提示', '说明/注意事项'),
    meta('consent', '同意', '知情同意'),
    meta('notice', '告知', '告知书/宣教'),
    meta('consult', '会诊', '会诊/多学科'),
    meta('discharge', '出院', '出院记录/医嘱'),
    meta('transfer', '转科', '转科/转院'),
    meta('followup', '随访', '复诊/随访'),
    meta('calendar', '计划', '计划/排程'),
    meta('phone', '沟通', '电话/联系'),
    meta('message', '沟通', '信息/沟通'),
    meta('tag', '标签', '标签/关键词'),
    meta('bookmark', '收藏', '收藏/常用'),
    meta('settings', '设置', '设置/管理'),
    meta('sort', '排序', '排序/调整'),
    meta('upload', '导入', '导入/恢复'),
    meta('download', '导出', '导出/备份'),
    meta('receipt', '收据', '备份收据/清单'),
    meta('restore', '恢复', '恢复/回滚'),
    meta('user', '个人', '个人/患者'),
    meta('users', '人群', '人群/家族'),
    meta('search', '搜索', '搜索/查找'),
    meta('pen', '编辑', '编辑/重命名'),
    meta('copy', '复制', '复制/重复'),
    meta('star', '星标', '星标/重点'),
    meta('clock', '时间', '时间/时钟'),
    meta('eye', '查看', '查看/预览'),
    meta('lock', '锁定', '锁定/权限'),
    meta('unlock', '解锁', '解锁/开放'),
    meta('home', '主页', '主页/首页'),
    meta('hospital', '医院', '医院/科室'),
    meta('ambulance', '急救', '急救/救护车'),
    meta('bed', '病床', '病床/住院'),
    meta('droplet', '血滴', '血液/出血'),
    meta('thermometer', '体温', '体温/发热'),
    meta('location', '定位', '定位/地址'),
    meta('link', '链接', '链接/关联'),
    meta('printer', '打印', '打印/输出'),
    meta('image', '图片', '图片/图像'),
    meta('share', '分享', '分享/转发'),

    meta('mail', '邮件', '邮件/通知'),
    meta('bell', '提醒', '提醒/通知'),
    meta('bellOff', '静音', '静音/免打扰'),
    meta('camera', '拍照', '拍照/影像记录'),
    meta('video', '视频', '视频/视频随访'),
    meta('paperclip', '附件', '附件/上传'),

    meta('database', '数据库', '数据/存储'),
    meta('cloud', '云端', '云端/同步'),
    meta('server', '服务器', '服务器/系统'),
    meta('wifi', '网络', '网络/连接'),
    meta('refresh', '同步', '同步/刷新'),
    meta('undo', '撤销', '撤销/回退'),
    meta('redo', '重做', '重做/前进'),
    meta('archive', '归档', '归档/封存'),
    meta('inbox', '收件', '收件/待处理'),
    meta('send', '发送', '发送/提交'),

    meta('book', '手册', '指南/手册'),
    meta('bookOpen', '指南', '指南/阅读'),
    meta('graduationCap', '教学', '教学/培训'),

    meta('wrench', '工具', '工具/维护'),
    meta('key', '密钥', '密钥/权限'),
    meta('idCard', '身份', '身份/信息卡'),
    meta('stamp', '盖章', '盖章/签章'),
    meta('signature', '签名', '签名/手写'),
    meta('scan', '扫描', '扫描/录入'),
    meta('qr', '二维码', '二维码/识别'),
    meta('barcode', '条码', '条码/编号'),

    meta('calculator', '计算', '计算/评分'),
    meta('creditCard', '支付', '支付/费用'),
    meta('wallet', '费用', '费用/结算'),

    meta('package', '物资', '物资/耗材'),
    meta('truck', '转运', '转运/物流'),

    meta('cigarette', '吸烟', '个人史/吸烟'),
    meta('baby', '儿科', '儿科/新生儿'),
    meta('mars', '男性', '男性/男'),
    meta('wheelchair', '轮椅', '行动不便'),
    meta('crutch', '拐杖', '康复/辅助'),
    meta('mask', '口罩', '防护/感染控制'),
    meta('handWash', '洗手', '洗手/消毒'),
    meta('virus', '感染', '感染/病毒'),
    meta('bug', '问题', '问题/故障'),

    meta('clipboardSignature', '签署', '签署/签名'),
    meta('clipboardPulse', '监测', '监测/生命体征'),
    meta('radiation', '放射', '放射/辐射'),
    meta('xray', 'X光', 'X光/放射'),


    meta('activity', '生命体征', '生命体征/监护'),
    meta('gauge', '血压', '血压/压力表'),
    meta('clipboardCheck', '核对', '核对/检查清单'),
    meta('clipboardList', '清单', '清单/列表'),
    meta('list', '列表', '列表/条目'),
    meta('listCheck', '完成清单', '清单/勾选'),
    meta('filter', '筛选', '筛选/鉴别'),
    meta('route', '路径', '流程/路径/经过'),
    meta('ear', '耳鼻喉', '耳鼻喉/耳'),
    meta('venus', '妇科', '妇科/女性'),
    meta('utensils', '饮食', '饮食/营养'),
    meta('nurse', '护理', '护理/照护'),
    meta('handover', '交接', '交接班/交接'),
    meta('rounds', '查房', '查房/团队'),
    meta('report', '总结', '摘要/汇总/小结'),
    meta('barChart', '统计', '统计/趋势'),
    meta('pieChart', '构成', '构成/比例'),
    meta('fileText', '文本', '文本/说明'),
    meta('fileCheck', '已确认', '确认/诊断依据'),
    meta('fileSearch', '检索', '检索/查找'),
    meta('checkSquare', '勾选', '勾选/确认项'),
    meta('minusCircle', '排除', '排除/阴性'),
    meta('plusSquare', '补充', '补充/新增'),
    meta('zap', '疼痛', '疼痛/电击样'),
    meta('flag', '标记', '标记/异常'),
    meta('layers', '分层', '分层/多级'),
    meta('target', '目标', '目标/诊疗目标'),
    meta('stomach', '腹部', '腹部/消化'),

    meta('move', '移动', '移动/迁移'),
    meta('save', '保存', '保存'),
    meta('trash', '删除', '删除'),
    meta('palette', '图标', '图标/选择'),
    meta('plus', '添加', '添加'),
    meta('plusCircle', '新增', '新增/创建'),
    meta('x', '关闭', '关闭/取消'),
    meta('check', '确认', '确认/完成'),
    meta('chevronDown', '展开', '展开'),
    meta('chevronUp', '收起', '收起'),
    meta('chevronRight', '进入', '进入/右箭头'),
  ];

  const map = new Map();
  list.forEach(i => map.set(i.key, i));
  return {
    get: (key) => map.get(key),
    all: () => Array.from(map.values()),
    svg: (key) => (map.get(key)?.svg || P.folder),
    exists: (key) => map.has(key)
  };
})();

/* =========================
   2) 默认分类（含你新增）
   - main: iconKey
   - subs: {name, iconKey}
   ========================= */
const DEFAULT_CATEGORIES = [
  { name: "主诉", iconKey: "message", subs: [
    { name:"一般主诉", iconKey:"clipboard" },
    { name:"急诊主诉", iconKey:"alert" },
    { name:"复诊主诉", iconKey:"followup" },
  ]},
  { name: "现病史", iconKey: "note", subs: [
    { name:"发病情况", iconKey:"info" },
    { name:"诊疗经过", iconKey:"file" },
    { name:"症状描述", iconKey:"stethoscope" },
    { name:"阴性鉴别", iconKey:"shield" },
  ]},
  { name: "病例特点", iconKey: "bookmark", subs: [
    { name:"阳性体征汇总", iconKey:"check" },
    { name:"病史摘要", iconKey:"clipboard" },
    { name:"辅助检查汇总", iconKey:"lab" },
  ]},
  { name: "既往史", iconKey: "calendar", subs: [
    { name:"疾病史", iconKey:"heart" },
    { name:"手术史", iconKey:"scalpel" },
    { name:"过敏史", iconKey:"alert" },
    { name:"输血史", iconKey:"infusion" },
  ]},
  { name: "个人史/家族史", iconKey: "users", subs: [
    { name:"个人史", iconKey:"info" },
    { name:"婚育史", iconKey:"calendar" },
    { name:"家族史", iconKey:"dna" },
    { name:"月经史", iconKey:"calendar" },
  ]},
  { name: "体格检查", iconKey: "stethoscope", subs: [
    { name:"生命体征", iconKey:"heart" },
    { name:"一般检查", iconKey:"check" },
    { name:"头颈部", iconKey:"brain" },
    { name:"心肺听诊", iconKey:"lungs" },
    { name:"腹部", iconKey:"info" },
    { name:"神经系统", iconKey:"brain" },
  ]},
  { name: "专科检查", iconKey: "stethoscope", subs: [
    { name:"眼科检查", iconKey:"imaging" },
    { name:"耳鼻喉", iconKey:"message" },
    { name:"妇科检查", iconKey:"info" },
    { name:"骨科查体", iconKey:"bone" },
    { name:"皮肤科", iconKey:"shield" },
  ]},
  { name: "辅助检查", iconKey: "lab", subs: [
    { name:"实验室检查", iconKey:"lab" },
    { name:"影像学检查", iconKey:"imaging" },
    { name:"病理检查", iconKey:"microscope" },
    { name:"特殊检查", iconKey:"info" },
  ]},
  { name: "初步诊断", iconKey: "check", subs: [
    { name:"中医诊断", iconKey:"bookmark" },
    { name:"西医诊断", iconKey:"check" },
    { name:"补充诊断", iconKey:"info" },
  ]},
  { name: "鉴别诊断", iconKey: "shield", subs: [
    { name:"常见病鉴别", iconKey:"info" },
    { name:"疑难病鉴别", iconKey:"alert" },
    { name:"危急重症鉴别", iconKey:"alert" },
  ]},
  { name: "诊断依据", iconKey: "file", subs: [
    { name:"症状依据", iconKey:"stethoscope" },
    { name:"体征依据", iconKey:"check" },
    { name:"检查依据", iconKey:"lab" },
  ]},
  { name: "诊疗计划", iconKey: "calendar", subs: [
    { name:"检查计划", iconKey:"lab" },
    { name:"药物治疗", iconKey:"pill" },
    { name:"手术计划", iconKey:"scalpel" },
    { name:"护理级别", iconKey:"shield" },
    { name:"饮食医嘱", iconKey:"info" },
  ]},
  { name: "围手术期", iconKey: "periop", subs: [
    { name:"术前评估", iconKey:"check" },
    { name:"术前准备", iconKey:"folderOpen" },
    { name:"术后管理", iconKey:"shield" },
    { name:"疼痛管理", iconKey:"pill" },
  ]},
  { name: "手术记录", iconKey: "scalpel", subs: [
    { name:"术前诊断", iconKey:"check" },
    { name:"术中要点", iconKey:"note" },
    { name:"术后诊断", iconKey:"check" },
    { name:"术后医嘱", iconKey:"discharge" },
  ]},
  { name: "会诊处置", iconKey: "consult", subs: [
    { name:"会诊意见", iconKey:"consult" },
    { name:"处置记录", iconKey:"note" },
    { name:"多学科讨论", iconKey:"message" },
  ]},
  { name: "病程描述", iconKey: "note", subs: [
    { name:"病情变化", iconKey:"info" },
    { name:"治疗反应", iconKey:"check" },
    { name:"特殊情况记录", iconKey:"alert" },
  ]},
  { name: "病程记录", iconKey: "file", subs: [
    { name:"首次病程", iconKey:"file" },
    { name:"日常病程", iconKey:"note" },
    { name:"上级医师查房", iconKey:"stethoscope" },
    { name:"交接班记录", iconKey:"transfer" },
    { name:"抢救记录", iconKey:"alert" },
    { name:"阶段小结", iconKey:"bookmark" },
  ]},
  { name: "知情同意", iconKey: "consent", subs: [
    { name:"手术同意书", iconKey:"consent" },
    { name:"输血同意书", iconKey:"infusion" },
    { name:"特殊检查同意", iconKey:"imaging" },
    { name:"自费药同意", iconKey:"pill" },
  ]},
  { name: "告知书", iconKey: "notice", subs: [
    { name:"病危/病重告知", iconKey:"alert" },
    { name:"入院告知", iconKey:"info" },
    { name:"拒绝治疗告知", iconKey:"shield" },
  ]},
  { name: "处理意见", iconKey: "discharge", subs: [
    { name:"出院医嘱", iconKey:"discharge" },
    { name:"转科意见", iconKey:"transfer" },
    { name:"门诊随访", iconKey:"followup" },
  ]},
];

/* =========================
   3) 全局数据
   ========================= */
let templates = JSON.parse(localStorage.getItem('med_templates_v3')) || [];
let categoryTree = JSON.parse(localStorage.getItem('med_categories_v3')) || DEFAULT_CATEGORIES;

// =========================
// 内置预设数据（用于一键恢复）
// 来自用户上传的备份文件，可在“设置 → 数据 → 导入预设”一键导入
// =========================
const PRESET_BACKUP_JSON = `{"version": "3.6-sticky-footer", "timestamp": "2026/1/17 19:42:29", "categories": [{"name": "主诉", "subs": ["一般主诉", "急诊主诉", "复诊主诉"]}, {"name": "现病史", "subs": ["发病情况", "治疗经过", "症状描述", "阴性鉴别"]}, {"name": "病例特点", "subs": ["阳性体征汇总", "病史摘要", "辅助检查汇总"]}, {"name": "既往史", "subs": ["疾病史", "手术史", "过敏史", "输血史"]}, {"name": "个人史/家族史", "subs": ["个人史", "婚育史", "家族史", "月经史"]}, {"name": "体格检查", "subs": ["生命体征", "一般检查", "头颈部", "心肺听诊", "腹部", "神经系统"]}, {"name": "专科检查", "subs": ["口腔科"]}, {"name": "辅助检查", "subs": ["实验室检查", "影像学检查", "病理检查", "特殊检查"]}, {"name": "初步诊断", "subs": ["中医诊断", "西医诊断", "补充诊断"]}, {"name": "鉴别诊断", "subs": ["常见病鉴别", "疑难病鉴别", "危急重症鉴别"]}, {"name": "诊断依据", "subs": ["症状依据", "体征依据", "检查依据"]}, {"name": "诊疗计划", "subs": ["检查计划", "药物治疗", "手术计划", "护理级别", "饮食医嘱"]}, {"name": "病程描述", "subs": ["病情变化", "治疗反应", "特殊情况记录"]}, {"name": "病程记录", "subs": ["首次病程", "日常病程", "上级医师查房", "交接班记录", "抢救记录", "阶段小结"]}, {"name": "知情同意", "subs": ["手术同意书", "输血同意书", "特殊检查同意", "自费药同意"]}, {"name": "告知书", "subs": ["病危/病重告知", "入院告知", "拒绝治疗告知"]}, {"name": "处理意见", "subs": ["转科意见", "门诊随访"]}, {"name": "手术记录", "subs": []}, {"name": "围手术期", "subs": ["术前小结", "术前讨论记录"]}, {"name": "会诊处置", "subs": []}, {"name": "查房观察", "subs": []}, {"name": "出院记录", "subs": ["诊疗经过", "出院医嘱", "出院病情"]}], "templates": [{"id": "1768650118719", "mainCat": "出院记录", "subCat": "出院医嘱", "title": "颌面间隙感染(药物)", "tags": "出院医嘱, 住院", "content": "1、加强身体适当锻炼，清淡高营养饮食；2、观察感染恢复情况，若有反复，建议立即返院接受治疗；3、必要时可口服抗生素，警惕感染；4、身体完全恢复后，前往我科门诊处理病灶牙，警惕感染反复；5、我科随诊。"}, {"id": "1768638723197", "mainCat": "现病史", "subCat": "", "title": "腮腺肿瘤", "tags": "住院", "content": "1个月前，患者无明显诱因发现左侧耳后区“板栗”样大小肿物，无明显疼痛，扪及无明显不适感。2天前，患者干农活时被太阳照射发现左侧腮腺区肿胀明显，有明显疼痛不适感，就诊于当地县医院行输液治疗，无明显疗效。现患者就诊于我科门诊，行“腮腺区穿刺术”，未穿刺出明显脓性分泌物，考虑腮腺区肿物，建议患者住院手术治疗。门诊以“腮腺肿瘤”收治入院。"}, {"id": "1768638679326", "mainCat": "现病史", "subCat": "", "title": "颌骨骨折", "tags": "住院", "content": "2天前，患者因发生车祸致面部出血肿胀，出血量不详，衣领浸满血液，于左侧面部皮肤见一弧形不规则开放性创口，伴有明显疼痛，且张口困难，口腔内牙齿错位不能咬合，严重影响进食，立即就诊于当地医院行伤口简单包扎，医生评估病情后建议转至上级医院治疗，故转入我院急诊科行头颅CT排除颅内病变后，急诊以“下颌骨骨折”收治入院治疗。患者受伤来无头昏、头痛，无恶心、呕吐等症状，精神欠佳，未进食，无嗜睡，大小便正常，体重无明显改变。"}, {"id": "1768638648598", "mainCat": "现病史", "subCat": "", "title": "颌下间隙感染", "tags": "住院", "content": "1周前，患者无明显诱因发现右侧下颌后牙疼痛，无冷热刺激痛，进食时有疼痛加重，一直未予以重视/自行口服消炎药无效，症状无明显好转/一周后疼痛自行减轻。2天前，发现对应颌下区肿胀越发明显，有明显压痛，无破溃流脓，无进食胀痛感，无明显消长史，质软，不可活动。立即就诊于当地医院，行消炎药输液治疗（具体药物及用量不详），疗效不佳，症状未见较轻。随后肿胀逐渐增大，疼痛加剧不能张口，现为进一步治疗，就诊于我科，门诊以“颌下间隙感染”收治入院。患者自病来否认头昏头痛、恶心呕吐等不适，精神饮食稍差，体重无明显减轻，大小便如常，体重未见明显变化。"}, {"id": "1768638620518", "mainCat": "现病史", "subCat": "", "title": "溃疡性口炎", "tags": "住院", "content": "5天前，患者出现双侧颊部粘膜疼痛不适，进食时尤为明显，自行口服消炎药（具体药物名称及用法不详），疗效差，随后患者发现病情加重，并蔓延至上下唇，引起唇粘膜肿胀，伴有明显疼痛，起痂壳，可撕脱，撕脱后见渗血，影响进食。患者为求进一步治疗就诊于我科，门诊以“坏死性溃疡性口炎”收治入院，患者自病来否认心慌、胸闷，无尿频尿急，无咳嗽、咳痰，无头痛、头晕，无腹泻，饮食差，睡眠欠佳，二便如常，体重未见明显变化。"}, {"id": "1768638594446", "mainCat": "现病史", "subCat": "", "title": "颌骨囊肿", "tags": "住院", "content": "1个月前，患者无明显诱因发现右侧上颌后牙疼痛，无冷热刺激痛，进食时有疼痛加重，一直未予以重视/自行口服消炎药无效，症状无明显好转/一周后疼痛自行减轻。2天前，患者复诊拍片时医生发现右侧上颌骨部有一“根尖囊肿”，无破溃流脓，无进食胀痛感，无明显消长史，质软，不可活动。医生建议转至上级医院手术治疗，现为进一步治疗，就诊于我科，门诊以“左上颌骨肿物”收治入院。患者自病来否认头昏、头痛、恶心呕吐等不适，精神饮食稍差，体重无明显减轻，大小便如常，体重未见明显变化。"}, {"id": "1768638543957", "mainCat": "现病史", "subCat": "", "title": "舌下腺囊肿", "tags": "住院", "content": "1个月前，患者家属发现患儿左侧舌下一“鹌鹑蛋”大小的肿物，质软，浅蓝色透明样，无明显压痛，无破溃流脓，无进食胀痛感，无明显消长史，不可活动。随后发现肿物逐渐增大，舌活动受限影响说话及进食，现为进一步治疗，就诊于我科，门诊以“舌下腺囊肿”收治入院。患者自病来否认头昏、头痛、恶心呕吐等不适，精神饮食稍差，体重无明显减轻，大小便如常，体重未见明显变化。"}, {"id": "1768638511261", "mainCat": "现病史", "subCat": "", "title": "急性冠周炎", "tags": "住院", "content": "1周前，患者自觉左下后牙区疼痛不适，否认冷热刺激痛，进食咀嚼时疼痛感加重，夜间疼痛加重，自行口服消炎药（具体药物名称及用法不详），无明显好转。2天前，该患牙周围牙龈疼痛不能缓解，并伴有不同量的脓液流出，唇口不能张大，严重影响了进食及生活质量。患者为求进一步诊治，就诊于我科门诊，我科门诊以“急性冠周炎”收治入院，患者自病来否认畏寒、发热，无头昏头痛等不适，饮食欠佳，精神、睡眠良好，二便如常，体重未见明显变化。"}, {"id": "1768638466638", "mainCat": "现病史", "subCat": "", "title": "面部肿物", "tags": "住院", "content": "3个月前，患者无意中发现右面部有一“黄豆”样大小肿物，无痛，无流脓，暴露在高温下肿物有增大现象且触之微痛，质软，活动度可，未引起患者重视，未行任何特殊处理。近日现患者发现肿物逐渐增大为求进一步治疗，就诊于我科，门诊以“面部肿物”收治入院，患者病来否认头昏头痛、恶心呕吐等不适，精神饮食睡眠均良好，二便如常，体重未见明显异常变化。"}, {"id": "1768638431318", "mainCat": "现病史", "subCat": "", "title": "颌下腺肿瘤", "tags": "住院", "content": "1月前，患者无明显诱因发现右颌下区发热感，随后发现颌下区肿胀越发明显，有明显压痛，无破溃流脓，无进食胀痛感，无明显消长史，质软，不可活动。立即就诊于当地医院，行消炎药输液治疗（具体药物及用量不详），疗效不佳。随后肿物逐渐增大，疼痛加剧不能张口，现为进一步治疗，就诊于我科，门诊以“颌下腺炎”收治入院。患者自病来否认头昏头痛、恶心呕吐等不适，精神饮食稍差，体重无明显减轻，大小便如常，体重未见明显变化。"}, {"id": "1768638403910", "mainCat": "现病史", "subCat": "", "title": "软组织创伤", "tags": "住院", "content": "1天前，患者因不慎摔伤致左侧面部肿胀出血，出血量不详，衣领浸满血液，于左侧面部皮肤见一弧形不规则开放性创口，伴有明显疼痛，立即就诊于当地医院行伤口简单包扎，医生评估病情后建议转至我院治疗，我院急诊科行头颅CT排除颅内病变后，急诊以“面部裂伤”收治入院治疗。患者受伤来无头昏、头痛，无恶心、呕吐等症状，精神欠佳，未进食，无嗜睡，大小便正常，体重无明显改变。"}, {"id": "1768638364174", "mainCat": "现病史", "subCat": "", "title": "眶下间隙感染", "tags": "住院", "content": "1周前，患者无明显诱因发现右上颌牙齿疼痛明显，无冷热刺激痛，一直未予以重视，一周后疼痛自行减轻。2天前，患者发现口内及眶下区明显肿胀，口内有异常渗出，恶臭味，腭部明显肿胀，伴有疼痛，严重影响患者生活，遂就诊于我院，我科门诊以“眶下间隙感染”收治入院。患者病来精神一般，饮食差，睡眠差，二便如常，否认畏寒、发热，无头昏头痛等不适，体重未见明显变化。"}, {"id": "1768638322006", "mainCat": "现病史", "subCat": "", "title": "急性腮腺炎", "tags": "住院", "content": "1天前，患者无明显诱因出现双耳前区肿痛，性质为持续性钝痛，伴有恶心、食欲下降，无呕吐，体温不高，患者自行口服治疗药物（具体药物及用法不详）无效，为求进一步诊治就诊于我院门诊。门诊以“急性腮腺炎”收治入院。患者自病来否认心慌、胸闷，无尿频尿急，无咳嗽、咳痰，无头痛、头晕，无腹泻，饮食、睡眠欠佳，二便如常，体重未见明显变化。"}, {"id": "1768638290478", "mainCat": "现病史", "subCat": "", "title": "唇肿瘤", "tags": "住院", "content": "1+月前，患者家属无意中发现患者右下唇有一“米粒”样大小肿物，无痛，无流脓，无进食胀痛感，无下唇麻木及活动受限，无明显消长史，质软，不可活动，一直未引起患者家属重视，未做任何特殊处理。现患者家属发现肿物逐渐增大，为求进一步治疗，就诊于我科，门诊以“右下唇肿物”收治入院，患者病来精神尚可，饮食稍差，睡眠可，二便如常，否认头昏头痛、恶心呕吐等不适，体重未见明显异常变化。"}, {"id": "1768638256686", "mainCat": "现病史", "subCat": "", "title": "阻生牙", "tags": "现病史, 住院", "content": "1周前，患者自觉左下后牙疼痛不适，否认冷热刺激痛，进食咀嚼时疼痛感加重，自行口服消炎药（具体药物名称及用法不详）/一直未予以重视，一周后自行好转。随后，该患牙反复发作疼痛，严重影响了进食及生活质量。患者为求进一步诊治，就诊于我科门诊，我科门诊以“阻生牙”收治入院，患者自病来否认畏寒、发热，无头昏头痛等不适，饮食欠佳，精神、睡眠良好，二便如常，体重未见明显变化。"}, {"id": "1768638212454", "mainCat": "现病史", "subCat": "", "title": "颊部肿物", "tags": "住院", "content": "1月前，患者因牙痛就诊于当地医院，医生发现左侧颊部可扪及一“黄豆”大小包块，有明显压痛，无破溃流脓，无进食胀痛感，无明显消长史，质软，不可活动。医生建议转至上级医院手术治疗，随后肿物逐渐增大，疼痛加剧不能咀嚼，现为进一步治疗，就诊于我科，门诊以“左颊部包块”收治入院。患者自病来否认头昏、头痛、恶心呕吐等不适，精神饮食稍差，体重无明显减轻，大小便如常，体重未见明显变化。"}, {"id": "1768638166662", "mainCat": "现病史", "subCat": "", "title": "腭裂", "tags": "住院", "content": "患儿出生时被家人发现腭部裂开，进食易呛咳，否认进食返流。睡觉不打鼾，否认憋气，鼻呼吸，腭裂语音。现要求修复腭部裂隙来我院治疗。我科以“先天性腭裂”收治入院。患儿近来一般情况良好，胃纳正常，无咳嗽、发热等不适，体重未见明显减轻。"}, {"id": "1768638018294", "mainCat": "出院记录", "subCat": "出院医嘱", "title": "舌下腺囊肿", "tags": "住院", "content": "1、出院后注意保持口腔卫生清洁；2、1周后，酌情拆除口内缝线（也可待其自行吸收）；3、忌辛辣刺激性食物，餐后漱口；4、不适随诊（0856-8169478）。"}, {"id": "1768637989590", "mainCat": "出院记录", "subCat": "出院医嘱", "title": "唇裂", "tags": "住院", "content": "1、出院后保持创面干燥、卫生清洁，餐后漱口；2、忌哭闹，忌咀嚼硬物及刺激性强的食物；3、一周后酌情拆除缝线（也可待其自行吸收）；4、不适随诊（0856-8169478）。"}, {"id": "1768637956486", "mainCat": "出院记录", "subCat": "出院医嘱", "title": "腭裂", "tags": "住院", "content": "1、出院后保持口腔卫生清洁，餐后漱口；2、忌咀嚼硬物及刺激性强的食物；3、一周后酌情拆除缝线（也可待其自行吸收）；4、不适随诊（0856-8169478）。"}, {"id": "1768637941454", "mainCat": "出院记录", "subCat": "出院医嘱", "title": "拔牙创面", "tags": "住院", "content": "1、出院后注意保持口腔卫生清洁；2、1周后，酌情拆除口内缝线（可待其自行吸收）；3、不适随诊。"}, {"id": "1768637926902", "mainCat": "出院记录", "subCat": "出院医嘱", "title": "颌面部感染(手术)", "tags": "住院", "content": "1、出院后一周内，每日换药冲洗（复诊）；2、保持创面干燥，保持口腔卫生清洁；3、出院后口服抗生素，警惕感染；4、完全恢复后，需前往我科门诊行病灶牙处理，我科随诊。"}, {"id": "1768637906118", "mainCat": "出院记录", "subCat": "出院医嘱", "title": "腮腺肿瘤", "tags": "住院", "content": "1、继续加压包扎一周，5天后拆除缝线（口腔科门诊）；2、禁酸饮食一个月，定期复查；3、甲钴胺，0.5mg，Po,Tid,疗程为1个月；阿托品片,0.6mg,Po,三餐前30分钟，1周；4、不适随诊。"}, {"id": "1768637862790", "mainCat": "出院记录", "subCat": "出院病情", "title": "舌下腺囊肿", "tags": "住院", "content": "患者精神状态良好，饮食稍差，夜间睡眠良好，大小便如常，未诉其他不适。患者面型基本对称，面部无明显好转，口内见术区创面清洁，表面少许假膜覆盖，缝线在位无松脱，伤口对位愈合好，无明显感染征象。舌体活动度良好，病理检查结果未回。"}, {"id": "1768637847182", "mainCat": "出院记录", "subCat": "出院病情", "title": "舌肿物", "tags": "住院", "content": "患者精神状态佳，夜间睡眠良好，饮食稍差，二便如常，未诉特殊不适。专科查：患者面型欠对称，张口轻微受限，张口度约两指半，口内见舌腹部创面少许假膜覆盖，创口无明显渗出溢脓，缝线在位稳妥，周围组织未见红肿，舌体无明显肿胀，活动度正常，发音明确，伸舌自如。口腔卫生维持一般。"}, {"id": "1768637829318", "mainCat": "出院记录", "subCat": "出院病情", "title": "拔牙创面", "tags": "住院", "content": "患者精神状态良好，睡眠良好，饮食一般，二便如常，未诉特殊不适。患者面型基本对称，肿胀较前明显好转，口内见术区创面清洁，拔牙窝血凝块充盈，周围牙龈未见明显红肿，无渗出溢脓，表面少许假膜覆盖，缝线在位无松脱，伤口对位愈合好，口腔卫生较清洁，无明显感染征象。"}, {"id": "1768637814254", "mainCat": "出院记录", "subCat": "出院病情", "title": "面部肿物", "tags": "住院", "content": "患者精神良好，饮食正常，睡眠良好，二便如常，未诉特殊不适。患者右额部肿物已经手术切除，周围皮肤色泽正常，皮温不高，创口未见明显红肿，无明显渗出，少许结痂，缝线在位无松脱，未见明显面神经功能障碍。"}, {"id": "1768637800934", "mainCat": "出院记录", "subCat": "出院病情", "title": "口腔肿物", "tags": "住院", "content": "患者精神状态良好，饮食稍差，夜间睡眠良好，大小便如常，未诉其他不适。患者面型基本对称，肿胀较前明显好转，口内见术区创面清洁，表面少许假膜覆盖，缝线在位无松脱，伤口对位愈合好，无明显感染征象。舌体活动度良好，病理检查结果未回。"}, {"id": "1768637780998", "mainCat": "出院记录", "subCat": "出院病情", "title": "颌面部感染", "tags": "住院", "content": "患者精神良好，饮食正常，睡眠良好，二便如常，未诉特殊不适。患者面型基本对称，右面部肿胀较前明显改善，颏下区稍显肿胀，表面皮肤色泽正常，皮温无异，无明显波动感及搏动感。引流条在位，引流通畅，未见明显脓性及血性渗出，术区敷料清洁干燥。"}, {"id": "1768637762094", "mainCat": "出院记录", "subCat": "出院病情", "title": "腮腺肿瘤", "tags": "住院", "content": "患者精神良好，饮食正常，睡眠良好，二便如常，未诉特殊不适。患者面型欠对称，左面部稍显肿胀，无轻微鼓腮漏气及口角歪斜等症状，余未诉特殊不适。术区敷料清洁干燥，缝线在位无松脱，伤口对位愈合好、I/甲愈合。"}, {"id": "1768637729175", "mainCat": "出院记录", "subCat": "出院病情", "title": "唇裂", "tags": "住院", "content": "患者精神状态良好，睡眠良好，饮食一般，二便如常，未诉特殊不适。患者面型基本对称，唇部无明显肿胀，缝线在位无松脱，伤口对位愈合好，无出血，伤口较清洁，外形较好。"}, {"id": "1768637693159", "mainCat": "出院记录", "subCat": "出院病情", "title": "腭裂", "tags": "住院", "content": "患儿患者精神良好，饮食正常，睡眠良好，二便如常，未诉特殊不适。术后无明显发热、感冒等不适。专科查：患儿面型对称，张口度张口型可，上腭部创口愈合良好，无明显感染征象，碘仿纱条已拆除，口腔卫生稍差，余无特殊。"}, {"id": "1768637627006", "mainCat": "出院记录", "subCat": "诊疗经过", "title": "舌下腺囊肿", "tags": "住院", "content": "患者入院后进入舌下腺良性病变临床路径诊疗，积极完善术前检查，结果提示未见明显异常，无明显手术禁忌证，于2019年7月17日全麻下行“左舌下腺囊肿摘除术+左舌下腺切除术”，手术顺利，术后给予患者预防性应用抗菌药物，同时给予患者镇痛、补液治疗，术后恢复好，口内创口未见明显异常渗出，患者家属要求出院，请示上级医师后，患者已完成临床路径诊疗，准予办理出院手续，告知患者出院注意事项。"}, {"id": "1768637612374", "mainCat": "出院记录", "subCat": "诊疗经过", "title": "创伤清创", "tags": "住院", "content": "患者入院后进入口腔颌面部创伤临床路径诊疗，急诊神经阻滞麻醉下行“口腔颌面部软组织清创缝合术”，术后给予患者注射破伤风免疫球蛋白，同时给予患者抗菌药物预防感染，并给予消肿、补液等对症处理。术后每日换药，现患者术区创面明显好转。与患者沟通病情，患者要求出院，鉴于患者病情稳定，已按临床路径完成诊疗，请示上级医师后，给予患者办理出院手续，交代患者出院注意事项。"}, {"id": "1768637594262", "mainCat": "出院记录", "subCat": "诊疗经过", "title": "流腮", "tags": "住院", "content": "患者入院后进入急性腮腺炎临床路径诊疗，积极完善常规化验检验，结果提示“淀粉酶 246.4 U/L”，异常升高，经上级医师查房后考虑为腮腺炎的前驱表现，积极给予患者抗病毒治疗，患者时有发热症状，给予患者对症药物及物理降温，发热控制良好。抗病毒控制感染后疗效佳，双侧腮腺区疼痛明显减轻，后发现病变转移 至右侧颌下腺，可扪及右侧颌下腺肿胀，但无疼痛。给予患者复查2018-12-12生化全套血清淀粉酶，值为：淀粉酶 1026.6 U/L，结果异常升高，请示上级医师后，考虑为患者腮腺病毒性转移至颌下腺，引起颌下腺感染急性期，导致患者淀粉酶明显升高，遵上级医师意见，继续给予患者抗病毒药物（5％葡萄糖注射液500ml(三明)每次500ml,利巴韦林注射剂每次0.5g,静脉滴入 Bid），严密观察患者病情变化。拟于2018-12-14复查血清淀粉酶观察患者治疗效果，但患者家属拒绝抽血化验，并强烈要求出院。经与上级医师分析后，签署拒绝化验检验告知书及自动出院告知书，办理出院手续，告知患者出院注意事项，退出临床路径。"}, {"id": "1768637580142", "mainCat": "出院记录", "subCat": "诊疗经过", "title": "拔牙术后", "tags": "住院", "content": "患者入院后进入阻生牙复杂牙拔除临床路径诊疗，积极完善术前检查，结果提示未见明显异常，无明显手术禁忌证，于手术时间全麻下行“阻生牙拔除术”，手术顺利，术后给予患者预防性应用抗菌药物，同时给予患者镇痛、补液治疗，术后恢复好，口内创口未见明显异常渗出，现患者病情平稳，已按其临床路径完成诊疗，我科暂无特殊处理，患者要求出院，请示上级医师后，准予办理出院手续，交代出院后注意事项。"}, {"id": "1768637564599", "mainCat": "出院记录", "subCat": "诊疗经过", "title": "颌面部感染", "tags": "住院", "content": "患者入院后纳入口腔颌面部感染临床路径诊疗，立即急诊局麻下行“颏部脓肿切开引流术”，术后给予抗菌药物控制感染，同时给予患者消肿、补液等对症治疗，每日行脓腔冲洗换药，更换敷料，患者恢复良好。现患者病情平稳，已按其临床路径完成诊疗，我科暂无特殊处理，患者要求出院，请示上级医师后，准予办理出院手续，交代出院后注意事项。"}, {"id": "1768637405982", "mainCat": "出院记录", "subCat": "诊疗经过", "title": "腮腺肿瘤", "tags": "住院", "content": "患者入院后进入腮腺良性肿物临床路径诊疗，积极完善常规检查，各项化验检验结果回示后，提示未见明显异常，无手术禁忌证，于填报日期在全身麻醉下行“左耳后包块探查切除术+左腮腺浅叶部分切除术+左面神经解剖术”，术后予以预防性应用抗菌药物，同时给予患者消肿、止血补液等对症支持治疗。每日换药，术区加压包扎。现患者病情平稳，已按其临床路径完成诊疗，我科暂无特殊处理，患者要求出院，请示上级医师后，准予办理出院手续，交代出院后注意事项。"}, {"id": "1768637344382", "mainCat": "查房观察", "subCat": "", "title": "脓毒血症", "tags": "住院", "content": "今日查房见患者精神好，神志清楚，对答切题，自诉呼吸顺畅。体格检查：心率60次/分，呼吸20次/分，血氧饱和度99%，血压93/61mmHg；专科检查：患者面型欠对称，左侧下颌角处软组织稍显红肿，程度较前明显好转，术区敷料中间见少许渗出浸湿，未见活动性出血，揭起敷料后见引流管在位，引流通畅，左侧肩颈部皮肤无明显肿胀，颌下区水肿较前明显消退，皮肤不红，皮温不高。患者张口受限，张口度约一指半，口内见左侧咽旁肿胀较前明显消退，左侧颊龈沟处未见明显肿胀膨隆。因患者各项生命体征平稳，患者精神状态好，给予停止心电监护、吸氧及生命征监测，继续脓腔冲洗，更改引流管继续引流，敷料包扎。&nbsp;"}, {"id": "1768637307694", "mainCat": "查房观察", "subCat": "", "title": "下颌骨骨折", "tags": "住院", "content": "患者精神状态良好，饮食稍差，夜间睡眠良好，大小便如常，未诉其他不适。患者口内见术区创面清洁，表面少许假膜覆盖，缝线在位无松脱，伤口对位愈合好，无明显感染征象。咬合关系呈前牙反合，磨牙呈近中关系，舌体活动度良好。"}, {"id": "1768637280551", "mainCat": "查房观察", "subCat": "", "title": "急性冠周炎", "tags": "住院", "content": "今日查房，患者精神状态正常，饮食良好，睡眠正常，二便如常，未诉特殊不适。患者右侧面部肿胀较前消退，扪及疼痛减轻，张口度约两指半，口内见右侧下颌48周围牙龈仍红肿，挤压对应外侧皮肤，仍可见少量暗灰色脓性渗出，量较前减少，口腔卫生差。今日继续给予患者注射用头孢唑啉钠1.0g(三明)每次1g,氯化钠注射液每次100ml,静脉滴入 Bid;地塞米松磷酸钠注射剂（三明）每次10mg,5％葡萄糖注射液每次500ml,维生素C注射液（三明）每次1g,静脉滴入 QD，观察患者感染控制情况，待感染控制后再行进一步治疗患牙。"}, {"id": "1768637258135", "mainCat": "查房观察", "subCat": "", "title": "舌病损", "tags": "住院", "content": "患者精神状态佳，夜间睡眠良好，饮食稍差，二便如常，未诉特殊不适。患者面型欠对称，张口轻微受限，张口度约两指半，口内见舌腹部创面少许假膜覆盖，创口无明显渗出溢脓，缝线在位稳妥，周围组织未见红肿，舌体无明显肿胀，活动度正常，发音明确，伸舌自如。口腔卫生维持一般。"}, {"id": "1768637225262", "mainCat": "查房观察", "subCat": "", "title": "皮肤创口愈合", "tags": "住院", "content": "患者精神良好，饮食正常，睡眠良好，二便如常，未诉特殊不适。患者面型基本对称，右侧肿胀已基本消退，创面干燥清洁，周围皮肤色泽正常，皮温不高，未扪及波动感，创口未见明显红肿，无明显渗出，少许结痂，缝线在位无松脱，未见明显面神经功能障碍。"}, {"id": "1768637196382", "mainCat": "查房观察", "subCat": "", "title": "皮肤创面愈合情况", "tags": "住院", "content": "患者精神良好，饮食正常，睡眠良好，二便如常，未诉特殊不适。患者右额部肿物已经手术切除，周围皮肤色泽正常，皮温不高，创口未见明显红肿，无明显渗出，少许结痂，缝线在位无松脱，未见明显面神经功能障碍。"}, {"id": "1768637162398", "mainCat": "查房观察", "subCat": "", "title": "脓肿切开引流术后", "tags": "住院", "content": "患者左侧颊部皮肤肿胀较前减轻，表面皮肤色泽稍红，皮温无明显升高，未触及波动感，无捻发感。左侧颌下区肿胀较前减轻，可见敷料松脱，可见敷料被脓性分泌物浸染，量多，揭开敷料后可见患者颌下区引流管固定在位，引流通畅，切口内可见灰白色脓性炎性肉芽形成。"}, {"id": "1768637101399", "mainCat": "查房观察", "subCat": "", "title": "脓肿切开引流", "tags": "住院", "content": "患者精神良好，进软食，较前明显好转，睡眠正常，二便正常，未诉特殊不适。患者面型不对称，右侧面部及颌下肿胀较前有所好转，肿胀减轻，疼痛减轻，敷料包扎在位，敷料可见浸湿，渗出量较前明显减少，术区引流管引流通畅，引流在位，张口受限，张口度约两指，口内见拔牙术区创面见少许渗出。"}, {"id": "1768635942816", "mainCat": "诊疗计划", "subCat": "手术计划", "title": "术后首次病程", "tags": "住院", "content": "术后给予患者全麻术后常规护理，心电监测、持续吸氧及血氧饱和度监测等一级护理，患者摘除右侧颌下腺，导管结石与口内相通，创口较大，有感染风险，术后继续予以头孢唑林钠预防感染治疗，同时给予患者布洛芬止痛、酚磺乙胺止血、地塞米松消肿、补液等对症支持治疗，VTE危险因素评估(Caprini模型)1分，因患者为全麻手术，遂暂予以卧床休息，待患者病情平稳后自主活动即可，暂无处理。营养风险筛查1分，密切观察患者创口渗血情况。"}, {"id": "1768635828351", "mainCat": "诊疗计划", "subCat": "手术计划", "title": "出院前一天", "tags": "住院", "content": "现患者病情稳定，我科暂无特殊处理，应患者及家属要求，准予办理出院手续，告知患者出院后注意事项。"}, {"id": "1768635797392", "mainCat": "诊疗计划", "subCat": "手术计划", "title": "术后第二天", "tags": "住院", "content": "患者手术创伤较大，且口腔卫生不易保持，易发生感染，故继续给予患者预防性应用抗菌药物，同时给予患者消肿、镇痛补液等对症支持治疗，警惕患者伤口感染。持续观察患者口腔内创口愈合情况。"}, {"id": "1768635778304", "mainCat": "诊疗计划", "subCat": "手术计划", "title": "术后第一天", "tags": "住院", "content": "患者各项术后生命体征平稳，停止患者心电监测、持续吸氧及血氧饱和度监测等一级护理，并继续行预防性使用抗生素，同时给予患者消肿、镇痛、护胃、补液等对症支持治疗。"}, {"id": "1768635760664", "mainCat": "诊疗计划", "subCat": "手术计划", "title": "术前一天", "tags": "住院", "content": "患者各项检查结果已回，结果提示未见明显异常，无明显手术禁忌证，拟于明日麻醉方法下行“手术/操作名称”，术前与患者沟通手术必要性及不良后果，签署手术知情同意书，完善术前准备，术前禁饮食，待术。"}, {"id": "1768635736736", "mainCat": "诊疗计划", "subCat": "手术计划", "title": "入院第一天", "tags": "住院", "content": "<div>1、入院后给予二级护理，按照口腔颌面外科常规护理进行；<\/div><div>2、入院后完善三大常规、肝肾功能、凝血功能、电解质、血糖、感染免疫学、心电图、胸片、上下颌骨CT等检验检查；<\/div><div>3、待排除手术禁忌症后择期手术；该患者VTE风险Caprini评分0分，低危组，患者既往无下肢静脉血栓病史，且患者现可自主活动，遂暂不予处理，营养风险筛查评分0分。<\/div><div>4、该病符合颌骨囊肿临床路径，纳入该临床路径进行诊疗。<\/div>"}, {"id": "1768635715792", "mainCat": "诊疗计划", "subCat": "手术计划", "title": "入院第二天", "tags": "住院", "content": "完善术前各项检查，结合患者病灶CT结果，患者有明显手术适应证，经入院后排查，无明显绝对手术禁忌证，可排择期手术治疗。完善术前准备，告知患者手术必要性及不良后果，签署手术知情同意书。"}, {"id": "1768635660968", "mainCat": "诊疗计划", "subCat": "药物治疗", "title": "抗生素用药", "tags": "住院", "content": "目前患者肿胀较前消退，可继续当前治疗方案，因患者创口较深大，且与口内相通，易继发感染，故继续抗菌药物预防感染。"}, {"id": "1768635575376", "mainCat": "鉴别诊断", "subCat": "常见病鉴别", "title": "舌下腺肿物", "tags": "住院", "content": "<div>1、口底皮样囊肿：位于口底正中，成圆形或卵圆形，边界清楚，表面粘膜及囊壁厚，囊腔内含半固体状皮脂性分泌物，扪诊有面团杨柔韧感，无波动感，可有压迫性凹陷。肿物表面颜色与口底粘膜相似而非浅紫蓝色。<\/div><div>2、下颌下区囊性水瘤：常见于婴幼儿，穿刺检查见囊腔内容物稀薄，无粘液，淡黄清亮，图片检查可见淋巴细胞。<\/div>"}, {"id": "1768635553889", "mainCat": "鉴别诊断", "subCat": "常见病鉴别", "title": "白塞病", "tags": "住院", "content": "<div>1.系统性红斑狼疮&nbsp; 可有眼部病变、口腔溃疡及神经、心血管系统病变，但其病情进行性加重，并不呈周期发作性，而且LE细胞、抗核抗体阳性，这些异常发现决不见于白塞病。<\/div><div>2.韦格内肉芽肿&nbsp; 虽有眼部病变及多系统损伤，但其病情进行性恶化，肺部X线检查可见有变化多端的浸润影，有时可有空洞形成，组织病理特征为肉芽肿性血管炎，而且肾功能损害严重，无阴部溃疡，针刺试验阴性，很易与白塞病相鉴别。<\/div><div>3.结核性关节炎&nbsp; 有时伴有结节性红斑，但无眼部损害及阴部溃疡，一般也无心血管及神经系统损害，抗结核治疗有效。虽然结核菌感染可引起白塞病，对抗痨治疗有效，但结核杆菌引起的白塞病不仅有结节性红斑和关节炎，而且还有血管系统、神经系统及黏膜改变，二者鉴别并不困难。<\/div><div>4.多发性大动脉炎&nbsp; 当白塞病以血管病变为主要临床表现时，应与多发性大动脉炎相区别。后者主要表现为上肢或下肢无脉症，无口腔、阴部溃疡，组织病理改变为巨细胞动脉炎，无静脉改变，针刺反应阴性，很少有皮损。<\/div><div>5.克罗恩病&nbsp; 肠道白塞病与克罗恩病有相似的临床表现，但仍应作为两种不同的疾病对待。不完全型肠道白塞病与克罗恩病都伴有口腔、会阴溃疡者，临床上不易鉴别。此时通过组织病理及血管造影可将两者加以区分开来。<\/div>"}, {"id": "1768635521584", "mainCat": "鉴别诊断", "subCat": "常见病鉴别", "title": "牙槽突骨折", "tags": "住院", "content": "<div>1、单纯牙脱位 表现为牙齿的松动和脱离正常的牙列，可有牙龈出血、肿胀和唇的损伤，但一般无两个以上的牙齿“联动” 现象。<\/div><div>2、上颌骨骨折 主要应与上颌骨低位骨折相鉴别。此类骨折的骨折线自梨状孔下部开始，沿牙槽突以及上颌结节的上方，水平向后延伸至翼突。摇动骨折片上的牙齿，可见整个骨块随之活动，且联动的牙齿比较多。<\/div><div>3、下颌骨骨折 骨折片的移动度通常不如牙槽突骨折时明显，如为下颌骨体部的双线骨折，骨折片动度明显，同时可检查到骨断端的骨擦感以及台阶等体征。<\/div>"}, {"id": "1768635498376", "mainCat": "鉴别诊断", "subCat": "常见病鉴别", "title": "涎石症", "tags": "住院", "content": "<div>1、舌下腺肿瘤绝大多数舌下腺肿瘤无导管阻塞症状，有极少数因肿瘤压迫下颌下腺导管出现不全阻塞症状，X线检查无阳性结石。<\/div><div>2、下颌下腺肿瘤 下颌下腺呈进行性肿大。无进食肿胀或下颌下腺炎症发作史。<\/div><div>3、慢性硬化性下颌下腺炎 呈硬结性肿块。肿块虽硬但一般不大，无进行性增大的表现。<\/div><div>4、下颌下淋巴结炎反复肿大，但与进食无关，下颌下腺分泌正常。下颌下淋巴结位置较表浅，容易抇及并常有触痛。<\/div><div>5、下颌下间隙感染 有牙痛史并能查及病源牙。下颌下区肿胀呈硬性浸润，皮肤潮红并可出现凹陷性水肿。下颌下腺导管分泌可能减少但唾液正常，无涎石阻塞症状。<\/div>"}, {"id": "1768635458536", "mainCat": "鉴别诊断", "subCat": "常见病鉴别", "title": "血管神经性水肿", "tags": "住院", "content": "<div>1、蜂窝织炎为牙源性感染，多有牙痛病史，在肿胀部位 可找到患牙。局部有红、肿、热、痛炎症特点。有压痛或脓肿形成。抗生素治疗有效。<\/div><div>2、丹毒局部明显潮红肿胀，边缘清楚，局部有压痛，全身有发热、头痛不适等症状。为急性感染性进行性炎症。好发 于面唇部。也可呈慢性过程。<\/div><div>3、虫咬症在以单个皮损为表现时容易误诊，本病有叮咬史，肿胀的皮损上可见有小水疤或很细小的叮咬痕迹，有明显的痛痒或疼痛。<\/div><div>4、面肿型皮肤恶性网状细胞增生症 常为一侧性面部或上唇处持续性肿胀不退，表面皮肤正常，无自觉表现；病理检查的特异表现可以确诊。<\/div><div>5、Melkersson-Rosenthal综合征该病主要以肉芽肿性 唇炎、面神经麻痹和裂纹舌三联或两联表现相继出现为特点，个别仅有肉芽肿性唇炎表现时容易误诊，但持续时间较久，可达数周或数月或持续不退；病理改变偶可见与结节病相似的上皮样细胞肉芽肿。<\/div><div>6、上腔静脉梗阻综合征颈部以上弥漫性持续性水肿，常伴有眼脸红斑和胸壁静脉怒张等。<\/div>"}, {"id": "1768635430120", "mainCat": "鉴别诊断", "subCat": "常见病鉴别", "title": "化脓性颌骨骨髓炎", "tags": "住院", "content": "<div>1、颌骨肿瘤：良性肿瘤为无痛、生长缓慢的肿块，可扪及表面光滑的结节状。恶性肿瘤多为渐进性增大或缓慢生长而近期生长加快可伴有局部疼痛和神经疼痛或麻木症状。肿块小者可活动，轻微压痛，大者质硬，活动度差。病史中使用抗生素治疗无效，且肿瘤继续生长。与该患者病情不符，故予以排除。<\/div><div>2、颌骨血外渗性囊肿：为损伤后引起骨髓内出血、机化、渗出后形成，与牙组织本身无关，临床极为少见，多发生于青壮年，病人有明显损伤史，牙数目正常，无移位现象；囊肿无明显上皮衬里，仅为一层纤维组织，X线片边缘常显示不清楚。与该患者病情不符，故予以排除。&nbsp;<\/div><div>1、下颌骨中心型癌：下颌骨中心型癌可出现牙痛、局部颌骨疼痛，并相继出现下唇麻木，牙齿松动、甚至脱落。一般无急性炎症的表现。X线早期表现为根尖区不规则虫蚀状破坏，以后逐步破坏并浸润骨密质，但无增生修复的表现，如骨膜增生等，与本病不符，予以鉴别。<\/div><div>2、慢性根尖周炎：表现为根尖部的慢性炎症，有长期牙疼病史，行根管治疗或拔除患牙后可治愈，该患者无不适，与本病不符，予以鉴别。<\/div><div>1、牙龈炎：表现炎症局限性游离龈颌龈乳头，常有牙龈出血，牙龈边缘圆顿肥大，与本病不符，予以鉴别。<\/div><div>2、根尖囊肿：通常并有局部病灶牙，生长缓慢，多无自觉症状，囊肿大小可由豌豆大到鸡蛋大，小囊肿不易发现，增大时才被发现，根部部位有膨隆，表面黏膜色泽正常，根尖见低密度影，界限清楚，周围可见骨白线。与该患者病情不符，故予以排除。&nbsp; &nbsp;<\/div><div><br><\/div><div>1、下颌骨中央性颌骨骨髓炎应与下颌骨中心型癌相鉴别 下颌骨中心型癌可出现牙痛、局部颌骨疼痛，并相继出现下唇麻木，牙齿松动、甚至脱落。一般无急性炎症的表现。X线早期表现为根尖区不规则虫蚀状破坏，以后逐步破坏并浸润骨密质，但无增生修复的表现，如骨膜增生等。<\/div><div>2、下颌骨边缘性骨髓炎的增生型应与骨肉瘤及纤维肉瘤相鉴别&nbsp; 后两者在临床上有共同的临床表现，最后确诊主要靠病理诊断。多见于青年及儿童，病程较快，呈进行性地颌面骨膨胀性生长，也可出现局部牙痛、牙齿松动甚至自行脱落；皮肤表面常有血管扩张及充血；颌面骨在影像学检查中均有不同程度、不同性质的骨质破坏，且呈中心性由内向外发展；后期肿块破溃，可伴发溢液或出血。<\/div><div>3、上颌骨骨髓炎应与上颌窦癌相鉴别 根据肿瘤不同的原发部位而先后出现不同的症状，如牙痛、牙移位、牙松动、脱落；鼻塞、血性鼻涕、鼻衄；颊部麻木、肿胀；溢泪、复视；头痛、面痛、异物感等。影像学检查可见上颌窦有不规则的骨质破坏，上颌窦穿刺活检可明确诊断。<\/div>"}, {"id": "1768635380120", "mainCat": "鉴别诊断", "subCat": "常见病鉴别", "title": "上颌窦炎症", "tags": "住院", "content": "<div>1、化脓性上颌骨骨髓炎 也有急慢性之分。 急性期多有上颌牙痛史，疼痛剧烈，多放射到耳颞部，面部肿胀不明显。有发热及全身不适。随着病程的进展，可出现多个牙松动、龈沟溢脓和口臭。当脓液穿破骨皮质，形成蜂窝织炎后，可出现间隙感染症状，面部出现明显肿胀。全身中毒症状明显：高热、脱水、白细胞计数明显增高，有核左移现象。<\/div><div>2、上颌窦癌 根据不同的原发部位而出现不同的症状。内下部：先出现口腔及鼻部症状，如牙痛、牙移位、松动、脱落，鼻塞、流涕、鼻出血等；外下部：先出现口腔及面颊部症状，如颊部麻木、肿胀等；内上部：先出现鼻部及眼部症状，如溢泪、复视等；外上部：先出现面颊部及眼部症状；后深部：先出现张口受限或神经症状，如头痛、面痛、麻木感、异物感等。X线摄片、CT 检查均可见上颌窦有不规则的骨质破坏。<\/div><div><br><\/div>"}, {"id": "1768635328537", "mainCat": "鉴别诊断", "subCat": "常见病鉴别", "title": "牙脱位", "tags": "住院", "content": "<div>1、牙部分脱位应与牙震荡相鉴别，二者皆为外伤所致，牙震荡所受外力较轻微，患牙仅有伸长不适感，常有叩痛及轻微松动，牙跟可有少量出血，X线片多无明显异常。<\/div><div>2、牙完全性脱位应与牙根折相鉴别，牙根折特别是根尖处折裂时，如不注意观察，往往可忽视残留于牙槽窝内的残根，误诊为牙完全脱位。根尖处折裂时牙根不完整，可见较锐利的断端，认真检查牙槽窝可发现残留的牙根。<\/div><div><br><\/div>"}, {"id": "1768635308665", "mainCat": "鉴别诊断", "subCat": "常见病鉴别", "title": "牙折裂", "tags": "住院", "content": "与牙震荡鉴别：与牙折一样，牙震荡也有外伤史，患牙可有伸长感，有咬合痛，检查可有叩痛或有轻度松动，但大多无牙体缺损，x线片检查多无异常或有轻度的根尖牙周膜增宽，无牙折线。"}, {"id": "1768635287032", "mainCat": "鉴别诊断", "subCat": "常见病鉴别", "title": "慢性牙髓炎", "tags": "住院", "content": "<div>(1)深龋：无典型自发痛症状的慢性牙髓炎有时与深龋不易鉴别。深龋时往往是当温度刺激进入洞内才出现敏感或疼痛症状，刺激去除后症状立即消失；而慢性牙髓炎对温度刺激引起的疼痛反应会持续较长时间。 另外，深龋叩诊无明显异常，而慢 性牙髓炎可有轻度叩痛。<\/div><div>(2)可复性牙髓炎：对冷、热温度刺激或酸、甜化学刺激，特别是冷刺激敏感，引起瞬间疼痛，刺激去除后症状立即消失；叩诊无明显异常。<\/div><div>(3) 干槽症：患侧近期有拔牙史。 检查可见牙槽窝空虚，骨面暴露，有明显臭味。 拔牙窝邻牙也可有冷、热刺激敏感或叩痛，但无明确的牙髓疾患指征。<\/div>"}, {"id": "1768635270577", "mainCat": "鉴别诊断", "subCat": "常见病鉴别", "title": "急性牙髓炎", "tags": "住院", "content": "<div>&nbsp; &nbsp; (1)三叉神经痛：发作一般有疼痛＂扳机点“,当触及该点时即诱发剧烈疼痛。三叉神经痛很少在夜间发作，且冷、热温度刺激并不引起疼痛。<\/div><div>&nbsp; &nbsp; (2) 龈乳头炎：跟乳头炎也可出现剧烈的自发性疼痛，但疼痛性质为持续性胀痛，对温度测验敏感，但不会导致激发痛，患者对疼痛多可定位。 检查时可发现局部跟乳头充血、水肿，有明显触痛。 患处两邻牙间可见有食物嵌塞的痕迹或可问及食物嵌塞史。 一般不能查及引起牙髓炎的牙体硬组织损害。<\/div><div>&nbsp; &nbsp; (3)急性上颌窦炎：急性上颌窦炎时，患侧的上颌后牙可出现类似牙髓炎的疼痛症状，也可放散至头、颖、面部而易被误诊。但上颌窦炎时的疼痛为持续性胀痛，患侧的上颌前磨牙和磨牙 可同时受累而致二三颗牙均有叩痛，但无引起牙髓炎的牙体硬组织疾患，上颌窦前壁可有压痛，同时，患者还可能伴有头痛、鼻塞、脓涕等症状。<\/div>"}, {"id": "1768635248624", "mainCat": "鉴别诊断", "subCat": "常见病鉴别", "title": "可复性牙髓炎", "tags": "住院", "content": "<div>&nbsp; &nbsp; (1)深龋：患有深龋的患牙对温度刺激也敏感，但往往是当冷、热刺激进入深龋洞时才出现疼痛，且刺激去除后症状并不持续。 在临床上，二者往往很难区别，此时可按可复性牙髓炎的治疗原则进行处理。<\/div><div>&nbsp; &nbsp; (2)不可复性牙髓炎：二者鉴别的关键在于可复性牙髓炎绝无自发痛病史，而不可复性牙髓炎一般有自发痛史，且温度刺激去除后，疼痛反应持续时间较长久，有时患牙可有轻度叩痛。如二者一时难以鉴别，可先采用诊断性治疗的方法，即用氧化锌丁香油粘固剂进行安抚治疗，如出现自发性疼痛，则应诊断为不可复性牙髓炎。<\/div><div>&nbsp; &nbsp; (3)牙本质过敏症：患牙往往对探、触等机械刺激和酸、甜等化学刺激更为敏感。 而可复性牙髓炎主要对冷、热温度刺激一过性敏感。<\/div>"}, {"id": "1768635222641", "mainCat": "鉴别诊断", "subCat": "常见病鉴别", "title": "面颈部化脓性淋巴结炎", "tags": "住院", "content": "<div>1、结核性淋巴结炎&nbsp; 以颈部淋巴结常见。<\/div><div>2、结节病(肉样瘤)&nbsp; 临床表现与慢性淋巴结炎相似，有时肝、脾、肺、皮肤、骨髓、涎腺、泪腺也能受累。组织学形态不同于淋巴结炎，颇似结核。形成由类上皮细胞、淋巴细胞和多核巨细胞形成的肉芽肿样改变，但类上皮细胞增生极为显著，结节较小，倾向于分散，不融合，没有干酪样坏死，但可伴有少量纤维素样坏死，有时可出现同心圆状钙化灶。多核巨细胞核数量较多，一般大小，但胞核一般不呈马蹄铁状排列。<\/div><div>3、急性化脓性颌下腺炎&nbsp; 二者均发生在颌下区，后者常因外伤、导管异物或结石阻塞而继发感染，而前者可查出牙源性感染、扁桃体炎或口腔感染等病史。急性化脓性颌下腺炎肿块的体积通常较大，为颌下腺的轮廓，双合诊检查在颌下区及口内均可扪及，包块的位置深而固定，压迫肿大的腺体可从导管口挤出脓性分泌物，导管口乳头有红肿等炎症表现。而急性化脓性颌下淋巴结炎仅位于颌下区内，在口内无法触及肿大的淋巴结，通常肿大的淋巴结与肿大的颌下腺相比较，相对表浅，颌下腺导管乳头无炎症表现。<\/div><div>4、恶性淋巴瘤&nbsp; 临床上也常以淋巴结肿大而被发现。因为它是源于淋巴网状组织的恶性肿瘤，故往往可发生于全身多处淋巴结内。恶性淋巴瘤早期往往无自觉症状，无炎症病史，并且随着病变进展呈持续性、渐重的(反复或持续低热，也可高热)反应，并有疼痛(肿瘤性淋巴结长大压迫神经所致)以及相邻重要器官受侵的症状。局部淋巴结起初为单个肿大，可活动，以后可互相融合，并向附近淋巴结群扩展。抗感染治疗不见效。病理取材可见淋巴结剖面呈烂鱼肉样，正常结构消失。镜下主要需与霍奇金淋巴瘤鉴别，即虽然后者也可见各类慢性炎症细胞，但伴有异型组织细胞、Reed-Stemberg细胞(R-S细胞)，这种肉芽肿样组织占淋巴结一个相当大区域，形成边界不清的肿块病灶，分布不均，这与淋巴结炎不同。<\/div><div>5、传染性单核细胞增多症&nbsp; 为一种呈亚急性、良性、有自限性的淋巴组织增生性病变，也多表现为颈浅淋巴结的肿大。但触之较软，且可自行缩小、消退，常伴有肝功能异常、黄疸等全身症状，组织学上似霍奇金淋巴瘤，有R-S样T、B免疫母细胞及一般炎性增生特点，且淋巴结结构基本完整，其R-S样细胞体积小，核规则，染色质不成块状，核仁也小，但血象检查除白细胞计数升高，淋巴细胞可达60%～80%外，血清内尚可查见EB病毒抗体及异嗜性抗体可资鉴别。<\/div><div>6、人类免疫缺陷病毒感染(AIDS)&nbsp; 人类免疫缺陷病毒(human immunodeficiency virus，HIV)感染者可出现颌下淋巴结肿大。但该病人往往为全身性淋巴结肿大，且可伴有发热、体重下降、并发多种病毒、真菌、原虫感染和Kaposi肉瘤等严重的全身症状。淋巴结镜下检查与慢性淋巴结炎不同，可有增生、部分破坏的渐进性变化，早期化验即可查出AIDS抗体，中晚期可出现渐进性的CD4细胞减少(正常时＞(0.45～0.5)×109/L，AIDS中期CD4＜0.4×109/L，晚期CD4＜0.2×109/L)，CD4/CD8＜1(正常时CD4/CD8＞2)，5年死亡率近100%。<\/div><div>7、组织细胞性坏死性淋巴结炎&nbsp; 又称Kikuchi病(菊池病)，多见于青年女性。临床上常表现为双侧颈部淋巴结肿大、疼痛，并伴有持续性高热，但白细胞减少，血沉加快，抗生素治疗无效，似恶性病变。不同的是其预后多良好，数月或数周可热退、自愈。组织学上表现为皮质区或副皮质区的灶性坏死，坏死灶周围或尚未坏死区有大量组织细胞，这不同于非特异性颌下淋巴结炎。该病病因不清，可能为病毒感染。<\/div><div>8、布氏杆菌性淋巴结炎(Brucellosis)&nbsp; 淋巴结的布氏杆菌病较少，临床上可出现发热，全身不适，乏力、关节痛和淋巴结肿大(1～2cm)。病理上，肿大的淋巴结结构尚存，与慢性淋巴结炎不同的是呈肉芽肿性炎症，可伴坏死、纤维化和淋巴窦细胞或组织细胞增生。从临床病史及血清学反应均可为确诊提供依据。<\/div><div>9、弓形虫病(toxoplasma)&nbsp; 或称毒浆菌病。为感染啮齿动物弓形虫所致。由于该病原体广泛分布于温暖潮湿处，且所有哺乳动物、鸟类都可感染，故本病并不少见。人体可因摄入含卵囊虫的猫粪污染食物或食入未煮熟的牛、羊、猪肉等感染，以儿童、青少年多见。临床常表现为单个或1组淋巴结肿大，压痛，以颈部、耳后、枕部和腮腺区多见。偶伴乏力、发热，若发生在妊娠妇女可致流产。其组织学不同于非特异性淋巴结炎，可见淋巴滤泡增生，生发中心大量类上皮样细胞、组织细胞、巨噬细胞浸润，且偶见小块干酪样坏死灶，有时见吞噬了成堆卵圆形病原体(长4～6μm，宽2μm)的巨噬细胞一假囊。此病原体可用Giemsa染色(紫红色)加以鉴别。还可伴淋巴结周围炎、滤泡间区免疫母细胞增生，上皮样小静脉增生等改变。<\/div><div>10、寄生虫性淋巴结炎&nbsp; 能引起颈部或颌下淋巴结肿大的寄生虫炎有丝虫炎和血吸虫炎等。可通过其周围嗜酸性细胞反应及血清学检查及病史等来确诊。<\/div><div>11、药物性淋巴结炎&nbsp; 主要见于因应用苯妥英钠或其衍生类抗惊厥药物后1周到数月后引起，临床上除伴有非特异性炎的淋巴结肿大、发热、白细胞增高等外，尚有血中嗜酸性粒细胞增高、皮肤过敏性斑、疹及肝、脾大等改变，且有因用药出现，停药减轻等病史。<\/div>"}, {"id": "1768635151640", "mainCat": "鉴别诊断", "subCat": "常见病鉴别", "title": "妊娠期龈炎", "tags": "住院", "content": "本病应与化脓性肉芽肿鉴别。后者发生于非妊娠期的妇女，临床表现与妊娠性龈炎十分相似，也可出现个别牙龈乳头的无痛性突起，有蒂或无蒂，牙龈颜色鲜红或暗红，质地柔软极易出血。多数病变表面有溃疡和脓性渗出物，一般多可找到局部创伤或刺激物。病理变化为血管瘤样的肉芽性病变。大量内皮细胞增殖和新生的毛细血管为其主要特征。上皮可萎缩或增厚，表面常有溃疡。"}, {"id": "1768635119320", "mainCat": "鉴别诊断", "subCat": "常见病鉴别", "title": "单纯疱疹", "tags": "住院", "content": "<div>(一)原发性疱疹性口炎应与疱疹样口疮(口炎型口疮)相鉴别 1.急性疱疹性口炎好发于婴幼儿,急性发作,全身反应较重。病损为成簇小水疱,疱破后成为大片表浅的溃疡;损害遍及口腔黏膜各处;可伴有皮肤损害；2.疱疹样口疮(口炎型口疮)好发于成人,反复发作,全身反应较轻。 病损为散在分布的单个小溃疡,不聚集成簇,分散但不融合,无发疱期;溃疡仅限于无角化黏膜;无皮肤损害。<\/div><div>(二)三叉神经带状疱疹 水疱较大,疱疹聚集成簇,沿着三叉神经分支排列,但不超过中线。 疼痛剧烈,甚至损害愈合后一段时间内仍有疼痛。 任何年龄都可发生,愈后不再复发。<\/div><div>(三)手足口病 多见于4岁以下幼儿,特点是手、足以及口腔出现红斑和水疱。 口腔损害比皮肤重。 可有前驱症状,之后在口腔黏膜、手掌、足底出现散在水疱、丘疹和斑疹,周围有红晕,无明显压痛,其中央为小水疱。 口腔损害遍布唇、颊、舌、腭等处,为很多小水疱,迅速形成溃疡,牙龈较少累及。5-10d后愈合。<\/div><div>(四)疱疹性咽峡炎 疱疹性咽峡炎由柯萨奇A-4病毒引起,表现为咽峡部成簇的小水疱,主要侵犯10岁以下的儿童。引起的溃疡边缘整齐。1.全身症状:较特殊,有早期的不适和发热,儿童体温可达38~40C,可出现腹痛、头痛,偶尔有肌痛。成人一般很少发热,全身症状较轻,有时可发生鼻炎以及咳嗽；2.口腔症状:本病仅限于口腔后部以及咽喉部,如软腭、腭垂、硬腭后部、咽周、扁桃体处,偶尔可见于舌后部,从不波及牙龈、颊。<\/div>"}, {"id": "1768635099577", "mainCat": "鉴别诊断", "subCat": "常见病鉴别", "title": "口腔疼痛", "tags": "住院", "content": "<div>(一)牙源性疼痛 1.常为牙髓炎、根尖周炎、牙周炎等引起,可找到病灶牙；2.具有相应疾病的疼痛特点,如冷、热激发痛,夜间加重;不能咬矜,叩痛明显；牙齿松动,有较深的牙周袋；或检查时发现牙齿隐裂等；3.X线检查可见有根尖阴影、牙周膜增宽或有深部埋伏牙等；4.多无全身中毒症状,一般白细胞不高。<\/div><div>(二)三叉神经痛 1.三叉神经分布区阵发性、激发性疼痛,有明确的“扳机点”,漱口、刷牙、洗脸或说话时均可引起发作;2.疼痛呈火灼、刀割、撕裂或针刺状,难以忍受；3.每次疼痛持续时间较短,一般数秒到数分钟；4.疼痛发作时,常伴有颜面表情肌的痉挛性抽搐,有时会出现痛区潮红、结膜充血、流泪、出汗、流涎以及患侧鼻腔黏液增多等症状；5.无局部红肿、发热等症状。<\/div><div>(三)颌面部恶性肿瘤 1.疼痛多为持续性钝痛,病程较长,进行性加重,当肿瘤侵犯感觉神经时,可伴有神经支配区麻木感；2.疼痛可波及半侧头颈部,多能找到原发病灶；3.一般无红、肿、热症状及白细胞升高现象；4.X线摄片或CT检查,可发现局部明显占位影像和骨质破坏影像。<\/div>"}, {"id": "1768635060698", "mainCat": "鉴别诊断", "subCat": "常见病鉴别", "title": "复发性口疮", "tags": "住院", "content": "<div>(一)MjAU（重型口疮）应与癌性溃疡、结核性溃疡、创伤性溃疡和坏死性涎腺化生相鉴别&nbsp;<\/div><div>1.癌性溃疡:无反复发作史,无自限性,缓慢或快速长大。边缘不整齐,基底硬,呈菜花状,好发于舌腹舌缘、口角区、软腭复合体,病理检查可见细胞癌变；<\/div><div>&nbsp; &nbsp; 2.结核性溃疡:有结核病史,溃疡深在,周围轻度浸润呈鼠噬状,底部有肉芽组织,病理检查可见朗汉斯巨细胞,无自限性；<\/div><div>&nbsp; &nbsp; 3.创伤性溃疡:局部有创伤或刺激因素存在,无复发性,深或浅,周围炎症不明显,形态与损伤因素契合。 病理表现为慢性炎症,去除刺激因素后愈合较快；<\/div><div>&nbsp; &nbsp; 4.坏死性涎腺化生:溃疡深及骨面,边界清楚,边缘可隆起,底部有肉芽组织。 该病发生于硬腭、软硬腭交界处。有自限性。<\/div><div>(二)HU（疱疹样口疮）应与急性疱疹性口炎相鉴别：<\/div><div>&nbsp; &nbsp; 1.HU:多发生于成年人,反复发作,全身反应较轻。溃疡散在,仅限于口腔的无角化黏膜,无皮肤损害,溃疡无发疱期；<\/div><div>&nbsp; &nbsp; 2.急性疱疹性口炎:多发于婴幼儿,急性发作,全身反应重。成簇小水疱,疱破后形成溃疡面。可发生于口腔黏膜任何部位,包括角化牙龈,伴有皮肤损害。<\/div>"}, {"id": "1768635024777", "mainCat": "鉴别诊断", "subCat": "常见病鉴别", "title": "灼口综合征", "tags": "原始模板, 住院", "content": "<div>灼口综合征<\/div><div>(一)口腔溃疡 特别是舌根部的溃疡,可发生在任何年龄,在语言、吞咽等舌体运动时,舌根部出现明显的疼痛,进食酸辣等刺激食物时疼痛加重,常为尖锐的疼痛。 检查时可见舌根部有明确的溃疡病损,周围充血、水肿,触痛明显。与该患者病情不符，故予以排除。<\/div><div>(二)舌乳头炎 是由多种原因引起的丝状乳头、菌状乳头、轮廓乳头、叶状乳头炎症性反应。 表现为舌乳头部位疼痛不适,也可有烧灼样疼痛、刺激痛,检查舌体,除丝状乳头以萎缩为主外,其他舌乳头以充血肿胀为主,可有明显触痛。与该患者病情不符，故予以排除。<\/div><div>(三)舌癌 好发于舌侧缘中1/3部位,局部多有慢性刺激因素存在,如残根或锐利牙嵴等,可查到明显的溃疡或浸润块,常有明显的自发痛及触痛,且可反射至耳颞部。 当肿瘤广泛浸润时,可波及舌及舌下神经和舌外肌群而有舌感觉麻木与舌运动障碍。与该患者病情不符，故予以排除。<\/div><div><br><\/div><div>茎突舌骨综合征<\/div><div>(一)舌咽神经痛 生于舌根部、扁桃体区、颈深部及下颌后区等部位的阵发性激发性剧烈疼痛,发作时,咽喉部有梗塞感和异物感,常出现频繁的咳嗽。 在扁桃体部、舌根部等处可扪及“扳机点”,局部涂抹表面麻醉剂疼痛症状可减轻或消失。疼痛时间持续较短。影像学检查无茎突过长现象。与该患者病情不符，故予以排除。<\/div><div>(二)灼口综合征 多见于更年期女性,在说话或吞咽时自觉舌根、舌缘、舌尖或咽部发生疼痛,同时伴有某些精神、心理障碍症状,检查口咽部无明显器质性病变存在。与该患者病情不符，故予以排除。<\/div>"}, {"id": "1768634993697", "mainCat": "鉴别诊断", "subCat": "常见病鉴别", "title": "甲状舌管囊肿", "tags": "住院", "content": "<div>1、颏下淋巴结炎：表现为颏部肿物，局部压痛明显，肿物不随吞咽上下移动，无条索物与舌骨 相连。与该患者病情不符，故予以排除。<\/div><div>2、皮样囊肿：圆形或卵圆形，边界清楚，表面粘膜及囊壁厚，囊腔内含半固体状皮脂性分泌物，扪诊有面团样柔韧感，无波动感，可有压迫性凹陷。与该患者病情不符，故予以排除。<\/div><div>3、异位甲状腺：位于舌根部或舌盲孔的咽部，呈瘤状突起，表面紫蓝色，质地柔软，周围界限清楚。碘131甲状腺扫描有核素浓聚。与该患者病情不符，故予以排除。<\/div>"}, {"id": "1768634971769", "mainCat": "鉴别诊断", "subCat": "常见病鉴别", "title": "腮裂囊肿", "tags": "住院", "content": "<div>1、神经鞘瘤：穿刺时抽出血样液体，但不凝结是其特点。鳃裂囊肿穿刺可抽出囊液，见有棕色、清亮或微混的、含或不含胆固醇结晶的液体。与该患者病情不符，故予以排除。<\/div><div>2、颈动脉体瘤：颈部触诊可有搏动感，鳃裂囊肿有波动感，无搏动感。与该患者病情不符，故予以排除。<\/div>"}, {"id": "1768634942904", "mainCat": "鉴别诊断", "subCat": "常见病鉴别", "title": "流腮", "tags": "住院", "content": "<div>1、慢性淋巴结炎：耳前淋巴结或颌下淋巴结的慢性炎症也可表现为无痛性肿块，但常有感染来源，如面部、口腔或咽部的炎症。肿块常为多个，有时大时小的消长史，抗感染治疗常可奏效。与该患者病情不符，故予以排除。<\/div><div>&nbsp; &nbsp; &nbsp;2、化脓性腮腺炎：常为一侧腮腺局部红肿、压痛明显，晚期有波动感，挤压时有脓液自腮腺导管口流出，腮腺导管口位于第二磨牙相对的颊粘膜处。分泌物涂片及培养可发现化脓菌。白细胞总数和中性粒细胞明显增高。与该患者病情不符，故予以排除。<\/div><div>&nbsp; &nbsp; &nbsp;3、颈部及耳前淋巴结炎肿大：不以耳垂为中心，局限于颈部或耳前区，边缘清楚，压痛明显，表浅者可活动。可发现颈部或耳前区淋巴结相关组织有炎症，如咽峡炎、耳部疮疖等。白细胞总数及中性粒细胞明显增高。<\/div><div>&nbsp; &nbsp; &nbsp;4、症状性腮腺肿大：在糖尿病、营养不良、慢性肝病中，某些药物如碳化物，泾保泰松、异丙肾上腺素等可致腮腺肿大。 其特点为：对称性，无肿痛感，触之较软，组织检查主要为脂肪变性。<\/div><div>&nbsp; &nbsp; &nbsp;5、其他病毒所引起的腮腺炎：如单纯疤疹病毒、副流感病毒IlI型、柯萨奇病毒A组和B组、甲型流感病毒等均可引起腮腺炎。确诊需借助于血清学检查及病毒学分离。<\/div>"}, {"id": "1768634924073", "mainCat": "鉴别诊断", "subCat": "常见病鉴别", "title": "面部创伤", "tags": "住院", "content": "<div>1、挫伤：皮下及深部组织遭受力的挤压损伤而无开放性创口。多见于钝器作用造成以皮内或/和皮下软组织出血为主要改变的闭合性损伤。临床表现为局部皮肤变色、疼痛、肿胀甚至血肿形成。与该患者病情不符，故予以排除。<\/div><div>&nbsp; &nbsp; &nbsp;2、擦伤：有明显外伤病史。受伤部位皮肤表层破损，创面常附着泥沙或其他异物，有点片状创面或少量点状出血，伴有明显疼痛。与该患者病情不符，故予以排除。<\/div><div>&nbsp; &nbsp; &nbsp;3、刺、割伤：均有皮肤裂口，刺伤的创口小而伤道深，多为盲管伤，刺伤的刺入物可将砂土和细菌带入创口深处；切割伤的创缘整齐，伤及大血管时可引起大量出血。与该患者病情不符，故予以排除。<\/div><div>&nbsp; &nbsp; &nbsp;4、撕裂或撕脱伤：常见较大的机械力作用于组织，当超过组织的耐受力时，将组织撕裂甚至撕脱。可见于动物致伤。撕脱伤的伤情较重，出血多，疼痛剧烈，易发生休克。创口边缘多不整齐，皮下及肌肉组织均有挫伤，常有骨面裸露，时有组织缺损。与该患者病情不符，故予以排除。<\/div><div>&nbsp; &nbsp; &nbsp;5、裂伤：有明显外伤病史，主要见于车祸、摔伤及刀砍（划）伤等，皮肤或粘膜出现开放性裂口，深及皮下及更深部位，创口边缘可整齐也可不整齐，一般情况下，创口长度大于创口深度，多有出血（或大出血）、疼痛并伴有不同程度肿胀等特点。伤及周围神经还能出现相应功能感觉障碍。腮腺区裂伤还可出现腮腺导管断裂情况，病情较复杂，预后较差。与该患者病情不符，故予以排除。<\/div><div>&nbsp; &nbsp; &nbsp;6、颌骨骨折：有明显的外伤史，外力直接或间接地作用于颌面部所致。除局部肿胀淤血外，有骨擦音，触诊有台阶感，X线检查可见骨皮质连续性中断。临床表现为骨折段移位、张口受限和咬合关系紊乱、骨折段异常活动，甚至影响呼吸吞咽及感觉视觉障碍。与该患者病情不符，故予以排除。<\/div><div>&nbsp; &nbsp; &nbsp;7、颅底骨折：有明确的外伤史，邻近软组织有明显的迟发性瘀斑，呕吐黑红色或咖啡色液体，伤后数小时出现“熊猫眼”征，可有脑脊液鼻漏、不同程度的嗅觉障碍和视力下降，可伴有额叶的脑挫裂伤。影像学检查发现颅内积气为颅底骨折的重要证据。与该患者病情不符，故予以排除。<\/div><div>&nbsp; &nbsp; &nbsp;8、颌面部间隙感染：局部红、肿、热、痛、功能障碍，严重可形成脓肿，一般无外伤史，仔细检查可找到病灶牙。与该患者病情不符，故予以排除。<\/div>"}, {"id": "1768634896545", "mainCat": "鉴别诊断", "subCat": "常见病鉴别", "title": "阻生牙", "tags": "住院", "content": "<div>1、牙周炎：早期症状不明显，常伴有牙龈出血或口臭的表现，与牙龈炎相似，但牙周炎有牙周袋的形成，牙周溢脓甚至牙齿松动。与该患者病情不符，故予以排除。<\/div><div>&nbsp; &nbsp; &nbsp;2、龋齿：龋齿患者对冷热酸甜等刺激有明显的反应，进食时可感觉到不适。有明显牙体硬组织色、形、质的改变。与该患者病情不符，故予以排除。<\/div><div>&nbsp; &nbsp; &nbsp;3、牙列拥挤：是错合畸形中最常见者，可表现为牙齿拥挤错位排列不齐；拥挤的牙齿易发生龋及牙周病。与该患者病情不符，故予以排除。<\/div><div>&nbsp; &nbsp; &nbsp;4、四环素牙：又称为染色牙，是小儿在牙齿发育钙化时期服用了四环素类药物，造成牙齿硬组织的矿化抑制，表现为牙齿变色或釉质发育不全，使牙齿呈黄色、灰色或灰褐色。与该患者病情不符，故予以排除。<\/div><div>&nbsp; &nbsp; &nbsp;5、多生牙：在任何位置都可能发生多生牙，但最常见好发于上颌正中多生牙。多生牙形态与正常牙形态有明显差异，多呈小锥形，牙根较短。经常引起邻牙的错位或阻萌。与该患者病情不符，故予以排除。<\/div>"}, {"id": "1768634879753", "mainCat": "鉴别诊断", "subCat": "常见病鉴别", "title": "颌面部骨折", "tags": "住院", "content": "<div>1、上颌骨骨折：患者有明显外伤病史，严重时有昏迷、呕吐等病史。一般有骨折断端移位，多向后下方移位，导致上颌骨下坠。通常能见骨折断裂处有粘膜损伤撕裂，伴有出血疼痛。患者有明显咬合关系紊乱，多是后牙早接触，前牙开合或反合。与该患者病情不符，故予以排除。<\/div><div>&nbsp; &nbsp; &nbsp;2、下颌骨骨折：好发于正中联合部、颏孔区、下颌角及髁突颈部。多引起骨折断端移位，出现咬合错乱、张口受限、下唇麻木及牙龈撕裂等特征，部分还可见口底区域肿胀充血、舌体被抬高甚至舌后坠的情况发生。与该患者病情不符，故予以排除。<\/div><div>&nbsp; &nbsp; &nbsp;3、颧骨骨折：颧骨发生骨折后，颜面部多发生内陷移位，压迫颞肌和咬肌，阻碍喙突运动，导致张口疼痛和张口受限。与该患者病情不符，故予以排除。<\/div><div>&nbsp; &nbsp; &nbsp;4、颅底骨折：有明确的外伤史，邻近软组织有明显的迟发性瘀斑，呕吐黑红色或咖啡色液体，伤后数小时出现“熊猫眼”征，可有脑脊液鼻漏、不同程度的嗅觉障碍和视力下降，可伴有额叶的脑挫裂伤。影像学检查发现颅内积气为颅底骨折的重要证据。与该患者病情不符，故予以排除。<\/div><div>&nbsp; &nbsp; &nbsp;5、牙槽突骨折：主要受外力打击、撞击和跌倒所致。骨折线仅限于牙槽突位置，未波及上下颌骨体部，可以是线型的，也可以是粉碎性的，有时为单纯的外骨板或内骨板折断，有时是一段牙槽骨完全折断。常伴有牙齿松动（牙折或牙脱位），以及软组织撕裂。摇动伤区一颗牙时，骨折端端上牙整体移动。与该患者病情不符，故予以排除。<\/div><div>&nbsp; &nbsp; &nbsp;6、髁突骨折：单侧骨折时，患侧下颌向外侧及后方移位，不能作侧合运动，由于肌肉牵拉，可出现后牙早接触，前牙及对侧牙开合。双侧骨折时，下颌不能作前伸运动，后牙早接触及前牙开合更为明显，侧合运动受限。患侧耳前区可出现肿、压痛症状。<\/div><div>&nbsp; &nbsp; &nbsp;7、翼外肌功能亢进：主要症状是患者颞下颌关节处弹响和开口过大呈半脱位。患者常无关节区疼痛症状，也无压痛症状。<\/div><div>&nbsp; &nbsp; &nbsp;8、翼外肌痉挛：主要表现为疼痛和开口受限。在开口、咀嚼食物时，患者自觉关节区或关节周围疼痛，患者可以指出疼痛所在关节区深部，但不能触及。一般无自发痛，不影响睡眠，一般关节本身无压痛，一般情况下不出现弹响症状。开口时下颌偏向患侧。<\/div><div><br><\/div><div>骨折术后鉴别：<\/div><div>1、颌骨骨折错位愈合：骨折断端触诊有台阶感，X线检查可见骨皮质连续性中断。临床表现为骨折段移位、张口受限和咬合关系紊乱、骨折段异常活动。与该患者病情不符，故予以排除。<\/div><div>2、骨折不愈合：临床见既往术区持续性疼痛、压痛，口内咬合关系不稳定，异常动度，X线或CT可见骨折端吸收、间隙增宽、骨折端硬化、无骨痂桥接、内固定装置可能松动、断裂等情况发生。与该患者病情不符，故予以排除。<\/div><div>1、下颌骨骨折：好发于正中联合部、颏孔区、下颌角及髁突颈部。多引起骨折断端移位，出现咬合错乱、张口受限、下唇麻木及牙龈撕裂等特征，部分还可见口底区域肿胀充血、舌体被抬高甚至舌后坠的情况发生。患者X线片提示下颌骨骨折内固定装置固定在位，遂为骨折术后。与该患者病情不符，故予以排除。<\/div><div>2、牙槽突骨折：主要受外力打击、撞击和跌倒所致。骨折线仅限于牙槽突位置，未波及上下颌骨体部，可以是线型的，也可以是粉碎性的，有时为单纯的外骨板或内骨板折断，有时是一段牙槽骨完全折断。常伴有牙齿松动（牙折或牙脱位），以及软组织撕裂。摇动伤区一颗牙时，骨折端端上牙整体移动。患者X线片提示下颌骨骨折内固定装置固定在位，遂为骨折术后。与该患者病情不符，故予以排除。<\/div><div>1、颌骨骨折纤维愈合：骨折后愈合不良可出现纤维愈合，表现为X片上骨折断端低密度影，该患者骨折断端未见低密度影，与该患者病情不符，故予以排除。<\/div><div>&nbsp; 2、骨折术后感染：局部红、肿、热、痛、功能障碍，严重可形成脓肿及断端不愈合，与该患者病情不符，故予以排除。<\/div>"}, {"id": "1768634847361", "mainCat": "鉴别诊断", "subCat": "常见病鉴别", "title": "颌面部感染", "tags": "住院", "content": "<div>1、翼下颌间隙感染：多有下颌冠周炎及下颌磨牙的根尖周炎病史，继而出现张口受限、张口及吞咽疼痛。常出现邻近间隙的受累症状，检查可见张口受限，但面部肿胀部明显，仅下颌支后缘稍有肿胀，口内可见翼颌韧带区的丰满和压痛。与该患者病情不符，故予以排除。<\/div><div>2、眶下间隙感染：多来自上颌尖牙，第一前磨牙和上颌切牙的根尖化脓性炎症和牙槽脓肿。眶下区肿胀范围常波及内眦、眼睑、颧部皮肤。肿胀区皮肤发红，张力增大，眼睑水肿，鼻唇沟消失，眶下区可扪及波动感。与该患者病情不符，故予以排除。<\/div><div>3、颊间隙感染：常见于上、下颌磨牙的根尖脓肿或牙槽脓肿穿破骨膜，侵入颊间隙。在颊部皮下或粘膜下的脓肿，病程进展缓慢，肿胀及脓肿的范围较为局限；但感染波及颊脂垫时，肿胀范围波及整个颊部。与该患者病情不符，故予以排除。<\/div><div>4、上颌颌骨肿瘤伴感染：良性肿瘤为无痛、生长缓慢的肿块，可扪及表面光滑的结节状。恶性肿瘤多为渐进性增大或缓慢生长而近期生长加快可伴有局部疼痛和神经疼痛或麻木症状。肿块小者可活动，轻微压痛，大者质硬，活动度差。病史中使用抗生素治疗无效，且肿瘤继续生长。与该患者病情不符，故予以排除。<\/div><div>5、咬肌间隙感染：咬肌间隙感染常见以下颌角为中心明显肿胀，患者面肿胀，以左颊部明显，，左下颌角区无明显肿胀，无压痛，故暂不考虑。<\/div><div>6、咽旁间隙感染 ：患者颌下明显肿胀，考虑并发咽旁间隙感染可能，患者口咽部无肿胀，无吞咽及呼吸困难，故暂不考虑；<\/div><div>7、淋巴结核 ：淋巴结核表现为颌下区肿大淋巴结，触之质中，皮肤无红肿，皮温不高，淋巴结于周围组织无粘连，故暂不考虑 ；<\/div><div>8、肿瘤伴感染：良性肿瘤为无痛、生长缓慢的肿块，可扪及表面光滑的结节状。恶性肿瘤多为渐进性增大或缓慢生长而近期生长加快可伴有局部疼痛和神经疼痛或麻木症状。肿块小者可活动，轻微压痛，大者质硬，活动度差。病史中使用抗生素治疗无效，且肿瘤继续生长。与该患者病情不符，故予以排除。<\/div><div>9、咽旁脓肿：患侧咽旁壁连同扁桃体被推移向内隆起，也可出现张口受限，但咽部炎症较轻，扁桃体本身无明显病变。颈侧放射性疼痛剧烈，常有炎性脓肿及明显触痛，故暂不考虑。<\/div><div>10、扁桃体脓肿：为扁桃体本身的脓肿，可在扁桃体内穿刺抽出脓液，从扁桃体上隐窝中可见脓液流出。患侧扁桃体肿大，炎症向周围浸润，但无张口受限，故暂不考虑<\/div><div>11、骨髓炎：患者周围组织感染扩散至骨组织，出现持续疼痛、死骨形成、瘘管等，完善CT可见骨髓炎影像，与该患者病情不符，故予以排除。<\/div>"}, {"id": "1768634828449", "mainCat": "鉴别诊断", "subCat": "常见病鉴别", "title": "舌病损", "tags": "住院", "content": "<div>1、淋巴管瘤 ：淋巴管瘤男女发病率大致相同，弥漫性淋巴管瘤边界不清。单纯性淋巴管瘤，在四肢，阴囊皮肤，口腔粘膜常见，混合小血管时呈淡红或紫红，局限性者呈不规则的软肿块，边界不清无触痛，发生于舌唇部位，则出现巨舌，巨唇症；穿刺可抽出淡黄色清亮液体。与该患者病情不符，故予以排除。<\/div><div>2、舌缘挫伤：有明显的外伤史，舌缘局部肿胀，疼痛明显，边界不清，可伴有邻近牙齿折断及口底肿胀。与该患者病情不符，故予以排除。<\/div><div>3、舌下腺囊肿口外型：表现为下颌下区肿物，而口底囊肿不明显，触之柔软，与皮肤无粘连，不可压缩，低头时因重力关系，肿物稍有增大，穿刺可抽出蛋清样黏稠液体，淀粉酶试验阳性。与该患者病情不符，故予以排除。<\/div><div>4、粘液囊肿：为口腔粘膜下小涎腺因高管阻塞、分泌物潴留而形成的囊肿；囊肿位于粘膜下，呈半透明，浅蓝色小泡，黄豆至樱桃大小，质软而有弹性，边界清楚，常易咬伤二破裂，反复破裂后，囊肿透明度减低，表现为较厚的白色瘢痕状突起。与该患者病情不符，故予以排除。<\/div><div>5、舌异位甲状腺：简称舌甲状腺。舌甲状腺常位于舌根部或舌盲孔的咽部，呈瘤状突起，表面紫蓝色，质地柔软，周围界限清楚。病人常有语言不清，呈典型的\"含橄榄\"语音。较大时可出现吞咽困难和不同程度的入睡后呼吸困难等梗阻症状。在婴幼儿期，可由于巨大甲状腺异位引起呼吸困难；在成人还可发生舌甲状腺腺瘤。与该患者病情不符，故予以排除。<\/div>"}, {"id": "1768634806241", "mainCat": "鉴别诊断", "subCat": "常见病鉴别", "title": "软组织病损", "tags": "住院", "content": "<div>1、静脉畸形：好发于颊、颈、眼睑、舌及口底等，位置深浅不一，表浅者呈蓝色或紫色。边界不清，扪之柔软，可被压缩。体位移动性实验阳性，有时可扪及静脉石。与该患者病情不符，故予以排除。<\/div><div>2、假性动脉瘤，多见于腮腺区或上颈部，系由动脉破裂，血液潴留于软组织内形成的一种搏动性病损;病理检查可见纤维壁及血凝块。动脉造影多可确诊。与该患者病情不符，故予以排除。<\/div><div>3、动脉瘤，可分为蔓状血管瘤或葡萄状血管瘤，是一种与会弯曲，极部规则而有搏动性的血管畸形，主要由血管壁显著扩张的动脉与静脉直接吻合而成。动静脉畸形多见于成年人，幼儿少见。常发生于颞浅动脉所在的颞部或头皮下组织中。病损高起呈念珠状，表面温度较正常皮肤为高。病员可能自己感觉到搏动。扪诊有震颤感，听诊有吹风样杂音。与该患者病情不符，故予以排除。&nbsp;<\/div><div>4、神经纤维瘤：多见于成年人，生长缓慢，颜面部的神经纤维瘤的表面皮肤呈大小不一，不隆起的棕色斑皮肤内有质地较硬的多发结节，沿皮下神经分布，呈念珠状或丛状，如来自于感觉神经可有明显触痛，结缔组织可呈异样增生，导致皮肤松弛下垂，造成颜面畸形，功能障碍，肿瘤质地柔软，但无压缩感。与该患者病情不符，故予以排除。<\/div><div>5、基底细胞腺瘤：肿瘤表面光滑，界限清楚；剖面实质性，灰白或灰黄色；发生于腮腺者多有完整包膜；发生于小涎腺，特别是腭部者，常无包膜，有时发生于唇部。肿瘤常有囊性变，囊腔大小不等，内含褐色的粘液样物。与该患者病情不符，故予以排除。<\/div><div>6、盘状红斑狼疮：是一种慢性皮肤-粘膜结缔组织病，特点为持久性红斑，中央萎缩凹陷呈盘状，主要累及头面部皮肤和口腔黏膜，皮损表面有附着性鳞屑，粘膜病损周围周边有放射状排列的短密白色条纹，属于癌前病变。与该患者病情不符，故予以排除。<\/div><div>7、皮样囊肿：呈圆形或卵圆形，边界清楚，表面粘膜及囊壁厚，囊腔内含半固体状皮脂性分泌物，因为扪诊有柔韧感，无波动感，可有压迫性凹陷。与该患者病情不符，故予以排除。<\/div><div>8、皮脂腺囊肿：好发于颜面部，多见于青年男性，一般生长缓慢，多数无自觉症状，继发感染时，局部可有疼痛、红肿以及化脓，常位于真皮或皮下组织内，与表面皮肤紧密粘连，并向皮肤表面突出，中央可有一小色素点，囊肿周界清楚，基底部活动。与该患者病情不符，故予以排除。<\/div><div>9、脂肪瘤：可出现在身体任何有脂肪的部位，是一种常见的软组织良性肿瘤，一般为单个或多个位于皮下的局限性肿块，挤压瘤体基底部可使皮肤出现“橘皮”样纹理，瘤体质感软、有弹性，手指轻推可以轻微移动。与该患者病情不符，故予以排除。<\/div>"}, {"id": "1768634785377", "mainCat": "鉴别诊断", "subCat": "常见病鉴别", "title": "软组织囊肿", "tags": "住院", "content": "<div>1、皮脂腺囊肿：好发于颜面部，多见于青年男性，一般发展缓慢，多数无自觉症状，大小不一，位于真皮或皮下组织内，与表面皮肤紧密粘连，并向皮肤表面突出，中央可有一小色素点囊肿周界清楚，基底部活动。继发感染时，局部可有疼痛、红肿以及化脓。该囊肿一般单发，也有多个囊肿或身体多部位发作。与该患者病情不符，故予以排除。<\/div><div>2、皮样及表皮样囊肿：多见于儿童及青少年，皮样囊肿好发于口底、下颌下区域，表皮样囊肿好发于眼睑、额、眶外侧、鼻周、耳下等部位。生长缓慢，一般无自觉症状，多为单发，呈球形，界限清，表面光滑，挤压肿块时坚韧有弹性，似面团样，与皮肤及黏膜无粘连。口底囊肿较大时出现语言、吞咽及呼吸功能异常。与该患者病情不符，故予以排除。<\/div><div>3、神经鞘瘤：亦称施万瘤，来源于神经鞘膜。多见于中年人。一般生长缓慢，包膜完整，属良性瘤，但也有恶性者。肿瘤为圆形或卵圆形，一般体积较小，但亦可长大而呈分叶状，质地坚韧，来自感觉神经者常有压痛，亦可有放射样痛。肿瘤可沿神经轴侧向左右移动，但不能沿神经长轴活动。肿瘤愈大愈容易粘液性变，发生粘液性变后质软如囊肿。发生内出血后穿刺时可抽出血样液体，但不凝结是其特点。与该患者病情不符，故予以排除。<\/div>"}, {"id": "1768634763553", "mainCat": "鉴别诊断", "subCat": "常见病鉴别", "title": "颌骨囊肿", "tags": "住院", "content": "<div>1、根尖囊肿:通常并有局部病灶牙；生长缓慢，多无自觉症状，囊肿大小可由豌豆大到鸡蛋大，小囊肿不易发现，增大时才被发现，根部部位有膨隆，表面黏膜色泽正常。与该患者病情不符，故予以排除。<\/div><div>2、上颌颌骨肿瘤：良性肿瘤为无痛、生长缓慢的肿块，可扪及表面光滑的结节状。恶性肿瘤多为渐进性增大或缓慢生长而近期生长加快可伴有局部疼痛和神经疼痛或麻木症状。肿块小者可活动，轻微压痛，大者质硬，活动度差。病史中使用抗生素治疗无效，且肿瘤继续生长。与该患者病情不符，故予以排除。<\/div><div>3、角化囊肿：好发于下颌第三磨牙区及下颌支部，生长缓慢，初期无自觉症状，多向颊侧膨隆，发展过大时可能引起病理性骨折。穿刺大多可见黄、白色角蛋白样（皮脂样）物质混杂其中。角化囊肿还有显著的复发性和癌变能力。与该患者病情不符，故予以排除。&nbsp;&nbsp;<\/div><div>4、颌骨血外渗性囊肿：为损伤后引起骨髓内出血、机化、渗出后形成，与牙组织本身无关，临床极为少见，多发生于青壮年，病人有明显损伤史，牙数目正常，无移位现象；囊肿无明显上皮衬里，仅为一层纤维组织，X线片边缘常显示不清楚。与该患者病情不符，故予以排除。&nbsp;<\/div><div>5、造釉细胞瘤：为颌骨中心性上皮肿瘤，多发生于青壮年，生长缓慢，初期无自觉症状，逐渐发展可使颌骨膨大，造成畸形；如肿瘤侵犯牙槽突时，可使牙松动、移位或脱落，肿瘤继续增大时，使颌骨外板变薄，或甚至吸收，肿瘤可侵入软组织内，影响下颌骨的运动，可伴有吞咽、咀嚼或呼吸障碍，肿瘤压迫下牙槽神经时，患侧下唇及颊部可能感觉麻木不适；肿瘤很大，骨质破坏较多时，可能发生病理性骨折；典型成釉细胞瘤的X线表现早期呈蜂房状，以后形成多房性囊肿样阴影，单房较少见。与该患者病情不符，故予以排除。<\/div><div>6、牙源性腺样瘤：常见于上颌尖牙区，临床可见有缺牙。多见于青少年，肿瘤生长缓慢，早期多无自觉症状，以后出现颌骨局部膨隆。X线片显示为边缘清晰的单房阴影，其中有钙化小点为其特征，常有埋伏牙。与该患者病情不符，故予以排除。<\/div><div>7、上颌窦囊肿：此为常见上颌窦良性病变，通常是由上颌窦黏膜腺管口堵塞使得黏液潴留于窦粘膜内而形成。囊肿生长较缓，早期无明显不适，当体积扩增到一定程度时则会出现相关的临床症状。影像学上这些囊肿通常表现为圆形的软组织影，常位于上颌窦的内壁和底壁。与该患者病情不符，故予以排除。<\/div><div><br><\/div><div><br><\/div><div>不能完全排除的：<\/div><div>&nbsp;1、角化囊肿：好发于下颌第三磨牙区及下颌支部，生长缓慢，初期无自觉症状，多向颊侧膨隆，发展过大时可能引起病理性骨折。穿刺大多可见黄、白色角蛋白样（皮脂样）物质混杂其中。角化囊肿还有显著的复发性和癌变能力。不能完全排除。&nbsp;<\/div><div>&nbsp;2、含牙囊肿：是指附着于牙颈部釉牙骨质界处并包绕未萌出牙冠的一种囊肿，好发于下颌第三磨牙区，其次为上颌尖牙区，症状与囊肿大小有关，小的含牙囊肿可无症状，大的囊肿可能会导致颌骨膨胀、邻牙移位等，若继发感染可能会导致牙龈肿胀、发红、下颌麻木等。不能完全排除。<\/div><div>3、上颌窦囊肿：此为常见上颌窦良性病变，通常是由上颌窦黏膜腺管口堵塞使得黏液潴留于窦粘膜内而形成。囊肿生长较缓，早期无明显不适，当体积扩增到一定程度时则会出现相关的临床症状。影像学上这些囊肿通常表现为圆形的软组织影，常位于上颌窦的内壁和底壁。该患者肿物性质未明，遂暂不排除此诊断。<\/div>"}, {"id": "1768634734017", "mainCat": "鉴别诊断", "subCat": "常见病鉴别", "title": "牙龈增生性疾病", "tags": "住院", "content": "<div>1、增生性龈炎：早期表现以炎性肿胀为主，多发生于上、下前牙的唇侧牙龈，牙龈呈深红或暗红色，松软光亮，探之易出血，龈缘肥厚，龈乳头呈球状增生，病程较长者炎症程度减轻，颜色变浅或接近正常。与该患者病情不符，故予以排除。<\/div><div>2、牙龈浆细胞增多症：主要发生于牙龈，可累及附着龈，唇、舌侧龈均可受累，表现为多个牙或全口牙的牙龈鲜红、肿大，松软而脆弱，表面呈结节状或分叶状，上皮菲薄，呈半透明状，极易出血，可有牙齿松动，移位，一般不发生附着丧失，有时可合并不同程度的感染，有溢脓和口臭。与该患者病情不符，故予以排除。<\/div><div>3、扁平苔藓：发生于真皮浅层的慢性炎症性皮肤病，也侵及口腔黏膜。多发于口腔颊黏膜出现白色颗粒状条纹或网状、树枝状、斑块状、环状丘疹或水疱等多种形式的病损，往往具有明显的左右对成性，局部烧灼痛等不适。与该患者病情不符，故予以排除。<\/div>"}, {"id": "1768634705633", "mainCat": "鉴别诊断", "subCat": "常见病鉴别", "title": "牙龈病损", "tags": "住院", "content": "<div>1、牙龈结核性溃疡：浅表、微凹而平坦溃疡，基底部见暗红桑葚杨肉芽肿，表面少许脓性物，溃疡边缘微隆，呈鼠噬样，向中央卷曲，呈潜掘状边缘。结核菌素试验（+），X胸片有时可见结核灶，病理活检可以明确诊断。与该患者病情不符，故予以排除。<\/div><div>2、牙龈创伤性溃疡：由残根、锐利牙尖、不良修复体长期摩擦刺激引起，疼痛为自发性，溃疡呈凹陷性，边缘隆起。下方炎性侵润块，基底部较软，去除刺激物，抗炎药物治疗逐步好转。与该患者病情不符，故予以排除。<\/div><div>3、牙龈癌：下牙龈癌较上牙龈癌多见，男性多于女性。牙龈癌多为高分化鳞状细胞癌，生长较缓慢，以溃疡型最为多见。早期向牙槽突及颌骨浸润，使骨质破坏，引起牙松动和疼痛。上牙龈癌可侵入上颌窦及腭部；下牙龈癌可侵及口底及颊部，如向后发展至磨牙后区及咽部，可引起张口受限。下牙龈癌比上牙龈癌淋巴结转移早，同时也多见。下牙龈癌多转移到患侧下颌下及颏下淋巴结，以后到颈深淋巴结；上牙龈癌则转移到患侧下颌下及颈深上淋巴结。远处转移较少见。与该患者病情不符，故予以排除。<\/div><div>4、牙龈瘤：牙龈瘤位于唇、颊侧者较舌、腭侧者多。最常见的部位是前磨牙区。肿块较局限，呈圆球或椭圆形。肿块有的有蒂如息肉；有的无蒂，基底宽广。随着肿块的增大，可以破坏牙槽骨壁，牙可能松动、移位。与该患者病情不符，故予以排除。<\/div>"}, {"id": "1768634688449", "mainCat": "鉴别诊断", "subCat": "常见病鉴别", "title": "颈部肿物", "tags": "住院", "content": "<div>1、颈动脉体瘤：好发于青壮年，一般为颈上部无痛性肿块，生长缓慢，质中，可左右移动，不能上下移动。近颈动脉者可伴有传递性搏动。随肿瘤增大少数病例可出现压迫症状：压迫迷走神经可出现声嘶、呛咳、恶心；压迫颈交感干可出现Horner综合征；压迫舌下神经可引起半舌萎缩、舌运动受限；压迫舌咽神经可出现软腭下陷、吞咽困难；压迫颈动脉窦引起\"颈动脉窦综合征\"-如直立性眩晕、上腹不适、一过性神志消失等症状。与该患者病情不符，故予以排除。<\/div><div>2、恶性淋巴瘤：可发生于任何年龄，但以儿童和青壮年较多。肿瘤科发生于任何淋巴组织，但以颈部淋巴结最好发生。常为多发性，肿大的淋巴结可以移动，表面皮肤发红，皮温增高，质地坚实而具有弹性，比较饱满，无压痛，大小不等。肿瘤生长迅速可引起相应的症状，如局部出血、肿痛；全身发热、乏力和食欲减退等，激素治疗效果明显。与该患者病情不符，故予以排除。<\/div><div>3、淋巴结结核：最初可在下颌下、或颈侧发现单个或多个成串的淋巴结，缓慢肿大。较硬，无疼痛，与周围组织无粘连：病变继续发展，淋巴结中心因有干酪样坏死，组织溶解液化变软。炎症波及周围组织时，淋巴结可彼此粘连成团，或与皮肤粘连，但皮肤表面一般无红、热及明显压痛，扪之有波动感。 颈部淋巴结结核可发生于一侧或双侧，常位于胸锁乳突机前，后缘或沿颈内静脉分布的淋巴结，故可形成颈深部冷脓肿，脓肿破溃后形成经久不愈的窦或瘘。与该患者病情不符，故予以排除。<\/div><div>4、鳃裂囊肿：可发生于任何年龄，但常见于20-50岁。临床上颈部以第二腮裂来源的最多见。囊肿表面光滑，但有时呈分叶状。肿块大小不定，生长缓慢，病人无自觉症状。包块上下左右都可活动，作穿刺时，可见有黄色或棕色的、清亮的、含或不含胆固醇的液体。与该患者病情不符，故予以排除。<\/div>"}, {"id": "1768634668857", "mainCat": "鉴别诊断", "subCat": "常见病鉴别", "title": "颌下肿物", "tags": "住院", "content": "<div>1、囊性水瘤：淋巴管畸形由数个大囊腔组成，囊腔互不相通，内含淋巴液，或棕色液体，不能压缩，周围有较厚纤维组成，衬以单层扁平细胞，一般与正常组织无明显界限，术中分离困难。临床多发生在婴幼儿，好发在颌下、颈外侧，肿物表面皮肤正常，透光试验阳性。 与该患者病情不符，故予以排除。<\/div><div>2、口底皮样囊肿：位于口底正中，呈圆形或卵圆形，边界清楚，表面粘膜及囊壁厚，囊腔内含半固体状皮脂性分泌物，因为扪诊有面团样柔韧感，无波动感，可有压迫性凹陷。肿物表面颜色与口底粘膜相似。与该患者病情不符，故予以排除。<\/div><div>3、粘液囊肿：是最常见的小唾液腺瘤样病变，好发于下唇及舌尖腹，和经常摩擦关系较大，囊肿位于粘膜下，表面仅覆盖一薄层黏膜，故呈半透明的小泡，似水泡，大多为黄豆至樱桃大小，质软而有弹性。与该患者病情不符，故予以排除。<\/div>"}, {"id": "1768634641690", "mainCat": "鉴别诊断", "subCat": "常见病鉴别", "title": "腮腺肿瘤", "tags": "住院", "content": "<div>1、慢性淋巴结炎：耳前淋巴结或颌下淋巴结的慢性炎症也可表现为无痛性肿块，但常有感染来源，如面部、口腔或咽部的炎症。肿块常为多个，有时大时小的消长史，抗感染治疗常可奏效。与该患者病情不符，故予以排除。<\/div><div>2、多形性腺瘤：又名混合瘤，是唾液腺肿瘤中最常见者。在大唾液腺中，多形性腺瘤最常见于腮腺，任何年龄均可发生，但以30-50岁为多见，女性多于男性。多形性腺瘤生长缓慢，常无自觉症状，病史较长。肿瘤界限清楚，质地中等，扪诊呈结节状，高起处常较软，可有囊性变，低凹处较硬，多为实质性组织。一般可活动，但位于硬腭部或下颌后区者可固定而不活动。肿瘤长大后除表现畸形外，当肿瘤生长一段时期以后，突然出现生长加速，并伴有疼痛、面神经麻痹等症状时，应考虑恶变。与该患者病情不符，故予以排除。<\/div><div>3、腺淋巴瘤：又名沃辛瘤，沃辛瘤的组织发生与淋巴结有关，在胚胎发育时期，腮腺和腮腺内的淋巴组织同时发育，此时淋巴组织只是聚集成团的淋巴细胞，尚未形成淋巴结的包膜，因此，腺体组织可以迷走到淋巴组织中。沃辛瘤多见于男性，好发于年龄在40-70岁的中老年，患者常有吸烟史，其发病可能与吸烟有关，可有消长史，这是因为沃辛瘤由肿瘤性上皮和大量淋巴样间质所组成，淋巴样间质很容易发生炎症反应。绝大多数肿瘤位于腮腺后下极，可能系该部位分布的淋巴结较多所致。与该患者病情不符，故予以排除。<\/div><div>4、肌上皮瘤：好发于腮腺，生长缓慢，无痛，活动度好。肿瘤多为单个类圆形或结节状包块，周界清楚，有包膜，质地中等，与多形性腺瘤相似，易混淆难鉴别。最终诊断有赖于病理形态学。镜下见，肿瘤细胞呈梭形，浆细胞样或两种细胞同时混在。上述细胞多聚集呈条索或团片，少数分散存在或形成导管样结构，位于不等量粘液基质中，此粘液组织呈典型结缔组织粘液反应。可借助组织化学、免疫组织化学以证实之。与该患者病情不符，故予以排除。<\/div><div>5、复发性腮腺炎：儿童复发性腮腺炎发病年龄自婴幼儿至15岁均可发生，男性稍多于女性，可突发，也可逐渐发生。腮腺反复肿胀，伴不适，肿胀不如流行性腮腺炎明显，仅有轻度水肿，皮肤可潮红。个别患儿表现为腮腺肿块，多为炎性浸润块。挤压腺体可见导管口有脓液或胶冻状液体溢出，少数有脓肿形成。大多数持续1周左右。与该患者病情不符，故予以排除。<\/div><div>6、淋巴结结核：颌下及耳后淋巴结常见，逐渐增大，可有消长史，抗结核治疗后可缩小，肿块可为多个。极少伴有全身其他系统结核或结核病史，也无明确的特异性化验检查指标，故单个淋巴结肿大时极易误诊。细针吸取细胞学检查有助于诊断。与该患者病情不符，故予以排除。<\/div><div>7、腺样囊性癌：又名圆柱瘤或圆柱瘤型腺癌。最常见发生于腭部小唾液腺及腮腺，其次为下颌下腺。发生舌下腺的肿瘤，多为腺样囊性癌。肿瘤易沿神经扩散，常出现神经症状，如局部疼痛、面瘫、舌麻木或舌下神经麻痹。肿瘤浸润性极强，与周围组织无界限。肿瘤易侵入血管，血道转移率高达40％，转移部位以肺部为最多见。颈淋巴结转移率低。与该患者病情不符，故予以排除。<\/div><div>8、黏液表皮样癌：女性多于男性，发生于腮腺者居多，其次是腭部和下颌下腺，也可发生于其他的小唾液腺，特别时磨牙后腺。高分化的黏液表皮样癌临床表现有时与多形性腺瘤相似，呈无痛性肿块、生长缓慢。肿瘤体积大小不等，边界可清或不清，质地中等偏硬，表面可呈结节状。位于腭部的黏液表皮样癌有时可呈囊性，表面黏膜呈蓝色。与该患者病情不符，故予以排除。<\/div>"}, {"id": "1768634612369", "mainCat": "鉴别诊断", "subCat": "常见病鉴别", "title": "唇裂", "tags": "住院", "content": "<div>1、唇裂伤：有明显的外伤病史，多见于患者摔伤、车祸伤及高处坠落伤等。唇部皮肤表层破损裂开，伴有出血及明显的疼痛，但少见全层裂开病例，与唇裂可相鉴别；<\/div><div>2、牙槽突骨折：可与牙槽嵴裂鉴别，主要受外力打击、撞击和跌倒所致。骨折线仅限于牙槽突位置，未波及上下颌骨体部，可以是线型的，也可以是粉碎性的，有时为单纯的外骨板或内骨板折断，有时是一段牙槽骨完全折断。<\/div><div>3、唇隐裂：即皮肤和粘膜无裂开，但其下方肌层未能联合或错位联合，导致裂侧出现浅沟凹陷及唇峰分离等畸形，与该患者病情不符，故予以排除。<\/div><div>4、唇挫伤：皮下及深部组织遭受力的挤压损伤而无开放性创口。多见于钝器作用造成以皮内或/和皮下软组织出血为主要改变的闭合性损伤。临床表现为局部皮肤变色、疼痛、肿胀甚至血肿形成。与该患者病情不符，故予以排除。<\/div>"}, {"id": "1768634587561", "mainCat": "鉴别诊断", "subCat": "常见病鉴别", "title": "腭裂", "tags": "住院", "content": "<div>1、腭裂伤：有明显的外伤病史，多见于患者硬物刺伤、车祸伤及高处坠落伤等。腭部表层破损裂开，伴有出血及明显的疼痛，但少见软硬腭全层裂开病例，与唇裂畸形可相鉴别；<\/div><div>2、上颌骨骨折伴腭部裂开：患者有明显外伤病史。一般有骨折断端移位，多向后下方移位，导致上颌骨下坠。通常能见腭部骨折断裂处有粘膜损伤撕裂，伴有出血疼痛。患者有明显咬合关系紊乱，多是后牙早接触，前牙开合或反合。与该患者病情不符，故予以排除。<\/div>"}, {"id": "1768620697597", "mainCat": "专科检查", "subCat": "口腔科", "title": "面部肿物", "tags": "住院", "content": "患者面型<b>不对称<\/b>，左面部隆起，皮肤色泽正常，左面部见一大小约1cm*1cm*1cm等圆肿物，质地软，边界清楚，与皮肤无粘连，活动度可，有明显触痛，无触及波动感。"}, {"id": "1768620646525", "mainCat": "专科检查", "subCat": "口腔科", "title": "牙龈肿物", "tags": "住院", "content": "患者面型基本对称，张口度及张口型可，于<b><i>36、37<\/i><\/b>间颊舌牙龈凸起，稍显红润，与周围组织分界不清，表面光滑，点彩消失，包块质韧，活动度差，无粘连，压痛明显，无波动感及搏动感，颈部及颌下浅表淋巴结无肿大，口腔卫生差。"}, {"id": "1768620631326", "mainCat": "专科检查", "subCat": "口腔科", "title": "口腔溃疡", "tags": "住院", "content": "患者张口度张口型正常，上下唇红润，上唇内侧粘膜正中可见一个圆形溃疡面，直径约5mm，溃疡中央凹陷，基底不硬，周边围有约1mm的充血红晕带，表面覆有浅黄色假膜，灼痛感明显。<br><br>患者张口度张口型正常，上下唇红润，软腭右侧后份可见一处较大椭圆形溃疡，大小约2cm*1cm，溃疡面凹陷明显，似“弹坑”状，表面有黄白色假膜覆盖，周缘粘膜充血红肿，质地柔软，触痛明显。"}, {"id": "1768620614894", "mainCat": "专科检查", "subCat": "口腔科", "title": "过敏性口炎", "tags": "住院", "content": "患者面型欠对称，皮肤色泽正常，双唇明显肿胀，唇外侧皮肤红染，唇粘膜色泽暗红色，有疱疹、皲裂，右侧口角部分渗血，牙龈有出血、肿胀、红线、萎缩，无溢脓、铅线，开口度正常，咬合关系可。见双侧颊粘膜不平整，舌部表面见散在白色斑块，口腔卫生差，牙结石堆积严重。"}, {"id": "1768620590494", "mainCat": "专科检查", "subCat": "口腔科", "title": "舌下腺囊肿", "tags": "住院", "content": "患者面型基本对称，张口度张口型正常，左侧舌下区可见一大小约2cm*2cm的肿物，质软，浅蓝色透明状，表面张力大，舌体抬高状似“重舌”，无明显压痛，无破溃流脓，未扪及明显波动感，皮温正常，周围组织无明显红肿，无异常渗出，口腔卫生一般。"}, {"id": "1768620562382", "mainCat": "专科检查", "subCat": "口腔科", "title": "黏液腺囊肿", "tags": "住院", "content": "患者面型基本对称，张口度张口型正常，左下唇粘膜可见一大小约1cm*1cm肿物，突出于唇粘膜，肿物中间颜色呈白色，无破溃及糜烂，未扪及明显波动感，质软，皮温正常，周围组织无明显红肿，无异常渗出，口腔卫生一般。"}, {"id": "1768620543430", "mainCat": "专科检查", "subCat": "口腔科", "title": "颌骨囊肿", "tags": "住院", "content": "患者面型基本对称，张口度及张口型可，口内见牙龈部分萎缩，25、26不良修复体残留，牙体色泽偏暗，对应左上颌前庭沟处粘膜稍显隆起，触及轻微疼痛，可触及“乒乓球”感，周围牙龈未见明显红肿溢脓。17、37、38牙冠缺损，牙根滞留。46周围牙槽骨部分吸收，牙龈萎缩，牙一度松动。全口牙结石残留，口腔卫生较差。"}, {"id": "1768620527725", "mainCat": "专科检查", "subCat": "口腔科", "title": "颌下肿物", "tags": "住院", "content": "患者面型不对称，左颌下区突出，皮肤色泽正常，左颌下区见一大小约3cm*4cm*3cm等圆肿物，质地中等，边界清楚，与皮肤无粘连，活动度可，稍触痛，无触及波动感。唇粘膜色泽红润，牙龈发红，开口度正常，咬合关系可。舌体正常，舌运动正常，舌系带正常，口底粘膜色泽潮红，左口底粘膜稍显肿胀，表面无糜烂，颌下腺导管开口未见唾液溢出，导管沿途未扪及明显结石。"}, {"id": "1768620499621", "mainCat": "专科检查", "subCat": "口腔科", "title": "软组织创伤(耳颞部)", "tags": "住院", "content": "患者面型不对称，右面部明显肿胀，见右颞部表面一面积约4cm*5cm的“弹坑”样创口，创缘不规整，深达肌层，内见颞肌完整，颞浅动脉断裂，有活动性出血，部分游离组织呈黑紫色，部分溃烂，少许组织缺如，创口内见明显“玻璃碎片”残留，大小不等数十粒。另右颧面部有两个大小不等的开放性创口，最大直径约1cm，内可见少许“玻璃”样碎块，右耳廓前份见一长约3cm的开放性横向创口，内见异物残留，有少许渗血，外耳廓无软骨断裂。口腔内牙列完整，牙体未见明显异常，口腔卫生较差。"}, {"id": "1768620472550", "mainCat": "专科检查", "subCat": "口腔科", "title": "软组织创伤(颏唇部)", "tags": "住院", "content": "患者面型欠对称，左侧颏部肿胀明显，近颏唇沟外侧皮肤见一长约3cm开放性创口，创缘不规则，呈“锯齿”状，深达骨面，骨皮质部分缺如，内见有“泥沙”样异物残留，有部分游离坏死组织，有明显渗血点；创口向上达左侧上唇红白唇见一长约4cm的三角形不规则开放性创口，深达肌层，部分肌肉断裂，创口右侧创缘见一薄层游离缺血组织，有少许“泥沙”残留，少许渗血。左侧下睑外眦见一长约1.5cm的横向开放性创口，深及皮下，有少许渗血，无明显活动性出血，21牙齿横向折裂，牙冠未脱落，11牙齿脱落，周围牙龈组织少许红肿，无明显渗出，余无特殊。"}, {"id": "1768620448782", "mainCat": "专科检查", "subCat": "口腔科", "title": "流腮", "tags": "住院", "content": "患者面型欠对称，左侧腮腺区较对侧明显肿胀，皮肤稍显发红，皮温稍高，范围较局限。可扪及左侧颌下腺肿胀，无明显疼痛，右侧颌下腺也有肿胀，程度较轻，张口度正常，口内见左侧腮腺导管口分泌物清亮，粘膜色泽正常。{{全身浅表淋巴结未触及肿大}}。"}, {"id": "1768620416974", "mainCat": "专科检查", "subCat": "口腔科", "title": "咬肌间隙感染", "tags": "住院", "content": "患者面型不对称，左侧下颌角部较对侧明显隆起，皮肤色泽潮红，皮温异常，有明显压痛，张力增大，扪及生硬，边界不清，未扪及明显波动感及搏动感。唇粘膜色泽口唇，开口度Ⅱ度受限，咬合关系可。见（牙位）周围牙龈红肿，龈沟内见异常分泌物，前庭龈颊沟处可见明显的肿胀、膨隆，有明显压痛和波动感。"}, {"id": "1768620370686", "mainCat": "专科检查", "subCat": "口腔科", "title": "眶下间隙感染", "tags": "住院", "content": "患者面型不对称，左面部隆起，皮肤色泽潮红，皮温异常，有明显压痛，张力增大，边界不清，鼻唇沟变浅，眼睑水肿，睑裂变窄，有明显波动感及搏动感。唇粘膜色泽红润，牙龈无出血、肿胀、溢脓、铅线、红线、萎缩，牙龈发红，开口度Ⅱ度受限，咬合关系可。见（牙位){{残根情况描述}}，周围牙龈红肿，龈沟内异常分泌物，前庭龈颊沟处可见明显的肿胀、膨隆，有指压痛和波动感。"}, {"id": "1768620301413", "mainCat": "专科检查", "subCat": "口腔科", "title": "阻生智齿", "tags": "住院", "content": "患者面型基本对称，双侧颞下颌关节处未扪及明显疼痛，活动度正常。张口度张口型正常，口内见患者牙列完整，38、48未见萌出，周围牙龈无红肿溢脓，未见异常分泌物，邻牙、牙周未见明显异常。18、28部分冠萌出，垂直向下生长，牙冠高度与邻牙平齐，周围牙龈组织稍显红肿，部分牙龈撕脱，邻牙牙体未见明显损坏，口腔卫生一般。"}, {"id": "1768620283053", "mainCat": "专科检查", "subCat": "口腔科", "title": "阻生牙", "tags": "住院", "content": "患者面型基本对称，双侧颞下颌关节处未扪及明显疼痛，活动度正常。张口度张口型正常，口内见患者牙列完整，38、48水平向生长，可见部分牙冠萌出，周围牙龈无红肿溢脓，未见异常分泌物，邻牙、牙周未见明显异常。18、28部分冠萌出，垂直向下生长，牙冠高度与邻牙平齐，邻牙牙体未见明显损坏，口腔卫生一般。"}, {"id": "1768620266493", "mainCat": "专科检查", "subCat": "口腔科", "title": "腮腺肿物", "tags": "住院", "content": "患者面型基本对称，张口度张口型可，左侧腮腺扪及一约1cm*1cm包块，无压痛，质韧，活动度可，界清，表面皮肤色泽正常，皮温无增高，无波动感及搏动感，无闭眼不全、口角歪斜及鼓腮漏气等面神经损伤表现，口腔卫生可，双侧腮腺导管口无明显红肿，分泌物清亮。颌下区和颈部浅表淋巴结无肿大。"}, {"id": "1768620221581", "mainCat": "专科检查", "subCat": "口腔科", "title": "口腔肿物", "tags": "住院", "content": "患者面型基本对称，张口度及张口型可，于右侧颊部粘膜粘膜见一大小约1cm*1cm*1cm等圆肿物，呈“菜花样”突起，包块质韧，活动度良好，与周围组织边界不清，无粘连，压痛明显，无波动感及搏动感，表面皮肤色泽正常，皮温不高，颈部及颌下浅表淋巴结无肿大，口腔卫生差，见大量牙石及烟斑。"}, {"id": "1768620184941", "mainCat": "专科检查", "subCat": "口腔科", "title": "腭裂", "tags": "住院", "content": "患儿面型基本对称，张口度张口型正常，口内见悬雍垂正中至硬腭部裂开，裂隙最宽处1.5cm，有腭裂语音。"}, {"id": "1768620147806", "mainCat": "专科检查", "subCat": "口腔科", "title": "唇裂", "tags": "住院", "content": "患者面型不对称，唇红不连续，左侧上唇至鼻底全层裂开，长约3cm，裂隙最宽处约2cm；患侧鼻翼塌陷,鼻底较健侧增宽约1cm，鼻小柱偏向健侧；张口度可，口内见前牙牙槽突部分裂开，裂隙最宽处约0.5cm，发音正常。"}, {"id": "1768620131726", "mainCat": "专科检查", "subCat": "口腔科", "title": "通用", "tags": "原始模板", "content": "患者面型不对称，左面部隆起，皮肤色泽正常，左面部见一大小约1cm*1cm*1cm等圆肿物，质地硬，边界清楚，与皮肤无粘连，活动度可，无明显触痛，无触及波动感。\n唇粘膜色泽红润，牙龈无出血、肿胀、溢脓、铅线、红线、萎缩，牙龈正常，开口度正常，咬合关系可，牙列完整。\n牙体情况：牙位浅龋，冠根折，Ⅰ度松动，叩(+),探(+-),牙龈无瘘管,牙龈无压痛。\n牙周情况:Ⅰ°牙石,牙龈增生至冠中1/3,探及浅牙周袋,腭黏膜正常。\n口内及唾液腺检查：舌体过大，舌运动伸舌左偏，舌系带过短，口底粘膜色泽苍白，左舌缘见一大小约1cm*1cm*1cm等圆肿物，边界清楚，质地软，与皮肤无粘连，表面无糜烂，无压痛，颌下腺导管开口正常，分泌物脓性分泌物，腮腺导管开口正常，分泌物正常。"}, {"id": "1768619863422", "mainCat": "会诊处置", "subCat": "", "title": "清创(书写会诊意见)", "tags": "清创会诊意见", "content": "1、与患者沟通手术必要性及手术风险，签署手术知情同意书，予以局麻下行“口腔颌面部软组织裂伤清创缝合术+任意皮瓣成形术”，术后行酒纱覆盖，敷料加压包扎创面；\n2、嘱患者及家属保持创面干燥清洁，创面两天后可予以暴露；\n3、贵科允许下可给予患者预防性应用抗生素，警惕创口感染；\n4、注射破伤风免疫球蛋白；\n5、3天后换药，7-10天后视病情愈合情况酌情拆除缝线；\n6、颧骨颧弓骨折可待患者创口愈合后观察患者予张口情况及咬合关系，若不影响功能，可给予保守治疗；若需手术，可再次请我科会诊评估病情。\n7、我科随诊，谢邀！"}, {"id": "1768619788925", "mainCat": "会诊处置", "subCat": "", "title": "清创(他科清创)", "tags": "清创记录", "content": "                         口腔颌面外科会诊清创缝合术记录\n     操作医师：杨磊 主治医师                        麻醉方式：局麻\n     操作时间：手术日期                     操作地点：科室名称清创换药室\n术前专科情况：患者面型不对称，右侧颧面部明显肿胀，皮肤色泽偏红，皮温稍高，患者右颧面部见一纵向切口，深达骨面，创缘不齐，部分组织缺血坏死，内见黑色颗粒异物存留，血凝块於结，有明显渗血。\n手术简要过程：1、患者取平卧位，暴露创面；2、2%利多卡因注射液行创口周围组织神经阻滞麻醉，待麻醉生效后生理盐水及双氧水清洗右侧颧面部创口，清除创口内血凝块及明显残渣异物；3、再次创面严密消毒，铺无菌洞巾，修整面部创口游离组织，使皮瓣成型以致创口能完整对合缝合，分层间断拉拢缝合肌层、皮下层、皮肤层，消灭残余腔隙，缝合后行酒纱覆盖，加压包扎创面，促进创面创口愈合。4、嘱患者家属保持创面干燥清洁。"}, {"id": "1768619687438", "mainCat": "会诊处置", "subCat": "", "title": "口腔白色念珠菌感染", "tags": "专科检查，会诊意见", "content": "专科检查：患者上下唇黏膜散在红色小斑点，似小溃疡面，疼痛，表面覆盖有白色丝绒状斑块，可擦去，舌背见大面积白色丝绒状斑块。触及疼痛。\n\n1、目前主要考虑口腔念珠菌感染，可应用碳酸氢钠片8片兑100ml水含漱，每日四次，制霉菌素片（自备，药店购买）2片，口服，每日四次，华素片（自备，药店购买）1片含化，每日四次。\n2、不适随诊，谢邀。"}, {"id": "1768619643383", "mainCat": "会诊处置", "subCat": "", "title": "口腔溃疡", "tags": "专科检查，会诊意见", "content": "专科1：患者张口度张口型正常，上下唇红润，上唇内侧粘膜正中可见一个圆形溃疡面，直径约5mm，溃疡中央凹陷，基底不硬，周边围有约1mm的充血红晕带，表面覆有浅黄色假膜，灼痛感明显。\n\n专科2：患者张口度张口型正常，上下唇红润，软腭右侧后份可见一处较大椭圆形溃疡，大小约2cm*1cm，溃疡面凹陷明显，似“弹坑”状，表面有黄白色假膜覆盖，周缘粘膜充血红肿，质地柔软，触痛明显。\n\n处理：1、醋酸泼尼松片口服，10mg0/日，1-2周；复合维生素B片口服，1片/次，3次/天；复方氯己定溶液含漱，适量，3次/日；曲安奈德益康唑乳膏，涂敷患处，适量，3次/日；外用重组人碱性成纤维细胞生长因子，喷涂患处，适量，1次/日。\n2、规律作息，不适随诊。"}, {"id": "1768619391822", "mainCat": "围手术期", "subCat": "术前讨论记录", "title": "颌骨骨折", "tags": "手术注意事项", "content": "1、术后感染、出血、疼痛以及水肿可能。2、术区感染，出现骨断端不愈合、骨不连甚至骨坏死等情况，需积极排查病因，若因钛板钛钉排异反应所致，应再次手术取出植入物。3、术后出血，及时给予患者止血处理，必要时应用止血药物。4、术后疼痛明显，适时给予患者药物止痛处理。5、术后积极与患者（家属）沟通，交代术后注意事项，争取达到患者及家属的配合。6、咬合关系差，需要进一步行颌间牵引固定，逐步改善患者咬合关系。7、以及其他目前无法预知情况。"}, {"id": "1768619375654", "mainCat": "围手术期", "subCat": "术前讨论记录", "title": "颌骨囊肿", "tags": "手术注意事项", "content": "1、术后感染、出血、疼痛以及水肿可能。2、术后患者术区肿胀，可应用药物减轻局部组织水肿。3、术后患者创面出血，及时给予患者止血处理，必要时应用止血药物。4、术后患者疼痛明显，适时给予患者药物止痛处理。5、术后积极与患者（或家属）沟通，交代术后注意事项，争取达到患者或家属的配合。6、以及其他目前无法预知情况。"}, {"id": "1768619353646", "mainCat": "围手术期", "subCat": "术前讨论记录", "title": "舌下腺囊肿", "tags": "手术注意事项", "content": "1、术后术区出血可能，需要及时止血处理，必要时应用止血药物止血。2、术后感染、涎瘘术区皮肤长期不愈，需长期换药可能。3、术中损伤舌神经致术后患侧舌部感觉麻木可能。4、术后颌下腺导管阻塞可能，需要及时疏通颌下腺导管。5、最终诊断需待常规病理，根据常规病理结果拟定进一步治疗方案。6、术后术区瘢痕增生，影响伸舌及其他功能。以及其他目前无法预知情况。"}, {"id": "1768619329367", "mainCat": "围手术期", "subCat": "术前讨论记录", "title": "腭裂", "tags": "手术注意事项", "content": "1、术后感染、出血、疼痛以及水肿可能。2、术后预期患者腭部创口愈合好，腭部间隙关闭。但可能出现缝线松脱，可能发生腭部复裂可能，需行二期手术进行修复。3、术后患者腭部创面出血，及时给予患者止血处理，必要时应用止血药物。4、术后患者疼痛明显，适时给予患者药物止痛处理。5、术后积极与患者（家属）沟通，交代术后注意事项，争取达到患者或家属的配合。6、以及其他目前无法预知情况。"}, {"id": "1768619307462", "mainCat": "围手术期", "subCat": "术前讨论记录", "title": "唇裂", "tags": "手术注意事项", "content": "1、术后感染、出血、疼痛以及水肿可能。2、术后预期患者唇部创口愈合好，唇部裂隙关闭。但有可能出现缝线松脱，可能发生唇部复裂可能，需行二期手术进行修复。3、术后患者唇部创面出血，及时给予患者止血处理，必要时应用止血药物。4、术后患者疼痛明显，适时给予患者药物止痛处理。5、术后积极与患者（家属）沟通，交代术后注意事项，争取达到患者及家属的配合。6、以及其他目前无法预知情况。"}, {"id": "1768619279455", "mainCat": "围手术期", "subCat": "术前小结", "title": "颌骨骨折", "tags": "手术注意事项", "content": "1、保护周围神经血管束，避免引起功能感觉障碍，减少出血发生，若出血较多，及时止血甚至输血治疗；2、恢复患者咬合关系，术中进行复位时，需注意用力方向和大小，避免损伤周围骨或组织，如发生颅底骨折引发脑脊液瘘；3、术中将骨折线上牙齿拔除，以免影响复位；4、尽量采用口内切口，减少疤痕形成影响外貌；5、注意其它手术意外的发生。"}, {"id": "1768619248799", "mainCat": "围手术期", "subCat": "术前小结", "title": "下颌骨囊肿", "tags": "手术注意事项", "content": "1、多采用口内切口，切口长度需超过去骨的范围，两侧附加切口应达到正常骨组织处；2、下颌骨囊肿较大，术中剥离囊肿时可能损伤下牙槽神经血管束，导致出血，可压迫止血、电凝或结扎活跃出血点，下牙槽神经损伤可引起术后麻木感；3、术中需将暴露在囊腔内的牙齿行根尖切除术，术前完善根管治疗术；4、骨腔内有活跃性出血时，可用骨腊或电凝止血；5、若囊肿破坏下颌升支内侧损伤颌内动脉引起出血，若有出血，应立即压迫止血并结扎出血点；6、口外切口需注意保护面神经下颌缘支；7、注意其它手术意外的发生。"}, {"id": "1768619228183", "mainCat": "围手术期", "subCat": "术前小结", "title": "上颌骨囊肿", "tags": "手术注意事项", "content": "1、多采用口内切口，切口长度需超过去骨的范围，两侧附加切口应达到正常骨组织处；2、尽量避免穿破上颌窦底粘膜，若已穿通，则根据具体情况行上颌窦根治术；3、术中需将暴露在囊腔内的牙齿行根尖切除术，术前完善根管治疗术；4、骨腔内有活跃性出血时，可用骨腊或电凝止血；5、尽可能保护上颌窦后壁，避免翼静脉丛损伤引起出血，若有出血，应立即压迫止血并结扎出血点；6、注意其它手术意外的发生。"}, {"id": "1768619207207", "mainCat": "围手术期", "subCat": "术前小结", "title": "舌下腺囊肿", "tags": "手术注意事项", "content": "1、术后感染、出血、疼痛以及水肿可能。2、术中注意保护患者舌神经、下颌下腺导管，避免引起患者舌部麻木感及下颌下腺导管阻塞继发颌下腺炎症。3、术中结扎沿途血管，尽量避免术后出血的发生。4、术中尽量避免暴力解剖，损伤周围组织不利于缝合及愈合。5、最终诊断需待常规病理，根据常规病理结果拟定进一步治疗方案。6、以及其他目前无法预知情况。"}, {"id": "1768619178375", "mainCat": "围手术期", "subCat": "术前小结", "title": "腭裂", "tags": "手术注意事项", "content": "1、术后感染、出血、疼痛以及水肿可能。2、术中注意保护腭大神经血管束，尽量减少出血及损伤临近神经。3、术中注意腭部组织瓣血供，警惕组织瓣缺血坏死。4、术中尽量恢复患者悬雍垂的长度以利于患者腭咽闭合功能。5、双侧松弛切口内应置入碘仿纱条促进周围组织生长，术后择期取出。6、术后术区瘢痕增生，影响二期手术修复。以及其他目前无法预知情况。"}, {"id": "1768619159839", "mainCat": "围手术期", "subCat": "术前小结", "title": "唇裂", "tags": "手术注意事项", "content": "1、患者无明显系统性疾病，各项检查检验无明显手术禁忌，满足手术条件；2、术前设计，对患者唇部外形作进一步分析评估；3、术中尽量保留更多的可利用组织，避免组织缺损影响修复效果；4、可应用一定浓度的肾上腺素溶液注射术区，减少术区出血及保证术区视野清晰；5、因患者涉及鼻底增宽，术中可适当过度缩窄鼻底外形，术后通过塑形恢复患者鼻腔形态；6、尽量恢复患者唇部及鼻部形态；7、积极预防其它手术意外的发生。"}, {"id": "1768618985647", "mainCat": "手术记录", "subCat": "", "title": "咬肌间隙感染(局麻)", "tags": "住院", "content": "患者取平卧位，暴露脓肿部位，2%利多卡因注射液周围皮肤组织行局部浸润麻醉，待麻醉生效后，从下颌支后缘绕过下颌角，距下颌下缘2cm处切开，切口长3-5cm，逐层切开皮肤、皮下组织、颈阔肌以及咬肌在下颌角区的部分附着，用骨膜剥离器由骨面推起咬肌进入脓腔，引出脓液，冲洗脓腔后置入橡皮引流条引流。"}, {"id": "1768618944679", "mainCat": "手术记录", "subCat": "", "title": "翼下颌间隙感染", "tags": "住院", "content": "#口内切口，适用于开口基本正常患者，切口在下颌支前缘稍内侧，即翼下颌皱襞稍外侧，纵行切开粘膜，长2～3 cm。用血管钳钝性分离粘膜下组织、颊肌后，即可沿下颌支内侧进入翼下颌间隙，引流出脓液后冲洗脓腔，置入橡皮条引流。\n#口外切口适合于张口受限者，从下颌支后缘绕过下颌角，距下颌下缘2cm处切开，切口长3～5cm，逐层切开皮肤、皮下组织、颈胸肌、钝性分离暴露下颌角下缘，在其内侧切开部分翼内肌附着及骨膜，用骨膜剥离器剥开翼内肌后，进入脓腔，引出脓液，用盐水或1%-3%过氧化氢液冲洗脓腔以盐水纱条填塞，次日更换敷料以橡皮管或橡皮条引流。"}, {"id": "1768618906111", "mainCat": "手术记录", "subCat": "", "title": "颧弓骨折", "tags": "住院", "content": "1、核对患者身份及手术部位等个人信息，确认无误后仰卧位，待全麻生效后，头偏向健侧，常规消毒铺巾展单。\n2、沿右侧颧面部创口向前延伸，切开皮肤皮下，暴露表面肌群，可见肌肉呈紫黑色，并可见少许血凝块存。分离肌肉后暴露骨折断端，可见骨折断端呈“M”型骨折。应用复位前将塌陷的骨折 断端将外牵拉复位，尽可能恢复患者右侧颧部形态。在相对稳定关系下置入一枚钛板，塑形后四颗螺钉固定。冲洗创口，缝合骨面肌层，再关闭患者创口。\n3、术区冲洗并彻底止血，术毕。待患者清醒后送入病房。"}, {"id": "1768618850631", "mainCat": "手术记录", "subCat": "", "title": "颌下肿物", "tags": "住院", "content": "1、核对患者身份及手术部位等个人信息，确认无误后仰卧位，待全麻生效后，头偏向健侧，常规消毒铺巾展单。\n2、沿左侧下颌下缘1.5cm处做一平行切口，切开皮肤、皮下组织、颈阔肌、颈深筋膜，显露下颌下腺及肿物，可见肿物与颌下腺粘连紧密，需要将颌下腺一并摘除。在咬肌前缘与下颌下缘交界处显露、钳夹、切断并结扎面动脉及面前静脉，注意保护在其浅面越过的面神经下颌缘支，然后分离下颌下腺上极。继续分离下颌下腺下极及前方，显露二腹肌前、后腹及下颌舌骨肌。将下颌舌骨肌拉向前，显露下颌下腺导管及舌神经，剪断并结扎颌下神经节通向下颌下腺的分泌支。游离下颌下腺导管，近口底钳夹、切断并双重结扎下颌下腺导管。游离下颌下腺深部，在下颌下腺后上方，二腹肌后腹浅面找出面动脉近心端，钳夹切断并双重结扎，完整摘除腺体及肿物。\n3、术区冲洗并彻底止血，创口内置入橡皮引流条，分层缝合颈阔肌、皮肤，然后加压包扎消灭死腔。\n4、术毕。待患者清醒后送入病房。"}, {"id": "1768618816263", "mainCat": "手术记录", "subCat": "", "title": "甲状舌管囊肿", "tags": "住院", "content": "1、核对患者身份及手术部位等个人信息，确认无误后仰卧位，待全麻生效后，头偏向健侧，常规消毒铺巾展单。\n2、沿肿物表面处做一长约3cm的横行切口，切开皮肤、皮下组织、颈阔肌、向上、拉开翻起皮瓣，上至显示舌骨，下至甲状软骨峡部。分离带状肌并向两侧拉开，显露囊肿。见囊肿与周围组织粘连、分界不清，有少许脓性分泌物，量不多，与舌骨中份连接紧密，继续分离囊肿下缘，在其粘连的两侧，切开舌骨膜及其肌肉附着，用剪刀剪断舌骨，使囊肿与舌骨中段连为一体并游离。\n3、术区冲洗并彻底止血，严密封闭创腔与口咽的通道，创口内置入橡皮引流条，分层缝合颈阔肌、皮下组织及皮肤，然后加压包扎消灭死腔。\n4、术区冲洗并彻底止血，术毕。待患者清醒后送入病房。"}, {"id": "1768618779768", "mainCat": "手术记录", "subCat": "", "title": "下颌骨骨折", "tags": "住院", "content": "1、核对患者身份及手术部位等个人信息，确认无误后仰卧位，待全麻生效后，头偏向健侧，常规消毒铺巾展单。\n2、(1)于33至43对应口腔前庭沟作切口，切开粘膜、黏骨膜瓣，紧贴骨面向下方剥离，显露下颌骨正中联合处骨折线，见部分移位。(2)充分暴露各骨折线后，清除大量纤维结缔组织，观察复位情况，上下颌骨内置入6颗牵引钉，胶圈行颌间牵引，随后观察咬合关系良好。(3)在此相对稳定的咬合关系下行下颌骨正中联合颌骨内坚固内固定，固定后观察咬合关系良好。(4)沿右侧下颌角下缘下方2CM处皮肤切开，切开皮肤、皮下，分离咬肌筋膜，暴露下颌角处骨折线，清除其内骨折线内结缔组织及新生肉芽组织后，保证咬合关系情况下给予患者行下颌角骨折内固定。固定后分层缝合粘骨膜层、肌层、皮肤层。\n3、手术共用钛板4枚，钛钉16枚，牵引钉6枚。术区冲洗并彻底止血，术毕。待患者清醒后送入病房。"}, {"id": "1768618750984", "mainCat": "手术记录", "subCat": "", "title": "阻生牙拔牙术", "tags": "住院", "content": "1、核对患者身份及手术部位等个人信息，确认无误后仰卧位，待全麻生效后，头偏向健侧，常规消毒铺巾展单。\n2、（1）切口及组织分层解剖：用电刀在A7B7C7D7远中处做一角形切口；（2）手术步骤：用金霉素眼膏涂抹双侧口角，以保护口角。按切口设计，翻开C6远中粘骨膜瓣，用骨凿祛除C7远中颊侧部分骨质，充分暴露C8牙冠外形高点及牙冠最大周径，祛除C8远中骨阻力及牙冠周围骨阻力、劈开C8近中牙冠解除邻牙阻力，分根，用牙挺将C8远中挺出，再分别取出近中牙冠及牙根，搔刮牙槽窝清除骨及牙碎屑，复位牙槽窝，修整牙槽骨和牙龈组织，用可吸收缝线缝合牙龈；棉纱压迫拔牙创。按切口设计，翻开D6远中粘骨膜瓣，用骨凿祛除D8远中、颊、舌侧部分骨质，充分暴露D8牙冠外形高点及牙冠最大周径，消除D8远中骨阻力及牙冠周围骨阻力，用电钻截冠祛除近中邻牙阻力，截根，解除根部阻力，用牙挺将D8牙冠、牙根分别挺出，搔刮牙槽窝清除骨及牙碎屑，复位牙槽，修整牙槽骨和牙龈组织，用可吸收缝线缝合牙龈。同法分离A8B8牙龈，用牙挺拔除患牙。检查患者咬合关系可，待患者清醒后安返病房。\n3、术区冲洗并彻底止血，术毕。待患者清醒后送入病房。"}, {"id": "1768618689671", "mainCat": "手术记录", "subCat": "", "title": "唇裂(旋转推进法)", "tags": "住院", "content": "1、核对患者身份及手术部位等个人信息，确认无误后仰卧位，待全麻生效后，常规消毒铺巾展单。\n2、采用旋转推进法，定点： 1点为健侧唇峰点；2点为人中切迹点；3点为唇红缘上一点，使3到2的距离等于2到1的距离；4点为患侧红唇最厚点，5点为健侧鼻底鼻小柱基部一点；6、7点为同一点位于鼻翼下方前份处；8点为患侧鼻翼外下处一点，此点根据需要恢复的唇高来确定，用美兰连接5-3-6，8-6-4；\n3、沿上述连线全层切开上唇组织。切开后得到健侧A﹑C瓣，患侧B瓣，A瓣下降恢复唇高，C瓣旋转封闭鼻底，纠正歪斜的鼻小柱。B瓣向健侧推进插入A、C瓣形成的三角间隙内，封闭裂隙；然后潜行游离出3-4mm口轮匝肌。\n4、分层缝合粘膜层、肌层、皮肤层，三角瓣法修复红唇。\n5、油纱管衬托鼻部外形，油纱覆盖伤口，蝶形胶布减张固定。\n6、手术顺利，患儿清醒后安返回房。"}, {"id": "1768618629487", "mainCat": "手术记录", "subCat": "", "title": "Le-I(II)型骨折", "tags": "住院", "content": "1、核对患者身份及手术部位等个人信息，确认无误后仰卧位，待全麻生效后，头偏向健侧，常规消毒铺巾展单。\n2、(1)于右侧下睑下缘作小切口，睑下缘处切开皮肤、皮下组织达眼轮匝肌浅面，钝性向下分离、于眶下缘处切开骨膜，紧贴骨膜向下方及内侧剥离，游离眶下血管神经束，充分显露眶下缘骨折段。于左颌下区至正中联合处作一长约8cm切口，切开皮肤、皮下组织、肌层直达骨面，剥离骨膜暴露骨折线。\n(2)于A5至B5对应口腔前庭沟作切口，切开黏骨膜瓣，紧贴骨面向上方剥离，显露右侧犁状孔、颧上颌缝、上颌结节及左侧上颌翼突缝。(3)充分暴露各骨折线后，清除大量纤维结缔组织，游离向下移位的眶下壁骨折段，沿眶脂体外侧钝性分离，将崁顿入眶下缘骨缝中的眶脂体复位。(4)将游离的眶下缘骨块复位后探查发现右侧眶底粉碎性骨折，取出碎骨片后见眶底缺损直径超过1cm。(5)松解上颌正中骨折断端，将移位的右侧上颌体向内上牵拉，恢复面中部高点及右侧面宽，解剖复位两侧颧上颌缝、右眶下缘、颧牙槽嵴等处骨折线，分别行两侧颧上颌缝、眶下缘、颧牙槽嵴等处微型钛板钛钉系统内固定。(6)将眶底钛网及取出的碎骨片用钛钉固定后置入眶底，用微型钛板钛钉内固定于眶下缘。(7)用咬骨钳去除下颌颏部牙槽骨、骨尖，将前庭沟伤口两侧软组织拉拢缝合，关闭前庭沟撕脱伤口。(8)冲洗、止血，分层对位缝合各手术创口，右眶内眦外侧及左颌下区创口无菌敷料包扎。\n3、术区冲洗并彻底止血，术毕。待患者清醒后送入病房。"}, {"id": "1768618565543", "mainCat": "手术记录", "subCat": "", "title": "腮腺肿瘤", "tags": "住院", "content": "1、核对患者身份及手术部位等个人信息，确认无误后仰卧位，待全麻生效后，头偏向健侧，常规消毒铺巾展单。\n2、(1)切口：于耳后沿包块外缘转向下内侧。做一长约6cm反“C”型切口。(2)沿切口设计，切开皮肤、皮下组织、颈阔肌，达腮腺嚼肌筋膜浅层，向前翻开皮肤组织瓣，显露腮腺浅叶后缘及前下缘，锐性切除腮腺咬肌筋膜层及少量腺体，钝性分离腺体，术中见耳大神经位于浅叶表面，小心剥离解剖出耳大神经，继续钝性分离腺体找到面后静脉，沿途保护可见的神经及结扎出血点，顺着面后静脉找到横跨于表面的面神经分支，根据面神经分支进行逆行性解剖面神经，术中出血较多，采取局部压迫及部分分支血管结扎，保持视野清晰，见包块紧邻面神经总干，保护面神经的同时将包块及周围0.5cm范围内的腮腺浅叶腺体组织完整摘除，见包块周围若干肿大淋巴结，将其一并摘除。剖开包块见包块剖面呈黑褐色，少量暗紫色液体残留，将包块及腺体送检。(3)创腔内充分止血，大量生理盐水反复冲洗创腔，分层缝合创腔。皮下放置橡皮引流条1根。对位皮肤,75%酒精消毒后，酒纱覆盖，碎纱加压包扎，无菌敷贴覆盖。\n3、术区冲洗并彻底止血，术毕。待患者清醒后送入病房。"}, {"id": "1768618525039", "mainCat": "手术记录", "subCat": "", "title": "颌骨囊肿", "tags": "住院", "content": "1、核对患者身份及手术部位等个人信息，确认无误后仰卧位，待全麻生效后，头偏向健侧，常规消毒铺巾展单。\n2、拉钩拉开上唇，暴露上颌前庭沟，自13至23牙龈移行处切开粘膜、粘膜下，用锐利的骨膜分离器仔细剥离粘骨膜，将粘骨膜瓣掀起，露出囊肿所在部位的骨壁。用剪刀将变薄的骨壁剪除或用骨钳沿穿破的骨缘去除变薄的骨片，显露囊壁。\n3、暴露根尖处囊肿，可见颊侧骨质已大部分吸收，囊腔内见炎性肉芽及结缔组织，根尖暴露于囊腔内，清除囊腔内炎性组织，向下可见腭侧骨板也已吸收，硬腭部分破溃，近似穿孔，用刮匙剜出坏死组织。\n4、沿囊壁与骨壁之间，用小骨膜剥离器仔细分离囊壁，完整摘除囊肿。\n5、盐水冲洗伤口，填塞碘仿纱条，达到止血、预防感染及促进肉芽生长的作用。\n6、缝合切口，预留切口，使碘仿纱条从切口引出。术毕。待患者清醒后送入病房。"}, {"id": "1768618447159", "mainCat": "手术记录", "subCat": "", "title": "拔牙术", "tags": "住院", "content": "1、核对患者身份及手术部位等个人信息，确认无误后仰卧位，待全麻生效后，头偏向健侧，常规消毒铺巾展单。\n2、用电刀在远中处做一角形切口，按切口设计，翻开38远中粘骨膜瓣，用骨凿祛除远中颊侧部分骨质，充分暴露牙冠外形高点及牙冠最大周径，祛除远中骨阻力及牙冠周围骨阻力、劈开牙近中牙冠解除邻牙阻力，分根，用牙挺将远中挺出，再分别取出近中牙冠及牙根，搔刮牙槽窝清除骨及牙碎屑，复位牙槽窝，修整牙槽骨和牙龈组织，用可吸收缝线缝合牙龈；棉纱压迫拔牙创。\n3、术区冲洗并彻底止血，术毕。待患者清醒后送入病房。"}, {"id": "1768618343159", "mainCat": "手术记录", "subCat": "", "title": "舌下腺囊肿", "tags": "住院", "content": "1、核对患者身份及手术部位等个人信息，确认无误后仰卧位，待全麻生效后，头偏向健侧，常规消毒铺巾展单。\n2、沿右侧舌下肉阜作横向切口，切开至黏膜下，暴露舌下腺囊肿，锐性分离，显露舌神经及颌下腺导管并保护，完整切除舌下腺，彻底止血后，对位缝合创口。术中囊肿破裂，淡黄色“唾液”样液体渗出，吸净后去除明显的囊壁组织。\n3、术区冲洗并彻底止血，术毕。待患者清醒后送入病房。"}, {"id": "1768618321031", "mainCat": "手术记录", "subCat": "", "title": "颌下腺摘除", "tags": "住院", "content": "1、核对患者身份及手术部位等个人信息，确认无误后仰卧位，待全身麻醉生效后，头偏向健侧，常规消毒铺巾展单。\n2、沿下颌下缘1.5cm处做一平行切口，切开皮肤、皮下组织、颈阔肌、颈深筋膜，显露下颌下腺。在咬肌前缘与下颌下缘交界处显露、钳夹、切断并结扎面动脉及面前静脉，注意保护在其浅面越过的面神经下颌缘支，然后分离下颌下腺上极。继续分离下颌下腺下机及前方，显露二腹肌前、后腹及下颌舌骨肌。将下颌舌骨肌拉向前，显露下颌下腺导管及舌神经，剪断并结扎颌下神经节通向下颌下腺的分泌支。游离下颌下腺导管，近口底钳夹、切断并双重结扎下颌下腺导管。游离下颌下腺深部，在下颌下腺后上方，二腹肌后腹浅面找出面动脉近心端，钳夹切断并双重结扎，完整摘除腺体。\n3、术区冲洗并彻底止血，创口内置入橡皮引流条，分层缝合颈阔肌、皮下组织及皮肤，然后加压包扎消灭死腔。\n4、术毕。待患者清醒后送入病房。"}, {"id": "1768618274200", "mainCat": "手术记录", "subCat": "", "title": "腭裂(两瓣法)", "tags": "住院", "content": "1、核对患者身份及手术部位等个人信息，确认无误后仰卧位，待全麻生效后，头后仰，常规消毒铺巾展单。\n2、(1)患者取平卧位，垫肩，待全麻生效后，常规消毒铺敷。(2)用1/20万肾上腺素生理盐水局部注射腭部组织瓣，减少术中出血。切开两瓣裂隙边缘粘骨膜至悬雍垂，剖开到肌层。用尖刀离牙槽嵴约2mm处切透两瓣的腭粘骨膜，向后绕上颌结节达舌腭弓的外侧。插入骨膜分离器沿骨面分离腭粘骨膜瓣，分离中保护并松解腭大神经血管束。将鼻腔黏膜与腭健膜分离开。(3)用丝线分3层（鼻腔黏膜、肌层、口腔黏膜）作交错相对缝合。暴露两侧松解部骨面填塞碘仿纱条。\n3、术区冲洗并彻底止血，术毕。待患者清醒后送入病房。"}, {"id": "1768618236440", "mainCat": "手术记录", "subCat": "", "title": "颌骨骨髓炎", "tags": "住院", "content": "1、核对患者身份及手术部位等个人信息，确认无误后仰卧位，待全麻生效后，常规消毒铺巾展单。\n    2、沿右侧下颌4-7前庭沟切开，翻开粘骨膜瓣，暴露下颌骨及病变部位，见右下颌骨颊侧皮质骨变薄部分吸收，内见大量肉芽组织并少量脓性分泌物、死骨等组织，彻底刮治并用动力系统磨除病灶周围坏死骨组织，术中尽量避免暴力牵拉并保护颏神经。核对46牙位，安放牙钳，予以完整拔除患牙，拔除后可见患牙为一颗纵裂牙，舌侧缘至根分叉处裂开。搔刮拔牙创，见拔牙创底部与骨髓炎病灶区相通，从拔牙窝入路填塞碘仿纱条至病灶区内，对位缝合创口。\n    3、术毕，术中出血量约50ml，肉芽组织及死骨示家属后送病理检查。待患者清醒后送入病房。"}, {"id": "1768618203592", "mainCat": "手术记录", "subCat": "", "title": "髁状突骨折合并正中联合骨折", "tags": "住院", "content": "1、核对患者身份及手术部位等个人信息，确认无误后仰卧位，待全麻生效后，头偏向健侧，常规消毒铺巾展单。\n2、左侧髁状突骨折切开复位内固定：(1)切口：采用耳前切口，在耳屏游离缘稍靠外耳道侧，切开皮肤、皮下组织、颞筋膜及骨膜，沿骨面向下分离，尽量靠外耳道前壁分离；牵开颞浅动静脉，结扎其后分支。在关节囊下方切开骨膜，分离显露骨折线及移位的髁突。可见断端下方靠前位置有面神经分支走形，将其进行松解并加以保护。(2)充分暴露骨折线后，可见骨折断端部分肌肉断裂，髁突头周围韧带剥脱，主要见髁突后缘韧带及骨膜破损，髁突向内侧近90°旋转，将其复位后在前缘、后缘分别置入一枚钛板，前3枚螺钉，后4枚螺钉固定，固定后可见髁状突形态可。（3）复位固定后大量生理盐水冲洗创口，将筋膜组织瓣成形，包绕髁突拉拢缝合，分层缝合粘骨膜层、肌层、皮肤层。\n3、下颌骨正中联合骨折切开复位内固定：(1)于33至43对应牙龈组织瓣下方口腔前庭沟作切口，翻开牙龈组织瓣，切开粘膜、黏骨膜瓣，紧贴骨面向下方剥离，显露下颌骨正中联合处骨折线，见部分移位。(2)充分暴露各骨折线后，清除大量纤维结缔组织，观察复位情况，上下颌骨内置入8颗牵引钉，胶圈行颌间牵引固定，随后观察咬合关系良好，下颌可见稍右侧偏颌，约2mm。(3)在此相对稳定的咬合关系下行下颌骨正中联合颌骨内坚固内固定，置入钛板一枚，固定后观察咬合关系良好。(4)固定后分层缝合粘骨膜层、粘膜层。\n4、手术共用钛板3枚，钛钉11枚，牵引钉8枚。术区冲洗并彻底止血，术毕。待患者清醒后送入病房。"}, {"id": "1768618131391", "mainCat": "手术记录", "subCat": "", "title": "拆除骨折内固定装置", "tags": "住院", "content": "1、核对患者身份及手术部位等个人信息，确认无误后仰卧位，待全麻生效后，头偏向健侧，常规消毒铺巾展单。\n2、(1)于47至42对应口腔前庭牙龈缘作切口，切开牙龈，翻开牙龈组织瓣，紧贴骨面向下方剥离，显露右侧下颌骨体部骨折处，剥离子分离粘骨膜瓣，可见明显粘连，可见上下两块钛板固定在位，周围可见新生骨质堆积。(2)充分暴露各骨折固定装置，清除周围大量纤维结缔组织，刮除表面骨痂，见骨折线间新生骨质生长好。前端可见颏神经不完全神经束从颏孔发出，并与周围组织明显粘连。(3)分离颏神经、松解并加以保护，用钛钉专用起子将螺钉去除后，去除钛板。(4)术区冲洗并彻底止血。修整创缘，使筋膜组织瓣成形，拉拢减张缝合后，分层缝合肌层、粘膜层。\n3、手术共拆除钛板2枚，钛钉11枚。术毕。待患者清醒后送入病房。"}, {"id": "1768618094335", "mainCat": "手术记录", "subCat": "", "title": "唇裂(三角瓣法)", "tags": "住院", "content": "1、核对患者身份及手术部位等个人信息，确认无误后仰卧位，待全麻生效后，常规消毒铺巾展单。\n2、采用下三角瓣法， 1点为健侧唇峰点；2点为人中切迹点；3点为唇红缘上一点，使3到2的距离等于2到1的距离；4点为患侧红唇最厚点，6、7点为同一点位于鼻翼下方前份处，5点为健侧人中中心一点，使3-6连线与3-5垂直；在患侧上唇定点8、9，9点为外侧一点，使4-8-9-4形成一等腰三角形，用美兰连接7-9-8-4。\n3、沿上述连线全层切开上唇组织。切开后得到健侧6-3-5形成的A和5-3-2形成的C瓣，患侧9-8-4形成的B瓣，C瓣下降降低患者健侧唇高。B瓣向健侧推进插入A、C瓣形成的三角间隙内，封闭裂隙；\n4、术中减张，分层缝合粘膜层、肌层、皮肤层，三角瓣法修复红唇。\n5、手术顺利，患儿清醒后安返回房。"}, {"id": "1768618043039", "mainCat": "手术记录", "subCat": "", "title": "面部肿物", "tags": "住院", "content": "1、核对患者身份及手术部位等个人信息，确认无误后仰卧位，待全麻生效后，头偏向健侧，常规消毒铺巾展单。\n2、(1)切口：在肿物周围正常组织内沿皮纹方向做一梭形切口/在肿物表面最隆起部分的表面沿皮纹方向、神经走向作一线型切口。(2)沿切口设计，切开皮肤、用镊子提起切开皮肤边缘，以小剪刀锐性分离显露囊壁，然后沿囊壁周围继续锐性分离（以蚊式血管钳钝性分离），直至囊肿完全分离，完整摘除。(3)创腔内充分止血，大量生理盐水反复冲洗创腔，分层缝合关闭创腔。无菌敷贴覆盖。\n3、术毕。待患者清醒后送入病房。"}, {"id": "1768617999367", "mainCat": "手术记录", "subCat": "", "title": "颊间隙感染累及颌下腺2", "tags": "住院", "content": "1、患者取平卧位，暴露脓肿部位，待麻醉生效后，从左侧下颌下距下颌下缘2cm在脓肿地位处切开，切口长5cm，逐层切开皮肤、皮下组织、颈阔肌，暴露左侧颌下三角区，可见左侧颌下腺明显变硬，周围包膜变脆，内含弥散性白色脓性物质，剥离包膜后可见大量脓性渗出，与患者家属沟通后摘除左侧颌下腺，分离左侧颌下腺周围组织，分离后端沿途结扎止血，前端分离后剥离左侧颌下腺导管，将其结扎后剪断，完整摘除左侧颌下腺。\n2、探查颈部及口底各间隙并清创周围炎性物质。用骨膜剥离器由切口处向上向内侧进入咽旁间隙，向前上进入颏下间隙，顿性分离引出脓液，大量黄白色脓液，共计量约60ml，用盐水液冲洗脓腔直至脓腔冲洗液清亮，冲洗脓腔后置入橡皮引流条引流。将有血管暴露的地方用筋膜组织瓣覆盖缝合两针，流出引流口。"}, {"id": "1768617971368", "mainCat": "手术记录", "subCat": "", "title": "颊间隙感染累及颌下腺", "tags": "住院", "content": "1、核对患者身份及手术部位等个人信息，确认无误后仰卧位，待全麻生效后，头偏向健侧，常规消毒铺巾展单。\n2、沿右侧颌下约2cm肿胀膨隆区处作一长约5cm的横行切口，切开皮肤、皮下组织、颈阔肌、颈深筋膜，显露下颌下腺，可见右侧颌下腺明显肿大，腺体弥漫性膨隆，周围组织粘连严重，颌下腺前份近导管口处见大量白色脓性液体潴留，并伴有破溃，邻近淋巴结肿胀伴脓肿形成。在咬肌前缘与下颌下缘交界处显露面动脉及面前静脉，沿途电刀电凝止血及钳夹缝合止血。注意保护在其浅面越过的面神经下颌缘支，然后分离下颌下腺上极。继续分离下颌下腺下极及前方，显露二腹肌前、后腹及下颌舌骨肌。将下颌舌骨肌拉向前，显露下颌下腺导管及舌神经，导管周围组织腐烂严重，剪断并结扎颌下神经节通向下颌下腺的分泌支。游离下颌下腺导管，近口底钳夹、切断并双重结扎下颌下腺导管，摘除右侧颌下腺腺体。腺体摘除后见右侧颌下三角区大量炎性腐败坏死组织形成，呈暗黑色，下方及深部大量脓性渗出，继续向周围间隙分离，见大量白色脓性液体溢出，量约50ml，用组织剪逐层修剪坏死腐败组织，清创干净，用大量生理盐水冲洗各个脓腔（颏下间隙、舌下间隙、翼下颌间隙、颌下间隙），直至冲洗液清亮，置入橡胶引流管至各个脓腔，缝线拉拢悬吊创口缩小创口并固定相较管。\n3、48拔牙术：术中患者被动张口可，可查及患者右侧下颌后牙牙龈萎缩，牙齿三度松动，周围牙龈剥脱，可见少许黄白色脓性渗出物。术中消毒后，洗净牙齿周围腐败物质，用牙钳将牙拔除，拔除后可见牙齿根尖吸收变小，并有明显黑染。\n4、术中麻醉满意，出血约50ml；术中取分泌物送细菌培养及药敏试验，切除颌下腺送病理检验。术毕，待患者清醒后送入病房。"}, {"id": "1768617913511", "mainCat": "手术记录", "subCat": "", "title": "清创标准操作", "tags": "住院", "content": "(1)冲洗创口：用消毒无菌纱布盖住创口，然后用外用生理盐水冲洗创口周围的皮肤，冲洗干净后予以碘伏消毒创面，用2%盐酸利多卡因注射液行周围组织神经阻滞麻醉，麻醉生效后，用大量生理盐水和1%过氧化氢溶液交替冲洗创口，用纱布反复擦洗创面，尽可能清除创口内的残留异物。(2)清理创口：皮肤消毒、铺巾，进行清创。清除创缘的坏死组织，尽可能保留受损组织，修整创缘，使创口两侧缘较规整，确保组织尽可能恢复或接近正常位置。(3)缝合：创口清创干净后，再次消毒创面，分层缝合创口，尽可能恢复患者局部外形。"}, {"id": "1768617678864", "mainCat": "知情同意", "subCat": "手术同意书", "title": "口腔肿物", "tags": "门诊", "content": "1、手术麻醉药物过敏，引起过敏性休克。麻醉意外导致心跳骤停，呼吸衰竭等；\n2、因治疗需要术中可能损伤邻近血管引起出血致失血性休克；根据部位及范围不同，术中可能损伤区域神经及其分支，引起感觉异常（如唇、舌麻木）、功能障碍（如面瘫）等并发症；\n3、术中如遇见术前无法预见之情况，医生有权停止手术或更改术式及手术时间；\n4、术后术区外形改变甚至畸形，创口感染，延期愈合甚至不愈合。创口疤痕形成影响器官功能，如唇、舌部活动障碍；\n5、若患者医从性差，不配合治疗，术中可能发生意外情况，导致其余部位或邻近组织损伤。\n6、因门诊手术条件受限，无法完善术前检查。患者应毫无保留的告知所患全身疾病，若患者隐瞒病情，可能出现因患者自身疾病所致的其他意外风险及不良后果，如既往疾病加重恶化、出血不止、创口长时间不愈合等。\n7、术后复发可能。根据病理结果明确诊断（不要求病理检验者除外），确定下一步治疗方案；\n8、其它许多未列举之可能性。若术中术后发生任何风险意外，患者或家属应积极同意配合医护人员为抢救生命而采取的应急救治所必需的仪器设备和治疗措施，并理解医院无法事先征得您的同意。\n\n如果不进行手术，患者可能面临的风险是：肿物增大、破溃、感染扩散影响周围组织器官等。"}, {"id": "1768617542312", "mainCat": "知情同意", "subCat": "手术同意书", "title": "面部肿物", "tags": "门诊", "content": "1、手术麻醉药物过敏，引起过敏性休克。麻醉意外导致心跳骤停，呼吸衰竭等；\n2、因治疗需要术中可能损伤邻近血管引起出血致失血性休克；根据部位及范围不同，术中可能损伤区域神经及其分支，引起感觉异常（如唇、舌麻木）、功能障碍（如面瘫）等并发症；\n3、术中如遇见术前无法预见之情况，医生有权停止手术或更改术式及手术时间；\n4、术后创口感染，延期愈合甚至不愈合。创口疤痕形成影响外观及器官功能，如唇、舌部活动障碍；\n5、若患者医从性差，不配合治疗，术中可能发生意外情况，导致其余部位或邻近组织损伤。\n6、因门诊手术条件受限，无法完善术前检查。患者应毫无保留的告知所患全身疾病，若患者隐瞒病情，可能出现因患者自身疾病所致的其他意外风险及不良后果，如既往疾病加重恶化、出血不止、创口长时间不愈合等。\n7、术后复发可能。根据病理结果明确诊断（不要求病理检验者除外），确定下一步治疗方案；\n8、其它许多未列举之可能性。若术中术后发生任何风险意外，患者或家属应积极同意配合医护人员为抢救生命而采取的应急救治所必需的仪器设备和治疗措施，并理解医院无法事先征得您的同意。"}, {"id": "1768617486480", "mainCat": "知情同意", "subCat": "手术同意书", "title": "清创+美容缝合", "tags": "门诊", "content": "1、手术麻醉药物过敏，引起过敏性休克。麻醉意外导致心跳骤停、呼吸衰竭等。\n2、因损伤部位及范围不同，术中可能损伤邻近血管引起出血致失血性休克；术中可能损伤区域神经及其分支，引起感觉（如麻木或其他不适感）、功能障碍（如面瘫）等并发症。\n3、术中如遇见术前无法预见之情况，医生有权停止手术、更改术式及调整手术时间。\n4、伤口异物残留，术后可能发生感染，导致伤口延期愈合甚至不愈合，根据创口愈合情况需行进一步治疗。\n5、瘢痕是创口愈合后的必然产物。瘢痕的粗细明显程度与瘢痕体质、创面的深度和污染程度呈正相关，还与受伤机制、受伤时间等多种因素有关。\n6、若患者医从性差，不配合治疗，导致身体其余部位或邻近组织损伤，甚至出现心理健康问题。\n7、患者急诊就诊，为抢救患者急症，无法完善术前检查。可能出现因患者自身疾病所致的其他风险及不良后果，如出血不止、创口长时间不愈合、心脑血管疾病致生命危险等。\n8、其它许多未列举之可能性。若术中术后发生任何风险意外，患者或家属应积极同意配合医护人员为抢救生命而采取的应急救治所必需的仪器设备和治疗措施，并理解医院无法事先征得您的同意。\n\n如果不进行手术，患者可能面临的风险是：创口错位愈合或愈合时间长不能愈合、感染。"}, {"id": "1768617373432", "mainCat": "知情同意", "subCat": "手术同意书", "title": "舌下腺切除", "tags": "门诊", "content": "1、手术麻醉药物过敏，引起过敏性休克。麻醉意外导致心跳骤停，呼吸衰竭等；\n2、因治疗需要术中可能损伤邻近血管引起出血致失血性休克；术中可能损伤区域神经及其分支，引起麻木、功能障碍等并发症，术中可能出现呼吸阻塞需急行气管切开手术；\n3、术中如遇见术前无法预见之情况，医生有权停止手术或更改术式及手术时间；\n4、术后出血、囊肿复发再发可能；\n5、术后感染，愈合较差或不能愈合，需要行二期治疗；\n6、术后疤痕形成，瘢痕增生伴挛缩致患侧舌部运动障碍，影响发音清晰度；\n7、术后进食困难，术区疼痛；\n8、术后颌下腺阻塞病变，需要进一步治疗或手术摘除颌下腺。其它许多未列举之可能性。\n\n如果不进行手术，患者可能面临的风险是：囊肿增大、破溃、感染扩散，影响患者舌部活动。 "}, {"id": "1768617326416", "mainCat": "知情同意", "subCat": "手术同意书", "title": "脓肿切开引流", "tags": "门诊", "content": "1、手术麻醉药物过敏，引起过敏性休克。麻醉意外导致心跳骤停，呼吸衰竭等。\n2、因治疗需要术中可能损伤邻近血管引起出血致失血性休克；术中引流区域神经及其分支可能损伤，引起感觉异常（如口唇麻木）、功能障碍（如面瘫、舌活动异常）等并发症；\n3、术中如遇见术前无法预见之情况，医生有权停止手术或更改术式及手术时间。\n4、术后感染仍有加重、扩散的可能，引起全身纵膈感染、败血症、脓毒血症、骨髓炎等，伤口愈合需要较长的时间，痊愈后伤口疤痕增生挛缩影响美观。\n5、术后需较长时间的冲洗换药，需要患者积极配合等。\n6、患者急诊就诊，为抢救患者急症，无法完善术前检查。可能出现因患者自身疾病所致的其他风险及不良后果，如出血不止、创口长时间不愈合、心脑血管疾病致生命危险等。若患者合并全身疾病，感染不易控制、伤口愈合缓慢等需要患者及家属积极配合治疗。\n7、其它许多未列举之可能性。若术中术后发生任何风险意外，患者或家属应积极同意配合医护人员为抢救生命而采取的应急救治所必需的仪器设备和治疗措施，并理解医院无法事先征得您的同意。\n\n如果不进行手术，患者可能面临的风险是：脓肿不能得到有效控制，感染扩散。 "}, {"id": "1768617301928", "mainCat": "知情同意", "subCat": "手术同意书", "title": "切取活检", "tags": "门诊", "content": "1、麻醉药物过敏，引起过敏性休克。麻醉意外导致心跳骤停，呼吸衰竭等；\n2、术中损伤血管，引起出血甚至失血性休克；损伤临近神经引起相应支配区域感觉或功能障碍；\n3、术后可能出现疼痛、渗血及局部肿胀。应避免进食烫食及其它刺激性食物。\n4、术后切取标本不能明确诊断，需再次切取组织加以明确。\n5、术后肿瘤生长迅速，需尽快采取治疗。\n6、术后伤口感染，局部愈合不佳，延迟愈合甚至不愈合。\n7、疤痕或瘀斑形成影响美观，其他不可预知及避免的并发症。\n8、其它许多未列举之可能性。若术中术后发生任何风险意外，患者或家属应积极同意配合医护人员为抢救生命而采取的应急救治所必需的仪器设备和治疗措施，并理解医院无法事先征得您的同意。\n\n如果不进行手术，患者可能面临的风险是：不能明确诊断，无法制定下一步治疗。"}, {"id": "1768617261273", "mainCat": "知情同意", "subCat": "手术同意书", "title": "根尖切除", "tags": "门诊", "content": "1、手术麻醉药物过敏，引起过敏性休克。麻醉意外导致心跳骤停，呼吸衰竭等；\n2、因治疗需要术中可能损伤邻近血管引起出血致失血性休克；根据部位及范围不同，术中可能损伤区域神经及其分支，引起感觉异常（如麻木）、功能障碍（如面瘫、咀嚼不适）等并发症；损伤邻近重要的解剖结构，如邻牙牙体或牙根损伤出现牙体症状，损伤上颌窦导致上颌窦瘘并长期不愈；\n3、术中如遇见术前无法预见之情况，医生有权停止手术、更改术式及调整手术时间；\n4、术后创口感染，延期愈合甚至不愈合。创口疤痕形成影响器官功能，如唇、舌部活动障碍；\n7、若患者医从性差，不配合治疗，术中可能发生意外情况，导致其余部位或邻近组织损伤。\n8、因门诊手术条件受限，无法完善术前检查。患者应毫无保留的告知所患全身疾病，若患者隐瞒病情，可能出现因患者自身疾病所致的其他意外风险及不良后果，如既往疾病加重恶化、出血不止、创口长时间不愈合等。\n9、术后复发可能。\n10、其它许多未列举之可能性。若术中术后发生任何风险意外，患者或家属应积极同意配合医护人员为抢救生命而采取的应急救治所必需的仪器设备和治疗措施，并理解医院无法事先征得您的同意。\n\n如果不进行手术，患者可能面临的风险是：根尖周病灶不能去除，感染无法控制。 "}, {"id": "1768617220593", "mainCat": "知情同意", "subCat": "手术同意书", "title": "黏液腺囊肿", "tags": "门诊", "content": "1、麻醉及麻醉并发症致死致残。麻醉意外导致心跳骤停，呼吸衰竭等；\n2、术中诱发心脑血管意外，因治疗需要术中可能损伤邻近血管引起出血致失血性休克危及生命；\n3、根据部位及范围不同，术中可能损伤区域神经及其分支，引起感觉异常（如唇、舌麻木）、功能障碍（如面瘫、舌运动异常）等并发症；\n4、术后复发可能。根据病理结果明确诊断（不要求病理检验者除外），确定下一步治疗方案；\n5、术后创口感染，延期愈合甚至不愈合，需要进一步治疗或再次手术可能；\n6、术后疤痕形成，影响外观或器官功能，如唇、舌部外观改变或活动障碍；\n7、术后进食困难可能，疼痛或肿胀发生；\n8、其他难以预料的意外并发症。若术中术后发生任何风险意外，患者或家属应积极同意配合医护人员为抢救生命而采取的应急救治所必需的仪器设备和治疗措施，并理解医院无法事先征得您的同意。\n\n如果不进行手术，患者可能面临的风险是：肿物不能去除，肿物增大影响周围组织及器官。"}, {"id": "1768617171584", "mainCat": "知情同意", "subCat": "手术同意书", "title": "清创缝合", "tags": "门诊", "content": "1、手术麻醉药物过敏，引起过敏性休克。麻醉意外导致心跳骤停、呼吸衰竭等。\n2、因损伤部位及范围不同，术中可能损伤邻近血管引起出血致失血性休克；术中可能损伤区域神经及其分支，引起感觉（如麻木或其他不适感）、功能障碍（如面瘫、舌活动受限）等并发症。\n3、术中如遇见术前无法预见之情况，医生有权停止手术、更改术式及调整手术时间。\n4、伤口异物残留，术后可能发生感染，导致伤口延期愈合甚至不愈合，根据创口愈合情况需行进一步治疗。\n5、瘢痕是创口愈合后的必然产物。瘢痕的粗细明显程度与瘢痕体质、创面的深度和污染程度呈正相关，还与受伤机制、受伤时间等多种因素有关。\n6、若患者医从性差，不配合治疗，导致身体其余部位或邻近组织损伤，甚至出现心理健康问题。\n7、患者急诊就诊，为抢救患者急症，无法完善术前检查。可能出现因患者自身疾病所致的其他风险及不良后果，如出血不止、创口长时间不愈合、心脑血管疾病致生命危险等。\n8、其它许多未列举之可能性。若术中术后发生任何风险意外，患者或家属应积极同意配合医护人员为抢救生命而采取的应急救治所必需的仪器设备和治疗措施，并理解医院无法事先征得您的同意。\n如果不进行手术，患者可能面临的风险是：创口错位愈合或愈合时间长不能愈合、感染。"}, {"id": "1768617064801", "mainCat": "知情同意", "subCat": "手术同意书", "title": "颌骨囊肿切除", "tags": "门诊", "content": "1、手术麻醉药物过敏，引起过敏性休克。麻醉意外导致心跳骤停，呼吸衰竭等；\n2、因治疗需要术中可能损伤邻近血管引起出血致失血性休克；根据部位及范围不同，术中可能损伤区域神经及其分支，引起感觉异常（如麻木）、功能障碍（如面瘫、咀嚼不适）等并发症；损伤邻近重要的解剖结构，如邻牙牙体或牙根损伤出现牙体症状，损伤上颌窦导致上颌窦瘘并长期不愈；\n3、术中如遇见术前无法预见之情况，医生有权停止手术、更改术式及调整手术时间；\n4、术后创口感染，延期愈合甚至不愈合。创口疤痕形成影响器官功能，如唇、舌部活动障碍；\n7、若患者医从性差，不配合治疗，术中可能发生意外情况，导致其余部位或邻近组织损伤。\n8、因门诊手术条件受限，无法完善术前检查。患者应毫无保留的告知所患全身疾病，若患者隐瞒病情，可能出现因患者自身疾病所致的其他意外风险及不良后果，如既往疾病加重恶化、出血不止、创口长时间不愈合等。\n9、术后复发可能。根据病理结果明确诊断，确定是否需下一步治疗方案；\n10、其它许多未列举之可能性。若术中术后发生任何风险意外，患者或家属应积极同意配合医护人员为抢救生命而采取的应急救治所必需的仪器设备和治疗措施，并理解医院无法事先征得您的同意。\n\n如果不进行手术，患者可能面临的风险是：囊肿增大、破溃、感染扩散影响周围组织器官等。"}]}`;
function getPresetBackup(){
  try { return JSON.parse(PRESET_BACKUP_JSON); } catch(e){ return null; }
}


let currentFilter = { type: 'ALL', value: '' }; // ALL/MAIN/SUB
let editingCategoryMain = null;

// 标签
let selectedTags = new Set();
let allTagsCache = [];
let tagUsageMap = new Map();
let tagPoolExpanded = false;

// 未保存快照
let templateModalSnapshot = null;
let moveModalSnapshot = null;
let listenersBound = false;

// 三选项上下文
let confirm3Context = null;

// icon picker 上下文
let iconPickerContext = null;
/*
  iconPickerContext = {
    scope: 'MAIN' | 'SUB' | 'NEW_MAIN' | 'NEW_SUB',
    mainIndex,
    subIndex,
    usedKeys: Set,
    onPick: (key) => void
  }
*/

// 新增分类临时选择
let newMainIconKey = 'folder';
let newSubIconKey = 'folderOpen';


/* =========================
   9) 密码保护（本地）
   ========================= */
const __AUTH_KEY = 'myemr_auth_v1';
const __AUTH_SESSION = 'myemr_unlocked';
let __appInitialized = false;
let __appInitDeferred = null;

function __authGetRecord(){
  try { return JSON.parse(localStorage.getItem(__AUTH_KEY) || 'null'); } catch(e){ return null; }
}
function __authIsPasswordSet(){ return !!__authGetRecord(); }
function __authIsUnlocked(){ return sessionStorage.getItem(__AUTH_SESSION) === '1'; }

function __b64ToU8(b64){
  const bin = atob(b64);
  const u8 = new Uint8Array(bin.length);
  for (let i=0;i<bin.length;i++) u8[i] = bin.charCodeAt(i);
  return u8;
}
function __u8ToB64(u8){
  let bin = '';
  u8.forEach(b => bin += String.fromCharCode(b));
  return btoa(bin);
}
async function __pbkdf2(pwd, saltB64, iterations){
  const enc = new TextEncoder();
  const key = await crypto.subtle.importKey('raw', enc.encode(pwd), {name:'PBKDF2'}, false, ['deriveBits']);
  const salt = __b64ToU8(saltB64);
  const bits = await crypto.subtle.deriveBits(
    {name:'PBKDF2', hash:'SHA-256', salt, iterations},
    key,
    256
  );
  return __u8ToB64(new Uint8Array(bits));
}
function __authClearErrors(){
  ['authLoginErr','authSetupErr','authChgErr'].forEach(id=>{
    const el = document.getElementById(id);
    if (el){ el.style.display='none'; el.textContent=''; }
  });
}
function __authShow(section){
  const overlay = document.getElementById('authOverlay');
  if (!overlay) return;

  // Hide app shell while locked (prevents confusing partial UI).
  const shell = document.getElementById('appShell');
  if (shell && !__authIsUnlocked()) shell.style.display = 'none';

  __authClearErrors();
  overlay.style.display = 'flex';

  // lock background scroll using existing robust lock
  if (typeof lockBodyScrollForModal === 'function') lockBodyScrollForModal();

  const secIds = ['authLoginSection','authSetupSection','authChangeSection'];
  secIds.forEach(id => { const el = document.getElementById(id); if (el) el.style.display = 'none'; });

  const login = document.getElementById('authLoginSection');
  const setup = document.getElementById('authSetupSection');
  const change = document.getElementById('authChangeSection');

  const toSetup = document.getElementById('authToSetupBtn');
  if (toSetup) toSetup.style.display = __authIsPasswordSet() ? 'none' : 'block';

  if (section === 'setup') setup.style.display = 'block';
  else if (section === 'change') change.style.display = 'block';
  else login.style.display = 'block';

  setTimeout(() => {
    const f = section === 'setup' ? 'authNewPwd' : (section === 'change' ? 'authOldPwd' : 'authLoginPwd');
    const inp = document.getElementById(f);
    if (inp) inp.focus();
  }, 50);
}
function __authHide(){
  const overlay = document.getElementById('authOverlay');
  if (overlay) overlay.style.display = 'none';
  if (typeof unlockBodyScrollForModal === 'function') unlockBodyScrollForModal();
}
async function __authSetPassword(pwd){
  const salt = crypto.getRandomValues(new Uint8Array(16));
  const saltB64 = __u8ToB64(salt);
  const iter = 210000;
  const hash = await __pbkdf2(pwd, saltB64, iter);
  localStorage.setItem(__AUTH_KEY, JSON.stringify({v:1, salt: saltB64, iter, hash, updatedAt: Date.now()}));
}
async function __authVerify(pwd){
  const rec = __authGetRecord();
  if (!rec || !rec.salt || !rec.hash) return false;
  const hash = await __pbkdf2(pwd, rec.salt, rec.iter || 210000);
  return hash === rec.hash;
}
function __authEnsureInit(){
  if (__appInitialized) return;
  __appInitialized = true;

  const shell = document.getElementById('appShell');
  if (shell) shell.style.display = '';

  if (typeof __appInitDeferred === 'function') __appInitDeferred();
}
function authBoot(){
  // If not set, show setup
  if (!__authIsPasswordSet()){
    __authShow('setup');
    return;
  }
  // If session unlocked, init directly
  if (__authIsUnlocked()){
    __authHide();
    __authEnsureInit();
    return;
  }
  __authShow('login');
}
function lockApp(){
  if (typeof __autoLockStop === 'function') __autoLockStop();
  sessionStorage.removeItem(__AUTH_SESSION);
  __appInitialized = false;
  __authShow('login');
}
function openChangePassword(){
  if (!__authIsPasswordSet()){
    __authShow('setup');
    return;
  }
  if (!__authIsUnlocked()){
    __authShow('login');
    return;
  }
  __authShow('change');
}

/* =========================
   9.5) 设置（安全/数据/自动锁定）
   ========================= */
const __SETTINGS_KEY = '__MYEMR_SETTINGS';
const __DEFAULT_SETTINGS = { autoLockMinutes: 2, lockOnLeave: true };
let __settings = null;

function __loadSettings(){
  try {
    const raw = localStorage.getItem(__SETTINGS_KEY);
    __settings = raw ? JSON.parse(raw) : {};
  } catch(e) {
    __settings = {};
  }
  __settings = Object.assign({}, __DEFAULT_SETTINGS, __settings || {});
  __settings.autoLockMinutes = Number(__settings.autoLockMinutes);
  if (!Number.isFinite(__settings.autoLockMinutes) || __settings.autoLockMinutes < 0) {
    __settings.autoLockMinutes = __DEFAULT_SETTINGS.autoLockMinutes;
  }
  __settings.lockOnLeave = !!__settings.lockOnLeave;
}

function __saveSettings(){
  try { localStorage.setItem(__SETTINGS_KEY, JSON.stringify(__settings)); } catch(e){}
}

function __applySettings(){
  const mins = Number(__settings.autoLockMinutes);
  __AUTOLOCK_IDLE_MS = (mins > 0) ? (mins * 60 * 1000) : 0;

  // Update UI (if present)
  const sel = document.getElementById('setAutoLockMinutes');
  if (sel) sel.value = String(mins);
  const chk = document.getElementById('setLockOnLeave');
  if (chk) chk.checked = !!__settings.lockOnLeave;

  // Reset timer immediately
  if (typeof __autoLockReset === 'function') __autoLockReset();
}

function openSettings(){
  if (!__settings) __loadSettings();
  __applySettings();
  const about = document.getElementById('aboutVersion');
  if (about) about.textContent = 'MyEMR V6.2';
  openModal('settingsModal');
}

function updateSettingsFromUI(){
  if (!__settings) __loadSettings();
  const sel = document.getElementById('setAutoLockMinutes');
  const chk = document.getElementById('setLockOnLeave');
  const mins = sel ? Number(sel.value) : __settings.autoLockMinutes;
  __settings.autoLockMinutes = Number.isFinite(mins) ? mins : __DEFAULT_SETTINGS.autoLockMinutes;
  __settings.lockOnLeave = chk ? !!chk.checked : __settings.lockOnLeave;
  __saveSettings();
  __applySettings();
}

function triggerImportFromSettings(){
  requestCloseModal('settingsModal');
  const fi = document.getElementById('fileInput');
  if (fi) fi.click();
}

function importPresetFromSettings(){
  const preset = getPresetBackup();
  if(!preset){
    openAlertModal('未找到内置预设数据。', '导入失败');
    return;
  }
  const ts = preset.timestamp || '预设';
  const cCount = Array.isArray(preset.categories) ? preset.categories.length : 0;
  const tCount = Array.isArray(preset.templates) ? preset.templates.length : 0;

  openConfirm3({
    title: '导入预设数据',
    body: `预设备份时间：${ts}\n分类数量：${cCount}\n模板数量：${tCount}\n\n请选择导入方式：\n- 增加导入：将预设内容合并到当前数据（不会删除现有内容，同名模板将按规则合并）\n- 覆盖导入：用预设完全替换当前数据`,
    labels: { continue: '取消', discard: '增加导入', save: '覆盖导入' },
    onDiscard: () => {
      const d = getPresetBackup();
      if(!d) return;
      doImportAdd(d);
    },
    onSave: () => {
      const d = getPresetBackup();
      if(!d) return;
      doImportOverride(d);
    }
  });
}

/* =========================
   10) 自动锁定（离开页面立即锁定 + 2分钟无操作锁定）
   ========================= */
let __AUTOLOCK_IDLE_MS = 120000; // default 2 minutes (will be overridden by settings)
let __autoLockTimer = null;
let __autoLockBound = false;

function __autoLockStop(){
  if (__autoLockTimer){
    clearTimeout(__autoLockTimer);
    __autoLockTimer = null;
  }
}
function __autoLockReset(){
  // Only count when unlocked
  if (!__authIsUnlocked()){
    __autoLockStop();
    return;
  }
  if (!__AUTOLOCK_IDLE_MS || __AUTOLOCK_IDLE_MS <= 0){
    __autoLockStop();
    return;
  }
  __autoLockStop();
  __autoLockTimer = setTimeout(() => {
    if (__authIsUnlocked()) lockApp();
  }, __AUTOLOCK_IDLE_MS);
}
function __autoLockBindOnce(){
  if (__autoLockBound) return;
  __autoLockBound = true;

  const opts = { passive: true };
  // User activity events
  ['pointerdown','pointermove','keydown','wheel','touchstart','touchmove','mousedown'].forEach(evt => {
    window.addEventListener(evt, __autoLockReset, opts);
  });
  window.addEventListener('scroll', __autoLockReset, opts);

  // Leaving the page / switching apps or tabs => lock immediately
  document.addEventListener('visibilitychange', () => {
    if (__settings && !__settings.lockOnLeave) return;
    if (document.hidden && __authIsUnlocked()) lockApp();
  });
  window.addEventListener('pagehide', () => {
    if (__settings && !__settings.lockOnLeave) return;
    if (__authIsUnlocked()) lockApp();
  });
}

function __bindAuthUIOnce(){
  if (window.__authBound) return;
  window.__authBound = true;

  const loginBtn = document.getElementById('authLoginBtn');
  const loginPwd = document.getElementById('authLoginPwd');
  const loginErr = document.getElementById('authLoginErr');

  const setupBtn = document.getElementById('authSetupBtn');
  const newPwd = document.getElementById('authNewPwd');
  const newPwd2 = document.getElementById('authNewPwd2');
  const setupErr = document.getElementById('authSetupErr');

  const toLoginBtn = document.getElementById('authToLoginBtn');
  const toSetupBtn = document.getElementById('authToSetupBtn');

  const chgBtn = document.getElementById('authChgBtn');
  const oldPwd = document.getElementById('authOldPwd');
  const chgPwd = document.getElementById('authChgPwd');
  const chgPwd2 = document.getElementById('authChgPwd2');
  const chgErr = document.getElementById('authChgErr');
  const chgCancel = document.getElementById('authChgCancelBtn');

  function showErr(el, msg){
    if (!el) return;
    el.textContent = msg;
    el.style.display = 'block';
  }

  async function doLogin(){
    __authClearErrors();
    const pwd = (loginPwd?.value || '').trim();
    if (!pwd){ showErr(loginErr, '请输入密码。'); return; }
    try{
      if (!window.crypto?.subtle) { showErr(loginErr, '当前环境不支持安全密码校验（需要 HTTPS）。'); return; }
      const ok = await __authVerify(pwd);
      if (!ok){ showErr(loginErr, '密码错误。'); return; }
      sessionStorage.setItem(__AUTH_SESSION, '1');
      __authHide();
      if (typeof __autoLockReset === 'function') __autoLockReset();
      if (typeof __autoLockReset === 'function') __autoLockReset();
      __authEnsureInit();
      if (loginPwd) loginPwd.value = '';
    }catch(e){
      showErr(loginErr, '登录失败，请重试。');
    }
  }

  async function doSetup(){
    __authClearErrors();
    const p1 = (newPwd?.value || '').trim();
    const p2 = (newPwd2?.value || '').trim();
    if (!p1 || p1.length < 4){ showErr(setupErr, '新密码至少 4 位。'); return; }
    if (p1 !== p2){ showErr(setupErr, '两次输入的新密码不一致。'); return; }
    try{
      if (!window.crypto?.subtle) { showErr(setupErr, '当前环境不支持安全密码校验（需要 HTTPS）。'); return; }
      await __authSetPassword(p1);
      sessionStorage.setItem(__AUTH_SESSION, '1');
      __authHide();
      __authEnsureInit();
      if (newPwd) newPwd.value = '';
      if (newPwd2) newPwd2.value = '';
    }catch(e){
      showErr(setupErr, '设置失败，请重试。');
    }
  }

  async function doChange(){
    __authClearErrors();
    const o = (oldPwd?.value || '').trim();
    const p1 = (chgPwd?.value || '').trim();
    const p2 = (chgPwd2?.value || '').trim();
    if (!o){ showErr(chgErr, '请输入旧密码。'); return; }
    if (!p1 || p1.length < 4){ showErr(chgErr, '新密码至少 4 位。'); return; }
    if (p1 !== p2){ showErr(chgErr, '两次输入的新密码不一致。'); return; }
    try{
      const ok = await __authVerify(o);
      if (!ok){ showErr(chgErr, '旧密码错误。'); return; }
      await __authSetPassword(p1);
      if (oldPwd) oldPwd.value = '';
      if (chgPwd) chgPwd.value = '';
      if (chgPwd2) chgPwd2.value = '';
      __authHide();
    }catch(e){
      showErr(chgErr, '修改失败，请重试。');
    }
  }

  function enterTo(inputEl, handler){
    if (!inputEl) return;
    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter'){ e.preventDefault(); handler(); }
    });
  }

  if (loginBtn) loginBtn.addEventListener('click', doLogin);
  if (setupBtn) setupBtn.addEventListener('click', doSetup);
  if (chgBtn) chgBtn.addEventListener('click', doChange);
  if (chgCancel) chgCancel.addEventListener('click', () => { __authHide(); });

  if (toLoginBtn) toLoginBtn.addEventListener('click', () => __authShow('login'));
  if (toSetupBtn) toSetupBtn.addEventListener('click', () => __authShow('setup'));

  enterTo(loginPwd, doLogin);
  enterTo(newPwd2, doSetup);
  enterTo(chgPwd2, doChange);

  // Clicking outside card does nothing; overlay blocks background.
  const overlay = document.getElementById('authOverlay');
  if (overlay) overlay.addEventListener('click', (e)=>{ e.stopPropagation(); });
}


/* =========================
   4) 初始化
   ========================= */
window.onload = function() {
  mountTopIcons();
  updateTopbarHeight();
  bindSidebarBackdropNoScrollOnce();
    window.addEventListener('resize', updateTagPoolToggleVisibility);
  __loadSettings();
  __applySettings();

  // Bind auth UI and defer app init until unlocked
  __bindAuthUIOnce();
  __autoLockBindOnce();
  __appInitDeferred = function() {
    normalizeDataForCompatibility();
    normalizeCategoryTreeForCompatibility();

    bindDirtyListenersOnce();
    setupTagInputEnter();
    bindTagAddButtonDisable();

    bindEscToClose();

    rebuildTagPool([]);
    renderSidebar();
    renderTemplates();
    updateTopbarHeight();
    updateTagPoolToggleVisibility();
    syncNewCategoryIconRemember();
  };

  authBoot();
};
/* =========================
   5) 顶部固定图标挂载
   ========================= */
function setIcon(elId, key) {
  const el = document.getElementById(elId);
  if (!el) return;
  el.innerHTML = ICONS.svg(key);
}
function mountTopIcons() {
  setIcon('icoPlus', 'plusCircle');
  setIcon('icoManage', 'sort');      // 你要匹配“管理分类与排序”
  setIcon('icoReceipt', 'receipt');      // 备份收据
  setIcon('icoRestore', 'restore');      // 恢复数据
  setIcon('icoMenu', 'menu');               // 移动端菜单按钮
  setIcon('icoSettings', 'settings');        // 侧边栏设置

  setIcon('icoCloseSettings', 'x');
  setIcon('icoSetKey', 'key');
  setIcon('icoSetLock', 'lock');
  setIcon('icoSetExport', 'download');
  setIcon('icoSetImport', 'upload');
  setIcon('icoSetPreset', 'bookmark');
  setIcon('icoSetInfo', 'info');

  setIcon('icoClose1', 'x');
  setIcon('icoClose2', 'x');
  setIcon('icoClose3', 'x');
  setIcon('icoClose4', 'x');
  setIcon('icoConfirmClose', 'x');
  setIcon('icoCloseDialog', 'x');

  setIcon('icoPlusTag', 'plus');         // 标签添加按钮图标更合适（+）
  setIcon('icoChevron', 'chevronDown');

  setIcon('icoTrash', 'trash');
  setIcon('icoSave', 'save');
  setIcon('icoX', 'x');
  setIcon('icoX2', 'x');
  setIcon('icoMove', 'move');

  setIcon('icoPalette1', 'palette');
  setIcon('icoPalette2', 'palette');
  setIcon('icoPlus3', 'plus');
  setIcon('icoPlus4', 'plus');
  setIcon('icoKey', 'key');
  setIcon('icoLock', 'lock');

  setIcon('icoSetToken', 'tag');
  setIcon('icoCloseTokenInsert', 'x');
  setIcon('icoCloseTokenValue', 'x');
  setIcon('icoCloseTokenMgr', 'x');
  setIcon('icoCloseTokenEdit', 'x');
  setIcon('icoTokenAdd', 'plus');

}

/* =========================
   6) 遮罩点击不关闭 + ESC 关闭
   ========================= */
function noopClose(e) {
  if (e) { e.stopPropagation(); e.preventDefault(); }
  return false;
}
function isModalOpen(id) {
  const el = document.getElementById(id);
  return el && el.style.display === 'flex';
}
let __modalLockCount = 0;
let __modalZTop = 2000;

function bumpModalZIndex(modalEl){
  if (!modalEl) return;
  // Find the current highest z-index among modals (robust for nested modals)
  let maxZ = 2000;
  document.querySelectorAll('.modal').forEach(m => {
    const zStr = window.getComputedStyle(m).zIndex;
    const z = parseInt(zStr, 10);
    if (!Number.isNaN(z)) maxZ = Math.max(maxZ, z);
  });
  __modalZTop = Math.max(__modalZTop, maxZ) + 2;
  modalEl.style.zIndex = String(__modalZTop);
}

let __bodyScrollY = 0;

function anyModalVisible() {
  return Array.from(document.querySelectorAll('.modal'))
    .some(m => m && m.style && m.style.display === 'flex');
}

function lockBodyScrollForModal() {
  // Robust iOS scroll lock: lock BOTH <html> and <body>.
  if (document.documentElement.classList.contains('modal-open')) return;
  __bodyScrollY = window.scrollY || window.pageYOffset || document.documentElement.scrollTop || 0;

  document.documentElement.classList.add('modal-open');
  document.body.classList.add('modal-open');

  // Freeze the page at the current scroll position.
  document.documentElement.style.top = `-${__bodyScrollY}px`;
  document.body.style.top = `-${__bodyScrollY}px`;
}

function unlockBodyScrollForModal() {
  if (!document.documentElement.classList.contains('modal-open')) return;

  document.documentElement.classList.remove('modal-open');
  document.body.classList.remove('modal-open');

  const y = __bodyScrollY || 0;
  document.documentElement.style.top = '';
  document.body.style.top = '';

  window.scrollTo(0, y);
}

function openModal(id) {
  // Mobile: if the sidebar drawer is open, close it before showing a modal.
  if (isMobile()) closeSidebar();
  const el = document.getElementById(id);
  if (!el) return;
  bumpModalZIndex(el);
  el.style.display = 'flex';
  __modalLockCount++;
  // On mobile we use page scrolling; lock it to prevent background move while scrolling the modal.
  if (isMobile()) lockBodyScrollForModal();
}

function closeModalDirect(id) {
  const el = document.getElementById(id);
  if (el) el.style.display = 'none';
  __modalLockCount = Math.max(0, __modalLockCount - 1);
  // If no modal is visible, unlock the page scroll.
  if (isMobile() && !anyModalVisible()) unlockBodyScrollForModal();
}

// iOS Safari: prevent scroll from propagating to the background while a modal is open.
if (!window.__modalTouchBound) {
  window.__modalTouchBound = true;
  document.addEventListener('touchmove', function(e) {
    if (!isMobile()) return;
    if (!anyModalVisible()) return;
    // Allow scrolling inside modal content.
    const inModal = e.target && e.target.closest && e.target.closest('.modal-content');
    if (inModal) return;
    e.preventDefault();
  }, { passive: false });
}

function isMobile() {
  return window.matchMedia && window.matchMedia('(max-width: 680px)').matches;
}

function updateTopbarHeight() {
  if (!isMobile()) { document.documentElement.style.removeProperty('--topbar-h'); return; }
  const tb = document.querySelector('.top-bar');
  if (!tb) return;
  // 使用 getBoundingClientRect，兼容 iOS 缩放/动态栏高度变化
  const h = Math.ceil(tb.getBoundingClientRect().height);
  if (h > 0) document.documentElement.style.setProperty('--topbar-h', h + 'px');
}

// ---- Drawer (sidebar) scroll lock (mobile) ----
let __drawerScrollY = 0;
function lockBodyScrollForDrawer() {
  // If modal already locks the page, only mark drawer-open and return.
  if (document.documentElement.classList.contains('drawer-open')) return;
  if (document.documentElement.classList.contains('modal-open')) {
    document.documentElement.classList.add('drawer-open');
    document.body.classList.add('drawer-open');
    return;
  }
  __drawerScrollY = window.scrollY || window.pageYOffset || document.documentElement.scrollTop || 0;
  document.documentElement.classList.add('drawer-open');
  document.body.classList.add('drawer-open');

  // Freeze page at current scroll position (iOS-safe)
  document.documentElement.style.top = `-${__drawerScrollY}px`;
  document.body.style.top = `-${__drawerScrollY}px`;

  document.documentElement.style.position = 'fixed';
  document.body.style.position = 'fixed';
  document.documentElement.style.width = '100%';
  document.body.style.width = '100%';

  document.documentElement.style.overflow = 'hidden';
  document.body.style.overflow = 'hidden';
}
function unlockBodyScrollForDrawer() {
  if (!document.documentElement.classList.contains('drawer-open')) return;

  document.documentElement.classList.remove('drawer-open');
  document.body.classList.remove('drawer-open');

  // If a modal is still open, keep locked by modal logic.
  if (document.documentElement.classList.contains('modal-open')) return;

  const y = __drawerScrollY || 0;
  document.documentElement.style.top = '';
  document.body.style.top = '';
  document.documentElement.style.position = '';
  document.body.style.position = '';
  document.documentElement.style.width = '';
  document.body.style.width = '';
  document.documentElement.style.overflow = '';
  document.body.style.overflow = '';
  window.scrollTo(0, y);
}

let __sidebarBackdropNoScrollBound = false;
function bindSidebarBackdropNoScrollOnce() {
  if (__sidebarBackdropNoScrollBound) return;
  __sidebarBackdropNoScrollBound = true;
  const bd = document.getElementById('sidebarBackdrop');
  if (!bd) return;
  const preventIfShown = (e) => {
    if (!bd.classList.contains('show')) return;
    e.preventDefault();
  };
  bd.addEventListener('touchmove', preventIfShown, { passive: false });
  bd.addEventListener('wheel', preventIfShown, { passive: false });
}
// ----------------------------------------------

function openSidebar() {
  if (!isMobile()) return;
  const sb = document.querySelector('.sidebar');
  const bd = document.getElementById('sidebarBackdrop');
  if (sb) sb.classList.add('open');
  if (bd) bd.classList.add('show');
  lockBodyScrollForDrawer();
}
function closeSidebar() {
  const sb = document.querySelector('.sidebar');
  const bd = document.getElementById('sidebarBackdrop');
  if (sb) sb.classList.remove('open');
  if (bd) bd.classList.remove('show');
  unlockBodyScrollForDrawer();
}
function toggleSidebar() {
  const sb = document.querySelector('.sidebar');
  if (!sb) return;
  if (sb.classList.contains('open')) closeSidebar();
  else openSidebar();
}
window.addEventListener('resize', () => { if (!isMobile()) closeSidebar(); updateTopbarHeight(); });

function bindEscToClose() {
  document.addEventListener('keydown', (e) => {
    if (e.key !== 'Escape') return;
    // 移动端：优先关闭侧边栏抽屉
    const sb = document.querySelector('.sidebar');
    if (isMobile() && sb && sb.classList.contains('open')) { closeSidebar(); return; }

    if (isModalOpen('confirm3Modal')) return closeConfirm3('cancel');
    if (isModalOpen('iconPickerModal')) return closeModalDirect('iconPickerModal');

    if (isModalOpen('templateModal')) return requestCloseModal('templateModal');
    if (isModalOpen('moveModal')) return requestCloseModal('moveModal');
    if (isModalOpen('categoryModal')) return requestCloseModal('categoryModal');
  });
}

/* =========================
   7) 三选项弹窗
   ========================= */
const CONFIRM3_DEFAULT_LABELS = { continue: '继续编辑', discard: '不保存关闭', save: '保存并关闭' };
function openConfirm3({ title, body, targetModalId, onSave, onDiscard, onContinue, labels }) {
  confirm3Context = { targetModalId, onSave, onDiscard, onContinue };
  document.getElementById('confirm3Title').textContent = title || '未保存的修改';
  document.getElementById('confirm3Body').textContent = body || '你有未保存的修改。';

  const l = labels || {};
  const btnC = document.getElementById('confirm3BtnContinue');
  const btnD = document.getElementById('confirm3BtnDiscard');
  const btnS = document.getElementById('confirm3BtnSave');
  if (btnC) btnC.textContent = l.continue || CONFIRM3_DEFAULT_LABELS.continue;
  if (btnD) btnD.textContent = l.discard || CONFIRM3_DEFAULT_LABELS.discard;
  if (btnS) btnS.textContent = l.save || CONFIRM3_DEFAULT_LABELS.save;

  openModal('confirm3Modal');
}

// ======== Dialog modal (replaces native alert/confirm) ========
let __dialogCtx = null;

function openDialogModal({ title, body, okText='确定', cancelText='取消', showCancel=true, danger=false, onOk, onCancel }) {
  __dialogCtx = { onOk, onCancel };
  document.getElementById('dialogTitle').textContent = title || '提示';
  document.getElementById('dialogBody').textContent = body || '';
  const btnOk = document.getElementById('dialogOkBtn');
  const btnCancel = document.getElementById('dialogCancelBtn');

  if (btnOk) {
    btnOk.textContent = okText || '确定';
    btnOk.classList.remove('btn-danger');
    if (danger) btnOk.classList.add('btn-danger');
  }
  if (btnCancel) {
    btnCancel.textContent = cancelText || '取消';
    btnCancel.style.display = showCancel ? 'inline-flex' : 'none';
  }

  openModal('dialogModal');
  setTimeout(()=>{ try { btnOk && btnOk.focus && btnOk.focus(); } catch(e){} }, 0);
}

function openAlertModal(body, title='提示', okText='确定', onOk) {
  openDialogModal({ title, body, okText, showCancel:false, danger:false, onOk });
}

function openConfirmModal(body, {
  title='确认操作',
  okText='确定',
  cancelText='取消',
  danger=false,
  onOk,
  onCancel
} = {}) {
  openDialogModal({ title, body, okText, cancelText, showCancel:true, danger, onOk, onCancel });
}

function closeDialogModal() {
  closeModalDirect('dialogModal');
  __dialogCtx = null;
}

function dialogModalOk() {
  const ctx = __dialogCtx;
  closeDialogModal();
  if (ctx && typeof ctx.onOk === 'function') ctx.onOk();
}

function dialogModalCancel() {
  const ctx = __dialogCtx;
  closeDialogModal();
  if (ctx && typeof ctx.onCancel === 'function') ctx.onCancel();
}


function closeConfirm3(action) {
  closeModalDirect('confirm3Modal');
  if (!confirm3Context) return;

  const ctx = confirm3Context;
  confirm3Context = null;

  if (action === 'cancel') return;
  if (action === 'continue') return (typeof ctx.onContinue === 'function') ? ctx.onContinue() : undefined;
  if (action === 'discard') return (typeof ctx.onDiscard === 'function') ? ctx.onDiscard() : undefined;
  if (action === 'save') return (typeof ctx.onSave === 'function') ? ctx.onSave() : undefined;
}

function requestCloseModal(id) {
  if (id === 'templateModal') {
    if (isTemplateModalDirty()) {
      openConfirm3({
        title: '未保存的修改',
        body: '检测到你在“模板编辑”中有未保存的更改。\n\n请选择：保存并关闭 / 不保存关闭 / 继续编辑。',
        targetModalId: 'templateModal',
        onSave: () => {
          const ok = saveTemplate(true);
          if (ok) closeModalDirect('templateModal');
        },
        onDiscard: () => {
          templateModalSnapshot = null;
          closeModalDirect('templateModal');
        }
      });
      return;
    }
    closeModalDirect('templateModal');
    return;
  }

  if (id === 'moveModal') {
    if (isMoveModalDirty()) {
      openConfirm3({
        title: '未确认的移动',
        body: '你修改了移动目标但尚未确认。\n\n请选择：确认移动并关闭 / 不移动关闭 / 继续编辑。',
        targetModalId: 'moveModal',
        onSave: () => {
          confirmMoveTemplate(true);
        },
        onDiscard: () => {
          moveModalSnapshot = null;
          closeModalDirect('moveModal');
        }
      });
      return;
    }
    closeModalDirect('moveModal');
    return;
  }

  closeModalDirect(id);
}

/* =========================
   8) 兼容旧数据：templates
   ========================= */
function normalizeDataForCompatibility() {
  templates = (templates || []).map(t => ({
    id: (t.id ?? Date.now().toString()) + "",
    mainCat: (t.mainCat ?? ""),
    subCat: (t.subCat ?? ""),
    title: (t.title ?? ""),
    tags: (t.tags ?? ""),
    content: (t.content ?? "")
  }));
  saveToLocal();
}

/* =========================
   9) 兼容旧数据：categoryTree（关键）
   - 旧 subs: ["a","b"] => subs: [{name:"a", iconKey:"..."}, ...]
   - 旧 main 没 iconKey => 自动分配
   ========================= */
function normalizeCategoryTreeForCompatibility() {
  if (!Array.isArray(categoryTree)) categoryTree = DEFAULT_CATEGORIES;

  // 收集已使用的主图标（一级分类全局不重复）
  const usedMain = new Set();

  // 收集已使用的子图标（二级分类全局不重复）
  const usedSubGlobal = new Set();

  categoryTree.forEach((c, mainIndex) => {
    if (!c.iconKey || !ICONS.exists(c.iconKey)) c.iconKey = guessMainIcon(c.name);
    if (usedMain.has(c.iconKey)) c.iconKey = pickFreeIcon(usedMain, guessMainIcon(c.name));
    usedMain.add(c.iconKey);

    if (!Array.isArray(c.subs)) c.subs = [];

    // 子分类兼容（统一对象结构）+ 二级分类图标全局不重复
    c.subs = c.subs.map((sub, subIndex) => {
      if (typeof sub === 'string') {
        const preferred = guessSubIcon(sub);
        const iconKey = pickFreeSubIcon(usedSubGlobal, sub, preferred);
        usedSubGlobal.add(iconKey);
        return { name: sub, iconKey };
      }

      const name = (sub?.name ?? '').toString();
      let iconKey = (sub?.iconKey ?? '').toString();
      if (!ICONS.exists(iconKey)) iconKey = guessSubIcon(name);

      // 全局不重复：如果已被占用，则按语义候选集再挑一个
      iconKey = pickFreeSubIcon(usedSubGlobal, name, iconKey);
      usedSubGlobal.add(iconKey);

      return { name, iconKey };
    });
  });

  saveCategories();
}

function guessMainIcon(name) {
  const n = (name || '').toString();
  if (/主诉|沟通|问诊/.test(n)) return 'message';
  if (/现病史|病程|记录|描述/.test(n)) return 'note';
  if (/体格|查体|专科检查/.test(n)) return 'stethoscope';
  if (/辅助检查|化验|检验|实验室/.test(n)) return 'lab';
  if (/影像|CT|MRI|超声/.test(n)) return 'imaging';
  if (/诊断/.test(n)) return 'check';
  if (/鉴别/.test(n)) return 'shield';
  if (/计划/.test(n)) return 'calendar';
  if (/围手术期/.test(n)) return 'periop';
  if (/手术记录|手术/.test(n)) return 'scalpel';
  if (/会诊/.test(n)) return 'consult';
  if (/知情同意/.test(n)) return 'consent';
  if (/告知/.test(n)) return 'notice';
  if (/处理意见|出院|医嘱/.test(n)) return 'discharge';
  if (/既往史/.test(n)) return 'calendar';
  if (/个人史|家族史/.test(n)) return 'dna';
  return 'folder';
}

function guessSubIcon(name) {
  const n = (name || '').toString();

  // 更细的语义映射：优先把常见二级分类映射到更专用图标
  if (/生命体征|血压|脉搏|呼吸|氧饱和|SpO2|体温/.test(n)) return 'activity';
  if (/疼痛/.test(n)) return 'zap';
  if (/护理/.test(n)) return 'nurse';
  if (/饮食|营养/.test(n)) return 'utensils';
  if (/交接班/.test(n)) return 'handover';
  if (/查房/.test(n)) return 'rounds';
  if (/小结|摘要|汇总|总结/.test(n)) return 'report';
  if (/阴性|排除|鉴别/.test(n)) return 'filter';
  if (/诊疗经过|经过|流程|路径/.test(n)) return 'route';

  if (/急诊|抢救|危重|病危/.test(n)) return 'ambulance';
  if (/过敏/.test(n)) return 'alert';
  if (/输血|输液|静脉/.test(n)) return 'infusion';
  if (/影像|CT|MRI|超声/.test(n)) return 'imaging';
  if (/病理/.test(n)) return 'microscope';
  if (/实验室|化验|检验/.test(n)) return 'lab';
  if (/药物|用药/.test(n)) return 'pill';
  if (/手术|术中|切开/.test(n)) return 'scalpel';
  if (/麻醉/.test(n)) return 'anesthesia';
  if (/随访|复诊/.test(n)) return 'followup';
  if (/会诊|讨论/.test(n)) return 'consult';
  if (/出院|医嘱/.test(n)) return 'discharge';
  if (/转科|转院/.test(n)) return 'transfer';
  if (/体征|查体|听诊/.test(n)) return 'stethoscope';
  if (/心肺/.test(n)) return 'lungs';
  if (/神经/.test(n)) return 'brain';
  if (/骨/.test(n)) return 'bone';
  if (/口腔|牙/.test(n)) return 'tooth';

  if (/眼科/.test(n)) return 'eye';
  if (/耳鼻喉|耳/.test(n)) return 'ear';
  if (/妇科|月经|婚育/.test(n)) return 'venus';
  if (/腹部|消化|胃肠/.test(n)) return 'stomach';

  if (/计划/.test(n)) return 'calendar';
  return 'file';
}

// 从图标库挑一个未使用的（优先给候选key，否则给任意可用）
// 默认会避开纯控制类图标（如关闭/箭头等），优先用于“分类图标”。
const CATEGORY_ICON_EXCLUDE = new Set([
  'plus','plusCircle','x','chevronDown','chevronUp','chevronRight',
  'move','save','trash','palette','settings','sort','upload','download','receipt','restore'
]);
function getCategoryIconKeys() {
  return ICONS.all().map(x => x.key).filter(k => !CATEGORY_ICON_EXCLUDE.has(k));
}

function pickFreeIcon(usedSet, preferredKey, poolKeys) {
  const all = (Array.isArray(poolKeys) && poolKeys.length) ? poolKeys : getCategoryIconKeys();
  if (preferredKey && !usedSet.has(preferredKey) && ICONS.exists(preferredKey)) return preferredKey;
  for (const k of all) if (!usedSet.has(k) && ICONS.exists(k)) return k;
  // 兜底：如果图标池被完全占满，则返回一个存在的图标（可能重复）
  if (preferredKey && ICONS.exists(preferredKey)) return preferredKey;
  return 'folder';
}

function pushUniq(arr, ...keys) {
  for (const k of keys) {
    if (!k) continue;
    if (!arr.includes(k)) arr.push(k);
  }
}

function subIconCandidates(name, preferredKey) {
  const n = (name || '').toString();
  const c = [];
  pushUniq(c, preferredKey, guessSubIcon(n));

  if (/生命体征|血压|脉搏|呼吸|氧饱和|SpO2|体温/.test(n)) pushUniq(c, 'activity','gauge','heart','thermometer');
  if (/疼痛/.test(n)) pushUniq(c, 'zap','pill');
  if (/护理/.test(n)) pushUniq(c, 'nurse','bed','shield');
  if (/饮食|营养/.test(n)) pushUniq(c, 'utensils','info');
  if (/交接班/.test(n)) pushUniq(c, 'handover','transfer');
  if (/查房/.test(n)) pushUniq(c, 'rounds','stethoscope','users');
  if (/小结|摘要|汇总|总结/.test(n)) pushUniq(c, 'report','fileText','barChart','star','bookmark');
  if (/阴性|排除|鉴别/.test(n)) pushUniq(c, 'filter','minusCircle','shield','info');
  if (/诊疗经过|经过|流程|路径/.test(n)) pushUniq(c, 'route','layers','fileText');

  if (/急诊|抢救|危重|病危/.test(n)) pushUniq(c, 'ambulance','alert');
  if (/过敏/.test(n)) pushUniq(c, 'alert','shield');
  if (/输血|输液|静脉/.test(n)) pushUniq(c, 'infusion','droplet');
  if (/影像|CT|MRI|超声/.test(n)) pushUniq(c, 'imaging','ct','mri','ultrasound','image');
  if (/实验室|化验|检验/.test(n)) pushUniq(c, 'lab','barChart','droplet');
  if (/病理/.test(n)) pushUniq(c, 'microscope','fileSearch');
  if (/药物|用药/.test(n)) pushUniq(c, 'pill','clipboardList');
  if (/手术|术中|术前|术后|切开/.test(n)) pushUniq(c, 'scalpel','periop','clipboardCheck','clipboardList');
  if (/麻醉/.test(n)) pushUniq(c, 'anesthesia','shield');
  if (/随访|复诊/.test(n)) pushUniq(c, 'followup','calendar');
  if (/会诊|讨论/.test(n)) pushUniq(c, 'consult','message','users');
  if (/出院|医嘱/.test(n)) pushUniq(c, 'discharge','fileCheck','printer');
  if (/转科|转院/.test(n)) pushUniq(c, 'transfer','handover','route');
  if (/计划/.test(n)) pushUniq(c, 'calendar','clipboardList','listCheck','target');
  if (/耳鼻喉|耳/.test(n)) pushUniq(c, 'ear','stethoscope');
  if (/眼科/.test(n)) pushUniq(c, 'eye','imaging');
  if (/妇科|月经|婚育/.test(n)) pushUniq(c, 'venus','calendar');
  if (/腹部|消化|胃肠/.test(n)) pushUniq(c, 'stomach','info');

  // 仅保留当前版本存在的 key
  return c.filter(k => ICONS.exists(k));
}

function pickFreeSubIcon(usedSet, name, preferredKey) {
  const candidates = subIconCandidates(name, preferredKey);
  for (const k of candidates) if (!usedSet.has(k)) return k;
  return pickFreeIcon(usedSet, preferredKey);
}

/* =========================
   10) 安全自动备份（最近5次）
   ========================= */
function autoBackup(reason) {
  try {
    const key = 'med_auto_backups_v3';
    const backups = JSON.parse(localStorage.getItem(key)) || [];
    backups.unshift({
      ts: new Date().toLocaleString(),
      reason,
      categories: categoryTree,
      templates: templates
    });
    localStorage.setItem(key, JSON.stringify(backups.slice(0, 5)));
  } catch (e) {}
}

/* =========================
   11) 富文本编辑器（与3.5保持）
   ========================= */
function rteCmd(cmd) {
  const editor = document.getElementById('inputContentEditor');
  editor.focus();
  document.execCommand(cmd, false, null);
  refreshTemplateDirtyFlag();
}
function normalizeCssColor(color) {
  const t = document.createElement('span');
  t.style.color = color;
  t.style.position = 'fixed';
  t.style.left = '-9999px';
  t.style.top = '-9999px';
  document.body.appendChild(t);
  const rgb = window.getComputedStyle(t).color;
  t.remove();
  return rgb;
}

function caretHasColor(editor, color) {
  const sel = window.getSelection();
  if (!sel || sel.rangeCount === 0) return false;
  if (!sel.isCollapsed) return true;
  const range = sel.getRangeAt(0);
  let node = range.startContainer;
  if (node.nodeType === 3) node = node.parentElement;
  if (!node || !editor.contains(node)) return false;
  const cs = window.getComputedStyle(node);
  if (!cs || !cs.color) return false;
  return normalizeCssColor(cs.color) === normalizeCssColor(color);
}

function normalizeRteFontTags(editor) {
  const fonts = Array.from(editor.querySelectorAll('font'));
  fonts.forEach(f => {
    const c = f.getAttribute('color') || f.style.color;
    const span = document.createElement('span');
    if (c) span.style.color = c;
    while (f.firstChild) span.appendChild(f.firstChild);
    f.replaceWith(span);
  });
}

function ensureCaretColorSpan(editor, color) {
  const sel = window.getSelection();
  if (!sel || sel.rangeCount === 0) return;
  if (!sel.isCollapsed) return;
  const range = sel.getRangeAt(0);
  if (!editor.contains(range.commonAncestorContainer)) return;

  // 如果光标所在位置已经是目标颜色，则不插入零宽字符
  try {
    const has = caretHasColor(editor, color);
    if (has) return;
  } catch(e) {}

  const span = document.createElement('span');
  span.style.color = color;
  span.appendChild(document.createTextNode('​'));
  range.insertNode(span);

  // 将光标移动到 span 内部，位于零宽字符之后
  const nr = document.createRange();
  nr.setStart(span.firstChild, 1);
  nr.collapse(true);
  sel.removeAllRanges();
  sel.addRange(nr);
}

function rteColor(color) {
  const editor = document.getElementById('inputContentEditor');
  editor.focus();

  const sel = window.getSelection();
  if (!sel || sel.rangeCount === 0) return;

  const range = sel.getRangeAt(0);
  if (!editor.contains(range.commonAncestorContainer)) {
    // 强制将光标放入编辑器末尾
    const r = document.createRange();
    r.selectNodeContents(editor);
    r.collapse(false);
    sel.removeAllRanges();
    sel.addRange(r);
  }

  // 尽可能使用 CSS 样式（部分浏览器仍会插入 <font>）
  try { document.execCommand('styleWithCSS', false, true); } catch(e) {}
  try { document.execCommand('foreColor', false, color); } catch(e) {}

  // 兼容 iOS/Safari：可能生成 <font color="...">，这里统一转为 <span style="color:...">
  normalizeRteFontTags(editor);

  // 某些移动端在 selection collapsed 时不会影响后续输入：插入一个零宽字符携带颜色
  try { ensureCaretColorSpan(editor, color); } catch(e) {}

  refreshTemplateDirtyFlag();
}


/* =========================
   11.5) 字段元素（可点击填写的占位符）
   ========================= */
const __TOKEN_KEY = '__MYEMR_TOKEN_DEFS';
let __tokenDefs = null;
let __activeTokenEl = null;

function __uuid(){
  try { return crypto.randomUUID(); } catch(e) {
    return 'tok_' + Math.random().toString(16).slice(2) + Date.now().toString(16);
  }
}

function __defaultTokenDefs(){
  return [
    {
      id: 'tok_site',
      name: '发病部位',
      mode: 'select',
      options: ['左侧','右侧','双侧','上颌','下颌','颌下区','腮腺区','颊部','唇部','舌','口底']
    }
  ];
}

function __loadTokenDefs(){
  if (__tokenDefs) return;
  try {
    const raw = localStorage.getItem(__TOKEN_KEY);
    __tokenDefs = raw ? JSON.parse(raw) : null;
  } catch(e) {
    __tokenDefs = null;
  }
  if (!Array.isArray(__tokenDefs) || __tokenDefs.length === 0) {
    __tokenDefs = __defaultTokenDefs();
    __saveTokenDefs();
  }
}

function __saveTokenDefs(){
  try { localStorage.setItem(__TOKEN_KEY, JSON.stringify(__tokenDefs || [])); } catch(e){}
}

function mergeTokenDefs(incoming){
  __loadTokenDefs();
  const inc = Array.isArray(incoming) ? incoming : [];
  if (inc.length === 0) return;

  // 合并规则：以 id 为主键；若 id 冲突则保留现有；新 id 追加
  const byId = new Map((__tokenDefs || []).map(t => [t.id, t]));
  for (const t of inc) {
    if (!t || !t.id || !t.name) continue;
    if (byId.has(t.id)) continue;
    byId.set(String(t.id), {
      id: String(t.id),
      name: String(t.name),
      mode: (String(t.mode) === 'text' ? 'text' : 'select'),
      options: Array.isArray(t.options) ? t.options.map(x => String(x)) : []
    });
  }
  __tokenDefs = Array.from(byId.values());
  __saveTokenDefs();
}


function __findTokenDef(id){
  __loadTokenDefs();
  return (__tokenDefs || []).find(t => t.id === id);
}

function __renderTokenSpan(span){
  const id = span.getAttribute('data-emr-id') || '';
  const def = __findTokenDef(id);
  const value = (span.getAttribute('data-emr-value') || '').toString();

  if (!def) {
    // 若字段定义被删除，保留当前文本并降级为普通内容
    span.classList.remove('emr-token');
    span.removeAttribute('data-emr-id');
    span.removeAttribute('data-emr-value');
    span.removeAttribute('data-emr-name');
    span.removeAttribute('contenteditable');
    span.removeAttribute('title');
    return;
  }

  span.classList.add('emr-token');
  span.setAttribute('contenteditable','false');
  span.setAttribute('data-emr-id', def.id);
  span.setAttribute('data-emr-name', def.name);
  span.setAttribute('data-emr-value', value);
  span.setAttribute('title', def.name);

  // ✅ 规则：已填写则只显示值；未填写则显示字段名（作为占位）
  if (value && value.trim()) {
    span.textContent = value.trim();
  } else {
    span.textContent = def.name;
  }
}

function __enhanceTokensInEditor(){
  const editor = document.getElementById('inputContentEditor');
  if (!editor) return;
  editor.querySelectorAll('span.emr-token, span[data-emr-id]').forEach(sp => __renderTokenSpan(sp));

  if (!editor.__tokenBound) {
    editor.__tokenBound = true;
    editor.addEventListener('click', (ev) => {
      const token = ev.target && ev.target.closest ? ev.target.closest('span.emr-token') : null;
      if (!token) return;
      ev.preventDefault();
      ev.stopPropagation();
      openTokenValue(token);
    });
  }
}

function openTokenInsert(){
  __loadTokenDefs();
  const inp = document.getElementById('tokenInsertSearch');
  if (inp) inp.value = '';
  renderTokenInsertList();
  openModal('tokenInsertModal');
}

function renderTokenInsertList(){
  __loadTokenDefs();
  const q = (document.getElementById('tokenInsertSearch')?.value || '').trim().toLowerCase();
  const list = document.getElementById('tokenInsertList');
  if (!list) return;
  const items = (__tokenDefs || []).filter(t => !q || (t.name || '').toLowerCase().includes(q));
  list.innerHTML = items.map(t => {
    const sub = t.mode === 'select' ? `下拉选择 · ${(t.options||[]).length} 项` : '自由输入';
    return `<div class="token-item">
      <div class="meta">
        <div class="name">${escapeHtml(t.name)}</div>
        <div class="sub">${escapeHtml(sub)}</div>
      </div>
      <div class="ops">
        <button class="icon-btn icon-only" type="button" title="插入" aria-label="插入" onclick="insertTokenById('${t.id}')">
          <span class="ico">${ICONS.svg('plus')}</span>
        </button>
      </div>
    </div>`;
  }).join('') || `<div class="hint">没有匹配的字段元素。你可以在“设置 → 字段元素”中新增。</div>`;
}

function insertTokenById(id){
  const def = __findTokenDef(id);
  if (!def) return;
  const editor = document.getElementById('inputContentEditor');
  if (!editor) return;
  editor.focus();
  const html = `<span class="emr-token" contenteditable="false" data-emr-id="${escapeHtml(def.id)}" data-emr-value="">${escapeHtml(def.name)}：未填</span>&nbsp;`;
  document.execCommand('insertHTML', false, html);
  __enhanceTokensInEditor();
  requestCloseModal('tokenInsertModal');
}

function openTokenValue(tokenEl){
  __activeTokenEl = tokenEl;
  const id = tokenEl.getAttribute('data-emr-id') || '';
  const def = __findTokenDef(id);
  if (!def) {
    openAlertModal('该字段元素已被删除或不可识别。你可以删除该字段或在设置中重新创建。', '字段元素不可用');
    return;
  }
  const cur = (tokenEl.getAttribute('data-emr-value') || '').toString();

  const title = document.getElementById('tokenValueTitle');
  if (title) title.textContent = `填写：${def.name}`;

  const body = document.getElementById('tokenValueBody');
  if (!body) return;

  if (def.mode === 'select') {
    // iOS: avoid auto popping the keyboard when the field offers quick-pick options.
    try { document.activeElement && document.activeElement.blur && document.activeElement.blur(); } catch(e) {}
    const opts = Array.isArray(def.options) ? def.options : [];
    body.innerHTML = `
      <div class="hint" style="margin-bottom:8px;">点击选项快速填入。需要新增选项时，在下方输入后点“添加”。</div>
      <div class="hint" style="margin-bottom:10px;">当前：<span class="token-cur" id="tokenCurValue">${escapeHtml(cur || '未填写')}</span></div>

      <div class="token-opt-grid" id="tokenOptGrid"></div>

      <div class="token-add-wrap" style="margin-top:12px;">
        <label class="form-label">自定义添加（会加入该字段的下拉选项）</label>
        <div class="token-add-row">
          <input class="form-input" id="tokenNewOpt" value="" placeholder="输入内容…">
          <button class="btn btn-secondary btn-sm" id="btnAddTokenOpt" type="button" disabled onclick="addTokenOptFromInput()">添加</button>
        </div>
        <div class="hint" style="margin-top:6px;">提示：新增的选项会保存到该字段元素中，后续可直接点选；也可在“设置 → 字段元素”中管理。</div>
      </div>
      <!-- hidden value carrier for applyTokenValue() -->
      <input type="hidden" id="tokenValueCustom" value="${escapeHtml(cur)}">
    `;

    // render options and selection
    renderTokenOptGrid(opts, cur);

    // enable/disable add button
    const inp = document.getElementById('tokenNewOpt');
    const btn = document.getElementById('btnAddTokenOpt');
    if (inp && btn) {
      const sync = () => { btn.disabled = !(inp.value || '').toString().trim(); };
      inp.addEventListener('input', sync);
      sync();
    }
  } else {
    body.innerHTML = `
      <label class="form-label">内容</label>
      <input class="form-input" id="tokenValueCustom" value="${escapeHtml(cur)}" placeholder="输入…">
    `;
  }
  openModal('tokenValueModal');
}

function showTokenCustomInput(){
  const wrap = document.getElementById('tokenCustomWrap');
  if (wrap) wrap.style.display = 'block';
  const inp = document.getElementById('tokenValueCustom');
  if (inp) {
    setTimeout(() => {
      try {
        inp.focus();
        const n = (inp.value || '').length;
        inp.setSelectionRange(n, n);
      } catch(e) {}
    }, 0);
  }
}

function escapeJsString(str){
  return (str ?? '').toString()
    .replace(/\\/g, '\\\\')
    .replace(/'/g, "\\'")
    .replace(/\r/g, '\\r')
    .replace(/\n/g, '\\n');
}

function renderTokenOptGrid(options, selectedVal){
  const grid = document.getElementById('tokenOptGrid');
  if (!grid) return;
  const opts = Array.isArray(options) ? options : [];
  const sel = (selectedVal ?? '').toString();
  grid.innerHTML = opts.map(o => {
    const v = (o ?? '').toString();
    const cls = (v === sel && sel) ? 'token-opt is-selected' : 'token-opt';
    return `<div class="${cls}" data-val="${escapeHtml(v)}" onclick="pickTokenOpt('${escapeJsString(v)}')">${escapeHtml(v)}</div>`;
  }).join('');
}

function addTokenOptFromInput(){
  const inp = document.getElementById('tokenNewOpt');
  if (!inp) return;
  const val = (inp.value || '').toString().trim();
  if (!val) return;

  if (!__activeTokenEl) return;
  const id = __activeTokenEl.getAttribute('data-emr-id') || '';
  const def = __findTokenDef(id);
  if (!def) return;

  if (!Array.isArray(def.options)) def.options = [];
  const exists = def.options.some(o => (o ?? '').toString().trim() === val);
  if (!exists) {
    def.options.push(val);
    __saveTokenDefs();
  }

  // refresh grid & pick
  renderTokenOptGrid(def.options, val);
  pickTokenOpt(val);

  inp.value = '';
  const btn = document.getElementById('btnAddTokenOpt');
  if (btn) btn.disabled = true;
}


function pickTokenOpt(val){
  const v = (val ?? '').toString();
  const inp = document.getElementById('tokenValueCustom');
  if (inp) inp.value = v;

  const cur = document.getElementById('tokenCurValue');
  if (cur) cur.textContent = v || '未填写';

  const grid = document.getElementById('tokenOptGrid');
  if (grid) {
    grid.querySelectorAll('.token-opt').forEach(el => {
      el.classList.toggle('is-selected', (el.getAttribute('data-val') || '') === v);
    });
  }
}

function clearTokenValue(){
  const inp = document.getElementById('tokenValueCustom');
  if (inp) inp.value = '';
  const cur = document.getElementById('tokenCurValue');
  if (cur) cur.textContent = '未填写';
  const grid = document.getElementById('tokenOptGrid');
  if (grid) grid.querySelectorAll('.token-opt').forEach(el => el.classList.remove('is-selected'));
}

function applyTokenValue(){
  if (!__activeTokenEl) { requestCloseModal('tokenValueModal'); return; }
  const id = __activeTokenEl.getAttribute('data-emr-id') || '';
  const def = __findTokenDef(id);
  if (!def) { requestCloseModal('tokenValueModal'); return; }
  const inp = document.getElementById('tokenValueCustom');
  const val = (inp ? inp.value : '').toString().trim();
  __activeTokenEl.setAttribute('data-emr-value', val);
  __renderTokenSpan(__activeTokenEl);
  requestCloseModal('tokenValueModal');
  __activeTokenEl = null;
}

function openTokenManager(){
  __loadTokenDefs();
  renderTokenManagerList();
  openModal('tokenManagerModal');
}

function renderTokenManagerList(){
  __loadTokenDefs();
  const list = document.getElementById('tokenManagerList');
  if (!list) return;
  const items = (__tokenDefs || []);
  list.innerHTML = items.map(t => {
    const sub = t.mode === 'select' ? `下拉选择 · ${(t.options||[]).length} 项` : '自由输入';
    return `<div class="token-item">
      <div class="meta">
        <div class="name">${escapeHtml(t.name)}</div>
        <div class="sub">${escapeHtml(sub)}</div>
      </div>
      <div class="ops">
        <button class="icon-btn icon-only" type="button" title="编辑" aria-label="编辑" onclick="openTokenEdit('${t.id}')"><span class="ico">${ICONS.svg('pen')}</span></button>
        <button class="icon-btn icon-only danger" type="button" title="删除" aria-label="删除" onclick="deleteTokenDef('${t.id}')"><span class="ico">${ICONS.svg('trash')}</span></button>
      </div>
    </div>`;
  }).join('') || `<div class="hint">暂无字段元素。点击上方“新增字段元素”。</div>`;
}

function openTokenEdit(id){
  __loadTokenDefs();
  const isNew = !id;
  const def = isNew ? { id: __uuid(), name: '', mode: 'select', options: [] } : (__tokenDefs.find(t => t.id === id) || null);
  if (!def) return;

  document.getElementById('tokenEditTitle').textContent = isNew ? '新增字段元素' : '编辑字段元素';
  document.getElementById('tokenEditId').value = def.id;
  document.getElementById('tokenEditName').value = def.name || '';
  document.getElementById('tokenEditMode').value = def.mode || 'select';
  document.getElementById('tokenEditOptions').value = Array.isArray(def.options) ? def.options.join('\n') : '';
  toggleTokenEditOptions();
  openModal('tokenEditModal');
}

function toggleTokenEditOptions(){
  const mode = document.getElementById('tokenEditMode')?.value || 'select';
  const wrap = document.getElementById('tokenEditOptionsWrap');
  if (wrap) wrap.style.display = (mode === 'select') ? 'block' : 'none';
}

function saveTokenDef(){
  __loadTokenDefs();
  const id = (document.getElementById('tokenEditId')?.value || '').trim();
  const name = (document.getElementById('tokenEditName')?.value || '').trim();
  const mode = (document.getElementById('tokenEditMode')?.value || 'select').trim();
  const rawOpts = (document.getElementById('tokenEditOptions')?.value || '').trim();

  if (!name) {
    openAlertModal('字段名称不能为空。', '保存失败');
    return;
  }
  const dupe = (__tokenDefs || []).find(t => t.id !== id && (t.name || '').trim() === name);
  if (dupe) {
    openAlertModal('字段名称已存在，请使用不同名称。', '保存失败');
    return;
  }

  let opts = [];
  if (mode === 'select') {
    opts = rawOpts ? rawOpts.split(/\n|,/).map(s => s.trim()).filter(Boolean) : [];
    if (opts.length === 0) {
      openAlertModal('“下拉选择”需要至少 1 个选项。', '保存失败');
      return;
    }
  }

  const existing = (__tokenDefs || []).find(t => t.id === id);
  if (existing) {
    existing.name = name;
    existing.mode = (mode === 'text' ? 'text' : 'select');
    existing.options = opts;
  } else {
    (__tokenDefs || []).push({ id, name, mode: (mode === 'text' ? 'text' : 'select'), options: opts });
  }
  __saveTokenDefs();
  renderTokenManagerList();
  requestCloseModal('tokenEditModal');
  __enhanceTokensInEditor();
}

function deleteTokenDef(id){
  __loadTokenDefs();
  const def = (__tokenDefs || []).find(t => t.id === id);
  if (!def) return;

  openConfirmModal(`确定要删除“${def.name}”吗？\n\n提示：已插入到模板中的该字段将保留为普通文本，不再可点击编辑。`, {
    title: '删除字段元素',
    okText: '删除',
    danger: true,
    onOk: () => {
      __tokenDefs = (__tokenDefs || []).filter(t => t.id !== id);
      __saveTokenDefs();
      renderTokenManagerList();
      __enhanceTokensInEditor();
    }
  });
}

/* =========================
   12) HTML安全与转换
   ========================= */
function filterStyle(styleText) {
  if (!styleText) return '';
  const allowed = new Set(['color','background-color','font-weight','text-decoration','font-style']);
  const parts = styleText.split(';').map(s => s.trim()).filter(Boolean);
  const kept = [];
  for (const p of parts) {
    const idx = p.indexOf(':');
    if (idx === -1) continue;
    const prop = p.slice(0, idx).trim().toLowerCase();
    let val = p.slice(idx + 1).trim();
    if (!allowed.has(prop)) continue;
    const vlow = val.toLowerCase();
    if (vlow.includes('expression') || vlow.includes('url(') || vlow.includes('javascript:')) continue;
    if (val.length > 80) val = val.slice(0, 80);
    kept.push(`${prop}:${val}`);
  }
  return kept.join('; ');
}
function sanitizeHtml(inputHtml) {
  const html = (inputHtml ?? '').toString();
  const parser = new DOMParser();
  const doc = parser.parseFromString(`<div>${html}</div>`, 'text/html');
  const root = doc.body.firstChild;

  const allowedTags = new Set(['b','strong','i','em','u','s','br','p','div','span','ul','ol','li','blockquote','pre','code']);

  const walk = (node) => {
    const children = Array.from(node.childNodes);
    for (const child of children) {
      if (child.nodeType === Node.ELEMENT_NODE) {
        const tag = child.tagName.toLowerCase();

        // 将 <font color="..."> 统一转换为 <span style="color:...">，避免颜色信息丢失
        if (tag === 'font') {
          const span = doc.createElement('span');
          const colorAttr = child.getAttribute('color');
          const styleAttr = child.getAttribute('style') || '';
          const merged = [];
          if (colorAttr) merged.push(`color:${colorAttr}`);
          if (styleAttr) merged.push(styleAttr);
          const fs = filterStyle(merged.join(';'));
          if (fs) span.setAttribute('style', fs);
          while (child.firstChild) span.appendChild(child.firstChild);
          child.replaceWith(span);
          walk(span);
          continue;
        }

        if (!allowedTags.has(tag)) {
          const text = doc.createTextNode(child.textContent || '');
          child.replaceWith(text);
          continue;
        }
        const attrs = Array.from(child.attributes);
        for (const a of attrs) {
          const name = a.name.toLowerCase();
          if (name.startsWith('on')) { child.removeAttribute(a.name); continue; }
          if (name === 'style') {
            const fs = filterStyle(a.value);
            if (fs) child.setAttribute('style', fs);
            else child.removeAttribute('style');
            continue;
          }

          // Allow minimal safe attributes for interactive token spans
          if (tag === 'span') {
            if (name === 'class') {
              const allowedClasses = new Set(['emr-token','emr-token-label','emr-token-value']);
              const cls = (a.value || '').toString().split(/\s+/).filter(Boolean).filter(c => allowedClasses.has(c));
              if (cls.length) child.setAttribute('class', cls.join(' '));
              else child.removeAttribute('class');
              continue;
            }
            if (name === 'contenteditable') {
              const v = (a.value || '').toString().toLowerCase();
              if (v === 'false') child.setAttribute('contenteditable', 'false');
              else child.removeAttribute('contenteditable');
              continue;
            }
            if (name.startsWith('data-emr-')) {
              let v = (a.value || '').toString();
              if (v.length > 200) v = v.slice(0, 200);
              child.setAttribute(a.name, v);
              continue;
            }
          }

          child.removeAttribute(a.name);
        }
        walk(child);
      } else if (child.nodeType === Node.COMMENT_NODE) {
        child.remove();
      }
    }
  };
  walk(root);
  return root.innerHTML;
}
function isProbablyHtml(str) {
  const s = (str ?? '').toString();
  return /<\/?(p|br|div|span|b|strong|i|em|u|ul|ol|li|pre|code|blockquote)\b/i.test(s);
}
function escapeHtml(str) {
  return (str ?? '').toString()
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}
function plainTextToHtml(text) {
  const escaped = escapeHtml(text ?? '');
  return escaped.replace(/\r\n|\n|\r/g, '<br>');
}
function htmlToPlainText(html, opts) {
  const tmp = document.createElement('div');
  tmp.innerHTML = sanitizeHtml(html);

  // opts.emptyTokenBrackets: when true, empty token outputs like "[字段名]"
  const useBrackets = !!(opts && opts.emptyTokenBrackets);

  // 字段元素：默认仅输出“值”；若未填写且 useBrackets=true，则输出“[字段名]”
  tmp.querySelectorAll('span.emr-token, span[data-emr-id]').forEach(sp => {
    const v = (sp.getAttribute('data-emr-value') || '').toString().trim();
    if (v) {
      sp.replaceWith(document.createTextNode(v));
    } else if (useBrackets) {
      const name = (sp.getAttribute('data-emr-name') || sp.getAttribute('title') || '').toString().trim() || '字段';
      sp.replaceWith(document.createTextNode('[' + name + ']'));
    } else {
      sp.replaceWith(document.createTextNode(''));
    }
  });

  return (tmp.innerText || '').trimEnd();
}
function getEditorHtmlForSave() {
  const editor = document.getElementById('inputContentEditor');
  const raw = (editor.innerHTML || '').replace(/\u200B/g, '');
  return sanitizeHtml(raw);
}
function setEditorContentFromStored(stored) {
  const editor = document.getElementById('inputContentEditor');
  const s = (stored ?? '').toString();
  if (!s) { editor.innerHTML = ''; return; }
  if (isProbablyHtml(s)) editor.innerHTML = sanitizeHtml(s);
  else editor.innerHTML = plainTextToHtml(s);
  __enhanceTokensInEditor();
}


/* =========================
   13) 未保存判断
   ========================= */
function bindDirtyListenersOnce() {
  if (listenersBound) return;
  listenersBound = true;

  const title = document.getElementById('inputTitle');
  const main  = document.getElementById('inputMainCat');
  const sub   = document.getElementById('inputSubCat');
  const editor= document.getElementById('inputContentEditor');
  const newTag= document.getElementById('newTagInput');

  if (title) title.addEventListener('input', refreshTemplateDirtyFlag);
  if (main)  main.addEventListener('change', refreshTemplateDirtyFlag);
  if (sub)   sub.addEventListener('change', refreshTemplateDirtyFlag);
  if (editor) editor.addEventListener('input', refreshTemplateDirtyFlag);
  if (newTag) newTag.addEventListener('input', refreshTemplateDirtyFlag);
}

function takeTemplateModalSnapshot() {
  templateModalSnapshot = getTemplateModalState();
  updateTemplateModalTitleDirty(false);
}

function getTemplateModalState() {
  const mainCat = document.getElementById('inputMainCat')?.value || '';
  const subCat  = document.getElementById('inputSubCat')?.value || '';
  const title   = document.getElementById('inputTitle')?.value || '';

  const tagsArr = Array.from(selectedTags).map(s => s.trim()).filter(Boolean)
    .sort((a,b)=>a.localeCompare(b,'zh-Hans-CN'));
  const tags = tagsArr.join(', ');

  const contentHtml = getEditorHtmlForSave();
  return { mainCat, subCat, title, tags, contentHtml };
}

function isTemplateModalDirty() {
  if (!templateModalSnapshot) return false;
  const pendingTag = (document.getElementById('newTagInput')?.value || '').trim();
  if (pendingTag) return true;

  const now = getTemplateModalState();
  return JSON.stringify(now) !== JSON.stringify(templateModalSnapshot);
}

function updateTemplateModalTitleDirty(isDirty) {
  const titleEl = document.getElementById('modalTitleText');
  if (!titleEl) return;
  const raw = titleEl.textContent.replace(/\s*\*\s*$/, '');
  titleEl.textContent = isDirty ? (raw + ' *') : raw;
}

function refreshTemplateDirtyFlag() {
  if (!isModalOpen('templateModal')) return;
  updateTemplateModalTitleDirty(isTemplateModalDirty());
}

function takeMoveModalSnapshot() { moveModalSnapshot = getMoveModalState(); }
function getMoveModalState() {
  const mainCat = document.getElementById('moveMainCat')?.value || '';
  const subCat  = document.getElementById('moveSubCat')?.value || '';
  return { mainCat, subCat };
}
function isMoveModalDirty() {
  if (!moveModalSnapshot) return false;
  if (!isModalOpen('moveModal')) return false;
  const now = getMoveModalState();
  return JSON.stringify(now) !== JSON.stringify(moveModalSnapshot);
}

/* =========================
   14) 标签：按钮禁用逻辑（你新增要求）
   ========================= */
function bindTagAddButtonDisable() {
  const input = document.getElementById('newTagInput');
  const btn = document.getElementById('btnAddTag');
  if (!input || !btn) return;

  const apply = () => {
    const v = (input.value || '').trim();
    btn.disabled = !v;
  };
  input.addEventListener('input', apply);
  apply();
}

function setupTagInputEnter() {
  const input = document.getElementById('newTagInput');
  if (!input) return;
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      addNewTagFromInput();
    }
  });
}

function parseTags(tagStr) {
  if (!tagStr) return [];
  return tagStr.split(',').map(s => s.trim()).filter(Boolean);
}
function buildTagUsageMap() {
  const map = new Map();
  templates.forEach(t => {
    parseTags(t.tags).forEach(tag => {
      map.set(tag, (map.get(tag) || 0) + 1);
    });
  });
  return map;
}
function getAllTagsByUsage() {
  const map = buildTagUsageMap();
  const tags = Array.from(map.keys());
  tags.sort((a, b) => {
    const da = map.get(a) || 0;
    const db = map.get(b) || 0;
    if (db !== da) return db - da;
    return a.localeCompare(b, 'zh-Hans-CN');
  });
  tagUsageMap = map;
  return tags;
}
function rebuildTagPool(preselect = []) {
  allTagsCache = getAllTagsByUsage();
  selectedTags = new Set(preselect);

  renderSelectedTagsRow();
  renderTagPool();

  tagPoolExpanded = false;
  applyTagPoolCollapsedState();
  updateTagPoolToggleVisibility();

  refreshTemplateDirtyFlag();
}

function renderSelectedTagsRow() {
  const row = document.getElementById('selectedTagsRow');
  row.innerHTML = '';

  if (selectedTags.size === 0) {
    row.innerHTML = `<div style="color:#9ca3af; font-size:12px;">未选择标签</div>`;
    return;
  }

  Array.from(selectedTags)
    .sort((a,b)=>a.localeCompare(b,'zh-Hans-CN'))
    .forEach(tag => {
      const chip = document.createElement('span');
      chip.className = 'tag-chip active';
      chip.innerHTML = `<span>${escapeHtml(tag)}</span><span class="x">×</span>`;
      chip.title = '点击取消选择';
      chip.onclick = () => {
        selectedTags.delete(tag);
        renderSelectedTagsRow();
        syncPoolActiveStates();
        refreshTemplateDirtyFlag();
      };
      row.appendChild(chip);
    });
}

function renderTagPool() {
  const pool = document.getElementById('tagPool');
  pool.innerHTML = '';

  if (allTagsCache.length === 0) {
    pool.innerHTML = `<div style="color:#9ca3af; font-size:12px;">暂无已有标签（可在上方输入并添加）</div>`;
    return;
  }

  allTagsCache.forEach(tag => {
    const chip = document.createElement('span');
    chip.className = 'tag-chip' + (selectedTags.has(tag) ? ' active' : '');
    chip.textContent = tag;
    const count = tagUsageMap.get(tag) || 0;
    chip.title = `点击选择/取消（多选）${count ? '；使用次数：' + count : ''}`;
    chip.onclick = () => {
      if (selectedTags.has(tag)) selectedTags.delete(tag);
      else selectedTags.add(tag);
      chip.classList.toggle('active');
      renderSelectedTagsRow();
      refreshTemplateDirtyFlag();
    };
    pool.appendChild(chip);
  });

  setTimeout(updateTagPoolToggleVisibility, 0);
}

function syncPoolActiveStates() {
  const pool = document.getElementById('tagPool');
  const chips = Array.from(pool.querySelectorAll('.tag-chip'));
  chips.forEach(chip => {
    const tag = chip.textContent;
    if (selectedTags.has(tag)) chip.classList.add('active');
    else chip.classList.remove('active');
  });
}

function normalizeTagInputToList(raw) {
  return (raw || '').split(',').map(s => s.trim()).filter(Boolean);
}

function addNewTagFromInput() {
  const input = document.getElementById('newTagInput');
  const btn = document.getElementById('btnAddTag');
  const raw = (input.value || '').trim();
  if (!raw) return;

  const newTags = normalizeTagInputToList(raw);
  if (newTags.length === 0) return;

  newTags.forEach(tag => selectedTags.add(tag));

  const existing = new Set(allTagsCache);
  newTags.forEach(tag => {
    if (!existing.has(tag)) {
      allTagsCache.push(tag);
      tagUsageMap.set(tag, 1);
    }
  });

  allTagsCache.sort((a,b) => {
    const da = tagUsageMap.get(a) || 0;
    const db = tagUsageMap.get(b) || 0;
    if (db !== da) return db - da;
    return a.localeCompare(b, 'zh-Hans-CN');
  });

  input.value = '';
  if (btn) btn.disabled = true;

  renderSelectedTagsRow();
  renderTagPool();
  refreshTemplateDirtyFlag();
}

function toggleTagPool() {
  tagPoolExpanded = !tagPoolExpanded;
  applyTagPoolCollapsedState();
  setIcon('icoChevron', tagPoolExpanded ? 'chevronUp' : 'chevronDown');
}
function applyTagPoolCollapsedState() {
  const pool = document.getElementById('tagPool');
  const text = document.getElementById('tagPoolToggleText');
  if (!pool || !text) return;

  if (tagPoolExpanded) {
    pool.classList.remove('collapsed');
    text.textContent = '收起标签池';
  } else {
    pool.classList.add('collapsed');
    text.textContent = '展开标签池';
  }
}
function updateTagPoolToggleVisibility() {
  const pool = document.getElementById('tagPool');
  const toggle = document.getElementById('tagPoolToggle');
  if (!pool || !toggle) return;

  const chips = Array.from(pool.querySelectorAll('.tag-chip'));
  if (chips.length === 0) {
    toggle.style.display = 'none';
    pool.classList.remove('collapsed');
    return;
  }

  // 以“行数”判定是否超过两行：比固定像素更稳（移动端缩放/字体变化也准确）
  const tops = chips.map(c => c.offsetTop).sort((a,b)=>a-b);
  const rowTops = [];
  const EPS = 4; // 允许少量像素误差
  tops.forEach(t => {
    if (rowTops.length === 0 || Math.abs(rowTops[rowTops.length-1] - t) > EPS) rowTops.push(t);
  });

  const needToggle = rowTops.length > 2;
  toggle.style.display = needToggle ? 'inline-flex' : 'none';

  if (!needToggle) {
    // 不超过两行：直接全部展示，且保持“默认不占位的按钮”
    pool.classList.remove('collapsed');
  } else {
    applyTagPoolCollapsedState();
    setIcon('icoChevron', tagPoolExpanded ? 'chevronUp' : 'chevronDown');
  }
}
/* =========================
   15) 侧边栏：一级点击筛选 + 展开/收起
       - 无子分类：不显示箭头（你新增要求）
       - 二级分类显示图标（你新增要求）
   ========================= */
function renderSidebar() {
  const container = document.getElementById('sidebarTree');
  container.innerHTML = `
    <div class="cat-header active" onclick="setFilter('ALL', '', this)">
      <div class="cat-left">
        <span class="ico">${ICONS.svg('folder')}</span>
        <span class="cat-name">全部显示</span>
      </div>
    </div>
  `;

  categoryTree.forEach((main, idx) => {
    const mainDiv = document.createElement('div');

    const hasSubs = Array.isArray(main.subs) && main.subs.length > 0;

    const subDiv = document.createElement('div');
    subDiv.className = 'sub-cat-list';

    if (hasSubs) {
      main.subs.forEach(subObj => {
        const subName = typeof subObj === 'string' ? subObj : subObj.name;
        const iconKey = (typeof subObj === 'object' && subObj.iconKey) ? subObj.iconKey : guessSubIcon(subName);

        const subItem = document.createElement('div');
        subItem.className = 'sub-cat-item';
        subItem.innerHTML = `
          <span class="ico">${ICONS.svg(iconKey)}</span>
          <span style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${escapeHtml(subName)}</span>
        `;
        subItem.onclick = (e) => {
          e.stopPropagation();
          setFilter('SUB', subName, subItem);
        };
        subDiv.appendChild(subItem);
      });
    }

    const header = document.createElement('div');
    header.className = 'cat-header';
    header.innerHTML = `
      <div class="cat-left">
        <span class="ico">${ICONS.svg(main.iconKey || 'folder')}</span>
        <span class="cat-name">${escapeHtml(main.name)}</span>
      </div>
      <div class="cat-right" ${hasSubs ? '' : 'style="display:none"'}></div>
    `;

    if (hasSubs) {
      const right = header.querySelector('.cat-right');
      right.innerHTML = `
        <span class="cat-arrow" title="展开/收起">
          <span class="ico">${ICONS.svg('chevronDown')}</span>
        </span>
      `;
      const arrow = right.querySelector('.cat-arrow');
      arrow.onclick = (e) => {
        e.stopPropagation();
        subDiv.classList.toggle('expanded');
        const isEx = subDiv.classList.contains('expanded');
        arrow.innerHTML = `<span class="ico">${ICONS.svg(isEx ? 'chevronUp' : 'chevronDown')}</span>`;
      };
    }

    header.onclick = () => {
      setFilter('MAIN', main.name, header);
      if (hasSubs) {
        subDiv.classList.toggle('expanded');
        const arrow = header.querySelector('.cat-arrow');
        if (arrow) {
          const isEx = subDiv.classList.contains('expanded');
          arrow.innerHTML = `<span class="ico">${ICONS.svg(isEx ? 'chevronUp' : 'chevronDown')}</span>`;
        }
      }
    };

    mainDiv.appendChild(header);
    mainDiv.appendChild(subDiv);
    container.appendChild(mainDiv);
  });
}

/* =========================
   16) 筛选与渲染模板
   ========================= */
function setFilter(type, value, el) {
  currentFilter = { type, value };
  document.querySelectorAll('.cat-header, .sub-cat-item').forEach(d => d.classList.remove('active'));

  if (type === 'ALL') {
    el.classList.add('active');
    document.getElementById('currentFilterLabel').textContent = "全部模板";
  } else {
    el.classList.add('active');
    if (type === 'SUB') el.parentElement.previousElementSibling.classList.add('active');
    document.getElementById('currentFilterLabel').textContent = `${value} 模板`;
  }
  renderTemplates();
  updateTopbarHeight();
  if (isMobile()) closeSidebar();
}

function renderTemplates() {
  const search = document.getElementById('searchInput').value.toLowerCase();
  const container = document.getElementById('templateList');
  container.innerHTML = '';

  const filtered = templates.filter(t => {
    const contentText = htmlToPlainText(t.content || '');
    const catText = (t.mainCat || '') + ' ' + (t.subCat || '');
    const textMatch = (t.title + ' ' + contentText + ' ' + (t.tags || '') + ' ' + catText)
      .toLowerCase()
      .includes(search);

    let catMatch = true;
    if (currentFilter.type === 'MAIN') catMatch = t.mainCat === currentFilter.value;
    else if (currentFilter.type === 'SUB') catMatch = t.subCat === currentFilter.value;

    return textMatch && catMatch;
  });

  if (filtered.length === 0) {
    container.innerHTML = `<div style="text-align:center; color:#9ca3af; margin-top:50px;">暂无内容</div>`;
    return;
  }

  filtered.forEach(t => {
    const tags = parseTags(t.tags);
    const tagHtml = tags.map(x => `<span class="tag">${escapeHtml(x)}</span>`).join('');
    const bodyHtml = isProbablyHtml(t.content) ? sanitizeHtml(t.content) : plainTextToHtml(t.content);

    const card = document.createElement('div');
    card.className = 'template-card';
    card.innerHTML = `
      <div class="card-header">
        <div class="card-title">${escapeHtml(t.title)}</div>
        <div class="card-actions">
          <button class="btn-move" onclick="openMoveModal('${t.id}')">
            <span class="ico">${ICONS.svg('move')}</span> 移动
          </button>
          <button class="btn-copy" onclick="copyContent('${t.id}', this)">
            <span class="ico">${ICONS.svg('copy')}</span> 复制
          </button>
        </div>
      </div>
      <div class="card-meta">
        <span class="tag tag-main">${escapeHtml(t.mainCat || '未分类')}</span>
        ${t.subCat ? `<span class="tag tag-sub">${escapeHtml(t.subCat)}</span>` : ''}
        ${tagHtml}
      </div>
      <div class="card-body" onclick="editTemplate('${t.id}')" title="点击编辑">${bodyHtml}</div>
    `;
    container.appendChild(card);
  });
}

/* =========================
   17) CRUD：模板
   ========================= */
function saveTemplate(silentClose = false) {
  const id = document.getElementById('editId').value;
  const mainCat = document.getElementById('inputMainCat').value;
  const subCat = document.getElementById('inputSubCat').value;
  const title = document.getElementById('inputTitle').value;

  const pending = (document.getElementById('newTagInput').value || '').trim();
  if (pending) addNewTagFromInput();

  const tagsArr = Array.from(selectedTags)
    .map(s => s.trim())
    .filter(Boolean)
    .sort((a,b)=>a.localeCompare(b,'zh-Hans-CN'));
  const tags = tagsArr.join(', ');

  const contentHtml = getEditorHtmlForSave();
  const contentText = htmlToPlainText(contentHtml);

  if (!title || !mainCat || !contentText.trim()) {
    openAlertModal("请至少填写分类、标题和内容");
    return false;
  }

  const data = { id: id || Date.now().toString(), mainCat, subCat, title, tags, content: contentHtml };

  if (id) {
    const index = templates.findIndex(t => t.id === id);
    if (index > -1) templates[index] = data;
  } else {
    templates.unshift(data);
  }

  saveToLocal();
  rebuildTagPool(tagsArr);

  takeTemplateModalSnapshot();
  if (!silentClose) closeModalDirect('templateModal');
  renderTemplates();
  updateTopbarHeight();
  return true;
}

function deleteTemplate() {
  const id = document.getElementById('editId').value;
  const t = templates.find(x => x.id === id);
  const title = t ? t.title : '';
  const msg = `确定要删除该模板吗？\n\n标题：${title}\n\n此操作不可撤销。`;

  openConfirmModal(msg, {
    title: '确认删除',
    okText: '删除',
    cancelText: '取消',
    danger: true,
    onOk: () => {
      autoBackup('delete_template');
      templates = templates.filter(x => x.id !== id);
      saveToLocal();
      rebuildTagPool([]);
      templateModalSnapshot = null;
      closeModalDirect('templateModal');
      renderTemplates();
      updateTopbarHeight();
    }
  });
}

function editTemplate(id) {
  const t = templates.find(i => i.id === id);
  if(!t) return;

  document.getElementById('editId').value = t.id;
  document.getElementById('inputTitle').value = t.title;
  document.getElementById('modalTitleText').textContent = "编辑模板";
  document.getElementById('btnDelete').style.display = 'inline-flex';

  populateCatSelects(t.mainCat, t.subCat);

  const preTags = parseTags(t.tags);
  document.getElementById('newTagInput').value = '';
  document.getElementById('btnAddTag').disabled = true;
  rebuildTagPool(preTags);

  setEditorContentFromStored(t.content);

  openModal('templateModal');
  takeTemplateModalSnapshot();
}

function openTemplateModal() {
  document.getElementById('editId').value = '';
  document.getElementById('inputTitle').value = '';
  document.getElementById('modalTitleText').textContent = "新建模板";
  document.getElementById('btnDelete').style.display = 'none';

  let defaultMain = categoryTree[0]?.name || '';
  let defaultSub = '';
  if (currentFilter.type === 'MAIN') defaultMain = currentFilter.value;
  if (currentFilter.type === 'SUB') {
    const parent = categoryTree.find(c => Array.isArray(c.subs) && c.subs.some(s => (typeof s === 'string' ? s : s.name) === currentFilter.value));
    if (parent) { defaultMain = parent.name; defaultSub = currentFilter.value; }
  }

  populateCatSelects(defaultMain, defaultSub);

  document.getElementById('newTagInput').value = '';
  document.getElementById('btnAddTag').disabled = true;
  rebuildTagPool([]);

  setEditorContentFromStored('');

  openModal('templateModal');
  takeTemplateModalSnapshot();
}

function populateCatSelects(selectedMain, selectedSub) {
  const mainSel = document.getElementById('inputMainCat');
  mainSel.innerHTML = '';

  const mainNames = categoryTree.map(c => c.name);
  const selectedMainExists = mainNames.includes(selectedMain);

  if (selectedMain && !selectedMainExists) {
    const opt = document.createElement('option');
    opt.value = selectedMain;
    opt.textContent = `${selectedMain} (已不存在，请选择新分类)`;
    opt.selected = true;
    mainSel.appendChild(opt);
  }

  categoryTree.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.name;
    opt.textContent = c.name;
    if(c.name === selectedMain) opt.selected = true;
    mainSel.appendChild(opt);
  });

  updateSubCatOptions(selectedSub);
}

function updateSubCatOptions(selectedSub = '') {
  const mainVal = document.getElementById('inputMainCat').value;
  const subSel = document.getElementById('inputSubCat');
  subSel.innerHTML = '<option value="">(无)</option>';

  const catObj = categoryTree.find(c => c.name === mainVal);
  const subs = (catObj && Array.isArray(catObj.subs)) ? catObj.subs : [];
  const subNames = subs.map(s => (typeof s === 'string' ? s : s.name));

  if (selectedSub && !subNames.includes(selectedSub)) {
    const opt = document.createElement('option');
    opt.value = selectedSub;
    opt.textContent = `${selectedSub} (已不存在)`;
    opt.selected = true;
    subSel.appendChild(opt);
  }

  subs.forEach(s => {
    const name = typeof s === 'string' ? s : s.name;
    const opt = document.createElement('option');
    opt.value = name;
    opt.textContent = name;
    if(name === selectedSub) opt.selected = true;
    subSel.appendChild(opt);
  });

  refreshTemplateDirtyFlag();
}

/* =========================
   18) 移动模板
   ========================= */
function openMoveModal(id) {
  const t = templates.find(x => x.id === id);
  if (!t) return;

  document.getElementById('moveId').value = id;

  const mainSel = document.getElementById('moveMainCat');
  mainSel.innerHTML = '';
  categoryTree.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.name;
    opt.textContent = c.name;
    if (c.name === t.mainCat) opt.selected = true;
    mainSel.appendChild(opt);
  });

  updateMoveSubCatOptions(t.subCat);
  openModal('moveModal');
  takeMoveModalSnapshot();
}

function updateMoveSubCatOptions(selectedSub = '') {
  const mainVal = document.getElementById('moveMainCat').value;
  const subSel = document.getElementById('moveSubCat');
  subSel.innerHTML = '<option value="">(无)</option>';

  const catObj = categoryTree.find(c => c.name === mainVal);
  const subs = (catObj && Array.isArray(catObj.subs)) ? catObj.subs : [];
  subs.forEach(s => {
    const name = typeof s === 'string' ? s : s.name;
    const opt = document.createElement('option');
    opt.value = name;
    opt.textContent = name;
    if (name === selectedSub) opt.selected = true;
    subSel.appendChild(opt);
  });
}

function confirmMoveTemplate(silentClose = false) {
  const id = document.getElementById('moveId').value;
  const t = templates.find(x => x.id === id);
  if (!t) return false;

  const newMain = document.getElementById('moveMainCat').value;
  const newSub = document.getElementById('moveSubCat').value;

  const msg =
    `确定移动该模板吗？\n\n` +
    `标题：${t.title}\n` +
    `从：${t.mainCat}${t.subCat ? ' / ' + t.subCat : ''}\n` +
    `到：${newMain}${newSub ? ' / ' + newSub : ''}`;

  openConfirmModal(msg, {
    title: '确认移动',
    okText: '移动',
    cancelText: '取消',
    danger: false,
    onOk: () => {
      autoBackup('move_template');
      t.mainCat = newMain;
      t.subCat = newSub;

      saveToLocal();
      moveModalSnapshot = null;
      if (!silentClose) closeModalDirect('moveModal');
      renderTemplates();
      updateTopbarHeight();
    }
  });

  return true;
}

/* =========================
   19) 分类管理（重命名/排序/删除/选图标/二级选图标）
   ========================= */
function openCategoryManager() {
  openModal('categoryModal');
  renderManageMainList();
  renderManageSubList(null);
}

function renderManageMainList() {
  const list = document.getElementById('manageMainList');
  list.innerHTML = '';

  categoryTree.forEach((c, index) => {
    const item = document.createElement('div');
    item.className = `manage-item ${editingCategoryMain === c ? 'active' : ''}`;
    item.setAttribute('data-main-index', index);
    item.onclick = () => {
      editingCategoryMain = c;
      renderManageMainList();
      renderManageSubList(c);
    };

    item.innerHTML = `      <div class="manage-item-left">
        <span class="ico">${ICONS.svg(c.iconKey || 'folder')}</span>
        <span class="name cat-name" title="双击编辑名称" ondblclick="event.stopPropagation(); startInlineRenameMain(${index});">${escapeHtml(c.name)}</span>
      </div>
      <div class="item-controls" onclick="event.stopPropagation()">
        <button class="icon-btn iconpick icon-only" type="button" title="更换图标" aria-label="更换图标" onclick="openIconPickerForMain(${index})">
          <span class="ico">${ICONS.svg('palette')}</span>
        </button>
        <button class="icon-btn rename icon-only" type="button" title="编辑名称" aria-label="编辑名称" onclick="startInlineRenameMain(${index})">
          <span class="ico">${ICONS.svg('pen')}</span>
        </button>

        <button class="icon-btn more icon-only" type="button" title="更多" aria-label="更多" onclick="toggleRowMoreMenu(this)">
          <span class="ico">${ICONS.svg('more')}</span>
        </button>

        <button class="icon-btn" type="button" title="上移" onclick="moveMainCat(${index}, -1)">↑</button>
        <button class="icon-btn" type="button" title="下移" onclick="moveMainCat(${index}, 1)">↓</button>
        <button class="icon-btn delete" type="button" title="删除" onclick="deleteMainCat(${index})">
          <span class="ico">${ICONS.svg('trash')}</span>
        </button>

        <div class="more-menu" onclick="event.stopPropagation()">
          <button class="more-menu-item" type="button" onclick="openIconPickerForMain(${index}); closeAllRowMoreMenus();">
            <span class="ico">${ICONS.svg('palette')}</span><span>更换图标</span>
          </button>
          <button class="more-menu-item" type="button" onclick="startInlineRenameMain(${index}); closeAllRowMoreMenus();">
            <span class="ico">${ICONS.svg('pen')}</span><span>编辑名称</span>
          </button>
          <button class="more-menu-item" type="button" onclick="moveMainCat(${index}, -1); closeAllRowMoreMenus();">
            <span class="ico">${ICONS.svg('chevronUp')}</span><span>上移</span>
          </button>
          <button class="more-menu-item" type="button" onclick="moveMainCat(${index}, 1); closeAllRowMoreMenus();">
            <span class="ico">${ICONS.svg('chevronDown')}</span><span>下移</span>
          </button>
          <button class="more-menu-item danger" type="button" onclick="deleteMainCat(${index}); closeAllRowMoreMenus();">
            <span class="ico">${ICONS.svg('trash')}</span><span>删除</span>
          </button>
        </div>
      </div>
    `;
    list.appendChild(item);
  });
}

function renderManageSubList(catObj) {
  const list = document.getElementById('manageSubList');
  const input = document.getElementById('newSubCatName');
  const btn = document.getElementById('btnAddSub');
  const btnPick = document.getElementById('btnPickNewSubIcon');

  list.innerHTML = '';

  if (!catObj) {
    list.innerHTML = '<div style="padding:10px; color:#9ca3af; text-align:center">请先在左侧选择一级分类</div>';
    document.getElementById('selectedMainCatName').textContent = "未选择";
    document.getElementById('selectedMainCatName').style.color = "#9ca3af";
    input.disabled = true;
    btn.disabled = true;
    btnPick.disabled = true;
    return;
  }

  document.getElementById('selectedMainCatName').textContent = catObj.name;
  document.getElementById('selectedMainCatName').style.color = "var(--accent-color)";
  input.disabled = false;
  btn.disabled = false;
  btnPick.disabled = false;

  const subs = Array.isArray(catObj.subs) ? catObj.subs : [];
  subs.forEach((sub, index) => {
    const subName = (typeof sub === 'string') ? sub : sub.name;
    const iconKey = (typeof sub === 'object' && sub.iconKey) ? sub.iconKey : guessSubIcon(subName);

    const item = document.createElement('div');
    item.className = 'manage-item';
    item.setAttribute('data-sub-index', index);

    item.innerHTML = `      <div class="manage-item-left">
        <span class="ico">${ICONS.svg(iconKey)}</span>
        <span class="name cat-name" title="点击编辑名称" onclick="event.stopPropagation(); startInlineRenameSub(${index});">${escapeHtml(subName)}</span>
      </div>
      <div class="item-controls" onclick="event.stopPropagation()">
        <button class="icon-btn iconpick icon-only" type="button" title="更换图标" aria-label="更换图标" onclick="openIconPickerForSub(${index})">
          <span class="ico">${ICONS.svg('palette')}</span>
        </button>
        <button class="icon-btn rename icon-only" type="button" title="编辑名称" aria-label="编辑名称" onclick="startInlineRenameSub(${index})">
          <span class="ico">${ICONS.svg('pen')}</span>
        </button>

        <button class="icon-btn more icon-only" type="button" title="更多" aria-label="更多" onclick="toggleRowMoreMenu(this)">
          <span class="ico">${ICONS.svg('more')}</span>
        </button>

        <button class="icon-btn" type="button" title="上移" onclick="moveSubCat(${index}, -1)">↑</button>
        <button class="icon-btn" type="button" title="下移" onclick="moveSubCat(${index}, 1)">↓</button>
        <button class="icon-btn delete" type="button" title="删除" onclick="deleteSubCat(${index})">
          <span class="ico">${ICONS.svg('trash')}</span>
        </button>

        <div class="more-menu" onclick="event.stopPropagation()">
          <button class="more-menu-item" type="button" onclick="openIconPickerForSub(${index}); closeAllRowMoreMenus();">
            <span class="ico">${ICONS.svg('palette')}</span><span>更换图标</span>
          </button>
          <button class="more-menu-item" type="button" onclick="startInlineRenameSub(${index}); closeAllRowMoreMenus();">
            <span class="ico">${ICONS.svg('pen')}</span><span>编辑名称</span>
          </button>
          <button class="more-menu-item" type="button" onclick="moveSubCat(${index}, -1); closeAllRowMoreMenus();">
            <span class="ico">${ICONS.svg('chevronUp')}</span><span>上移</span>
          </button>
          <button class="more-menu-item" type="button" onclick="moveSubCat(${index}, 1); closeAllRowMoreMenus();">
            <span class="ico">${ICONS.svg('chevronDown')}</span><span>下移</span>
          </button>
          <button class="more-menu-item danger" type="button" onclick="deleteSubCat(${index}); closeAllRowMoreMenus();">
            <span class="ico">${ICONS.svg('trash')}</span><span>删除</span>
          </button>
        </div>
      </div>
    `;
    list.appendChild(item);
  });
}

function moveMainCat(index, direction) {
  if (direction === -1 && index === 0) return;
  if (direction === 1 && index === categoryTree.length - 1) return;

  autoBackup('move_main_category');
  const temp = categoryTree[index];
  categoryTree[index] = categoryTree[index + direction];
  categoryTree[index + direction] = temp;

  saveCategories();
  renderManageMainList();
  renderSidebar();
}

function moveSubCat(index, direction) {
  if (!editingCategoryMain) return;
  const subs = editingCategoryMain.subs;
  if (direction === -1 && index === 0) return;
  if (direction === 1 && index === subs.length - 1) return;

  autoBackup('move_sub_category');
  const temp = subs[index];
  subs[index] = subs[index + direction];
  subs[index + direction] = temp;

  saveCategories();
  renderManageSubList(editingCategoryMain);
  renderSidebar();
}

function addMainCategory() {
  const input = document.getElementById('newMainCatName');
  const name = (input.value || '').trim();
  if(!name) return;
  if(categoryTree.find(c => c.name === name)) { openAlertModal("分类已存在"); return; }

  // 主图标不重复
  const used = new Set(categoryTree.map(c => c.iconKey));
  const iconKey = pickFreeIcon(used, newMainIconKey);

  autoBackup('add_main_category');
  categoryTree.push({ name, iconKey, subs: [] });
  saveCategories();

  input.value = '';
  newMainIconKey = pickFreeIcon(new Set(categoryTree.map(c => c.iconKey)), 'folder');

  syncNewCategoryIconRemember();
  renderManageMainList();
  renderSidebar();
}

function deleteMainCat(index) {
  const name = categoryTree[index]?.name || '';
  const msg =
    `确定删除一级分类【${name}】吗？\n\n` +
    `注意：该分类下的模板不会被删除，但会失去目录归属（仍可在“全部显示”中找到，并可编辑/移动重新归类）。`;

  openConfirmModal(msg, {
    title: '确认删除一级分类',
    okText: '删除',
    cancelText: '取消',
    danger: true,
    onOk: () => {
      autoBackup('delete_main_category');
      if (categoryTree[index] === editingCategoryMain) {
        editingCategoryMain = null;
        renderManageSubList(null);
      }
      categoryTree.splice(index, 1);
      saveCategories();

      // 如果当前筛选指向被删的一级分类，回到全部
      if (currentFilter.type === 'MAIN' && currentFilter.value === name) {
        currentFilter = { type:'ALL', value:'' };
      }
      renderSidebar();
      renderManageMainList();
      renderTemplates();
      updateTopbarHeight();
    }
  });
}

function addSubCategory() {
  if(!editingCategoryMain) return;
  const input = document.getElementById('newSubCatName');
  const name = (input.value || '').trim();
  if(!name) return;

  const subs = editingCategoryMain.subs || [];
  const subNames = subs.map(s => (typeof s === 'string' ? s : s.name));
  if (subNames.includes(name)) { openAlertModal("子分类已存在"); return; }

  // 二级分类图标全局不重复
  const used = getUsedSubIconKeys(-1, -1);
  const preferred = (newSubIconKey && ICONS.exists(newSubIconKey)) ? newSubIconKey : guessSubIcon(name);
  const iconKey = pickFreeSubIcon(used, name, preferred);

  autoBackup('add_sub_category');
  editingCategoryMain.subs.push({ name, iconKey });
  saveCategories();

  input.value = '';
  // 新默认：在全局二级分类图标中找一个空闲
  const usedAfter = getUsedSubIconKeys(-1, -1);
  newSubIconKey = pickFreeIcon(usedAfter, 'folderOpen');
  syncNewCategoryIconRemember();

  renderManageSubList(editingCategoryMain);
  renderSidebar();
}

function deleteSubCat(index) {
  if (!editingCategoryMain) return;
  const subName = editingCategoryMain.subs[index];
  const mainName = editingCategoryMain.name;

  const msg =
    `确定删除二级分类【${mainName} / ${subName}】吗？\n\n` +
    `注意：该二级分类下的模板不会被删除，但其二级字段将失去目录归属（仍可编辑/移动重新归类）。`;

  openConfirmModal(msg, {
    title: '确认删除二级分类',
    okText: '删除',
    cancelText: '取消',
    danger: true,
    onOk: () => {
      autoBackup('delete_sub_category');
      editingCategoryMain.subs.splice(index, 1);
      saveCategories();

      if (currentFilter.type === 'SUB' && currentFilter.value === subName) {
        currentFilter = { type:'ALL', value:'' };
      }
      renderSidebar();
      renderManageSubList(editingCategoryMain);
      renderTemplates();
      updateTopbarHeight();
    }
  });
}

function startInlineRenameMain(index) {
  const cat = categoryTree[index];
  if (!cat) return;

  // 关闭其他正在编辑的内联输入
  if (window.__inlineRenameCleanup && typeof window.__inlineRenameCleanup === 'function') {
    window.__inlineRenameCleanup(true);
  }

  const item = document.querySelector(`#manageMainList .manage-item[data-main-index="${index}"]`);
  if (!item) return;

  const nameEl = item.querySelector('.manage-item-left .cat-name');
  if (!nameEl) return;

  const oldName = (cat.name || '').trim();
  let finished = false;

  const input = document.createElement('input');
  input.type = 'text';
  input.className = 'inline-rename-input';
  input.value = oldName;
  input.setAttribute('maxlength', '60');
  input.setAttribute('aria-label', '编辑一级分类名称');

  const stop = (e) => { e.stopPropagation(); };
  ['mousedown','click','touchstart','pointerdown'].forEach(ev => {
    try { input.addEventListener(ev, stop, {passive:false}); } catch(_) { input.addEventListener(ev, stop); }
  });

  const cleanup = (reRender = true) => {
    if (finished) return;
    finished = true;
    window.__inlineRenameCleanup = null;
    if (reRender) renderManageMainList();
  };
  window.__inlineRenameCleanup = cleanup;

  nameEl.replaceWith(input);
  input.focus();
  try { input.setSelectionRange(0, input.value.length); } catch(_) {}

  const commit = () => {
    if (finished) return;

    const nn = (input.value || '').trim();
    if (!nn) {
      openAlertModal('名称不能为空');
      input.focus();
      return;
    }
    if (nn === oldName) {
      cleanup(true);
      return;
    }
    if (categoryTree.some((c, i) => i !== index && c.name === nn)) {
      openAlertModal('已存在同名一级分类');
      input.focus();
      return;
    }

    autoBackup('rename_main_category');
    categoryTree[index].name = nn;

    templates.forEach(t => { if (t.mainCat === oldName) t.mainCat = nn; });
    if (currentFilter.type === 'MAIN' && currentFilter.value === oldName) currentFilter.value = nn;

    saveCategories();
    saveToLocal();

    finished = true;
    window.__inlineRenameCleanup = null;

    renderSidebar();
    renderManageMainList();
    renderManageSubList(editingCategoryMain);
    renderTemplates();
  updateTopbarHeight();
  };

  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') { e.preventDefault(); commit(); }
    if (e.key === 'Escape') { e.preventDefault(); cleanup(true); }
  });

  input.addEventListener('blur', () => {
    // 延迟一个 tick，避免与点击控制按钮的事件顺序冲突
    setTimeout(commit, 0);
  });
}

function renameMainCat(index) {
  // 兼容旧调用：改为内联编辑
  startInlineRenameMain(index);
}


function startInlineRenameSub(index) {
  if (!editingCategoryMain) return;

  // 关闭其他正在编辑的内联输入
  if (window.__inlineRenameCleanup && typeof window.__inlineRenameCleanup === 'function') {
    window.__inlineRenameCleanup(true);
  }

  const mainName = (editingCategoryMain.name || '').trim();
  const oldObj = editingCategoryMain.subs[index];
  const oldSub = (typeof oldObj === 'string') ? oldObj : (oldObj && oldObj.name);
  if (!oldSub) return;

  const item = document.querySelector(`#manageSubList .manage-item[data-sub-index="${index}"]`);
  if (!item) return;

  const nameEl = item.querySelector('.manage-item-left .cat-name');
  if (!nameEl) return;

  const oldName = (oldSub || '').trim();
  let finished = false;

  const input = document.createElement('input');
  input.type = 'text';
  input.className = 'inline-rename-input';
  input.value = oldName;
  input.setAttribute('maxlength', '60');
  input.setAttribute('aria-label', '编辑二级分类名称');

  const stop = (e) => { e.stopPropagation(); };
  ['mousedown','click','touchstart','pointerdown'].forEach(ev => {
    try { input.addEventListener(ev, stop, {passive:false}); } catch(_) { input.addEventListener(ev, stop); }
  });

  const cleanup = (reRender = true) => {
    if (finished) return;
    finished = true;
    window.__inlineRenameCleanup = null;
    if (reRender) renderManageSubList(editingCategoryMain);
  };
  window.__inlineRenameCleanup = cleanup;

  nameEl.replaceWith(input);
  input.focus();
  try { input.setSelectionRange(0, input.value.length); } catch(_) {}

  const commit = () => {
    if (finished) return;

    const nn = (input.value || '').trim();
    if (!nn) {
      openAlertModal('名称不能为空');
      input.focus();
      return;
    }
    if (nn === oldName) {
      cleanup(true);
      return;
    }

    const names = editingCategoryMain.subs.map((s, i) => {
      if (i === index) return null;
      return (typeof s === 'string') ? s : (s && s.name);
    }).filter(Boolean);

    if (names.includes(nn)) {
      openAlertModal('该一级分类下已存在同名二级分类');
      input.focus();
      return;
    }

    autoBackup('rename_sub_category');

    const iconKey = (typeof oldObj === 'object' && oldObj && oldObj.iconKey) ? oldObj.iconKey : guessSubIcon(nn);
    editingCategoryMain.subs[index] = { name: nn, iconKey };

    templates.forEach(t => { if (t.mainCat === mainName && t.subCat === oldName) t.subCat = nn; });
    if (currentFilter.type === 'SUB' && currentFilter.value === oldName) currentFilter.value = nn;

    saveCategories();
    saveToLocal();

    finished = true;
    window.__inlineRenameCleanup = null;

    renderSidebar();
    renderManageSubList(editingCategoryMain);
    renderTemplates();
  updateTopbarHeight();
  };

  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') { e.preventDefault(); commit(); }
    if (e.key === 'Escape') { e.preventDefault(); cleanup(true); }
  });

  input.addEventListener('blur', () => {
    setTimeout(commit, 0);
  });
}

function renameSubCat(index) {
  // 兼容旧调用：改为内联编辑
  startInlineRenameSub(index);
}


/* =========================
   20) 图标选择器（主/子/新增）
   ========================= */
function getUsedMainIconKeys(exceptIndex = -1) {
  const used = new Set();
  categoryTree.forEach((c, i) => {
    if (i === exceptIndex) return;
    if (c.iconKey) used.add(c.iconKey);
  });
  return used;
}
function getUsedSubIconKeys(exceptMainIndex = -1, exceptSubIndex = -1) {
  // 二级分类图标：全局去重（可选排除某一个正在编辑的条目）
  const used = new Set();
  categoryTree.forEach((c, mi) => {
    (c.subs || []).forEach((s, si) => {
      if (mi == exceptMainIndex && si == exceptSubIndex) return;
      if (typeof s === 'object' && s.iconKey) used.add(s.iconKey);
    });
  });
  return used;
}

function openIconPickerForMain(mainIndex) {
  const used = getUsedMainIconKeys(mainIndex);
  iconPickerContext = {
    scope: 'MAIN',
    mainIndex,
    usedKeys: used,
    onPick: (key) => {
      categoryTree[mainIndex].iconKey = key;
      saveCategories();
      renderManageMainList();
      renderSidebar();
    }
  };
  openIconPicker(`选择一级分类图标：${categoryTree[mainIndex].name}`, used);
}

function openIconPickerForSub(subIndex) {
  if (!editingCategoryMain) return;
  const mainIndex = categoryTree.findIndex(x => x === editingCategoryMain);
  const used = getUsedSubIconKeys(mainIndex, subIndex);

  iconPickerContext = {
    scope: 'SUB',
    mainIndex,
    subIndex,
    usedKeys: used,
    onPick: (key) => {
      // 保险：再次校验全局不重复
      if (getUsedSubIconKeys(mainIndex, subIndex).has(key)) {
        openAlertModal('该图标已被其他二级分类占用，请选择未置灰的图标。', '无法选择');
        return;
      }
      const old = editingCategoryMain.subs[subIndex];
      const name = (typeof old === 'string') ? old : old.name;
      editingCategoryMain.subs[subIndex] = { name, iconKey: key };
      saveCategories();
      renderManageSubList(editingCategoryMain);
      renderSidebar();
    }
  };
  const subObj = editingCategoryMain.subs[subIndex];
  const name = (typeof subObj === 'string') ? subObj : subObj.name;
  openIconPicker(`选择二级分类图标：${editingCategoryMain.name} / ${name}`, used);
}

function openIconPickerForNewMain() {
  const used = getUsedMainIconKeys(-1);
  iconPickerContext = {
    scope: 'NEW_MAIN',
    usedKeys: used,
    onPick: (key) => {
      newMainIconKey = key;
      syncNewCategoryIconRemember();
    }
  };
  openIconPicker('为“新一级分类”选择图标', used);
}

function openIconPickerForNewSub() {
  if (!editingCategoryMain) return;
  const mainIndex = categoryTree.findIndex(x => x === editingCategoryMain);
  const used = getUsedSubIconKeys(-1, -1);

  iconPickerContext = {
    scope: 'NEW_SUB',
    usedKeys: used,
    onPick: (key) => {
      if (getUsedSubIconKeys(-1, -1).has(key)) {
        openAlertModal('该图标已被其他二级分类占用，请选择未置灰的图标。', '无法选择');
        return;
      }
      newSubIconKey = key;
      syncNewCategoryIconRemember();
    }
  };
  openIconPicker('为“新二级分类”选择图标（二级分类全局不重复）', used);
}

function openIconPicker(title, usedKeys) {
  document.getElementById('iconPickerTitle').textContent = title;

  const scope = iconPickerContext ? iconPickerContext.scope : '';
  const levelText = (scope === 'MAIN' || scope === 'NEW_MAIN') ? '一级分类' :
                    (scope === 'SUB'  || scope === 'NEW_SUB')  ? '二级分类' : '当前范围';

  document.getElementById('iconPickerHint').textContent =
    `提示：置灰表示该图标已在${levelText}中使用（全局不重复）。`;

  const si = document.getElementById('iconSearchInput');
  if (si) {
    si.value = '';
    // Suppress any extra search overlay behavior in some mobile WebViews
    if (!si.dataset.bound) {
      si.dataset.bound = '1';
      si.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
        }
      });
    }
  }

  openModal('iconPickerModal');

  // 让用户输入即筛选：不再有任何“弹框搜索”
  const body = document.querySelector('#iconPickerModal .icon-picker-body');
  if (body) body.scrollTop = 0;
  setTimeout(() => { try { si && si.focus(); } catch(e){} }, 0);

  renderIconPickerGrid();
}


function renderIconPickerGrid() {
  const grid = document.getElementById('iconGrid');
  const q = (document.getElementById('iconSearchInput').value || '').trim().toLowerCase();

  const used = (iconPickerContext && iconPickerContext.usedKeys) ? iconPickerContext.usedKeys : new Set();
  const all = ICONS.all();

  const filtered = all.filter(x => {
    if (!q) return true;
    return (x.label + ' ' + x.desc + ' ' + x.key).toLowerCase().includes(q);
  });

  grid.innerHTML = '';
  filtered.forEach(x => {
    const isUsed = used.has(x.key);
    const item = document.createElement('div');
    item.className = 'icon-item' + (isUsed ? ' disabled' : '');
    item.innerHTML = `
      <div class="icon-badge">${ICONS.svg(x.key)}</div>
      <div class="icon-text">
        <div class="label">${escapeHtml(x.label)}</div>
        <div class="desc">${escapeHtml(x.desc)} · ${escapeHtml(x.key)}</div>
      </div>
    `;

    if (!isUsed) {
      item.onclick = () => {
        if (!iconPickerContext || typeof iconPickerContext.onPick !== 'function') return;
        iconPickerContext.onPick(x.key);
        closeModalDirect('iconPickerModal');
      };
    } else {
      item.onclick = () => {}; // 占用则不选
    }

    grid.appendChild(item);
  });
}

function syncNewCategoryIconRemember() {
  const mainPrev = document.getElementById('newMainIconPreview');
  if (mainPrev) mainPrev.innerHTML = ICONS.svg(newMainIconKey);

  const subPrev = document.getElementById('newSubIconPreview');
  if (subPrev) subPrev.innerHTML = ICONS.svg(newSubIconKey);
}

/* =========================
   21) 备份/恢复
   ========================= */
function exportData() {
  openConfirm3({
    title: '选择备份格式',
    body: `你可以选择导出格式：

- JSON：用于恢复/迁移（完整数据）
- Word：用于阅读/存档（排版更适合查看）
- 两份：同时导出 JSON + Word`,
    labels: { continue: '导出JSON', discard: '导出Word', save: '导出两份' },
    onContinue: () => exportJsonBackup(),
    onDiscard: () => exportWordBackup(),
    onSave: () => { exportJsonBackup(); exportWordBackup(); }
  });
}

function getExportStamp(){
  const d = new Date();
  const pad = (n)=>String(n).padStart(2,'0');
  return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}${pad(d.getHours())}${pad(d.getMinutes())}`;
}

function exportJsonBackup() {
  const data = {
    version: "4.11",
    timestamp: new Date().toLocaleString(),
    categories: categoryTree,
    templates: templates,
    tokenDefs: (function(){ try { __loadTokenDefs(); return __tokenDefs || []; } catch(e){ return []; } })()
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `EMR_V6.2_${getExportStamp()}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function exportWordBackup() {
  const data = {
    version: "4.11",
    timestamp: new Date().toLocaleString(),
    categories: categoryTree,
    templates: templates,
    tokenDefs: (function(){ try { __loadTokenDefs(); return __tokenDefs || []; } catch(e){ return []; } })()
  };

  const html = buildWordBackupHtml(data);
  const blob = new Blob(['﻿', html], {type: 'application/msword'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `EMR_V6.2_${getExportStamp()}.doc`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function escapeHtmlForWord(s) {
  return String(s ?? '')
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#39;');
}

function stripScripts(html) {
  return String(html ?? '').replace(/<script[\s\S]*?<\/script>/gi, '');
}

function normalizeWordContentHtml(html) {
  // 适度清理：避免 Word 中出现不可见字符/空段，同时将字段元素输出为“值”
  let s = stripScripts(html);
  s = s.replace(/[​-‍﻿]/g, '');

  // 字段元素：Word 备份中仅保留值（未填写则为空）
  try {
    const wrap = document.createElement('div');
    wrap.innerHTML = s;
    wrap.querySelectorAll('span.emr-token, span[data-emr-id]').forEach(sp => {
      const v = (sp.getAttribute('data-emr-value') || '').toString().trim();
      if (v) {
        sp.replaceWith(document.createTextNode(v));
      } else {
        const name = (sp.getAttribute('data-emr-name') || sp.getAttribute('title') || '').toString().trim() || '字段';
        sp.replaceWith(document.createTextNode('[' + name + ']'));
      }
    });
    s = wrap.innerHTML;
  } catch(e) {}

  s = s.replace(/<p>(\s|&nbsp;)*<\/p>/gi, '');
  return s;
}

function buildWordBackupHtml(data) {
  const versionLabel = 'MyEMR V6.2';
  const ts = data.timestamp || '';
  const cats = Array.isArray(data.categories) ? data.categories : [];
  const tpls = Array.isArray(data.templates) ? data.templates : [];

  // 构建排序索引：按分类树顺序导出
  const mainOrder = new Map();
  const subOrder = new Map(); // mainName -> Map(subName -> index)
  cats.forEach((m, i) => {
    const mName = String(m?.name ?? '').trim();
    if (!mName) return;
    mainOrder.set(mName, i);
    const sm = new Map();
    (Array.isArray(m.subs) ? m.subs : []).forEach((s, j) => {
      const sName = String((typeof s === 'string') ? s : (s?.name ?? '')).trim();
      if (!sName) return;
      sm.set(sName, j);
    });
    subOrder.set(mName, sm);
  });

  // 聚合模板
  const group = new Map(); // main -> sub -> [tpl]
  tpls.forEach(t => {
    const m = String(t?.mainCat ?? '').trim() || '未分类';
    const s = String(t?.subCat ?? '').trim() || '未分组';
    if (!group.has(m)) group.set(m, new Map());
    const sm = group.get(m);
    if (!sm.has(s)) sm.set(s, []);
    sm.get(s).push(t);
  });

  // 生成有序的 main 列表：先按分类树，再补齐其它
  const mains = Array.from(group.keys());
  mains.sort((a,b) => {
    const ia = mainOrder.has(a) ? mainOrder.get(a) : 999999;
    const ib = mainOrder.has(b) ? mainOrder.get(b) : 999999;
    if (ia !== ib) return ia - ib;
    return a.localeCompare(b,'zh-Hans-CN');
  });

  // 目录
  let tocHtml = '';
  mains.forEach((m, mi) => {
    const mId = `m_${mi}`;
    tocHtml += `<div class="toc-item toc-main"><a href="#${mId}">${escapeHtmlForWord(m)}</a></div>`;
    const sm = group.get(m);
    const subs = Array.from(sm.keys());
    const smOrder = subOrder.get(m) || new Map();
    subs.sort((a,b) => {
      const ia = smOrder.has(a) ? smOrder.get(a) : 999999;
      const ib = smOrder.has(b) ? smOrder.get(b) : 999999;
      if (ia !== ib) return ia - ib;
      return a.localeCompare(b,'zh-Hans-CN');
    });
    subs.forEach((s, si) => {
      const sId = `m_${mi}_s_${si}`;
      tocHtml += `<div class="toc-item toc-sub"><a href="#${sId}">${escapeHtmlForWord(s)}</a></div>`;
    });
  });

  // 正文
  let bodyHtml = '';
  mains.forEach((m, mi) => {
    const mId = `m_${mi}`;
    bodyHtml += `<div class="pagebreak"></div>`;
    bodyHtml += `<h1 id="${mId}">${escapeHtmlForWord(m)}</h1>`;

    const sm = group.get(m);
    const subs = Array.from(sm.keys());
    const smOrder = subOrder.get(m) || new Map();
    subs.sort((a,b) => {
      const ia = smOrder.has(a) ? smOrder.get(a) : 999999;
      const ib = smOrder.has(b) ? smOrder.get(b) : 999999;
      if (ia !== ib) return ia - ib;
      return a.localeCompare(b,'zh-Hans-CN');
    });

    subs.forEach((s, si) => {
      const sId = `m_${mi}_s_${si}`;
      bodyHtml += `<h2 id="${sId}">${escapeHtmlForWord(s)}</h2>`;

      const arr = sm.get(s) || [];
      // 标题排序：先按中文，再按创建近似（id）
      arr.sort((a,b) => String(a?.title ?? '').localeCompare(String(b?.title ?? ''), 'zh-Hans-CN'));

      arr.forEach((t, ti) => {
        const title = String(t?.title ?? '').trim() || '未命名模板';
        const tags = String(t?.tags ?? '').trim();
        const id = String(t?.id ?? '').trim();
        const content = normalizeWordContentHtml(t?.content ?? '');

        bodyHtml += `<div class="tpl">`;
        bodyHtml += `<h3>${escapeHtmlForWord(title)}</h3>`;
        bodyHtml += `<div class="meta">分类：${escapeHtmlForWord(m)} / ${escapeHtmlForWord(s)}${tags ? `　|　标签：${escapeHtmlForWord(tags)}` : ''}${id ? `　|　ID：${escapeHtmlForWord(id)}` : ''}</div>`;
        bodyHtml += `<div class="content">${content}</div>`;
        bodyHtml += `</div>`;
      });
    });
  });

  // 移除第一个 pagebreak（封面后紧接正文不需要强制换页）
  bodyHtml = bodyHtml.replace('<div class="pagebreak"></div>', '');

  const totalCats = cats.length;
  const totalTpl = tpls.length;

  return `<!DOCTYPE html>
<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40">
<head>
<meta charset="utf-8" />
<title>MyEMR V6.2</title>
<style>
  @page { margin: 24mm 18mm; }
  body { font-family: "Microsoft YaHei", "PingFang SC", "SimSun", Arial; font-size: 11pt; line-height: 1.6; color: #111; }
  h1 { font-size: 20pt; margin: 14pt 0 8pt; }
  h2 { font-size: 15pt; margin: 12pt 0 6pt; }
  h3 { font-size: 12.5pt; margin: 10pt 0 4pt; }
  .cover-title { font-size: 26pt; font-weight: 700; margin: 0 0 10pt; }
  .cover-sub { color: #444; margin: 0 0 18pt; }
  .info { border: 1px solid #ddd; border-radius: 6px; padding: 10pt 12pt; background: #fafafa; }
  .info-row { margin: 2pt 0; }
  .toc { margin-top: 14pt; }
  .toc-title { font-weight: 700; font-size: 14pt; margin: 14pt 0 8pt; }
  .toc-item { margin: 2pt 0; }
  .toc-main { font-weight: 600; }
  .toc-sub { margin-left: 18pt; color: #333; }
  a { color: #111; text-decoration: none; }
  .pagebreak { page-break-before: always; }
  .tpl { margin: 0 0 14pt; padding: 10pt 10pt 12pt; border: 1px solid #e5e7eb; border-radius: 8px; }
  .meta { color:#555; font-size: 10.5pt; margin-bottom: 6pt; }
  .content p { margin: 0 0 6pt; }
  .content ul, .content ol { margin: 0 0 6pt 18pt; }
  .content table { border-collapse: collapse; margin: 6pt 0; }
  .content table td, .content table th { border: 1px solid #ddd; padding: 4pt 6pt; }

  /* Import merge content divider */
  .merge-hr{border:none;border-top:1px solid var(--border);margin:10px 0;}
  .merge-note{font-size:12px;color:var(--muted);margin:0 0 8px;}

    /* ===== MyEMR Token Elements (interactive placeholders) ===== */
    .emr-token{
      display:inline-flex;
      align-items:center;
      gap:0;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(17,24,39,.18);
      background:rgba(17,24,39,.04);
      color:#111827;
      font-size:13px;
      line-height:1.4;
      user-select:none;
      cursor:pointer;
      white-space:nowrap;
      vertical-align:baseline;
    }
    .emr-token:hover{ background:rgba(17,24,39,.07); }
    .emr-token .emr-token-label{ opacity:.92; font-weight:700; }
    .emr-token .emr-token-value{ opacity:.92; }
    .emr-token[data-emr-value=""] .emr-token-value{ opacity:.6; }
    .token-list{ display:flex; flex-direction:column; gap:10px; }
    .token-item{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px; border:1px solid rgba(17,24,39,.12);
      border-radius:12px; background:#fff;
    }
    .token-item .meta{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .token-item .meta .name{ font-weight:700; color:#111827; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .token-item .meta .sub{ font-size:12px; color:rgba(17,24,39,.65); }
    .token-item .ops{ display:flex; gap:8px; flex:0 0 auto; }
    .token-opt-grid{ display:grid; grid-template-columns:repeat(2, minmax(0, 1fr)); gap:10px; }
    .token-opt{
      padding:10px 10px; border:1px solid rgba(17,24,39,.14);
      border-radius:12px; background:#fff; cursor:pointer; text-align:center; user-select:none;
    }
    .token-opt:hover{ background:rgba(17,24,39,.04); }
    @media (max-width: 680px){
      .token-opt-grid{ grid-template-columns:1fr; }
    }

</style>
</head>
<body>
  <div>
    <div class="cover-title">MyEMR</div>
    <div class="cover-sub">模板备份（Word 可阅读存档） · ${escapeHtmlForWord(versionLabel)} · ${escapeHtmlForWord(ts)}</div>
    <div class="info">
      <div class="info-row">系统版本：${escapeHtmlForWord(versionLabel)}</div>
      <div class="info-row">备份时间：${escapeHtmlForWord(ts)}</div>
      <div class="info-row">分类数量：${totalCats}</div>
      <div class="info-row">模板数量：${totalTpl}</div>
      <div class="info-row" style="color:#666;">提示：如需恢复/迁移，请同时保留 JSON 备份。</div>
    </div>

    <div class="toc">
      <div class="toc-title">目录</div>
      ${tocHtml || '<div class="toc-item">（无内容）</div>'}
    </div>
  </div>

  ${bodyHtml}
  </div>

  <!-- 字段元素：插入选择 -->
  <div class="modal" id="tokenInsertModal" onclick="noopClose(event)">
    <div class="modal-content" style="width: 520px;" onclick="event.stopPropagation()">
      <div class="modal-title">
        <span>插入字段元素</span>
        <span class="modal-close" onclick="requestCloseModal('tokenInsertModal')">
          <span class="ico" id="icoCloseTokenInsert"></span>
          <span>关闭</span>
        </span>
      </div>
      <div class="modal-body">
        <div class="settings-row" style="margin-bottom:10px;">
          <div class="settings-label" style="min-width:72px;">搜索</div>
          <input class="form-input" id="tokenInsertSearch" placeholder="输入字段名称关键词…" oninput="renderTokenInsertList()">
        </div>
        <div id="tokenInsertList" class="token-list"></div>
      </div>
      <div class="modal-footer">
        <button class="btn secondary" type="button" onclick="requestCloseModal('tokenInsertModal')">取消</button>
      </div>
    </div>
  </div>

  <!-- 字段元素：填写/选择值 -->
  <div class="modal" id="tokenValueModal" onclick="noopClose(event)">
    <div class="modal-content" style="width: 520px;" onclick="event.stopPropagation()">
      <div class="modal-title">
        <span id="tokenValueTitle">填写字段</span>
        <span class="modal-close" onclick="requestCloseModal('tokenValueModal')">
          <span class="ico" id="icoCloseTokenValue"></span>
          <span>关闭</span>
        </span>
      </div>
      <div class="modal-body">
        <div id="tokenValueBody"></div>
      </div>
      <div class="modal-footer">
        <button class="btn danger" type="button" onclick="clearTokenValue()">清空</button>
        <button class="btn secondary" type="button" onclick="requestCloseModal('tokenValueModal')">取消</button>
        <button class="btn" type="button" onclick="applyTokenValue()">确定</button>
      </div>
    </div>
  </div>

  <!-- 字段元素：管理 -->
  <div class="modal" id="tokenManagerModal" onclick="noopClose(event)">
    <div class="modal-content" style="width: 680px;" onclick="event.stopPropagation()">
      <div class="modal-title">
        <span>管理字段元素</span>
        <span class="modal-close" onclick="requestCloseModal('tokenManagerModal')">
          <span class="ico" id="icoCloseTokenMgr"></span>
          <span>关闭</span>
        </span>
      </div>
      <div class="modal-body">
        <div class="settings-actions" style="margin-bottom:10px;">
          <button class="action-btn" type="button" onclick="openTokenEdit('')">
            <span class="ico" id="icoTokenAdd"></span>
            <span>新增字段元素</span>
          </button>
        </div>
        <div id="tokenManagerList" class="token-list"></div>
        <div class="hint" style="margin-top:8px;">提示：字段元素插入到模板内容后，可点击该字段进行快速选择/填写。</div>
      </div>
      <div class="modal-footer">
        <button class="btn secondary" type="button" onclick="requestCloseModal('tokenManagerModal')">关闭</button>
      </div>
    </div>
  </div>

  <!-- 字段元素：新增/编辑 -->
  <div class="modal" id="tokenEditModal" onclick="noopClose(event)">
    <div class="modal-content" style="width: 560px;" onclick="event.stopPropagation()">
      <div class="modal-title">
        <span id="tokenEditTitle">新增字段元素</span>
        <span class="modal-close" onclick="requestCloseModal('tokenEditModal')">
          <span class="ico" id="icoCloseTokenEdit"></span>
          <span>关闭</span>
        </span>
      </div>
      <div class="modal-body">
        <input type="hidden" id="tokenEditId" value="">
        <div class="form-grid">
          <div class="form-col">
            <label class="form-label">字段名称</label>
            <input class="form-input" id="tokenEditName" placeholder="例如：发病部位">
          </div>
          <div class="form-col">
            <label class="form-label">填写方式</label>
            <select class="form-select" id="tokenEditMode" onchange="toggleTokenEditOptions()">
              <option value="select">下拉选择</option>
              <option value="text">自由输入</option>
            </select>
          </div>
          <div class="form-col" id="tokenEditOptionsWrap">
            <label class="form-label">可选项（每行一个，或用逗号分隔）</label>
            <textarea class="form-input" id="tokenEditOptions" style="min-height:120px;" placeholder="右侧颌下区\n左侧颌下区\n上颌\n下颌"></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn secondary" type="button" onclick="requestCloseModal('tokenEditModal')">取消</button>
        <button class="btn" type="button" onclick="saveTokenDef()">保存</button>
      </div>
    </div>
  </div>


</body>
</html>`;
}

function generateUniqueId(existingIds) {
  let id;
  do {
    id = (Date.now().toString() + Math.floor(Math.random()*100000).toString().padStart(5,'0'));
  } while (existingIds.has(id));
  return id;
}

function mergeCategoryTrees(baseTree, incomingTree) {
  if (!Array.isArray(baseTree)) return;
  if (!Array.isArray(incomingTree)) return;

  const mainMap = new Map();
  baseTree.forEach(c => {
    if (c && typeof c.name !== 'undefined') mainMap.set(String(c.name), c);
  });

  incomingTree.forEach(cIn => {
    if (!cIn) return;
    const name = String(cIn.name ?? '').trim();
    if (!name) return;

    const cloned = JSON.parse(JSON.stringify(cIn));
    if (!mainMap.has(name)) {
      baseTree.push(cloned);
      mainMap.set(name, baseTree[baseTree.length - 1]);
      return;
    }

    const baseMain = mainMap.get(name);
    if (!baseMain) return;
    if (!Array.isArray(baseMain.subs)) baseMain.subs = [];

    const subMap = new Set(baseMain.subs.map(s => String((typeof s === 'string') ? s : (s?.name ?? '')).trim()).filter(Boolean));
    const inSubs = Array.isArray(cloned.subs) ? cloned.subs : [];
    inSubs.forEach(sIn => {
      const sName = String((typeof sIn === 'string') ? sIn : (sIn?.name ?? '')).trim();
      if (!sName) return;
      if (subMap.has(sName)) return;
      baseMain.subs.push(sIn);
      subMap.add(sName);
    });
  });
}

function upsertCategoryFromTemplate(mainName, subName) {
  const m = String(mainName ?? '').trim();
  const s = String(subName ?? '').trim();
  if (!m) return;

  let main = categoryTree.find(x => String(x.name ?? '').trim() === m);
  if (!main) {
    main = { name: m, iconKey: guessMainIcon(m), subs: [] };
    categoryTree.push(main);
  }

  if (!s) return;
  if (!Array.isArray(main.subs)) main.subs = [];
  const exists = main.subs.some(x => String((typeof x === 'string') ? x : (x?.name ?? '')).trim() === s);
  if (!exists) {
    main.subs.push({ name: s, iconKey: guessSubIcon(s) });
  }
}

function doImportOverride(data) {
  autoBackup('import_override');

  // 字段元素（可点击填写）定义：覆盖模式下同步覆盖
  if (Array.isArray(data.tokenDefs)) {
    try { __tokenDefs = data.tokenDefs; __saveTokenDefs(); } catch(e) {}
  }

  if (data.categories) {
    categoryTree = data.categories;
    normalizeCategoryTreeForCompatibility();
  }
  if (data.templates) {
    templates = data.templates;
    normalizeDataForCompatibility();
  }
  openAlertModal("恢复成功（已覆盖）！", "导入完成", "确定", () => location.reload());
}

function doImportAdd(data) {
  autoBackup('import_add');

  // 字段元素（可点击填写）定义：增加模式下合并追加
  if (Array.isArray(data.tokenDefs)) {
    try { mergeTokenDefs(data.tokenDefs); } catch(e) {}
  }

  // 1) 合并分类（按名称去重）
  if (Array.isArray(data.categories)) {
    mergeCategoryTrees(categoryTree, data.categories);
  }

  // 2) 合并模板（规则加强：同名模板自动合并，避免重复）
  const incomingTemplates = Array.isArray(data.templates) ? data.templates : [];

  const normalizedIncoming = incomingTemplates.map(t => ({
    id: String(t?.id ?? ''),
    mainCat: String(t?.mainCat ?? ''),
    subCat: String(t?.subCat ?? ''),
    title: String(t?.title ?? ''),
    tags: String(t?.tags ?? ''),
    content: String(t?.content ?? '')
  }));

  // 为导入模板补齐分类（即使对方备份缺 categories 也能合并）
  normalizedIncoming.forEach(t => upsertCategoryFromTemplate(t.mainCat, t.subCat));

  const existingIds = new Set((templates || []).map(t => String(t?.id ?? '')));

  const norm = (s) => String(s ?? '').trim().toLowerCase();
  const makeKey = (m, s, t) => `${norm(m)}||${norm(s)}||${norm(t)}`;
// 索引现有模板：仅在“同一一级/二级分类条目下 + 同标题”时合并（不同分类下同名不合并）
const byKey = new Map();
(templates || []).forEach(t => {
  const k = makeKey(t.mainCat, t.subCat, t.title);
  if (!byKey.has(k)) byKey.set(k, t);
});
function splitTagsFlexible(tagStr) {
    if (!tagStr) return [];
    return String(tagStr)
      .split(/[，,;；\n]/)
      .map(s => s.trim())
      .filter(Boolean);
  }

  function mergeTags(baseTags, incomingTags) {
    const set = new Set();
    splitTagsFlexible(baseTags).forEach(x => set.add(x));
    splitTagsFlexible(incomingTags).forEach(x => set.add(x));
    return Array.from(set).join(', ');
  }

  function mergeContentHtml(baseHtml, incomingHtml) {
    const b = (baseHtml ?? '').toString();
    const i = (incomingHtml ?? '').toString();
    if (!b) return i;
    if (!i) return b;

    // 规范化：处理 iOS/不同浏览器带来的 NBSP/零宽字符差异，避免“内容一样却被重复追加”
    const canonText = (html) => htmlToPlainText(html)
      .replace(/\u200B/g, '')
      .replace(/\u00A0/g, ' ')
      .replace(/\u3000/g, ' ')
      .replace(/\s+/g, '')
      .trim();

    const canonHtml = (html) => String(html ?? '')
      .replace(/\u200B/g, '')
      .replace(/\u00A0/g, ' ')
      .replace(/\u3000/g, ' ')
      .replace(/&nbsp;/gi, ' ')
      .replace(/\s+/g, ' ')
      .replace(/>\s+</g, '><')
      .trim();

    const bt = canonText(b);
    const it = canonText(i);

    // 完全一致（包括富文本结构）时：不追加
    const bh = canonHtml(b);
    const ih = canonHtml(i);
    if (bh && ih && bh === ih) return b;

    // 文本完全一致 / 互为包含时：不重复追加
    if (bt && it && bt === it) return (b.length >= i.length) ? b : i;
    if (bt && it && bt.includes(it)) return b;
    if (bt && it && it.includes(bt)) return i;

    // 内容不同：为避免丢失信息，追加“导入合并内容”块（尽量不侵入，且可读）
    return `${b}<hr class="merge-hr"><div class="merge-note">导入合并内容</div>${i}`;
  }

  function mergeInto(target, incoming) {
    if (!target) return;
    // 标题：保留已有（若已有为空则补齐）
    if (!String(target.title ?? '').trim() && String(incoming.title ?? '').trim()) target.title = incoming.title;

    // 分类：不主动改变现有归类；仅在现有为空时补齐
    if (!String(target.mainCat ?? '').trim() && String(incoming.mainCat ?? '').trim()) target.mainCat = incoming.mainCat;
    if (!String(target.subCat ?? '').trim() && String(incoming.subCat ?? '').trim()) target.subCat = incoming.subCat;

    // 标签：并集
    target.tags = mergeTags(target.tags, incoming.tags);

    // 内容：同内容不重复；不同内容追加合并块
    target.content = mergeContentHtml(target.content, incoming.content);
  }

  const stats = { added: 0, merged: 0 };
  const toAdd = [];

  normalizedIncoming.forEach(inc => {
    const title = String(inc.title ?? '').trim();
    if (!title) return; // 无标题的模板不导入（避免产生不可识别条目）

    const key = makeKey(inc.mainCat, inc.subCat, inc.title);
    const target = byKey.get(key);
if (target) {
      mergeInto(target, inc);
      stats.merged += 1;
      return;
    }

    // 新增：处理 ID 冲突
    let id = String(inc.id ?? '');
    if (!id || existingIds.has(id)) id = generateUniqueId(existingIds);
    existingIds.add(id);

    const obj = { ...inc, id };
    toAdd.push(obj);
    stats.added += 1;

    // 更新索引，避免导入文件内部同名产生重复
    byKey.set(key, obj);
});

  // 插入到前部（让新导入的更容易看到）
  templates = [...toAdd, ...(templates || [])];

  // 统一做一次兼容与图标去重
  normalizeCategoryTreeForCompatibility();
  normalizeDataForCompatibility();

  openAlertModal(`导入成功！新增 ${stats.added}，合并同名 ${stats.merged}。`, "导入完成", "确定", () => location.reload());
}

function importData(inputElement) {
  const file = inputElement.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    let data;
    try {
      data = JSON.parse(e.target.result);
    } catch(err) {
      openAlertModal("文件损坏或格式错误", "导入失败");
      inputElement.value = '';
      return;
    }

    const ts = data.timestamp || '未知';
    const tCount = Array.isArray(data.templates) ? data.templates.length : 0;
    const cCount = Array.isArray(data.categories) ? data.categories.length : 0;

    openConfirm3({
      title: '导入数据',
      body: `发现备份文件：${ts}\n分类数量：${cCount}\n模板数量：${tCount}\n\n请选择导入方式：\n- 增加导入：将备份中的分类/模板合并到当前数据（不会删除现有内容，同名模板将自动合并）\n- 覆盖导入：用备份完全替换当前数据`,
      labels: { continue: '取消', discard: '增加导入', save: '覆盖导入' },
      onDiscard: () => {
        try { doImportAdd(data); } finally { inputElement.value = ''; }
      },
      onSave: () => {
        try { doImportOverride(data); } finally { inputElement.value = ''; }
      }
    });
  };
  reader.readAsText(file);
}
/* =========================
   22) 复制
   ========================= */
function copyContent(id, btn) {
  const t = templates.find(i => i.id === id);
  if(t) {
    const text = htmlToPlainText(t.content, { emptyTokenBrackets: true });
    navigator.clipboard.writeText(text).then(() => {
      const old = btn.innerHTML;
      btn.innerHTML = `<span class="ico">${ICONS.svg('check')}</span> 已复制`;
      btn.classList.add('copied');
      setTimeout(() => {
        btn.innerHTML = old;
        btn.classList.remove('copied');
      }, 2000);
    });
  }
}

/* =========================
   23) localStorage
   ========================= */
function saveToLocal() { localStorage.setItem('med_templates_v3', JSON.stringify(templates)); }
function saveCategories() { localStorage.setItem('med_categories_v3', JSON.stringify(categoryTree)); }

/* =========================
   24) 处理“users”图标缺失的容错（你默认分类里用了 users）
   ========================= */
(function ensureUsersIcon() {
  if (!ICONS.exists('users')) {
    // 追加一个 users（不会影响已有 key，只在缺失时补）
    // 这里用最简双人轮廓
    const s = (paths) => `<svg viewBox="0 0 24 24" aria-hidden="true">${paths}</svg>`;
    const usersSvg = s(`<path d="M16 11a3 3 0 1 0-3-3 3 3 0 0 0 3 3z"/><path d="M8 11a3 3 0 1 0-3-3 3 3 0 0 0 3 3z"/><path d="M4 20a4 4 0 0 1 8 0"/><path d="M12 20a4 4 0 0 1 8 0"/>`);
    // hack: 将 users 注入 ICONS 内部不可行（闭包），因此：把 users 统一映射到 dna 或 info
    // 这里直接把 DEFAULT_CATEGORIES 的 users 替换为 dna
    categoryTree.forEach(c => { if (c.iconKey === 'users') c.iconKey = 'dna'; });
    saveCategories();
  }
})();

/* ===== Mobile: compact row actions (more menu) ===== */
function closeAllRowMoreMenus() {
  document.querySelectorAll('.manage-item.show-more-menu').forEach(el => el.classList.remove('show-more-menu'));
}
function toggleRowMoreMenu(btn) {
  if (!btn) return;
  const row = btn.closest('.manage-item');
  if (!row) return;
  const willOpen = !row.classList.contains('show-more-menu');
  closeAllRowMoreMenus();
  if (willOpen) row.classList.add('show-more-menu');
}

// close on outside click / scroll
document.addEventListener('click', (e) => {
  if (e.target.closest('.more-menu') || e.target.closest('.icon-btn.more')) return;
  closeAllRowMoreMenus();
}, true);
document.addEventListener('scroll', () => closeAllRowMoreMenus(), true);

</script>


  <!-- 字段元素：插入选择 -->
  <div class="modal" id="tokenInsertModal" onclick="noopClose(event)">
    <div class="modal-content" style="width: 520px;" onclick="event.stopPropagation()">
      <div class="modal-title">
        <span>插入字段元素</span>
        <span class="modal-close" onclick="requestCloseModal('tokenInsertModal')">
          <span class="ico" id="icoCloseTokenInsert"></span>
          <span>关闭</span>
        </span>
      </div>
      <div class="modal-body">
        <div class="settings-row" style="margin-bottom:10px;">
          <div class="settings-label" style="min-width:72px;">搜索</div>
          <input class="form-input" id="tokenInsertSearch" placeholder="输入字段名称关键词…" oninput="renderTokenInsertList()">
        </div>
        <div id="tokenInsertList" class="token-list"></div>
      </div>
      <div class="modal-footer">
        <button class="btn secondary" type="button" onclick="requestCloseModal('tokenInsertModal')">取消</button>
      </div>
    </div>
  </div>

  <!-- 字段元素：填写/选择值 -->
  <div class="modal" id="tokenValueModal" onclick="noopClose(event)">
    <div class="modal-content" style="width: 520px;" onclick="event.stopPropagation()">
      <div class="modal-title">
        <span id="tokenValueTitle">填写字段</span>
        <span class="modal-close" onclick="requestCloseModal('tokenValueModal')">
          <span class="ico" id="icoCloseTokenValue"></span>
          <span>关闭</span>
        </span>
      </div>
      <div class="modal-body">
        <div id="tokenValueBody"></div>
      </div>
      <div class="modal-footer">
        <button class="btn danger" type="button" onclick="clearTokenValue()">清空</button>
        <button class="btn secondary" type="button" onclick="requestCloseModal('tokenValueModal')">取消</button>
        <button class="btn" type="button" onclick="applyTokenValue()">确定</button>
      </div>
    </div>
  </div>

  <!-- 字段元素：管理 -->
  <div class="modal" id="tokenManagerModal" onclick="noopClose(event)">
    <div class="modal-content" style="width: 680px;" onclick="event.stopPropagation()">
      <div class="modal-title">
        <span>管理字段元素</span>
        <span class="modal-close" onclick="requestCloseModal('tokenManagerModal')">
          <span class="ico" id="icoCloseTokenMgr"></span>
          <span>关闭</span>
        </span>
      </div>
      <div class="modal-body">
        <div class="settings-actions" style="margin-bottom:10px;">
          <button class="action-btn" type="button" onclick="openTokenEdit('')">
            <span class="ico" id="icoTokenAdd"></span>
            <span>新增字段元素</span>
          </button>
        </div>
        <div id="tokenManagerList" class="token-list"></div>
        <div class="hint" style="margin-top:8px;">提示：字段元素插入到模板内容后，可点击该字段进行快速选择/填写。</div>
      </div>
      <div class="modal-footer">
        <button class="btn secondary" type="button" onclick="requestCloseModal('tokenManagerModal')">关闭</button>
      </div>
    </div>
  </div>

  <!-- 字段元素：新增/编辑 -->
  <div class="modal" id="tokenEditModal" onclick="noopClose(event)">
    <div class="modal-content" style="width: 560px;" onclick="event.stopPropagation()">
      <div class="modal-title">
        <span id="tokenEditTitle">新增字段元素</span>
        <span class="modal-close" onclick="requestCloseModal('tokenEditModal')">
          <span class="ico" id="icoCloseTokenEdit"></span>
          <span>关闭</span>
        </span>
      </div>
      <div class="modal-body">
        <input type="hidden" id="tokenEditId" value="">
        <div class="form-grid">
          <div class="form-col">
            <label class="form-label">字段名称</label>
            <input class="form-input" id="tokenEditName" placeholder="例如：发病部位">
          </div>
          <div class="form-col">
            <label class="form-label">填写方式</label>
            <select class="form-select" id="tokenEditMode" onchange="toggleTokenEditOptions()">
              <option value="select">下拉选择</option>
              <option value="text">自由输入</option>
            </select>
          </div>
          <div class="form-col" id="tokenEditOptionsWrap">
            <label class="form-label">可选项（每行一个，或用逗号分隔）</label>
            <textarea class="form-input" id="tokenEditOptions" style="min-height:120px;" placeholder="右侧颌下区\n左侧颌下区\n上颌\n下颌"></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn secondary" type="button" onclick="requestCloseModal('tokenEditModal')">取消</button>
        <button class="btn" type="button" onclick="saveTokenDef()">保存</button>
      </div>
    </div>
  </div>


</body>
</html>
